<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<title>Sessão 7: Hardening de sistemas web</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="_sessão_7_hardening_de_sistemas_web">Sessão 7: Hardening de sistemas web</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nesta sessão, iremos configurar um website usando o CMS Wordpress seguindo as melhores práticas de segurança, bem como tornando-o altamente disponível através do balanceamento de carga em múltiplos nodos de <em>frontend</em> web.</p>
</div>
<div class="sect2">
<h3 id="_1_topologia_desta_sessão">1) Topologia desta sessão</h3>
<div class="paragraph">
<p>Criaremos quatro novas máquinas nesta sessão, a saber:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>www1</code>, primeiro nodo de atendimento web, instalado manualmente. Endereço IP 10.0.42.5/24.</p>
</li>
<li>
<p><code>www2</code>, segundo nodo de atendimento web, instalado de forma automática via Ansible. Endereço IP 10.0.42.6/24.</p>
</li>
<li>
<p><code>db</code>, servidor de banco de dados para as máquinas <code>www1</code> e <code>www2</code>. Endereço IP 10.0.42.7/24.</p>
</li>
<li>
<p><code>lb</code>, balanceador de carga HTTP/HTTPS que redirecionará requisições para as VMs <code>www1</code> e <code>www2</code>. Endereço IP 10.0.42.8/24.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Temos que criar quatro novos registros DNS diretos e reversos. Acesse a máquina <code>ns1</code> como o usuário <code>root</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
ns1
root</pre>
</div>
</div>
<div class="paragraph">
<p>Edite o arquivo de zonas <code>/etc/nsd/zones/intnet.zone</code>, inserindo entradas A para a máquinas indicadas no começo desta atividade. <strong>Não se esqueça</strong> de incrementar o valor do serial no topo do arquivo!</p>
</div>
<div class="literalblock">
<div class="content">
<pre># nano /etc/nsd/zones/intnet.zone
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># grep 'www1\|www2\|db\|lb' /etc/nsd/zones/intnet.zone
www1    IN    A                 10.0.42.5
www2    IN    A                 10.0.42.6
db      IN    A                 10.0.42.7
lb      IN    A                 10.0.42.8</pre>
</div>
</div>
<div class="paragraph">
<p>Faça o mesmo para o arquivo de zona reversa:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># nano /etc/nsd/zones/10.0.42.zone</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># grep 'www1\|www2\|db\|lb' /etc/nsd/zones/10.0.42.zone
5       IN   PTR                www1.intnet.
6       IN   PTR                www2.intnet.
7       IN   PTR                db.intnet.
8       IN   PTR                lb.intnet.</pre>
</div>
</div>
<div class="paragraph">
<p>Assine o arquivo de zonas usando o <em>script</em> criado anteriormente:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># bash /root/scripts/signzone-intnet.sh
reconfig start, read /etc/nsd/nsd.conf
ok
ok
ok
ok removed 0 rrsets, 0 messages and 0 key entries</pre>
</div>
</div>
<div class="paragraph">
<p>Verifique a criação das entradas usando o comando <code>dig</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># for host in www1 www2 db lb; do echo -n "$host: "; dig ${host}.intnet +short; done
www1: 10.0.42.5
www2: 10.0.42.6
db: 10.0.42.7
lb: 10.0.42.8</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># for ip in 5 6 7 8; do echo -n "10.0.42.${ip}: "; dig -x 10.0.42.${ip} +short; done
10.0.42.5: www1.intnet.
10.0.42.6: www2.intnet.
10.0.42.7: db.intnet.
10.0.42.8: lb.intnet.</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_2_configuração_do_servidor_de_banco_de_dados">2) Configuração do servidor de banco de dados</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Vamos começar criando a máquina que atuará como servidor de banco de dados em nossa topologia. Clone a máquina <code>debian-template</code> para uma nova, de nome <code>db</code>, com uma única interface de rede conectada à DMZ. O IP da máquina será 10.0.42.7/24.</p>
<div class="paragraph">
<p>Concluída a clonagem, ligue a máquina e logue como <code>root</code>. Depois, use o script <code>/root/scripts/changehost.sh</code> para fazer a configuração automática:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
debian-template
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># bash ~/scripts/changehost.sh -h db -i 10.0.42.7 -g 10.0.42.1
Signing ssh_host_ecdsa_key.pub key...
Signing ssh_host_ed25519_key.pub key...
Signing ssh_host_rsa_key.pub key...
Configuring host key trust...
Configuring user key trust...
All done!</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ip addr show label 'enp0s*' | grep 'inet ' | awk '{print $2,$NF}' ; hostname ; whoami
10.0.42.7/24 enp0s3
db
root</pre>
</div>
</div>
</li>
<li>
<p>Vamos aplicar à máquina <code>db</code> o <em>baseline</em> de segurança que configuramos no Ansible: <code>sudo</code>, OpenNTPD, Snoopy e Rsyslog centralizado. Acesse a máquina <code>client</code> como o usuário <code>ansible</code>:</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami
client
ansible</pre>
</div>
</div>
<div class="paragraph">
<p>Insira a máquina <code>db</code> no inventário gerenciado pelo Ansible:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ sed -i '/\[srv\]/a db' ~/ansible/hosts</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cat ~/ansible/hosts
[srv]
db
ns1
ns2
nfs
192.168.42.2
log

[ntp_server]
log

[log_server]
log

[web_server]
log</pre>
</div>
</div>
<div class="paragraph">
<p>Execute o <em>playbook</em> <code>/home/ansible/ansible/srv.yml</code>, limitando o escopo à máquina <code>db</code> e alterando a escala de privilégio para o <code>su</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ansible-playbook -i ~/ansible/hosts -l db -Ke ansible_become_method=su ~/ansible/srv.yml
SUDO password:

PLAY [srv] **********************************************************************************************************


TASK [Gathering Facts] **********************************************************************************************

ok: [db]

TASK [sudoers : Propagate sudoers configuration] ********************************************************************

changed: [db]

TASK [sudoers : Sets root account as expired] ***********************************************************************

changed: [db]

TASK [ntp : Install OpenNTPD] ***************************************************************************************

fatal: [db]: FAILED! =&gt; {"changed": false, "module_stderr": "Shared connection to db closed.\r\n", "module_stdout": "\r\nSua conta expirou; entre em contato com o administrador do sistema\r\nsu: Falha de autenticação\r\n", "msg": "MODULE FAILURE\nSee stdout/stderr for the exact error", "rc": 1}
        to retry, use: --limit @/home/ansible/ansible/srv.retry

PLAY RECAP **********************************************************************************************************

db                         : ok=3    changed=2    unreachable=0    failed=1</pre>
</div>
</div>
<div class="paragraph">
<p>A <em>role</em> irá falhar no passo de instalação do OpenNTPD, pois neste momento o <code>sudo</code> acaba de ser configurado e a conta do usuário <code>root</code>, expirada. Execute o <em>playbook</em> novamente, desta vez sem customizar o método de escalação de privilégio:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ansible-playbook -i ~/ansible/hosts -l db ~/ansible/srv.yml

PLAY [srv] **********************************************************************************************************


TASK [Gathering Facts] **********************************************************************************************

ok: [db]

TASK [sudoers : Propagate sudoers configuration] ********************************************************************

ok: [db]

TASK [sudoers : Sets root account as expired] ***********************************************************************

changed: [db]

TASK [ntp : Install OpenNTPD] ***************************************************************************************

changed: [db]

TASK [ntp : Copy OpenNTPD configuration] ****************************************************************************

changed: [db]

TASK [snoopy : Install Snoopy] **************************************************************************************

changed: [db]

TASK [snoopy : Configure ld.so.preload] *****************************************************************************

changed: [db]

TASK [syslog : Configure centralized syslog] ************************************************************************

changed: [db]

RUNNING HANDLER [ntp : Restart OpenNTPD] ****************************************************************************

changed: [db]

RUNNING HANDLER [syslog : Restart Rsyslog] **************************************************************************

changed: [db]

PLAY [web_server] ***************************************************************************************************

skipping: no hosts matched

PLAY RECAP **********************************************************************************************************

db                         : ok=10   changed=8    unreachable=0    failed=0</pre>
</div>
</div>
<div class="paragraph">
<p>Perfeito, a máquina está configurada para operar em nosso <em>datacenter</em>.</p>
</div>
</li>
<li>
<p>Agora, acesse a máquina <code>db</code> como o usuário <code>root</code>. Vamos instalar o SGBD MariaDB:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
db
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># usermod -e -1 root ; apt-get install -y --no-install-recommends mariadb-server ; usermod -e 0 root</pre>
</div>
</div>
</li>
<li>
<p>Vamos criar uma base de dados para nosso website, com o nome <code>seg10web</code>. Para acessar a base, criaremos um usuário <code>seg10user</code>, com senha <code>seg10pass</code>. Execute os comandos a seguir:</p>
<div class="literalblock">
<div class="content">
<pre># mysql -u root
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 2
Server version: 10.1.26-MariaDB-0+deb9u1 Debian 9.1

Copyright (c) 2000, 2017, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [(none)]&gt;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>MariaDB [(none)]&gt; create database seg10web;
Query OK, 1 row affected (0.00 sec)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>MariaDB [(none)]&gt; grant all on seg10web.* to seg10user@localhost identified by 'seg10pass';
Query OK, 0 rows affected (0.00 sec)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>MariaDB [(none)]&gt; grant all on seg10web.* to seg10user@'10.0.42.%' identified by 'seg10pass';
Query OK, 0 rows affected (0.00 sec)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>MariaDB [(none)]&gt; flush privileges;
Query OK, 0 rows affected (0.00 sec)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>MariaDB [(none)]&gt; quit
Bye</pre>
</div>
</div>
<div class="paragraph">
<p>Note que demos permissão para login a partir de <em>localhost</em>, e também da rede 10.0.42.0/24&#8201;&#8212;&#8201;logins oriundos de qualquer outro IP serão negados.</p>
</div>
</li>
<li>
<p>O MariaDB escuta apenas a conexões vindas de <em>localhost</em>, por padrão. Vamos corrigir isso:</p>
<div class="literalblock">
<div class="content">
<pre># sed -i 's/^\(bind-address[\t ]*\=\).*/\1 0.0.0.0/' /etc/mysql/mariadb.conf.d/50-server.cnf</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl restart mariadb</pre>
</div>
</div>
<div class="paragraph">
<p>Note que o SGBD está escutando em todas as interfaces:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ss -tnlp | grep 3306
LISTEN     0      80           *:3306                     *:*                   users:(("mysqld",pid=3579,fd=17))</pre>
</div>
</div>
<div class="paragraph">
<p>Essa é uma limitação do MariaDB/MySQL&#8201;&#8212;&#8201;apenas uma interface pode ser especificada na diretiva <code>bind-address</code> do arquivo de configuração. Se for necessário escutar em mais de uma interface de rede, e necessário especificar o <em>catch-all</em> 0.0.0.0 (referência: <a href="https://mariadb.com/kb/en/library/configuring-mariadb-for-remote-client-access/" class="bare">https://mariadb.com/kb/en/library/configuring-mariadb-for-remote-client-access/</a>).</p>
</div>
</li>
<li>
<p>Para consertar essa limitação, vamos usar o firewall local. Insira uma regra que permite que as máquinas <em>localhost</em>, <code>www1</code> e <code>www2</code> conectem-se ao SGBD, e nenhuma outra:</p>
<div class="literalblock">
<div class="content">
<pre># iptables -A INPUT -i lo -p tcp -m tcp --dport 3306 -j ACCEPT</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A INPUT -s 10.0.42.5,10.0.42.6 -p tcp -m tcp --dport 3306 -j ACCEPT</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A INPUT -p tcp --dport 3306 -j DROP</pre>
</div>
</div>
</li>
<li>
<p>Para manter as regras entre <em>reboots</em>, instale o pacote <code>iptables-persistent</code>:</p>
<div class="literalblock">
<div class="content">
<pre># apt-get install -y iptables-persistent</pre>
</div>
</div>
<div class="paragraph">
<p>Na instalação do pacote, quando perguntado, responda:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 65%;">
<caption class="title">Table 1. Configurações do iptables-persistent</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pergunta</th>
<th class="tableblock halign-left valign-top">Resposta</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Salvar as regras IPv4 atuais?</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sim</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Salvar as regras IPv6 atuais?</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sim</p></td>
</tr>
</tbody>
</table>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_4_configuração_do_servidor_web_www1">4) Configuração do servidor web www1</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Agora, vamos para o primeiro servidor web. Clone a máquina <code>debian-template</code> para uma de nome <code>www1</code>, com uma única interface de rede conectada à DMZ. O IP da máquina será 10.0.42.5/24.</p>
<div class="paragraph">
<p>Concluída a clonagem, ligue a máquina e logue como <code>root</code>. Depois, use o script <code>/root/scripts/changehost.sh</code> para fazer a configuração automática, como de costume.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
debian-template
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># bash ~/scripts/changehost.sh -h www1 -i 10.0.42.5 -g 10.0.42.1
Signing ssh_host_ecdsa_key.pub key...
Signing ssh_host_ed25519_key.pub key...
Signing ssh_host_rsa_key.pub key...
Configuring host key trust...
Configuring user key trust...
All done!</pre>
</div>
</div>
</li>
<li>
<p>Para aplicar o <em>baseline</em> de segurança via Ansible à máquina <code>www1</code>, repita o que fizemos no passo (2) da atividade (2) desta sessão:</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami
client
ansible</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ sed -i '/\[srv\]/a www1' ~/ansible/hosts</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ansible-playbook -i ~/ansible/hosts -l www1 -Ke ansible_become_method=su ~/ansible/srv.yml ; ansible-playbook -i ~/ansible/hosts -l www1 ~/ansible/srv.yml
SUDO password:

(...)

PLAY RECAP **********************************************************************************************************

www1                       : ok=10   changed=8    unreachable=0    failed=0</pre>
</div>
</div>
</li>
<li>
<p>Agora, acesse a máquina <code>www1</code> como o usuário <code>root</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
www1
root</pre>
</div>
</div>
</li>
<li>
<p>Vamos instalar as dependências para o correto funcionamento do CMS Wordpress em nosso servidor:</p>
<div class="literalblock">
<div class="content">
<pre># apt-get install -y nginx php-fpm php-mysql</pre>
</div>
</div>
</li>
<li>
<p>Primeiro, vamos configurar o servidor web Nginx. Apague a configuração-padrão de websites publicados do Nginx:</p>
<div class="literalblock">
<div class="content">
<pre># rm /etc/nginx/sites-enabled/default</pre>
</div>
</div>
<div class="paragraph">
<p>Crie o arquivo novo <code>/etc/nginx/sites-available/seg10</code> com o seguinte conteúdo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-conf" data-lang="conf">upstream php {
        server unix:/run/php/php7.0-fpm.sock;
}

server {
        server_name seg10web.intnet;
        root /var/www/seg10;
        index index.php;

        location = /favicon.ico {
                log_not_found off;
                access_log off;
        }

        location = /robots.txt {
                allow all;
                log_not_found off;
                access_log off;
        }

        location / {
                try_files $uri $uri/ /index.php?$args;
        }

        location ~ \.php$ {
                include fastcgi.conf;
                fastcgi_intercept_errors on;
                fastcgi_pass php;
                fastcgi_buffers 16 16k;
                fastcgi_buffer_size 32k;
        }

        location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
                expires max;
                log_not_found off;
        }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Habilite-o na configuração do Nginx:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># p=$PWD ; cd /etc/nginx/sites-enabled/ ; ln -s ../sites-available/seg10 . ; cd $p ; unset p</pre>
</div>
</div>
<div class="paragraph">
<p>Reinicie o Nginx:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl restart nginx.service</pre>
</div>
</div>
</li>
<li>
<p>O Wordpress recomenda uma ligeira alteração na configuração do PHP-FPM, como se segue:</p>
<div class="literalblock">
<div class="content">
<pre># sed -i 's/^;\(cgi\.fix\_pathinfo=\).*/\10/' /etc/php/7.0/fpm/php.ini</pre>
</div>
</div>
<div class="paragraph">
<p>Reinicie o <em>daemon</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl restart php7.0-fpm.service</pre>
</div>
</div>
</li>
<li>
<p>Vamos fazer o download do Wordpress, desempacotá-lo e renomear o diretório de acordo com a configuração do Nginx:</p>
<div class="literalblock">
<div class="content">
<pre># cd /var/www/ ; \
  wget -q https://wordpress.org/latest.tar.gz ; \
  tar zxf latest.tar.gz ; \
  rm latest.tar.gz ; \
  mv wordpress seg10 ; \
  chown -R www-data. /var/www</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ls -1 /var/www/
html
seg10</pre>
</div>
</div>
</li>
<li>
<p>Para conseguir acessar a máquina <code>www1</code> através do IP público do firewall, teremos que fazer alguns ajustes nas regras atuais. Acesse a máquina <code>ns1</code> como <code>root</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
ns1
root</pre>
</div>
</div>
<div class="paragraph">
<p>Para que consigamos atingir a máquina <code>www1</code> será necessário criar uma regra de DNAT na tabela <code>nat</code>, <em>chain</em> PREROUTING, além de uma regra na tabela <code>filter</code>, <em>chain</em> FORWARD, correspondente. Mapearemos a porta externa 80/TCP para a porta interna 80/TCP, sem alterações.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -t nat -A PREROUTING -i enp0s3 -p tcp -m tcp --dport 80 -j DNAT --to-destination 10.0.42.5</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A FORWARD -i enp0s3 -d 10.0.42.5/32 -p tcp -m tcp --dport 80 -j ACCEPT</pre>
</div>
</div>
</li>
<li>
<p>Perfeito! Em sua máquina física, abra o navegador e aponte-o para o IP da interface <code>enp0s3</code> da máquina <code>ns1</code>, o IP público do nosso <em>datacenter</em> simulado. Você deverá ver a tela de instalação inicial do Wordpress, como se segue:</p>
<div id="img-wordpress1" class="imageblock text-center">
<div class="content">
<img src="../img/wordpress1.png" alt="wordpress1">
</div>
<div class="title">Figure 1. Tela inicial de instalação do Wordpress</div>
</div>
<div class="paragraph">
<p>Escolha o idioma <em>Português do Brasil</em>, e clique em <em>Continuar</em>. Na tela seguinte, clique em <em>Vamos lá!</em>.</p>
</div>
<div class="paragraph">
<p>Na tela de configuração da conexão com o banco de dados, digite <code>seg10web</code> em <em>Nome do banco de dados</em>; para <em>Nome de usuário</em>, informe <code>seg10user</code>; em <em>Senha</em>, <code>seg10pass</code>; para <em>Servidor do banco de dados</em>, informe <code>db.intnet</code>; para o <em>Prefixo da tabela</em>, mantenha o padrão <code>wp_</code>. Sua tela deverá ficar assim:</p>
</div>
<div id="img-wordpress2" class="imageblock text-center">
<div class="content">
<img src="../img/wordpress2.png" alt="wordpress2">
</div>
<div class="title">Figure 2. Configuração da conexão com o banco de dados</div>
</div>
<div class="paragraph">
<p>Clique em <em>Enviar</em>, e depois em <em>Instalar</em>.</p>
</div>
<div class="paragraph">
<p>Na tela de informações do site, digite <code>Seg10 Web</code> para o <em>Título do site</em>; em <em>Nome de usuário</em>, defina <code>admin</code>; para <em>Senha</em>, escolha <code>rnpesr123</code>; em <em>O seu e-mail</em>, informe <code>seg10web@int.net</code>; finalmente, mantenha a caixa <em>Visibilidade nos mecanismos de busca</em> desmarcada. Ao final do processo, sua tela deverá estar da seguinte forma:</p>
</div>
<div id="img-wordpress3" class="imageblock text-center">
<div class="content">
<img src="../img/wordpress3.png" alt="wordpress3">
</div>
<div class="title">Figure 3. Configuração das informações do site</div>
</div>
<div class="paragraph">
<p>Clique em <em>Instalar WordPress</em>. Ao final do processo de instalação, clique em <em>Acessar</em> para entrar na interface administrativa do Wordpress. Alternativamente, digite o endereço IP da interface <code>enp0s3</code> da máquina <code>ns1</code> na URL do navegador para acessar a página inicial do nosso portal, como mostra a figura abaixo:</p>
</div>
<div id="img-wordpress4" class="imageblock text-center">
<div class="content">
<img src="../img/wordpress4.png" alt="wordpress4">
</div>
<div class="title">Figure 4. Página inicial do portal Seg10 Web</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_5_configuração_automática_do_servidor_web_www2">5) Configuração automática do servidor web www2</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Para o segundo servidor web, a ideia é automatizar sua configuração completamente usando o Ansible. Antes de mais nada, clone a máquina <code>debian-template</code> para uma de nome <code>www2</code>, com uma única interface de rede conectada à DMZ. O IP da máquina será 10.0.42.6/24.</p>
<div class="paragraph">
<p>Concluída a clonagem, ligue a máquina e logue como <code>root</code>. Depois, use o script <code>/root/scripts/changehost.sh</code> para fazer a configuração automática, como de costume.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
debian-template
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># bash ~/scripts/changehost.sh -h www2 -i 10.0.42.6 -g 10.0.42.1
Signing ssh_host_ecdsa_key.pub key...
Signing ssh_host_ed25519_key.pub key...
Signing ssh_host_rsa_key.pub key...
Configuring host key trust...
Configuring user key trust...
All done!</pre>
</div>
</div>
</li>
<li>
<p>Para aplicar o <em>baseline</em> de segurança via Ansible à máquina <code>www2</code>, repita o que fizemos no passo (2) da atividade (2) desta sessão:</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami
client
ansible</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ sed -i '/\[srv\]/a www2' ~/ansible/hosts</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ansible-playbook -i ~/ansible/hosts -l www2 -Ke ansible_become_method=su ~/ansible/srv.yml ; ansible-playbook -i ~/ansible/hosts -l www2 ~/ansible/srv.yml
SUDO password:

(...)

PLAY RECAP **********************************************************************************************************

www2                       : ok=10   changed=8    unreachable=0    failed=0</pre>
</div>
</div>
</li>
<li>
<p>Agora, ainda como o usuário <code>ansible</code> na máquina <code>client</code>, vamos criar uma <em>role</em> para automatizar totalmente a instalação e configuração do portal <em>Seg10 Web</em> na máquina <code>www2</code> (e em quaisquer outros nodos web que venhamos a adicionar no futuro):</p>
<div class="literalblock">
<div class="content">
<pre>$ ansible-galaxy init --init-path=/home/ansible/ansible/roles seg10-web
- seg10-web was created successfully</pre>
</div>
</div>
</li>
<li>
<p>Vamos começar adicionando o arquivo de configuração do servidor Nginx&#8201;&#8212;&#8201;crie o arquivo novo <code>/home/ansible/ansible/roles/seg10-web/files/nginx_seg10</code> com o seguinte conteúdo:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-conf" data-lang="conf">upstream php {
        server unix:/run/php/php7.0-fpm.sock;
}

server {
        server_name seg10web.intnet;
        root /var/www/seg10;
        index index.php;

        location = /favicon.ico {
                log_not_found off;
                access_log off;
        }

        location = /robots.txt {
                allow all;
                log_not_found off;
                access_log off;
        }

        location / {
                try_files $uri $uri/ /index.php?$args;
        }

        location ~ \.php$ {
                include fastcgi.conf;
                fastcgi_intercept_errors on;
                fastcgi_pass php;
                fastcgi_buffers 16 16k;
                fastcgi_buffer_size 32k;
        }

        location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
                expires max;
                log_not_found off;
        }
}</code></pre>
</div>
</div>
</li>
<li>
<p>O próximo passo é o arquivo de <em>tasks</em>. Edite o arquivo <code>/home/ansible/ansible/roles/seg10-web/tasks/main.yml</code> com o seguinte conteúdo:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">---
- name: Install nginx and deps
  apt:
    name: '{{ packages }}'
    state: present
    update_cache: true
    install_recommends: no
  vars:
    packages:
    - nginx
    - php-fpm
    - php-mysql
  notify:
    - Start nginx
    - Start php-fpm

- name: Add seg10 config
  copy:
    src: nginx_seg10
    dest: /etc/nginx/sites-available/seg10
    owner: root
    group: root

- name: Disable default site configuration
  file:
    dest: /etc/nginx/sites-enabled/default
    state: absent

- name: Enable seg10 site config
  file:
    src: /etc/nginx/sites-available/seg10
    dest: /etc/nginx/sites-enabled/seg10
    state: link

- name: Copy web root
  synchronize:
    src: seg10
    dest: /var/www
    recursive: yes

- name: Web Root Permissions
  file:
   dest: /var/www/seg10
   mode: u=rwX,g=rX,o=rX
   state: directory
   owner: www-data
   group: www-data
   recurse: yes
  notify:
    - Restart nginx

- name: Adjust php-fpm fix_pathinfo
  replace:
    path: /etc/php/7.0/fpm/php.ini
    regexp: '^;(cgi\.fix_pathinfo).*$'
    replace: '\1=0'
  notify:
    - Restart php-fpm</code></pre>
</div>
</div>
<div class="paragraph">
<p>A lista de tarefas acima irá instalar os pacotes na máquina-alvo, copiar a configuração do Nginx, desativar a configuração-padrão e criar o symlink apropriado, sincronizar usando o <code>rsync</code> os arquivos do website localizados na pasta <code>files</code> para o diretório <code>/var/www</code> no destino (copiaremos esses arquivos a seguir), configurará as permissões do <em>webroot</em> e ajustará a variável <code>cgi.fix_pathinfo</code> do PHP-FPM.</p>
</div>
</li>
<li>
<p>Temos <em>handlers</em> no arquivo acima, como visto. Edite <code>/home/ansible/ansible/roles/seg10-web/handlers/main.yml</code> com o seguinte conteúdo:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">---
- name: Start nginx
  service:
    name: nginx
    state: started

- name: Start php-fpm
  service:
    name: php7.0-fpm
    state: started

- name: Restart nginx
  service:
    name: nginx
    state: restarted

- name: Restart php-fpm
  service:
    name: php7.0-fpm
    state: restarted</code></pre>
</div>
</div>
</li>
<li>
<p>Para que a sincronização dos arquivos do website funcione, temos que obtê-los&#8201;&#8212;&#8201;use o <code>scp</code> para fazer isso:</p>
<div class="literalblock">
<div class="content">
<pre>$ scp -rpq www1:/var/www/seg10 /home/ansible/ansible/roles/seg10-web/files/</pre>
</div>
</div>
</li>
<li>
<p>Temos que ajustar o escopo das máquinas-alvo da nossa nova <em>role</em>. Adicione o novo grupo <code>seg10_server</code> ao inventário do Ansible:</p>
<div class="literalblock">
<div class="content">
<pre>$ cat &lt;&lt; EOF &gt;&gt; ~/ansible/hosts

[seg10_server]
www1
www2
EOF</pre>
</div>
</div>
<div class="paragraph">
<p>Ao final, o inventário deverá ficar assim:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cat ~/ansible/hosts
[srv]
www2
www1
db
ns1
ns2
nfs
192.168.42.2
log

[ntp_server]
log

[log_server]
log

[web_server]
log

[seg10_server]
www1
www2</pre>
</div>
</div>
</li>
<li>
<p>Vamos criar um novo <em>playbook</em> para utilizar a <em>role</em> que acabamos de criar:</p>
<div class="literalblock">
<div class="content">
<pre>$ cat &lt;&lt; EOF &gt;&gt; ~/ansible/seg10web.yml
- hosts: seg10_server
  become: yes
  become_user: root
  become_method: sudo
  roles:
    - seg10-web
EOF</pre>
</div>
</div>
</li>
<li>
<p>Hora da verdade! Execute o <em>playbook</em>:</p>
<div class="literalblock">
<div class="content">
<pre>$ ansible-playbook -i ~/ansible/hosts ~/ansible/seg10web.yml

PLAY [seg10_server] *************************************************************************************************


TASK [Gathering Facts] **********************************************************************************************

ok: [www1]
ok: [www2]

TASK [seg10-web : Install nginx and deps] ***************************************************************************

ok: [www1]
changed: [www2]

TASK [seg10-web : Add seg10 config] *********************************************************************************

changed: [www2]
ok: [www1]

TASK [seg10-web : Disable default site configuration] ***************************************************************

ok: [www1]
changed: [www2]

TASK [seg10-web : Enable seg10 site config] *************************************************************************

ok: [www1]
changed: [www2]

TASK [seg10-web : Copy web root] ************************************************************************************

changed: [www1]
changed: [www2]

TASK [seg10-web : Web Root Permissions] *****************************************************************************

changed: [www1]
changed: [www2]

TASK [seg10-web : Adjust php-fpm fix_pathinfo] **********************************************************************

changed: [www2]
ok: [www1]

RUNNING HANDLER [seg10-web : Start nginx] ***************************************************************************

ok: [www2]

RUNNING HANDLER [seg10-web : Start php-fpm] *************************************************************************

ok: [www2]

RUNNING HANDLER [seg10-web : Restart nginx] *************************************************************************

changed: [www1]
changed: [www2]

RUNNING HANDLER [seg10-web : Restart php-fpm] ***********************************************************************

changed: [www2]

PLAY RECAP **********************************************************************************************************

www1                       : ok=9    changed=3    unreachable=0    failed=0
www2                       : ok=12   changed=9    unreachable=0    failed=0</pre>
</div>
</div>
</li>
<li>
<p>Terá funcionado? Vamos alterar o firewall para redirecionar os pacotes chegando na porta 80/TCP para a máquina <code>www2</code>, ao invés da <code>www1</code>. Acesse a máquina <code>ns1</code> como <code>root</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
ns1
root</pre>
</div>
</div>
<div class="paragraph">
<p>Remova as regras que criamos originalmente para a máquina <code>www1</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -t nat -D PREROUTING -i enp0s3 -p tcp -m tcp --dport 80 -j DNAT --to-destination 10.0.42.5</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -D FORWARD -i enp0s3 -d 10.0.42.5/32 -p tcp -m tcp --dport 80 -j ACCEPT</pre>
</div>
</div>
<div class="paragraph">
<p>Insira as mesmas regras no firewall, mas agora para a máquina <code>www2</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -t nat -A PREROUTING -i enp0s3 -p tcp -m tcp --dport 80 -j DNAT --to-destination 10.0.42.6</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A FORWARD -i enp0s3 -d 10.0.42.6/32 -p tcp -m tcp --dport 80 -j ACCEPT</pre>
</div>
</div>
</li>
<li>
<p>Vamos testar. Na máquina <code>www2</code>, como o usuário <code>root</code>, monitore o log de acesso do Nginx:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
www2
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># tail -f -n0 /var/log/nginx/access.log</pre>
</div>
</div>
<div class="paragraph">
<p>No navegador da sua máquina física, acesse novamente o endereço IP da interface <code>enp0s3</code> da máquina <code>ns1</code>&#8230;&#8203; o <strong>mesmo</strong> website que havíamos configurado antes aparece! Volte a visualizar o log de acesso do Nginx instalado na máquina <code>www2</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>192.168.29.106 - - [17/Nov/2018:03:12:38 -0200] "GET / HTTP/1.1" 200 20854 "-" "Mozilla/5.0 (Windows NT 10.0; Win64;x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.102 Safari/537.36"
192.168.29.106 - - [17/Nov/2018:03:12:38 -0200] "GET /wp-content/themes/twentyseventeen/style.css?ver=4.9.8 HTTP/1.1" 200 83401 "http://192.168.29.104/" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.102 Safari/537.36"
192.168.29.106 - - [17/Nov/2018:03:12:38 -0200] "GET /wp-includes/js/jquery/jquery.js?ver=1.12.4 HTTP/1.1" 200 97184"http://192.168.29.104/" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.102 Safari/537.36"</pre>
</div>
</div>
<div class="paragraph">
<p>De fato, os acessos estão chegando à nova máquina, e o website está funcionando como esperado. Note que não fizemos <strong>qualquer</strong> modificação manual na máquina <code>www2</code>&#8201;&#8212;&#8201;todos as dependências, arquivos de configuração e arquivos do site foram instalados de forma automática pelo Ansible. Se quiséssemos lançar agora outros dois, três ou dez nodos de atendimento web, bastaria adicionar as máquinas ao inventário do Ansible e disparar a <em>role</em>; toda a configuração é feita de forma automática.</p>
</div>
</li>
<li>
<p>Como fizemos uma nova <em>role</em> para os sistemas web, é uma boa ideia enviar nossas modificações para o repositório Git central. Acesse a máquina <code>client</code> como o usuário <code>ansible</code>:</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami
client
ansible</pre>
</div>
</div>
<div class="paragraph">
<p>Envie as alterações, adicionando uma mensagem significativa:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cd ~/ansible/ ; git add . ; git commit -m 'Adicionada role para configuracao automatica de servidores web do portal seg10' ; git push

(...)

Counting objects: 1665, done.
Compressing objects: 100% (1632/1632), done.
Writing objects: 100% (1665/1665), 8.95 MiB | 8.87 MiB/s, done.
Total 1665 (delta 170), reused 0 (delta 0)
remote: Resolving deltas: 100% (170/170), completed with 1 local object.
To nfs:/home/ansible/ansible.git
   467f80d..bd3fbc2  master -&gt; master</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_6_configuração_do_balanceador_de_carga">6) Configuração do balanceador de carga</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Vamos para a instalação e configuração do balanceador de carga. Clone a máquina <code>debian-template</code> para uma de nome <code>lb</code>, com uma única interface de rede conectada à DMZ. O IP da máquina será 10.0.42.8/24.</p>
<div class="paragraph">
<p>Concluída a clonagem, ligue a máquina e logue como <code>root</code>. Depois, use o script <code>/root/scripts/changehost.sh</code> para fazer a configuração automática, como de costume.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
debian-template
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># bash ~/scripts/changehost.sh -h lb -i 10.0.42.8 -g 10.0.42.1
Signing ssh_host_ecdsa_key.pub key...
Signing ssh_host_ed25519_key.pub key...
Signing ssh_host_rsa_key.pub key...
Configuring host key trust...
Configuring user key trust...
All done!</pre>
</div>
</div>
</li>
<li>
<p>Aplique o <em>baseline</em> de segurança à máquina <code>lb</code>, repetindo o que fizemos no passo (2) da atividade (2) desta sessão:</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami
client
ansible</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ sed -i '/\[srv\]/a lb' ~/ansible/hosts</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ansible-playbook -i ~/ansible/hosts -l lb -Ke ansible_become_method=su ~/ansible/srv.yml ; ansible-playbook -i ~/ansible/hosts -l lb ~/ansible/srv.yml
SUDO password:

(...)

PLAY RECAP **********************************************************************************************************

lb                       : ok=10   changed=8    unreachable=0    failed=0</pre>
</div>
</div>
</li>
<li>
<p>Acesse a máquina <code>lb</code> como o usuário <code>root</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
lb
root</pre>
</div>
</div>
</li>
<li>
<p>Vamos instalar o balanceador de carga: usaremos o software HAProxy, uma solução <em>open-source</em> para balanceamento de carga e alta disponibilidade para aplicações baseadas em TCP e HTTP, reconhecido por sua excepcional performance e eficiência.</p>
<div class="literalblock">
<div class="content">
<pre># apt-get install -y haproxy</pre>
</div>
</div>
</li>
<li>
<p>Edite o arquivo de configuração do HAProxy, <code>/etc/haproxy/haproxy.cfg</code>, deixando-o exatamente com o conteúdo a seguir:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-conf" data-lang="conf">global
  log /dev/log    local0
  log /dev/log    local1 notice
  chroot /var/lib/haproxy
  stats socket /run/haproxy/admin.sock mode 660 level admin
  stats timeout 30s
  user haproxy
  group haproxy
  daemon
  maxconn 2048

  # Default SSL material locations
  ca-base /etc/ssl/certs
  crt-base /etc/ssl/private

  # Default ciphers to use on SSL-enabled listening sockets.
  # For more information, see ciphers(1SSL). This list is from:
  #  https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/
  # An alternative list with additional directives can be obtained from
  #  https://mozilla.github.io/server-side-tls/ssl-config-generator/?server=haproxy
  ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSS
  ssl-default-bind-options no-sslv3
  tune.ssl.default-dh-param 2048

defaults
  log     global
  mode    http
  option  httplog
  option  dontlognull
  option  forwardfor
  option  http-server-close
  timeout connect 5000
  timeout client  50000
  timeout server  50000
  errorfile 400 /etc/haproxy/errors/400.http
  errorfile 403 /etc/haproxy/errors/403.http
  errorfile 408 /etc/haproxy/errors/408.http
  errorfile 500 /etc/haproxy/errors/500.http
  errorfile 502 /etc/haproxy/errors/502.http
  errorfile 503 /etc/haproxy/errors/503.http
  errorfile 504 /etc/haproxy/errors/504.http

  stats enable
  stats uri /stats
  stats realm Haproxy\ Statistics
  stats auth admin:rnpesr123

frontend www-http
  bind 10.0.42.8:80
  reqadd X-Forwarded-Proto:\ http
  default_backend www-backend

frontend www-https
  bind 10.0.42.8:443 ssl crt /etc/ssl/private/seg10web.pem
  reqadd X-Forwarded-Proto:\ https
  default_backend www-backend

backend www-backend
  redirect scheme https if !{ ssl_fc }
  server www1 www1.intnet:80 check
  server www2 www2.intnet:80 check</code></pre>
</div>
</div>
<div class="paragraph">
<p>Em linhas gerais, definimos dois <em>frontends</em> de atendimento, um para conexões HTTP e outro para HTTPS. Ambos enviam suas requisições para o mesmo <em>backend</em>, o qual é atendido pelos servidores <code>www1</code> e <code>www2</code>, escutando na porta 80/TCP.</p>
</div>
</li>
<li>
<p>Note que para o atendimento das requisições HTTPS (o chamado <em>SSL offloading</em>, ou <em>SSL termination</em>), devemos configurar um par de chaves pública/privada auto-assinadas em formato PEM. Vamos fazer isso:</p>
<div class="literalblock">
<div class="content">
<pre># openssl req -x509 -nodes -days 730 -newkey rsa:4096 -keyout /etc/ssl/private/seg10web.key -out /etc/ssl/certs/seg10web.crt
Generating a 4096 bit RSA private key
..............................................++
.............................................................................................................................................................................................................................................................................................++
writing new private key to '/etc/ssl/private/seg10web.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:BR
State or Province Name (full name) [Some-State]:DF
Locality Name (eg, city) []:Brasilia
Organization Name (eg, company) [Internet Widgits Pty Ltd]:RNP
Organizational Unit Name (eg, section) []:ESR
Common Name (e.g. server FQDN or YOUR name) []:seg10web.intnet
Email Address []:seg10web@int.net</pre>
</div>
</div>
<div class="paragraph">
<p>Concatene as duas chaves em um arquivo em formato PEM:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># cat /etc/ssl/certs/seg10web.crt /etc/ssl/private/seg10web.key &gt; /etc/ssl/private/seg10web.pem</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># chmod 600 /etc/ssl/private/seg10web.pem</pre>
</div>
</div>
</li>
<li>
<p>Agora que tudo está configurado, reinicie o HAProxy:</p>
<div class="literalblock">
<div class="content">
<pre># systemctl restart haproxy.service</pre>
</div>
</div>
</li>
<li>
<p>Temos que alterar o firewall uma última vez, desta vez para redirecionar os pacotes chegando na porta 80/TCP para a máquina <code>lb</code>. Acesse a máquina <code>ns1</code> como <code>root</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
ns1
root</pre>
</div>
</div>
<div class="paragraph">
<p>Remova as regras que criamos para a máquina <code>www2</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -t nat -D PREROUTING -i enp0s3 -p tcp -m tcp --dport 80 -j DNAT --to-destination 10.0.42.6</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -D FORWARD -i enp0s3 -d 10.0.42.6/32 -p tcp -m tcp --dport 80 -j ACCEPT</pre>
</div>
</div>
<div class="paragraph">
<p>Adicione-as para o balanceador de carga&#8201;&#8212;&#8201;observe que como o HAProxy escuta tanto na porta 80/TCP como na 443/TCP, iremos redirecioná-las ambas:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -t nat -A PREROUTING -i enp0s3 -p tcp -m multiport --dports 80,443 -j DNAT --to-destination 10.0.42.8</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A FORWARD -i enp0s3 -d 10.0.42.8/32 -p tcp -m multiport --dports 80,443 -j ACCEPT</pre>
</div>
</div>
<div class="paragraph">
<p>Salve a configuração do firewall desta vez, já que ela será definitiva:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># /etc/init.d/netfilter-persistent save
[....] Saving netfilter rules...run-parts: executing /usr/share/netfilter-persistent/plugins.d/15-ip4tables save
run-parts: executing /usr/share/netfilter-persistent/plugins.d/25-ip6tables save
done.</pre>
</div>
</div>
</li>
<li>
<p>Vamos ao teste! No navegador da sua máquina física, acesse novamente o endereço IP da interface <code>enp0s3</code> da máquina <code>ns1</code>. De imediato, notamos uma diferença: o acesso está sendo feito em HTTPS, já que a diretiva <code>redirect scheme https if !{ ssl_fc }</code> do arquivo de configuração do HAProxy força esse protocolo aos clientes que estão se conectando.</p>
<div id="img-haproxy1" class="imageblock text-center">
<div class="content">
<img src="../img/haproxy1.png" alt="haproxy1">
</div>
<div class="title">Figure 5. Acesso desviado para HTTPS pelo HAProxy</div>
</div>
<div class="paragraph">
<p>Aceite o certificado auto-assinado, e prossiga para a página do portal <em>Seg10 Web</em>. Temos um problema! O CSS da página não foi carregado corretamente:</p>
</div>
<div id="img-haproxy2" class="imageblock text-center">
<div class="content">
<img src="../img/haproxy2.png" alt="haproxy2">
</div>
<div class="title">Figure 6. CSS não foi carregado na conexão HTTPS</div>
</div>
<div class="paragraph">
<p>O que fazemos? Felizmente, esse problema é facilmente solucionável. Acesse a máquina <code>client</code> como o usuário <code>ansible</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami
client
ansible</pre>
</div>
</div>
<div class="paragraph">
<p>Basta inserir a linha <code>if ($_SERVER['HTTP_X_FORWARDED_PROTO'] == 'https') $_SERVER['HTTPS']='on';</code> antes da última linha do arquivo <code>/home/ansible/ansible/roles/seg10-web/files/seg10/wp-config.php</code>. O comando <code>sed</code> a seguir faz a alteração de forma direta:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ sed -i "/wp-settings/i if (\$_SERVER['HTTP_X_FORWARDED_PROTO'] == 'https') \$_SERVER['HTTPS']='on';" /home/ansible/ansible/roles/seg10-web/files/seg10/wp-config.php</pre>
</div>
</div>
<div class="paragraph">
<p>Uhm&#8230;&#8203; como distribuir essas mudanças? Simples: basta re-executar nossa <em>role</em> <code>seg10-web</code> no Ansible:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ansible-playbook -i ~/ansible/hosts ~/ansible/seg10web.yml

(...)

TASK [seg10-web : Copy web root] ************************************************************************************

changed: [www1]
changed: [www2]

TASK [seg10-web : Web Root Permissions] *****************************************************************************

changed: [www1]
changed: [www2]

(...)

PLAY RECAP **********************************************************************************************************

www1                       : ok=9    changed=3    unreachable=0    failed=0
www2                       : ok=9    changed=3    unreachable=0    failed=0</pre>
</div>
</div>
<div class="paragraph">
<p>O Ansible detecta que a cópia local está diferente da observada nas máquinas remotas, e sobrescreve o arquivo <code>/var/www/seg10/wp-config.php</code> em ambos os servidores web com as modificações locais.</p>
</div>
<div class="paragraph">
<p>Vamos verificar se isso solucionou o problema no portal. Recarregue a página web no navegador em sua máquina física:</p>
</div>
<div id="img-haproxy3" class="imageblock text-center">
<div class="content">
<img src="../img/haproxy3.png" alt="haproxy3">
</div>
<div class="title">Figure 7. Correção na visualização da página via HTTPS</div>
</div>
<div class="paragraph">
<p>Excelente, tudo funcionando a contento.</p>
</div>
</li>
<li>
<p>O HAProxy possui uma página de estatísticas bastante interessante para acompanhar o funcionamento dos diferentes <em>frontends</em> e <em>backends</em> configurados. Adicione o sufixo <code>/stats</code> à URL do seu navegador, e faça login com o usuário <code>admin</code> e senha <code>rnpesr123</code> quando solicitado. Você verá a página a seguir:</p>
<div id="img-haproxy4" class="imageblock text-center">
<div class="content">
<img src="../img/haproxy4.png" alt="haproxy4">
</div>
<div class="title">Figure 8. Página de estatísticas do HAProxy</div>
</div>
<div class="paragraph">
<p>A partir desta página, é possível verificar quais <em>frontends</em> e <em>backends</em> estão ativos, quais estão inativos ou com problemas de acesso, e quantos bytes e sessões foram trafegados para cada um dos <em>hosts</em> envolvidos.</p>
</div>
<div class="paragraph">
<p>Tente recarregar a portal <em>Seg10 Web</em> algumas vezes, e confira o número de sessões registradas para cada um dos <em>backends</em>: o HAProxy envia requisições alternadas para cada um deles, segundo um algoritmo <em>round robin</em>. Com o HAProxy, é fácil desativar seletivamente alguns <em>backends</em> para atualizações ou manutenção, e levantá-los posteriormente, mantendo a disponibilidade do serviço e minimizando o impacto para os clientes.</p>
</div>
</li>
<li>
<p>Encerradas as nossas atividades com os servidores, recomenda-se que o aluno mantenha as máquinas <code>www1</code>, <code>www2</code>, <code>db</code> e <code>lb</code> desligadas a partir desta sessão. Apesar de as máquinas individualmente não ocuparem tantos recursos de memória e processamento, o fato de não precisarmos mais usá-las e a exigência de alteração de contexto da CPU para atendê-las faz com que a liberação de recursos, nesse caso, seja recomendável.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2018-11-20 11:55:47 -0200
</div>
</div>
</body>
</html>