<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<title>Sessão 4: Controles de segurança</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="_sessão_4_controles_de_segurança">Sessão 4: Controles de segurança</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Estando configurado nosso sistema de autenticação centralizado, quais seriam os próximos passos para realizar o <em>hardening</em> do ambiente? Nesta sessão, iremos tratar de algumas configurações mais simples, num escopo particular, mas que somadas tornarão o <em>datacenter</em> muito mais resiliente contra ataques, além de mais funcional. Iremos verificar se as senhas escolhidas pelos usuários são de fato seguras, implementar <em>quotas</em> de disco em um servidor de arquivos Linux, permitir controle mais granular de permissões de arquivos através de ACLs (<em>Access Control Lists</em>) e realizar um controle refinado de autorizações administrativas usando o comando <code>sudo</code>.</p>
</div>
<div class="paragraph">
<p>Vamos ao trabalho?</p>
</div>
<div class="sect2">
<h3 id="_1_topologia_desta_sessão">1) Topologia desta sessão</h3>
<div class="paragraph">
<p>A figura abaixo mostra a topologia de rede que será utilizada nesta sessão, com as máquinas relevantes em destaque.</p>
</div>
<div id="img-topologia4" class="imageblock text-center">
<div class="content">
<img src="../img/Topologia_SEG10_S4.png" alt="Topologia SEG10 S4">
</div>
<div class="title">Figure 1. Topologia de rede desta sessão</div>
</div>
<div class="paragraph">
<p>Teremos agora quatro máquinas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ns1</code>, com <em>alias</em> <code>fw</code>, atuando como firewall de rede e DNS primário. Endereços IP via DHCP (interface <em>bridge</em>), 10.0.42.1/24 (interface DMZ) e 192.168.42.1/24 (interface Intranet).</p>
</li>
<li>
<p><code>ns2</code>, com <em>alias</em> <code>ldap</code>, localizada na DMZ e atuando como DNS secundário, servidor LDAP de autenticação centralizada e repositório de chaves SSH-CA. Endereço IP 10.0.42.2/24.</p>
</li>
<li>
<p><code>nfs</code>, com <em>alias</em> <code>files</code>, localizada na DMZ e atuando como servidor de arquivos NFS. Endereço IP 10.0.42.3/24.</p>
</li>
<li>
<p><code>client</code>, localizada na Intranet e usada como ponto de partida para logins remotos nos diferentes servidores do <em>datacenter</em> simulado. Endereço IP 192.168.42.2/24.</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Na topologia há a previsão de criação de dois novos registros DNS, um mapeamento direto para o nome <code>nfs</code> e um <em>alias</em> dessa mesma máquina para o nome <code>files</code>. Vamos ajustar o DNS: acesse a máquina <code>ns1</code> como o usuário <code>root</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
ns1
root</pre>
</div>
</div>
<div class="paragraph">
<p>Edite o arquivo de zonas <code>/etc/nsd/zones/intnet.zone</code>, inserindo uma entrada A e outra CNAME para a máquina <code>nfs</code>, como se segue. <strong>Não se esqueça</strong> de incrementar o valor do serial no topo do arquivo!</p>
</div>
<div class="literalblock">
<div class="content">
<pre># nano /etc/nsd/zones/intnet.zone
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># grep nfs /etc/nsd/zones/intnet.zone
nfs     IN    A                 10.0.42.3
files   IN    CNAME             nfs</pre>
</div>
</div>
<div class="paragraph">
<p>Desta vez também será necessário alterar o arquivo de mapeamento reverso <code>/etc/nsd/zones/10.0.42.zone</code> com um registro PTR para a nova máquina. Novamente, lembre-se de incrementar o <strong>serial</strong> neste arquivo também.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># nano /etc/nsd/zones/10.0.42.zone
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># grep nfs /etc/nsd/zones/10.0.42.zone
3       IN   PTR                nfs.intnet.</pre>
</div>
</div>
<div class="paragraph">
<p>Assine o arquivo de zonas usando o <em>script</em> criado anteriormente:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># bash /root/scripts/signzone-intnet.sh
reconfig start, read /etc/nsd/nsd.conf
ok
ok
ok
ok removed 0 rrsets, 0 messages and 0 key entries</pre>
</div>
</div>
<div class="paragraph">
<p>Verifique que as entradas foram criadas com sucesso, usando o comando <code>dig</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># dig nfs.intnet +short
10.0.42.3</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># dig files.intnet +short
nfs.intnet.
10.0.42.3</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># dig -x 10.0.42.3 +short
nfs.intnet.</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_2_requisitos_de_senha_na_base_ldap">2) Requisitos de senha na base LDAP</h3>
<div class="paragraph">
<p>Uma preocupação frequente dos analistas de segurança é quanto às senhas dos usuários: será que elas tem um tamanho apropriado, não utilizam palavras constantes em <em>wordlists</em>, contém caracteres especiais? Apesar de termos configurado o acesso aos nossos servidores usando chaves assimétricas via SSH-CA (e, no caso da máquina <code>ns1</code>, aplicado restrição de acesso exclusivamente via chaves), não é interessante que nos despreocupemos totalmente da segurança de senhas dos usuários&#8201;&#8212;&#8201;afinal, os logins na máquina <code>ns2</code> ainda podem usar senhas, por exemplo.</p>
</div>
<div class="paragraph">
<p>Podemos utilizar o <em>policy overlay</em> do <code>slapd</code> (documentação em <a href="https://www.openldap.org/doc/admin24/overlays.html" class="bare">https://www.openldap.org/doc/admin24/overlays.html</a> ou <code>man 5 slapo-ppolicy</code>) para implementar alguns controles no diretório LDAP para exigir aspectos mínimos de qualidade das senhas dos usuários, tais como:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>pwdInHistory</code>: Histórico de senhas, mantém uma lista de senhas passadas que impede que o usuário as repita. O número de senhas mantidas em histórico é configurável.</p>
</li>
<li>
<p><code>pwdMaxAge</code>: Tempo máximo de validade da senha.</p>
</li>
<li>
<p><code>pwdMinAge</code>: Tempo mínimo de validade da senha, para evitar que o usuário circule pelo histórico rapidamente e apague o registro de uma senha que queira repetir.</p>
</li>
<li>
<p><code>pwdMinLength</code>: Tamanho mínimo da senha do usuário, em caracteres.</p>
</li>
<li>
<p><code>pwdMaxFailure</code>: Número máximo de tentativas de <em>bind</em> com senha incorreta antes que a conta do usuário seja travada.</p>
</li>
<li>
<p><code>pwdCheckQuality</code>: Define uma função externa para checagem de qualidade da senha do usuário&#8201;&#8212;&#8201;esta é uma extensão não-padrão da política de senhas do diretório LDAP, e não iremos configurá-la. O website <a href="http://ltb-project.org/wiki/documentation/openldap-ppolicy-check-password" class="bare">http://ltb-project.org/wiki/documentation/openldap-ppolicy-check-password</a> disponibiliza um software customizado que pode ser usado para implementar esse tipo de política.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Faça login como <code>root</code> na máquina <code>ns2</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
ns2
root</pre>
</div>
</div>
<div class="paragraph">
<p>Para habilitar esses controles em nossa base LDAP, o primeiro passo é carregar o arquivo LDIF do <em>schema</em> com as informações de políticas de senhas:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapadd -Y external -H ldapi:/// -f /etc/ldap/schema/ppolicy.ldif
SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
adding new entry "cn=ppolicy,cn=schema,cn=config"</pre>
</div>
</div>
</li>
<li>
<p>Em seguida, iremos adicionar o módulo <code>/usr/lib/ldap/ppolicy.la</code> à lista de módulos carregados pelo <code>slapd</code> em seu início. Crie o arquivo novo <code>/root/ldif/olcModuleLoad.ldif</code> com o seguinte conteúdo:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">dn: cn=module{0},cn=config
changetype: modify
add: olcModuleLoad
olcModuleLoad: ppolicy.la</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para aplicar as modificações desse LDIF à base LDAP, basta executar:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapmodify -Y EXTERNAL -H ldapi:/// -f ~/ldif/olcModuleLoad.ldif
SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
modifying entry "cn=module{0},cn=config"</pre>
</div>
</div>
</li>
<li>
<p>A próxima etapa é configurar o <em>overlay</em> de políticas de senhas para controlar os atributos <code>userPassword</code> de nossa base <code>cn=intnet</code>. Crie o arquivo novo <code>/root/ldif/olcOverlayPpolicy.ldif</code> com o seguinte conteúdo:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">dn: olcOverlay=ppolicy,olcDatabase={1}mdb,cn=config
objectClass: olcOverlayConfig
objectClass: olcPPolicyConfig
olcOverlay: ppolicy
olcPPolicyDefault: cn=passwordDefault,ou=Policies,dc=intnet
olcPPolicyHashCleartext: FALSE
olcPPolicyUseLockout: FALSE
olcPPolicyForwardUpdates: FALSE</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note que estamos indicando que o <em>overlay</em> <code>ppolicy</code> será aplicado sobre a base <code>{1}mdb</code>, que é exatamente a base com raiz em <code>dc=intnet</code>, como podemos confirmar através do comando:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapsearch -Y external -H ldapi:/// -LLL -b 'cn=config' '(&amp;(objectClass=olcDatabaseConfig)(olcSuffix=dc=intnet))' dn 2&gt; /dev/null
dn: olcDatabase={1}mdb,cn=config</pre>
</div>
</div>
<div class="paragraph">
<p>Caso estivéssemos fazendo esta configuração em um ambiente que possua várias bases LDAP carregadas dentro de um mesmo <em>daemon</em> <code>slapd</code>, seria necessário determinar o número da base MDB e editar o arquivo mostrado anteriormente.</p>
</div>
<div class="paragraph">
<p>Para aplicar as modificações desse LDIF à base LDAP, execute:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapadd -Y EXTERNAL -H ldapi:/// -f ~/ldif/olcOverlayPpolicy.ldif
SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
adding new entry "olcOverlay=ppolicy,olcDatabase={1}mdb,cn=config"</pre>
</div>
</div>
</li>
<li>
<p>Agora, vamos definir a política de senhas da base <code>dc=intnet</code>. Crie o arquivo novo <code>/root/ldif/passwordDefault.ldif</code> com o seguinte conteúdo:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">dn: ou=Policies,dc=intnet
ou: Policies
objectClass: organizationalUnit

dn: cn=passwordDefault,ou=Policies,dc=intnet
objectClass: pwdPolicy
objectClass: person
objectClass: top
cn: passwordDefault
sn: passwordDefault
pwdAttribute: userPassword
pwdCheckQuality: 2
pwdMinAge: 0
pwdMaxAge: 2592000
pwdMinLength: 8
pwdInHistory: 5
pwdMaxFailure: 3
pwdFailureCountInterval: 0
pwdLockout: TRUE
pwdLockoutDuration: 0
pwdAllowUserChange: TRUE
pwdExpireWarning: 0
pwdGraceAuthNLimit: 0
pwdMustChange: FALSE
pwdSafeModify: FALSE</code></pre>
</div>
</div>
<div class="paragraph">
<p>Estamos, em ordem:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Criando uma entrada <code>ou=Policies,dc=intnet</code> para armazenar políticas da base <code>dc=intnet</code>.</p>
</li>
<li>
<p>Dentro desta OU, criando o CN <code>cn=passwordDefault,ou=Policies,dc=intnet</code> que define a política de senhas da base. Configurações mais relevantes:</p>
<div class="ulist">
<ul>
<li>
<p><code>pwdAttribute</code> define o atributo que será verificado, que armazena senhas de usuários.</p>
</li>
<li>
<p><code>pwdCheckQuality</code> ativa a checagem de qualidade de senhas; como não estamos habilitando nenhum módulo externo, apenas a checagem de comprimento será aplicada.</p>
</li>
<li>
<p><code>pwdMinAge</code> define o tempo mínimo de validade de senhas; como queremos testar o histórico de senhas, explicado a seguir, não iremos ativar essa opção.</p>
</li>
<li>
<p><code>pwdMaxAge</code> define o tempo máximo de validade da senha, em segundos; ajustamos esse valor para 30 dias.</p>
</li>
<li>
<p><code>pwdMinLength</code> define o tamanho mínimo de senha, 8 caracteres.</p>
</li>
<li>
<p><code>pwdInHistory</code> define que iremos guardar o <em>hash</em> das 5 senhas mais recentes de cada usuário, que não poderão repeti-las.</p>
</li>
<li>
<p><code>pwdMaxFailure</code> define que usuários que errarem a senha consecutivamente mais de 3 vezes terão suas contas bloqueadas.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Para aplicar o LDIF à base LDAP temos que nos autenticar na raiz <code>dc=intnet</code>, como se segue:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapadd -D 'cn=admin,dc=intnet' -W -f ~/ldif/passwordDefault.ldif
Enter LDAP Password:
adding new entry "ou=Policies,dc=intnet"

adding new entry "cn=passwordDefault,ou=Policies,dc=intnet"</pre>
</div>
</div>
</li>
<li>
<p>Reinicie o <code>slapd</code> para aplicar as configurações:</p>
<div class="literalblock">
<div class="content">
<pre># systemctl restart slapd.service</pre>
</div>
</div>
</li>
<li>
<p>Vamos testar nossos controles&#8201;&#8212;&#8201;logue na máquina <code>client</code> como o usuário <code>luke</code>:</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami
client
luke</pre>
</div>
</div>
<div class="paragraph">
<p>Tente alterar a senha do usuário para uma <em>string</em> menor que o tamanho exigido, como <code>marte</code> por exemplo:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ passwd
(current) LDAP Password:
Nova senha:
Redigite a nova senha:
password change failed: Password fails quality checking policy
passwd : Erro de manipulação de token de autenticação
passwd: senha inalterada</pre>
</div>
</div>
<div class="paragraph">
<p>O <code>slapd</code> nos informa que a senha não atende os requisitos mínimos de qualidade, nesse caso, o tamanho da senha.</p>
</div>
</li>
<li>
<p>Altere a senha para um valor aceitável, como <code>seg10luke2</code>, por exemplo:</p>
<div class="literalblock">
<div class="content">
<pre>$ passwd
(current) LDAP Password:
Nova senha:
Redigite a nova senha:
passwd: senha atualizada com sucesso</pre>
</div>
</div>
<div class="paragraph">
<p>Agora, tente alterar a senha para um valor já usado anteriormente, como <code>seg10luke</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ passwd
(current) LDAP Password:
Nova senha:
Redigite a nova senha:
password change failed: Password is in history of old passwords
passwd : Erro de manipulação de token de autenticação
passwd: senha inalterada</pre>
</div>
</div>
<div class="paragraph">
<p>Somos informados que a senha consta do histórico de senhas antigas. Como o LDAP implementa isso? Acesse a máquina <code>ns2</code> como usuário <code>root</code> e pesquise pelo campo <code>pwdHistory</code> do usuário <code>luke</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
ns2
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapsearch -LLL -D 'cn=admin,dc=intnet' -W 'uid=luke' pwdHistory
Enter LDAP Password:
dn: uid=luke,ou=People,dc=intnet
pwdHistory: 20181114030204Z#1.3.6.1.4.1.1466.115.121.1.40#38#{SSHA}bI0fgkHR6MZ
 tAavv1bUYx9PuPucZhDyY</pre>
</div>
</div>
<div class="paragraph">
<p>Ao informarmos uma nova senha, o <code>slapd</code> compara o seu hash com um dos <em>hashes</em> guardados no histórico do usuário (nesse caso, <code>luke</code>); se encontrada, a senha é rejeitada.</p>
</div>
</li>
<li>
<p>Vamos testar o <em>lockout</em> de contas. Como teremos que fazer logins propositalmente incorretos, ainda como o usuário <code>root</code> na máquina <code>ns2</code>, pare o serviço Fail2ban para evitar que sejamos bloqueados pelo firewall durante o teste:</p>
<div class="literalblock">
<div class="content">
<pre># systemctl stop fail2ban</pre>
</div>
</div>
<div class="paragraph">
<p>De volta à máquina <code>client</code> como <code>luke</code>, tente logar via SSH na máquina <code>ns2</code> usando senha e erre propositalmente a combinação por 3 vezes consecutivas:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami
client
luke</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ssh -o PreferredAuthentications=keyboard-interactive,password -o PubkeyAuthentication=no luke@ns2
luke@ns2's password:
Permission denied, please try again.
luke@ns2's password:
Permission denied, please try again.
luke@ns2's password:
Permission denied (publickey,password).</pre>
</div>
</div>
<div class="paragraph">
<p>Agora, tente logar com a senha correta&#8201;&#8212;&#8201;note que seu acesso será negado:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ssh -o PreferredAuthentications=keyboard-interactive,password -o PubkeyAuthentication=no luke@ns2
luke@ns2's password:
Permission denied, please try again.</pre>
</div>
</div>
<div class="paragraph">
<p>De volta à máquina <code>ns2</code> como o usuário <code>root</code>, vamos verificar o que aconteceu:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
ns2
root</pre>
</div>
</div>
<div class="paragraph">
<p>Execute o comando <code>ldapsearch</code> abaixo para listar todos os usuários bloqueados na base <code>dc=intnet</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapsearch -LLL -D 'cn=admin,dc=intnet' -W 'pwdAccountLockedTime=*' pwdAccountLockedTime
Enter LDAP Password:
dn: uid=luke,ou=People,dc=intnet
pwdAccountLockedTime: 20181114030659Z</pre>
</div>
</div>
<div class="paragraph">
<p>Como esperado, <code>luke</code> está bloqueado. Para desbloquear um usuário específico crie um arquivo LDIF novo, <code>/root/ldif/unlockUser.ldif</code> com o seguinte conteúdo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">dn: uid=luke,ou=People,dc=intnet
changetype: modify
delete: pwdAccountLockedTime</code></pre>
</div>
</div>
<div class="paragraph">
<p>Aplique as alterações do LDIF à base com:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapmodify -D 'cn=admin,dc=intnet' -W -f ~/ldif/unlockUser.ldif
Enter LDAP Password:
modifying entry "uid=luke,ou=People,dc=intnet"</pre>
</div>
</div>
<div class="paragraph">
<p>De volta à máquina <code>client</code> como <code>luke</code>, tente logar novamente com a senha correta:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami
client
luke</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ssh -o PreferredAuthentications=keyboard-interactive,password -o PubkeyAuthentication=no luke@ns2
luke@ns2's password:
Linux ns2 4.9.0-8-amd64 #1 SMP Debian 4.9.130-2 (2018-10-27) x86_64

Last login: Wed Nov 14 00:15:11 2018 from 192.168.42.2
luke@ns2:~$</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami
ns2
luke</pre>
</div>
</div>
<div class="paragraph">
<p>Perfeito, nossos controles funcionaram como esperado. Na máquina <code>ns2</code>, como <code>root</code>, não se esqueça de reiniciar o Fail2ban:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
ns2
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl start fail2ban</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_3_busca_de_senhas_fracas">3) Busca de senhas fracas</h3>
<div class="paragraph">
<p>Simplesmente configurar um tamanho mínimo de senha, como fizemos na atividade anterior, não é garantia que os usuários escolherão senhas seguras para suas contas. Por exemplo, um usuário pode definir <code>12345678</code> como sua senha&#8201;&#8212;&#8201;essa <em>string</em> está dentro do tamanho mínimo exigido mas não pode, nem de perto, ser considerada uma senha segura. O que fazer?</p>
</div>
<div class="paragraph">
<p>Podemos submeter os <em>hashes</em> de senha dos usuários a testes de segurança, como ataques de força-bruta&#8201;&#8212;&#8201;em que testamos combinações de caracteres exaustivamente para descobrir a senha&#8201;&#8212;&#8201;ou de dicionário&#8201;&#8212;&#8201;em que usamos uma base de senhas previamente preechida, conhecida como <em>wordlist</em>, e verificamos se a senha do usuário se encontra nessa lista. Devido ao fato de as senhas do LDAP serem armazenadas por padrão em formado SSHA (SHA-1 com <em>salt</em>), ataques do tipo <em>rainbow table</em>&#8201;&#8212;&#8201;em que comparamos o <em>hash</em> da senha do usuário com uma base de <em>hashes</em> previamente computados, buscando por similaridades&#8201;&#8212;&#8201;não são viáveis. Podemos verificar o <em>hash</em> utilizado para armazenar a senha do usuário <code>luke</code>, por exemplo, usando o comando:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapsearch -x -LLL -D 'cn=admin,dc=intnet' -W 'uid=luke' userPassword | grep '^userPassword::' | awk '{print $NF}' | base64 --decode
Enter LDAP Password:
{SSHA}JK1/uM/9bmoWM/IzW1uIBM4b1Q4UEWd8</pre>
</div>
</div>
<div class="paragraph">
<p>A ferramenta que iremos utilizar para realizar os ataques de dicionário e força-bruta mencionados anteriormente será o <code>hashcat</code> (<a href="https://hashcat.net/hashcat/" class="bare">https://hashcat.net/hashcat/</a>). Uma das ferramentas mais rápidas para quebra de senhas disponíveis, é um programa <em>open source</em> multiplataforma que se utiliza da CPU ou GPUs (placas gráficas) de uma máquina para acelerar o processo de ataque sensivelmente, especialmente quando comparada com ferramentas mais tradicionais como o <code>john</code>.</p>
</div>
<div class="paragraph">
<p>Até a versão v3.00, o <code>hashcat</code> era dividido em duas versões, uma voltada para CPUs e outra para GPUs (esta, implementada via OpenCL ou CUDA). Com o lançamento da versão v3.00, as duas versões foram unificadas em uma única ferramenta, requerendo a biblioteca OpenCL (<a href="https://www.khronos.org/opencl/" class="bare">https://www.khronos.org/opencl/</a>) como dependência.</p>
</div>
<div class="paragraph">
<p>É boa prática de segurança que instalemos apenas o estritamente necessário em servidores, a fim de reduzir a superfície de ataque disponível em uma eventual invasão. Por esse motivo, instalaremos o <code>hashcat</code> e as demais bibliotecas necessárias na máquina <code>client</code>, que é menos crítica que os servidores <code>ns2</code> e <code>ns1</code>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Acesse a máquina <code>client</code> como o usuário <code>root</code>, e instale o <code>hashcat</code> e suas dependências:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
client
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># apt-get install --no-install-recommends hashcat libhwloc-dev ocl-icd-dev ocl-icd-opencl-dev pocl-opencl-icd</pre>
</div>
</div>
</li>
<li>
<p>Agora, acesse como o usuário <code>luke</code>, em seu diretório <em>home</em>.</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami ; pwd
client
luke
/home/luke</pre>
</div>
</div>
<div class="paragraph">
<p>Altere a senha do usuário <code>luke</code> para um valor propositalmente inseguro, como <code>password</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ passwd
(current) LDAP Password:
Nova senha:
Redigite a nova senha:
passwd: senha atualizada com sucesso</pre>
</div>
</div>
<div class="paragraph">
<p>O primeiro passo para testarmos a segurança das senhas dos usuários é obter seus <em>hashes</em>. Vamos fazer isso, de forma remota, usando um <em>script</em> shell mostrado a seguir. Crie o arquivo novo <code>/home/luke/scripts/gethashes.sh</code> com o seguinte conteúdo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">#!/bin/bash

TMPFILE="$( mktemp )"
OUTFILE="${HOME}/hashes.txt"

rm -f ${OUTFILE}
touch ${OUTFILE}

ldapsearch -x                     \
  -LLL                            \
  -H ldap://10.0.42.2             \
  -D 'cn=admin,dc=intnet'         \
  -w 'rnpesr'                     \
  -b 'dc=intnet'                  \
  'userPassword=*'                \
  cn userPassword                 \
  | grep '^cn:\|^userPassword::'  \
  | awk '{print $NF}'             \
  | sed 'N;s/\n/ /'               \
  | tr ' ' ':' &gt; ${TMPFILE}

while read l; do
  luser="$( echo ${l} | cut -d':' -f1 )"
  lhash="$( echo ${l} | cut -d':' -f2 )"

  echo "${luser}:$( echo ${lhash} | base64 --decode )" &gt;&gt; ${OUTFILE}
done &lt; ${TMPFILE}

rm -f ${TMPFILE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>O que esse <em>script</em> faz? Vamos ver:</p>
</div>
<div class="openblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>(Linhas 3-4) Criamos um arquivo temporário com o comando <code>mktemp</code>, e definimos o arquivo de saída como <code>~/hashes.txt</code>.</p>
</li>
<li>
<p>(Linhas 6-7) Se existente, removemos o arquivo de saída e criamos um novo, vazio.</p>
</li>
<li>
<p>(Linhas 9-20) Executamos um comando <code>ldapsearch</code> remoto na máquina <code>ns2</code>, executando o <em>bind</em> como o usuário <code>cn=admin,dc=intnet</code> e senha informada diretamente na linha de comando. Buscamos todos os DNs que possuem o campo <code>userPassword</code> não-vazio, e filtramos apenas os campos <code>cn</code> e <code>userPassword</code> na saída. Finalmente, fazemos uma junção de linhas duas-a-duas usando os comandos <code>awk</code>, <code>sed</code> e inserimos um separador usando o <code>tr</code>. Essa saída é escrita no arquivo temporário criado anteriormente.</p>
</li>
<li>
<p>(Linhas 22-27) Processamos o arquivo temporário linha-a-linha. Em cada linha, extraímos o campo 1 (<code>cn</code> do usuário) e o campo 2 (<code>userPassword</code>). O campo <code>userPassword</code> está codificado em base64, então usamos <code>base64 --decode</code> para traduzir esse campo, e escrevemos o <em>output</em> em ordem no arquivo de saída.</p>
</li>
<li>
<p>(Linha 29) O arquivo temporário é removido.</p>
</li>
</ol>
</div>
</div>
</div>
</li>
<li>
<p>Vamos testar o funcionamento do <em>script</em>:</p>
<div class="literalblock">
<div class="content">
<pre>$ bash ~/scripts/gethashes.sh</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cat hashes.txt
admin:{SSHA}NzQZTz7ufOxNM3PYy7cp+zV6p7bKFNcy
luke:{SSHA}46Qe8Ny+QQgDsbPcps2MODqUHGtdLX41
sshca:{SSHA}+JTtQ5+XEi+sJ4sPmWK3lZXrIHSpbcbn
han:{SSHA}BE6cC89vaJQtB/g9yEJTt0O8HCtRabel</pre>
</div>
</div>
</li>
<li>
<p>Vamos, primeiramente, executar um ataque de dicionário. Um ataque de dicionário, como mencionado anteriormente, é quando obtermos um arquivo com um conjunto de senhas em texto claro, calculamos seus <em>hashes</em> usando os valores de <em>salt</em> conhecidos, e comparamos os resultados com os <em>hashes</em> dos usuários.</p>
<div class="paragraph">
<p>No caso do algorito SSHA implementado no OpenLDAP, para extrair o <em>salt</em> devemos decodificar o <em>hash</em> original em base64 uma vez, remover o prefixo <code>{SSHA}</code>, decodificar o <em>hash</em> resultante em base64 novamente, e extrair os últimos 4 bytes; esses 4 bytes são o <em>salt</em> da senha codificada. Para ilustrar esse conceito, o <em>script</em> Perl a seguir pode ser usado para fazer a extração&#8201;&#8212;&#8201;crie o arquivo novo <code>/home/luke/scripts/getsalt.pl</code> com o seguinte conteúdo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-perl" data-lang="perl">#!/usr/bin/perl -w

my $hash=$ARGV[0];
# The hash is encoded as base64 twice:
use MIME::Base64;
$hash = decode_base64($hash);
$hash=~s/{SSHA}//;
$hash = decode_base64($hash);

# The salt length is four (the last four bytes).
$salt = substr($hash, -4);

# Split the salt into an array.
my @bytes = split(//,$salt);

# Convert each byte from binary to a human readable hexadecimal number.
foreach my $byte (@bytes) {
$byte = uc(unpack "H*", $byte);
print "$byte";
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vamos recuperar o <em>hash</em> de senha do usuário <code>luke</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ldapsearch -x -LLL -H ldap://ldap.intnet/ -D 'cn=admin,dc=intnet' -b 'dc=intnet' -w 'rnpesr' 'uid=luke' userPassword | grep '^userPassword::' | awk '{print $NF}'
e1NTSEF9anFkZC80MW1BT3dFYVpkMFpvWUZzYk1xQTJyVlVMVlU=</pre>
</div>
</div>
<div class="paragraph">
<p>Executando o <em>script</em> <code>getsalt.pl</code>, podemos extrair o <em>salt</em> da senha. Note que o valor de saída está em hexadecimal.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ perl ~/scripts/getsalt.pl e1NTSEF9anFkZC80MW1BT3dFYVpkMFpvWUZzYk1xQTJyVlVMVlU= ; echo
D550B554</pre>
</div>
</div>
</li>
<li>
<p>De volta ao ataque de dicionário, vamos executá-lo usando o <code>hashcat</code>. Primeiro, temos que descobrir a qual código o <em>hash</em> SSHA do LDAP corresponde:</p>
<div class="literalblock">
<div class="content">
<pre>$ hashcat --help | grep SSHA
    111 | nsldaps, SSHA-1(Base64), Netscape LDAP SSHA      | HTTP, SMTP, LDAP Server
   1711 | SSHA-512(Base64), LDAP {SSHA512}                 | HTTP, SMTP, LDAP Server
  10300 | SAP CODVN H (PWDSALTEDHASH) iSSHA-1              | Enterprise Application Software (EAS)</pre>
</div>
</div>
<div class="paragraph">
<p>O código é, então, <code>111</code>. Quanto ao tipo de ataque:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hashcat --help | grep 'Attack Modes' -A8
- [ Attack Modes ] -

  # | Mode
 ===+======
  0 | Straight
  1 | Combination
  3 | Brute-force
  6 | Hybrid Wordlist + Mask
  7 | Hybrid Mask + Wordlist</pre>
</div>
</div>
<div class="paragraph">
<p>O ataque de dicionário, também conhecido como <em>straight mode</em> (<a href="https://hashcat.net/wiki/doku.php?id=dictionary_attack" class="bare">https://hashcat.net/wiki/doku.php?id=dictionary_attack</a>), possui código <code>0</code>.</p>
</div>
<div class="paragraph">
<p>Falta apenas obter uma <em>wordlist</em> apropriada para executar o ataque. Procurando por termos como <em>"wordlist"</em>, <em>"password"</em> ou <em>"common"</em> no Google, é possível encontrar uma infinidade de páginas web dedicadas ao assunto, como por exemplo <a href="https://github.com/danielmiessler/SecLists/tree/master/Passwords" class="bare">https://github.com/danielmiessler/SecLists/tree/master/Passwords</a> . Iremos usar uma <em>wordlist</em> que alegadamente contém as 10 milhões de senhas mais comuns, que pode ser baixada na URL anteriormente mencionada ou solicitada ao instrutor. Note que, para um arquivo que contém apenas texto puro, seu tamanho é impressionante:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ wget -q https://github.com/danielmiessler/SecLists/raw/master/Passwords/Common-Credentials/10-million-password-list-top-1000000.txt</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ du -sh 10-million-password-list-top-1000000.txt
8,2M    10-million-password-list-top-1000000.txt</pre>
</div>
</div>
<div class="paragraph">
<p>Tudo pronto! Vamos executar o ataque:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hashcat --force --hash-type 111 --attack-mode 0 --username hashes.txt 10-million-password-list-top-1000000.txt
hashcat (v3.30) starting...

(...)

Session..........: hashcat
Status...........: Exhausted
Hash.Type........: SSHA-1(Base64), nsldaps, Netscape LDAP SSHA
Hash.Target......: hashes.txt
Time.Started.....: Wed Nov 14 01:16:49 2018 (1 sec)
Time.Estimated...: Wed Nov 14 01:16:50 2018 (0 secs)
Input.Base.......: File (10-million-password-list-top-1000000.txt)
Input.Queue......: 1/1 (100.00%)
Speed.Dev.#1.....:  2591.6 kH/s (0.36ms)
Recovered........: 1/4 (25.00%) Digests, 1/4 (25.00%) Salts
Progress.........: 3999996/3999996 (100.00%)
Rejected.........: 36/3999996 (0.00%)
Restore.Point....: 999999/999999 (100.00%)
Candidates.#1....: vjq445 -&gt; vjht008
HWMon.Dev.#1.....: N/A

Started: Wed Nov 14 01:16:45 2018
Stopped: Wed Nov 14 01:16:51 2018</pre>
</div>
</div>
<div class="paragraph">
<p>Na máquina usada como exemplo (a velocidade pode variar de acordo com a velocidade da CPU/GPU disponível), o ataque aos quatro <em>hashes</em> disponíveis usando 10 milhões de senhas demorou&#8230;&#8203; 9 segundos. Como visualizado em <code>Speed.Dev.#1</code>, a velocidade de tentativas foi de 2591 kilo-<em>hashes</em> por segundo ou, em outras palavras, 2591000 <em>hashes</em> por segundo. Foi descoberto um <em>digest</em>, que podemos visualizar emitindo o mesmo comando com a <em>flag</em> <code>--show</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hashcat --force --hash-type 111 --attack-mode 0 --username hashes.txt 10-million-password-list-top-1000000.txt --show
luke:{SSHA}jqdd/41mAOwEaZd0ZoYFsbMqA2rVULVU:password</pre>
</div>
</div>
<div class="paragraph">
<p>Excelente! Como era de se esperar, a senha fraca <code>password</code> do usuário <code>luke</code> foi descoberta usando o ataque de dicionário.</p>
</div>
</li>
<li>
<p>Mas, e as demais senhas? O usuário <code>han</code> e <code>sshca</code> possuem senhas relativamente mais complexas, mas sabemos que a senha do usuário <code>admin</code> é simples, <code>rnpesr</code>. Como essa <em>string</em> não consta do arquivo com 10 milhões de senhas usado no ataque anterior, ela não foi descoberta, no entanto.</p>
<div class="paragraph">
<p>Vamos executar um ataque de força-bruta contra essa senha. Para isso, alteraremos o modo de ataque do <code>hashcat</code> para <code>3</code>, e definiremos uma máscara igual a <code>?l?l?l?l?l?l</code>&#8201;&#8212;&#8201;senhas de até seis caracteres, apenas com caracteres de <code>[a-z]</code> minúsculos. Para aprender mais sobre a sintaxe de máscaras suportadas pelo <code>hashcat</code>, consulte sua página de manual ou <a href="https://hashcat.net/wiki/doku.php?id=mask_attack" class="bare">https://hashcat.net/wiki/doku.php?id=mask_attack</a> .</p>
</div>
<div class="paragraph">
<p>Ao trabalho:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hashcat --force --hash-type 111 --attack-mode 3 --username hashes.txt ?l?l?l?l?l?l
hashcat (v3.30) starting...

(...)

[s]tatus [p]ause [r]esume [b]ypass [c]heckpoint [q]uit =&gt; s</pre>
</div>
</div>
<div class="paragraph">
<p>Após a inicialização, a linha acima será mostrada. Podemos apertar os atalhos destacados entre colchetes para instruir o <code>hashcat</code> com ações durante o ataque. Apertando <code>s</code>, visualizamos o estado atual do ataque:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Session..........: hashcat
Status...........: Running
Hash.Type........: SSHA-1(Base64), nsldaps, Netscape LDAP SSHA
Hash.Target......: hashes.txt
Time.Started.....: Wed Nov 14 01:18:02 2018 (7 secs)
Time.Estimated...: Wed Nov 14 01:18:34 2018 (25 secs)
Input.Mask.......: ?l?l?l?l?l?l [6]
Input.Queue......: 1/1 (100.00%)
Speed.Dev.#1.....: 27956.2 kH/s (6.13ms)
Recovered........: 1/4 (25.00%) Digests, 1/4 (25.00%) Salts
Progress.........: 268409856/1235663104 (21.72%)
Rejected.........: 0/268409856 (0.00%)
Restore.Point....: 99072/456976 (21.68%)
Candidates.#1....: saufph -&gt; xqoxjk
HWMon.Dev.#1.....: N/A</pre>
</div>
</div>
<div class="paragraph">
<p>Observando a linha <code>Progress</code>, notamos que o ataque está 22,83% concluído. Aguardamos.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>{SSHA}AZv4/v1spKXTHw5GOK1y+vQhPrnb7CzA:rnpesr</pre>
</div>
</div>
<div class="paragraph">
<p>Após algum tempo, a linha acima é mostrada na tela. O <code>hashcat</code> conseguiu quebrar a senha do usuário <code>admin</code>, descobrindo-a como sendo <code>rnpesr</code>. Aguardamos a conclusão do processo.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Session..........: hashcat
Status...........: Exhausted
Hash.Type........: SSHA-1(Base64), nsldaps, Netscape LDAP SSHA
Hash.Target......: hashes.txt
Time.Started.....: Wed Nov 14 01:18:02 2018 (30 secs)
Time.Estimated...: Wed Nov 14 01:18:32 2018 (0 secs)
Input.Mask.......: ?l?l?l?l?l?l [6]
Input.Queue......: 1/1 (100.00%)
Speed.Dev.#1.....: 27362.0 kH/s (6.14ms)
Recovered........: 2/4 (50.00%) Digests, 2/4 (50.00%) Salts
Progress.........: 1235663104/1235663104 (100.00%)
Rejected.........: 0/1235663104 (0.00%)
Restore.Point....: 456976/456976 (100.00%)
Candidates.#1....: sacxqg -&gt; xqqfqg
HWMon.Dev.#1.....: N/A

Started: Wed Nov 14 01:18:00 2018
Stopped: Wed Nov 14 01:18:33 2018</pre>
</div>
</div>
<div class="paragraph">
<p>Depois de 33 segundos, o ataque encontra-se 100% concluído. Um novo <em>digest</em> foi descoberto, como podemos visualizar com a <em>flag</em> <code>--show</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hashcat --force --hash-type 111 --attack-mode 3 --username hashes.txt ?l?l?l?l?l?l --show
luke:{SSHA}jqdd/41mAOwEaZd0ZoYFsbMqA2rVULVU:password
admin:{SSHA}AZv4/v1spKXTHw5GOK1y+vQhPrnb7CzA:rnpesr</pre>
</div>
</div>
<div class="paragraph">
<p>O <code>hashcat</code> reporta não somente a senha descoberta do usuário <code>admin</code>, bem como a senha do usuário <code>luke</code> descoberta na execução anterior. Isso ocorre porque o <code>hashcat</code> mantém o histórico de ataques realizados no diretório <code>~/.hashcat</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ls -1 ~/.hashcat/
hashcat.dictstat
hashcat.potfile
kernels
sessions</pre>
</div>
</div>
<div class="paragraph">
<p>E assim, concluímos nossa busca por senhas fracas, via ataques de dicionário e força-bruta. O próximo passo, naturalmente, seria alterar o valor de senha dos usuários para um valor novo (bloqueando seu acesso), informá-los da nova senha e comunicar que devem alterar sua senha para uma combinação segura assim que possível.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_4_criação_da_vm_do_servidor_de_arquivos_nfs">4) Criação da VM do servidor de arquivos NFS</h3>
<div class="paragraph">
<p>Iremos implementar, agora, um servidor de arquivos simples para que os colaboradores da Intranet possam compartilhar arquivos e ter uma opção de backup emergencial para suas estações de trabalho. Como o ambiente que estamos simulando é inteiramente baseado em Linux, não há a necessidade de configurar uma solução interoperável com outros sistemas operacionais, como o Samba. Por isso, utilizaremos o NFS (<em>Network File System</em>), que é significativamente mais fácil de ser implementado.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>O primeiro passo, assim como fizemos antes, é clonar a máquina <code>debian-template</code> e criar uma nova, que chamaremos de <code>nfs</code>. Essa máquina estará conectada a uma única rede <em>host-only</em>, com o mesmo nome que foi alocado para a interface de rede da máquina virtual <code>ns1</code>, configurada durante a sessão 2, que está conectada à DMZ. O IP da máquina será 10.0.42.3/24.</p>
<div class="paragraph">
<p>Concluída a clonagem, ligue a máquina e faça login como o usuário <code>root</code>. Em seguida, use o script <code>/root/scripts/changehost.sh</code> para fazer a configuração automática:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
debian-template
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># bash ~/scripts/changehost.sh -h nfs -i 10.0.42.3 -g 10.0.42.1
Signing ssh_host_ecdsa_key.pub key...
Signing ssh_host_ed25519_key.pub key...
Signing ssh_host_rsa_key.pub key...
Configuring host key trust...
Configuring user key trust...
All done!</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ip addr show label 'enp0s*' | grep 'inet ' | awk '{print $2,$NF}' ; hostname ; whoami
10.0.42.3/24 enp0s3
nfs
root</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_5_ajuste_das_regras_de_firewall">5) Ajuste das regras de firewall</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Se você tentar acessar a máquina <code>nfs</code> recém-criada usando o SSH, a partir da máquina <code>client</code>, rapidamente perceberá que não é possível fazer o acesso:</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami
client
luke</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ssh nfs
ssh: connect to host nfs port 22: Connection timed out</pre>
</div>
</div>
<div class="paragraph">
<p>Qual a razão disso? Após breve reflexão, fica claro que o problema reside no firewall. Vamos revisá-lo.</p>
</div>
</li>
<li>
<p>Logue na máquina <code>ns1</code> como o usuário <code>root</code>, como de costume. Tendo em vista que o acesso que desejamos fazer <strong>passa pelo</strong> firewall, devemos checar a <em>chain</em> FORWARD:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
ns1
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -L FORWARD -vn
Chain FORWARD (policy DROP 171 packets, 12318 bytes)
 pkts bytes target     prot opt in     out     source               destination
31432   74M ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED
    3   180 ACCEPT     tcp  --  *      enp0s3  10.0.42.0/24         0.0.0.0/0            multiport dports 80,443
    3   180 ACCEPT     tcp  --  *      enp0s3  192.168.42.0/24      0.0.0.0/0            multiport dports 80,443
    2   148 ACCEPT     udp  --  *      *       192.168.42.0/24      10.0.42.2            udp dpt:53
   68  4080 ACCEPT     tcp  --  *      *       192.168.42.0/24      10.0.42.2            multiport dports 22,389</pre>
</div>
</div>
<div class="paragraph">
<p>Observe que liberamos o acesso SSH a partir da Intranet apenas para a máquina <code>ns2</code>, e nenhuma outra. Considerando que além da máquina <code>nfs</code> criaremos ainda outros servidores em nosso <em>datacenter</em> simulado, essa regra obviamente está inadequada. Vamos removê-la:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -D FORWARD -s 192.168.42.0/24 -d 10.0.42.2/32 -p tcp -m multiport --dports 22,389 -j ACCEPT</pre>
</div>
</div>
<div class="paragraph">
<p>Em seu lugar, vamos criar duas regras: uma que reautoriza o acesso da Intranet ao servidor LDAP (que estava embutido na regra antiga), e outra que autoriza a Intranet a realizar SSH para qualquer máquina da DMZ:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A FORWARD -s 192.168.42.0/24 -d 10.0.42.2/32 -p tcp -m tcp --dport 389 -j ACCEPT</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A FORWARD -s 192.168.42.0/24 -d 10.0.42.0/24 -p tcp -m tcp --dport 22 -j ACCEPT</pre>
</div>
</div>
</li>
<li>
<p>Ainda temos que tratar do acesso da Intranet ao serviço NFS, que configuraremos na atividade a seguir. Para nossa sorte, a configuração do firewall para o NFS versão 4 (que utilizaremos neste curso) é significativamente mais fácil que as versões anteriores, bastando liberar o tráfego dos clientes para a porta 2049/TCP do servidor remoto (em nosso caso, a máquina <code>nfs</code>). A regra a seguir irá atender este requisito:</p>
<div class="literalblock">
<div class="content">
<pre># iptables -A FORWARD -s 192.168.42.0/24 -d 10.0.42.3/32 -p tcp -m tcp --dport 2049 -j ACCEPT</pre>
</div>
</div>
</li>
<li>
<p>Finalmente, salve as regras de firewall atuais:</p>
<div class="literalblock">
<div class="content">
<pre># /etc/init.d/netfilter-persistent save
[....] Saving netfilter rules...run-parts: executing /usr/share/netfilter-persistent/plugins.d/15-ip4tables save
run-parts: executing /usr/share/netfilter-persistent/plugins.d/25-ip6tables save
done.</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_6_configuração_do_servidor_de_arquivos_nfs_e_quotas_de_disco">6) Configuração do servidor de arquivos NFS e quotas de disco</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Queremos usar o servidor NFS para armazenar arquivos de usuários da Intranet, para compartilhamento e backup. Isso imediatamente suscita uma grande preocupação: imagine um cenário em que usuários querem armazenar muitos arquivos no servidor (de forma acidental ou maliciosa)&#8201;&#8212;&#8201;isso pode atrapalhar o uso de outros colaboradores, ou até mesmo chegar a encher a partição raiz (<code>/</code>) do sistema, causando instabilidade. Para evitar esse cenário, vamos criar uma partição dedicada para arquivos de usuário no diretório <code>/home</code> do servidor <code>nfs</code>, e também aplicar <em>quotas</em> de disco aos usuários.</p>
<div class="paragraph">
<p>Desligue a máquina <code>nfs</code> e adicione a ela um novo disco de 10 GB, usando a interface do Virtualbox. A seguir, formate o disco e adicione-o ao sistema LVM, criando um novo <em>volume group</em> <code>vg-home</code> com um único volume lógico <code>lv-home</code>, de forma análoga ao que fizemos na atividades (7) e (8) da sessão (1). Finalmente, formate esse volume em <code>ext4</code> e ative sua montagem automática durante o <em>boot</em> da máquina <code>nfs</code> no diretório <code>/home</code> com as opções <code>defaults,nosuid,nodev</code>.</p>
</div>
<div class="paragraph">
<p>Vamos ao trabalho. Após desligar a VM e adicionar o disco de 10 GB, acessamos a máquina <code>nfs</code> como o usuário <code>root</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
nfs
root</pre>
</div>
</div>
<div class="paragraph">
<p>O próximo passo é descobrir sob qual nome o disco foi detectado. Nesse caso, temos a vantagem de saber que o tamanho do disco novo, 10 GB, é diferente do disco preexistente.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># dmesg | grep 'GiB'
[    1.585018] sd 1:0:0:0: [sdb] 20971520 512-byte logical blocks: (10.7 GB/10.0 GiB)
[    1.585187] sd 0:0:0:0: [sda] 16777216 512-byte logical blocks: (8.59 GB/8.00 GiB)</pre>
</div>
</div>
<div class="paragraph">
<p>Evidentemente, o disco <code>/dev/sdb</code> é o que acabamos de adicionar, portanto. Vamos formatá-lo:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># fdisk /dev/sdb

Bem-vindo ao fdisk (util-linux 2.29.2).
As alterações permanecerão apenas na memória, até que você decida gravá-las.
Tenha cuidado antes de usar o comando de gravação.

A unidade não contém uma tabela de partição conhecida.
Criado um novo rótulo de disco DOS com o identificador de disco 0x3bc30929.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Comando (m para ajuda): o
Criado um novo rótulo de disco DOS com o identificador de disco 0x8a16601c.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Comando (m para ajuda): n
Tipo da partição
   p   primária (0 primárias, 0 estendidas, 4 livre)
   e   estendida (recipiente para partições lógicas)

Selecione (padrão p):

Usando resposta padrão p.
Número da partição (1-4, padrão 1):
Primeiro setor (2048-20971519, padrão 2048):
Último setor, +setores ou +tamanho{K,M,G,T,P} (2048-20971519, padrão 20971519):

Criada uma nova partição 1 do tipo "Linux" e de tamanho 10 GiB.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Comando (m para ajuda): t
Selecionou a partição 1
Tipo de partição (digite L para listar todos os tipos): 8e
O tipo da partição "Linux" foi alterado para "Linux LVM".</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Comando (m para ajuda): w
A tabela de partição foi alterada.
Chamando ioctl() para reler tabela de partição.
Sincronizando discos.</pre>
</div>
</div>
<div class="paragraph">
<p>Agora, vamos criar o volume físico:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># pvcreate /dev/sdb1
  Physical volume "/dev/sdb1" successfully created.</pre>
</div>
</div>
<div class="paragraph">
<p>O grupo de volumes:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># vgcreate vg-home /dev/sdb1
  Volume group "vg-home" successfully created</pre>
</div>
</div>
<div class="paragraph">
<p>E, finalmente, o volume lógico:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># lvcreate -l +100%FREE -n lv-home vg-home
  Logical volume "lv-home" created.</pre>
</div>
</div>
<div class="paragraph">
<p>Vamos, agora, formatar o sistema de arquivos do LV:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># mkfs.ext4 /dev/mapper/vg--home-lv--home
mke2fs 1.43.4 (31-Jan-2017)
Creating filesystem with 2620416 4k blocks and 655360 inodes
Filesystem UUID: be99743c-7ca0-4144-8548-d7aab33a878b
Superblock backups stored on blocks:
        32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632

Allocating group tables: done
Writing inode tables: done
Creating journal (16384 blocks): done
Writing superblocks and filesystem accounting information: done</pre>
</div>
</div>
<div class="paragraph">
<p>A seguir, sincronizar os arquivos do diretório <code>/home</code> atual com o LV recém-criado:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># mount /dev/mapper/vg--home-lv--home /mnt/</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># rsync -av /home/ /mnt/
sending incremental file list
./
aluno/
aluno/.bash_history
aluno/.bash_logout
aluno/.bashrc
aluno/.profile
aluno/.vimrc
luke/
luke/.bash_history
luke/.bash_logout
luke/.bashrc
luke/.profile
luke/scripts/
luke/scripts/sshsign_user.sh

sent 11,669 bytes  received 225 bytes  23,788.00 bytes/sec
total size is 10,787  speedup is 0.91</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># umount /mnt</pre>
</div>
</div>
<div class="paragraph">
<p>E, finalmente, configurar a montagem no <code>/etc/fstab</code> e montar o LV:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># nano /etc/fstab
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># tail -n1 /etc/fstab
/dev/mapper/vg--home-lv--home /home ext4  defaults,nosuid,nodev         0  2</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># mount -a</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># df -h | sed -n '1p; /\/home/p'
Sist. Arq.                     Tam. Usado Disp. Uso% Montado em
/dev/mapper/vg--home-lv--home  9,8G   37M  9,3G   1% /home</pre>
</div>
</div>
</li>
<li>
<p>Agora, vamos instalar os pacotes para habilitar o compartilhamento de arquivos via NFS e <em>quotas</em> de disco. Como <code>root</code>, instale os pacotes <code>nfs-kernel-server</code>, <code>quota</code> e <code>quotatool</code>:</p>
<div class="literalblock">
<div class="content">
<pre># apt-get install nfs-kernel-server quota quotatool</pre>
</div>
</div>
</li>
<li>
<p>Vamos configurar primeiro o sistema de <em>quotas</em>. Edite a entrada do diretório <code>/home</code> no arquivo <code>/etc/fstab</code> e adicione as opções <code>usrquota,grpquota</code>, que ativam suporte a <em>quotas</em> por usuário e por grupo no sistema de arquivos.</p>
<div class="literalblock">
<div class="content">
<pre># nano /etc/fstab
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># tail -n1 /etc/fstab
/dev/mapper/vg--home-lv--home /home ext4  defaults,nosuid,nodev,usrquota,grpquota         0  2</pre>
</div>
</div>
<div class="paragraph">
<p>Em seguida, remonte o sistema de arquivos e verifique se o sistema de <em>quotas</em> foi habilitado na partição.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># mount -o remount /home</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># mount | grep '/home'
/dev/mapper/vg--home-lv--home on /home type ext4 (rw,nosuid,nodev,relatime,quota,usrquota,grpquota,data=ordered)</pre>
</div>
</div>
<div class="paragraph">
<p>Crie os arquivos de configuração de <em>quotas</em> usando o comando <code>quotacheck</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># quotacheck -ugc /home/</pre>
</div>
</div>
<div class="paragraph">
<p>Pronto, o sistema de <em>quotas</em> está configurado. Iremos editar <em>quotas</em> de usuário e testar seu funcionamento mais à frente, após a configuração do NFS.</p>
</div>
</li>
<li>
<p>O próximo passo é configurar o serviço NFS&#8201;&#8212;&#8201;lembre-se que queremos disponibilizar compartilhamentos para arquivos de usuário, no diretório <code>/home</code> do sistema. Insira a linha a seguir no arquivo <code>/etc/exports</code>:</p>
<div class="literalblock">
<div class="content">
<pre># echo '/home 192.168.42.0/24(rw,async,no_subtree_check,root_squash)' &gt;&gt; /etc/exports</pre>
</div>
</div>
<div class="paragraph">
<p>A linha acima irá configurar a exportação o diretório <code>/home</code> para todas as máquinas da Intranet (faixa 192.168.42.0/24), em modo leitura-escrita, assíncrono (i.e. escritas ao disco do servidor remoto não precisam ter sido efetivadas para que o cliente receba confirmação), sem checagem de sub-árvores de montagem (consultar página de manual com <code>man 5 exports</code>) e desabilitando o mapeamento de UID do <code>root</code> da máquina remota no servidor local.</p>
</div>
<div class="paragraph">
<p>Para exportar o diretório, basta executar:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># exportfs -a</pre>
</div>
</div>
<div class="paragraph">
<p>Finalmente, para visualizar quais diretórios estão sendo exportados, execute:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># showmount -e
Export list for nfs:
/home 192.168.42.0/24</pre>
</div>
</div>
</li>
<li>
<p>Vamos testar nosso sistema de compartilhamento de arquivos via NFS e <em>quotas</em> de disco. Acesse a máquina <code>client</code> como o usuário <code>root</code>, crie um diretório <code>/remote</code> para ser o ponto de montagem NFS e monte o diretório compartilhado.</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
client
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># mkdir /remote</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># mount -t nfs 10.0.42.3:/home /remote</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ls -l /remote/
total 40
drwxr-xr-x 2 aluno aluno   4096 nov 13 17:01 aluno
-rw------- 1 root  root    8192 nov 14 01:49 aquota.group
-rw------- 1 root  root    8192 nov 14 01:49 aquota.user
drwx------ 2 root  root   16384 nov 14 01:46 lost+found
drwxr-xr-x 3 luke  sysadm  4096 nov 14 01:41 luke</pre>
</div>
</div>
</li>
<li>
<p>Um dos principais problemas em sistemas de compartilhamento de arquivos em ambientes Unix é o mapeamento de UIDs e GIDs&#8201;&#8212;&#8201;como garantir que os usuários de múltiplas máquinas remotas possuam os mesmos identificadores que os usuários existentes no servidor de arquivos? Felizmente, nosso sistema centralizado de autenticação usando LDAP resolve esse problema de forma transparente: todos os usuários possuem um valor de UID e GID consistente em todo o <em>datacenter</em>, já que as contas são gerenciadas em um ponto único.</p>
<div class="paragraph">
<p>Senão, vejamos: como o usuário <code>luke</code>, tente criar um arquivo novo dentro do ponto de montagem <code>/remote/luke</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami
client
luke</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ echo test &gt; /remote/luke/file</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cat /remote/luke/file
test</pre>
</div>
</div>
<div class="paragraph">
<p>Funcionou perfeitamente! Uma vez que os valores de UID e GID do usuário <code>luke</code> são consistentes entre a máquina <code>client</code> e o servidor de arquivos <code>nfs</code>, não temos problemas de permissão.</p>
</div>
</li>
<li>
<p>E quanto ao usuário <code>root</code>? Será que o <code>root</code> local da máquina <code>client</code> possui acesso irrestrito aos arquivos compartilhados?</p>
<div class="literalblock">
<div class="content">
<pre>$ su -
Senha:
root@client:~#</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
client
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># echo test &gt; /remote/file
-su: /remote/file: Permissão negada</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># rm /remote/aquota.user
rm: não foi possível remover '/remote/aquota.user': Permissão negada</pre>
</div>
</div>
<div class="paragraph">
<p>Devido à utilização da opção <code>root_squash</code> no compartilhamento configurado via arquivo <code>/etc/exports</code> da máquina <code>nfs</code>, o mapeamento de UID do usuário <code>root</code> em máquinas remotas é desativado, efetivamente impedindo-o de alterar quaisquer arquivos.</p>
</div>
</li>
<li>
<p>Vamos testar o sistema de <em>quotas</em>. Na máquina <code>nfs</code>, como o usuário <code>root</code>, edite as <em>quotas</em> do usuário <code>luke</code> usando o comando <code>edquota</code>:</p>
<div class="literalblock">
<div class="content">
<pre># edquota -u luke</pre>
</div>
</div>
<div class="paragraph">
<p>O comando <code>edquota</code> irá invocar um editor (indicado pela variável de ambiente <code>$EDITOR</code>) para que as <em>quotas</em> sejam ajustadas. Vamos editar os campos <em>soft</em> e <em>hard</em> da seção <em>block</em> do arquivo, ajustando limites de 100 MB e 200 MB, respectivamente&#8201;&#8212;&#8201;note que os valores devem ser informados em kilobytes. Pode-se, opcionalmente, também setar um limite para <em>inodes</em> que o usuário pode criar.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Disk quotas for user luke (uid 10000):
  Filesystem                   blocks       soft       hard     inodes     soft     hard
  /dev/mapper/vg--home-lv--home    32     100000     200000          8        0        0</pre>
</div>
</div>
<div class="paragraph">
<p>Para verificar as <em>quotas</em> de um sistema de arquivos, use o comando <code>repquota</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># repquota -u /home
*** Report for user quotas on device /dev/mapper/vg--home-lv--home
Block grace time: 7days; Inode grace time: 7days
                        Block limits                File limits
User            used    soft    hard  grace    used  soft  hard  grace
----------------------------------------------------------------------
root      --      20       0       0              2     0     0
aluno     --      24       0       0              6     0     0
luke      --      32  100000  200000              8     0     0</pre>
</div>
</div>
<div class="paragraph">
<p>Para ativar as <em>quotas</em> em uma partição, utilize o comando <code>quotaon</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># quotaon -ug /home</pre>
</div>
</div>
</li>
<li>
<p>Acesse a máquina <code>client</code> como o usuário <code>luke</code>. Vamos tentar extrapolar o limite estabelecido pela <em>quota</em> no passo anterior.</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami
client
luke</pre>
</div>
</div>
<div class="paragraph">
<p>O kernel do SO é um arquivo interessante a ser usado para esse teste, já que possui um tamanho razoável. Vamos copiá-lo sucessivas vezes para o diretório <code>/remote/luke</code> e verificar o que acontece:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ du -sh /boot/vmlinuz-4.9.0-8-amd64
4,1M    /boot/vmlinuz-4.9.0-8-amd64</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ for i in {1..100}; do cp /boot/vmlinuz-4.9.0-8-amd64 /remote/luke/vmlinuz-$i; done
cp: falha ao fechar '/remote/luke/vmlinuz-49': Disk quota exceeded
cp: falha ao fechar '/remote/luke/vmlinuz-50': Disk quota exceeded
cp: falha ao fechar '/remote/luke/vmlinuz-51': Disk quota exceeded
(...)
cp: falha ao fechar '/remote/luke/vmlinuz-98': Disk quota exceeded
cp: falha ao fechar '/remote/luke/vmlinuz-99': Disk quota exceeded
cp: falha ao fechar '/remote/luke/vmlinuz-100': Disk quota exceeded</pre>
</div>
</div>
<div class="paragraph">
<p>Note que após 48 cópias de arquivo, o sistema reporta a <em>quota</em> de disco como excedida, e o usuário não pode mais escrever na partição. De fato, checando o estado da <em>quota</em> de disco com o comando <code>repquota</code> na máquina <code>nfs</code>, temos que:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
nfs
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># repquota -u /home/
*** Report for user quotas on device /dev/mapper/vg--home-lv--home
Block grace time: 7days; Inode grace time: 7days
                        Block limits                File limits
User            used    soft    hard  grace    used  soft  hard  grace
----------------------------------------------------------------------
root      --      20       0       0              2     0     0
aluno     --      24       0       0              6     0     0
luke      +-  200000  100000  200000  6days     108     0     0</pre>
</div>
</div>
<div class="paragraph">
<p>Temos, portanto, que nosso esquema de <em>quotas</em> está funcionando como esperado. Não se esqueça de apagar os diversos arquivos <code>vmlinuz*</code> que criamos, para liberar espaço no disco novamente:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># rm /home/luke/vmlinuz-*</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Observe que apenas os usuários <code>aluno</code> e <code>luke</code> possuem pastas no diretório <code>/home</code> compartilhado pela máquina <code>nfs</code>. Isso se deve ao fato de que apenas esses usuários haviam feito acesso local à máquina <code>nfs</code> até aquele momento&#8201;&#8212;&#8201;lembre-se que o arquivo de configuração <code>/usr/share/pam-configs/mkhomedir</code> que aplicamos ao PAM cria diretórios <em>home</em> apenas quando o usuário faz acesso à máquina pela primeira vez. Como consequência, o usuário <code>han</code>, para citar um exemplo, não possui uma pasta no servidor de arquivos.</p>
</div>
<div class="paragraph">
<p>Em produção, seria interessante que a pasta compartilhada do usuário fosse criada assim que este fosse adicionado à base LDAP, juntamente com o comando <code>ldapadduser</code>, por exemplo. Um <em>script</em> shell seria ideal para resolver essa situação. Claro, é possível que nem todos os novos usuários criados na base LDAP devam ter uma pasta nesse servidor, o que pode complicar sua configuração.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_7_uso_de_acls_localmente">7) Uso de ACLs localmente</h3>
<div class="paragraph">
<p>Imagine a seguinte situação, agora: o usuário <code>luke</code> quer criar um arquivo novo, sigiloso, e dar permissão para que <code>han</code> possa visualizá-lo. Ora, com as permissões padrão disponíveis em um sistema Linux, quais são nossas opções?</p>
</div>
<div class="paragraph">
<p>Sabemos que, ao criar o arquivo, o usuário-dono será <code>luke</code> e o grupo-dono será <code>sysadm</code>. Se <code>luke</code> altera o grupo-dono do arquivo para <code>fwadm</code> e <code>chmod</code> de <code>640</code>, apesar de a permissão objetivada para <code>han</code> ser garantida, todos os outros membros do grupo <code>fwadm</code> também poderão visualizar o arquivo, que não é o que queremos. Se garante-se a permissão de <code>644</code>, não só <code>han</code> como qualquer outro usuário pode visualizar o arquivo. Finalmente, a alternativa final que seria adicionar <code>han</code> ao grupo <code>sysadm</code> pode não ser desejável ou aceitável do ponto de vista administrativo. O que fazer?</p>
</div>
<div class="paragraph">
<p>O uso de ACLs (<em>Access Control Lists</em>) é especialmente adequado para esse tipo de situação, quando precisamos configurar permissões de arquivos e diretórios de forma granular. Com o uso de ACLs, é possível definir permissões customizadas para usuários e grupos diferentes dos donos do arquivo/diretório original, solucionando problemas de permissionamento para os quais o sistema tradicional de permissões Unix é inadequado.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Acesse a máquina <code>nfs</code> como o usuário <code>root</code>. Para consultar e ajustar ACLs localmente, basta instalar o pacote <code>acl</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
nfs
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># apt-get install acl</pre>
</div>
</div>
</li>
<li>
<p>Vamos testar o funcionamento de ACLs localmente, usando os usuários <code>luke</code> e <code>han</code>. Acesse a máquina <code>nfs</code> como o usuário <code>luke</code>:</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami ; pwd
nfs
luke
/home/luke</pre>
</div>
</div>
<div class="paragraph">
<p>Agora, crie o arquivo novo <code>~/teste</code>, com qualquer conteúdo. Em seguida, consulte suas ACLs atuais.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ echo oi &gt; teste</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ getfacl teste
# file: teste
# owner: luke
# group: sysadm
user::rw-
group::r--
other::r--</pre>
</div>
</div>
</li>
<li>
<p>Imaginemos que o arquivo criado na atividade anterior é especialmente sigiloso, devendo ser visualizado apenas pelo usuário <code>han</code> e seu dono, <code>luke</code>. Primeiro, retire as permissões do grupo e de outros:</p>
<div class="literalblock">
<div class="content">
<pre>$ chmod 600 ~/teste</pre>
</div>
</div>
<div class="paragraph">
<p>Em seguida, use ACLs para dar permissão de leitura a <code>han</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ setfacl -m u:han:r ~/teste</pre>
</div>
</div>
<div class="paragraph">
<p>Verifique as permissões Unix tradicionais&#8201;&#8212;&#8201;observe que ao final da coluna de permissionamento do <code>ls</code> vemos o caractere <code>+</code>, que indica que o arquivo possui permissões estendidas na forma de ACLs.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ls -ld /home/luke/teste
-rw-r-----+ 1 luke sysadm 3 nov  1 18:27 /home/luke/teste</pre>
</div>
</div>
<div class="paragraph">
<p>Consulte novamente as ACLs do arquivo, verificando que a configuração desejada foi aplicada.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ getfacl teste
# file: teste
# owner: luke
# group: sysadm
user::rw-
user:han:r--
group::---
mask::r--
other::---</pre>
</div>
</div>
</li>
<li>
<p>Terá funcionado? Vamos ver. Como o usuário <code>aluno</code>, tente visualizar o conteúdo do arquivo <code>/home/luke/teste</code>:</p>
<div class="literalblock">
<div class="content">
<pre>$ whoami
aluno</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cat /home/luke/teste
cat: /home/luke/teste: Permissão negada</pre>
</div>
</div>
<div class="paragraph">
<p>E como <code>han</code>? Vamos ver:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ whoami
han</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cat /home/luke/teste
oi</pre>
</div>
</div>
</li>
<li>
<p>Como <code>luke</code>, vamos remover a ACL de leitura do usuário <code>han</code> e testar:</p>
<div class="literalblock">
<div class="content">
<pre>$ whoami
luke</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ setfacl -x u:han ~/teste</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ su - han
Senha:</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ whoami
han</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cat /home/luke/teste
cat: /home/luke/teste: Permissão negada</pre>
</div>
</div>
<div class="paragraph">
<p>Perfeito! Lembre-se que também podemos configurar ACLs para grupos através do caractere <code>g</code>, o que não foi testado nesta atividade.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_8_uso_de_acls_via_nfs">8) Uso de ACLs via NFS</h3>
<div class="paragraph">
<p>A atividade anterior, apesar de interessante, é pouco prática quando consideramos nossa configuração atual: se ACLs podem apenas ser manipuladas localmente mas estamos mantendo nossos arquivos compartilhados via rede com NFS, então toda vez que um usuário quiser alterar ACLs ele terá que fazer um acesso local à máquina <code>nfs</code>? Não é razoável fazermos isso. De fato, tente fazer a alteração de ACLs a partir da máquina <code>client</code> como o usuário <code>luke</code>&#8201;&#8212;&#8201;lembre-se: assim como fizemos na máquina <code>nfs</code>, será necessário instalar o pacote <code>acl</code> antes de realizar este teste:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami
client
luke</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ setfacl -m u:han:rw /remote/luke/teste
setfacl: /remote/luke/teste: Operação não suportada</pre>
</div>
</div>
<div class="paragraph">
<p>Com efeito, ACLs POSIX não são suportadas diretamente via <code>setfacl</code> em <em>mounts</em> NFS.</p>
</div>
<div class="paragraph">
<p>Por outro lado, <em>mounts</em> NFS versão 4 possuem suporte a ACLs&#8201;&#8212;&#8201;de fato, a um conjunto de permissões ainda mais granulares e expressivas que as ACLs POSIX padrão. Mas primeiro, temos que responder à pergunta: nosso compartilhamento atual está em qual versão? Vamos ver:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ mount | grep '/home' | grep -o 'vers=[0-9\.]*'
vers=4.2</pre>
</div>
</div>
<div class="paragraph">
<p>Excelente, estamos usando a versão 4.2, o que deve ser suficiente. Os comandos para visualização e edição de ACLs NFSv4 não são os mesmos que utilizamos até agora, no entanto&#8201;&#8212;&#8201;vamos instalá-los.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Acesse a máquina <code>client</code> como o usuário <code>root</code> e instale o pacote <code>nfs4-acl-tools</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
client
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># apt-get install nfs4-acl-tools</pre>
</div>
</div>
</li>
<li>
<p>Agora sim, vamos testar o funcionamento de ACLs com a pasta compartilhada via NFS. Acesse como o usuário <code>luke</code>; para tornar o uso corriqueiro dessa pasta compartilhada mais conveniente, crie um link simbólico com o nome <code>remote</code> em seu diretório <em>home</em>.</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami ; pwd
client
luke
/home/luke</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ln -s /remote/luke/ ~/remote</pre>
</div>
</div>
</li>
<li>
<p>Consulte as ACLs NFSv4 do arquivo criado na atividade anterior:</p>
<div class="literalblock">
<div class="content">
<pre>$ nfs4_getfacl ~/remote/teste
A::OWNER@:rwatTcCy
A::GROUP@:tcy
A::EVERYONE@:tcy</pre>
</div>
</div>
<div class="paragraph">
<p>O formato de representação de permissões NFSv4 é bastante diferente do que estamos acostumados&#8201;&#8212;&#8201;muitas opções e controles adicionais são suportados. Nesta atividade iremos trabalhar apenas com as permissões mais usuais, <code>rwx</code>, mas a página de manual <code>man 5 nfs4_acl</code> possui uma documentação bastante completa sobre as possibilidades de uso desse sistema. Em especial, a seção <em>ACE PERMISSIONS</em> é recomendada para entender o formado do <em>output</em> acima.</p>
</div>
<div class="paragraph">
<p>Como um exemplo, vamos analisar em detalhe a ACE (<em>Access Control Entry</em>) <code>A::OWNER@:rwatTcCy</code>:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>A</code>: tipo da ACE; pode ser <code>A</code> (<em>allow</em>), <code>D</code> (<em>deny</em>), <code>U</code> (<em>audit</em>, usada para configurar log de acessos) e <code>L</code> (<em>alarm</em>, para gerar alarmes de sistema em caso de acesso).</p>
</li>
<li>
<p><code>::</code>: o segundo campo, neste caso vazio, define as <em>flags</em> da ACE; pode ser utilizado para indicar ACEs aplicáveis a grupos, configurações de herança da ACE para diretórios e arquivos-filho, ou <em>flags</em> administrativas para controlar eventos de log e alarme.</p>
</li>
<li>
<p><code>OWNER@</code>: define o <em>principal</em> ao qual se aplica a ACE corrente; pode ser um usuário, grupo ou uma de três ACEs especiais, <code>OWNER@</code>, <code>GROUP@</code> e <code>EVERYONE@</code>, funcionalmente equivalentes às suas contrapartes POSIX.</p>
</li>
<li>
<p><code>rwatTcCy</code>: permissões definidas pela ACE; no caso, temos definidas:</p>
<div class="ulist">
<ul>
<li>
<p><code>r</code>: permissão de leitura para arquivos, ou listagem de diretórios.</p>
</li>
<li>
<p><code>w</code>: permissão de escrita para arquivos, ou criação de novos arquivos em diretórios.</p>
</li>
<li>
<p><code>a</code>: <em>append</em> de dados em arquivos (escrever ao final), ou criar novos subdiretórios em diretórios.</p>
</li>
<li>
<p><code>t</code>: ler atributos do arquivo/diretório.</p>
</li>
<li>
<p><code>T</code>: escrever atributos do arquivo/diretório.</p>
</li>
<li>
<p><code>c</code>: ler ACLs NFSv4 do arquivo/diretório.</p>
</li>
<li>
<p><code>C</code>: escrever ACLs NFSv4 do arquivo/diretório.</p>
</li>
<li>
<p><code>y</code>: autorizar clientes a usar I/O síncrono com o servidor.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p>Vamos configurar uma ACL NFSv4 de leitura do arquivo para o usuário <code>han</code>, assim como fizemos anteriormente.</p>
<div class="literalblock">
<div class="content">
<pre>$ nfs4_setfacl -a A::han@intnet:rtcy ~/remote/teste</pre>
</div>
</div>
<div class="paragraph">
<p>Vamos ver como ficaram as ACEs do arquivo:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ nfs4_getfacl ~/remote/teste
A::OWNER@:rwatTcCy
A::10002:rtcy
A::GROUP@:tcy
A::EVERYONE@:tcy</pre>
</div>
</div>
<div class="paragraph">
<p>Note que o nome de usuário <code>han@intnet</code> foi mapeado para o UID <code>10002</code>&#8201;&#8212;&#8201;que é consistente entre todas as máquinas do <em>datacenter</em> graças à integração com o LDAP que fizemos na sessão 3. Verifique a correspondência do UID:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ getent passwd han
han:*:10002:10002:han:/home/han:/bin/bash</pre>
</div>
</div>
</li>
<li>
<p>Vamos testar? Acesse como o usuário <code>aluno</code> e tente exibir o conteúdo do arquivo <code>/remote/luke/teste</code>:</p>
<div class="literalblock">
<div class="content">
<pre>$ su - aluno
Senha:</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ whoami
aluno</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cat /remote/luke/teste
cat: /remote/luke/teste: Permissão negada</pre>
</div>
</div>
<div class="paragraph">
<p>Agora, teste com o usuário <code>han</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ su - han
Senha:</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ whoami
han</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cat /remote/luke/teste
oi</pre>
</div>
</div>
<div class="paragraph">
<p>Excelente, tudo funcionando a contento.</p>
</div>
</li>
<li>
<p>Como remover uma ACL NFSv4? É simples:</p>
<div class="literalblock">
<div class="content">
<pre>$ nfs4_setfacl -x A::han@intnet:rtcy ~/remote/teste</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ nfs4_getfacl ~/remote/teste
A::OWNER@:rwatTcCy
A::10002:rtcy
A::GROUP@:tcy
A::EVERYONE@:tcy</pre>
</div>
</div>
<div class="paragraph">
<p>Ué, não funcionou. Para deletar ACEs, temos que especificá-las <strong>exatamente</strong> no mesmo formato da linha reportada pelo comando <code>nfs4_getfacl</code>, ou usando o índice numérico da regra. Vamos tentar novamente:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ nfs4_setfacl -x A::10002:rtcy ~/remote/teste</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ nfs4_getfacl ~/remote/teste
A::OWNER@:rwatTcCy
A::GROUP@:tcy
A::EVERYONE@:tcy</pre>
</div>
</div>
<div class="paragraph">
<p>Agora sim, perfeito. Vamos verificar que a remoção da ACE surtiu efeito:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ su - han
Senha:</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ whoami
han</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cat /remote/luke/teste
cat: /remote/luke/teste: Permissão negada</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_9_controle_granular_de_permissões_via_sudo">9) Controle granular de permissões via sudo</h3>
<div class="paragraph">
<p>Para todas as ações privilegiadas que precisamos tomar até aqui, sempre usamos o comando <code>su</code> para nos tornarmos o usuário <code>root</code>, e então efetuamos a instalação de pacotes, adição de usuários ou criação de arquivos de configuração. Mas, como fica essa situação em um ambiente de <em>datacenter</em> como o que estamos simulando? Seria interessante passar a senha do usuário <code>root</code> para os usuários <code>luke</code> e <code>han</code> (e outros que viermos a criar), permitindo que tomem quaisquer ações nas máquinas?</p>
</div>
<div class="paragraph">
<p>O <code>sudo</code> (<em>Super User DO</em>) é um comando que permite que usuários comuns obtenham privilégios de outro usuário, em geral o <code>root</code>, para executar tarefas específicas dentro do sistema de maneira segura e controlável pelo administrador. Assim, podemos delimitar que um determinado usuário ou grupo pode executar apenas um pequeno conjunto de comandos dentro de um servidor específico. Como o <code>sudo</code> é compatível com <em>hostnames</em> e endereços IP, é possível utilizar o mesmo arquivo em todas as máquinas do parque, facilitando tremendamente o esforço de configuração.</p>
</div>
<div class="paragraph">
<p>Para ilustrar esse cenário, vamos solucionar dois exemplos hipotéticos:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>A colaboradora <code>leia</code> acaba de se juntar à equipe de <code>han</code>, o grupo <code>fwadm</code> em nosso sistema LDAP. Imagine que ela ficará responsável por editar regras no firewall de borda, a máquina <code>ns1</code>. Mas, por estar começando agora na empresa, <code>han</code> quer restringir o conjunto de comandos que <code>leia</code> pode executar na máquina, liberando apenas a edição do firewall via <code>iptables</code>. Sua senha será <code>seg10leia</code>. Nas demais máquinas (<code>ns2</code> e <code>nfs</code>) <code>leia</code> não deve ter qualquer acesso especial, apenas como um usuário regular.</p>
</li>
<li>
<p>O colaborador <code>chewie</code> foi contratado para auxiliar na manutenção da base LDAP da empresa. Para desempenhar suas tarefas, iremos colocá-lo em um novo grupo <code>ldapadm</code>. Os membros desse grupo devem ter acesso aos principais comandos de edição do LDAP (criação, modificação e deleção de usuários e grupos) na máquina <code>ns2</code>. Sua senha será <code>seg10chewie</code>. Nas demais máquinas (<code>ns1</code> e <code>nfs</code>) <code>chewie</code> não deve ter qualquer acesso especial, apenas como um usuário regular.</p>
</li>
<li>
<p>Os usuários atuais, <code>luke</code> e <code>han</code>, terão permissão para executar qualquer comando como o usuário <code>root</code>, em qualquer máquina.</p>
</li>
<li>
<p>Observe que temos controles alheios ao <code>sudo</code> já aplicados que irão restringir o acesso de certos usuários&#8201;&#8212;&#8201;por exemplo, apenas membros do grupo <code>fwadm</code> conseguem fazer login na máquina <code>ns1</code> devido à configuração do <code>nslcd</code> que realizamos na atividade (13) da sessão (3).</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Vamos solucionar esses problemas?</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Primeiro, devemos criar os usuários e grupos&#8201;&#8212;&#8201;vamos começar com <code>leia</code>. Como <code>root</code>, na máquina <code>ns2</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
ns2
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapadduser leia fwadm
Successfully added user leia to LDAP
Successfully set password for user leia</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapaddusertogroup leia fwadm
Successfully added user leia to group cn=fwadm,ou=Groups,dc=intnet</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapsetpasswd leia
Changing password for user uid=leia,ou=People,dc=intnet
New Password:
Retype New Password:
Successfully set password for user uid=leia,ou=People,dc=intnet</pre>
</div>
</div>
<div class="paragraph">
<p>Agora, <code>chewie</code>. Lembre-se que no caso dele temos também que adicionar um novo grupo, <code>ldapadm</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapaddgroup ldapadm
Successfully added group ldapadm to LDAP</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapadduser chewie ldapadm
Successfully added user chewie to LDAP
Successfully set password for user chewie</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapaddusertogroup chewie ldapadm
Successfully added user chewie to group cn=ldapadm,ou=Groups,dc=intnet</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapsetpasswd chewie
Changing password for user uid=chewie,ou=People,dc=intnet
New Password:
Retype New Password:
Successfully set password for user uid=chewie,ou=People,dc=intnet</pre>
</div>
</div>
<div class="paragraph">
<p>Fácil, não é mesmo?</p>
</div>
</li>
<li>
<p>Como já instalamos o <code>sudo</code> na máquina <code>debian-template</code> na sessão 1, o comando deve estar diponível no <code>$PATH</code>:</p>
<div class="literalblock">
<div class="content">
<pre># which sudo
/usr/bin/sudo</pre>
</div>
</div>
<div class="paragraph">
<p>Vamos testar? Edite o arquivo <code>/etc/sudoers</code> e autorize o usuário <code>luke</code> a usar o comando <code>/bin/grep</code> como o usuário <code>root</code>. Edite o arquivo com:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># visudo
(...)</pre>
</div>
</div>
<div class="paragraph">
<p>Insira a linha <code>luke ALL=/bin/grep</code> abaixo da entrada do usuário <code>root</code> na seção <em>User privilege specification</em>, como se segue:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># grep -A2 'User privilege specification' /etc/sudoers
# User privilege specification
root    ALL=(ALL:ALL) ALL
luke    ALL=(root)    /bin/grep</pre>
</div>
</div>
<div class="paragraph">
<p>Como o usuário <code>luke</code>, tente usar o comando <code>grep</code> com o <code>sudo</code> para visualizar um arquivo restrito, como o <code>/etc/shadow</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># su - luke</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ whoami
luke</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ sudo grep root /etc/shadow

Presumimos que você recebeu as instruções de sempre do administrador
de sistema local. Basicamente, resume-se a estas três coisas:

    #1) Respeite a privacidade dos outros.
    #2) Pense antes de digitar.
    #3) Com grandes poderes vêm grandes responsabilidades.

[sudo] senha para luke:
root:$6$s7Gt1cd.$UXQf67CVYxR7HP..h2wvhOx4nOtBT7do28R1uChYdMpZc.uLi43OKdtentrWD2zSTKv9EyB7Bdqcpwr6nAlNo.:17848:0:99999:7:::</pre>
</div>
</div>
<div class="paragraph">
<p>Agora, tente executar um comando não-autorizado, como o <code>cat</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ sudo cat /etc/shadow
Sinto muito, usuário luke não tem permissão para executar "/bin/cat /etc/shadow" como root em ns2.intnet.</pre>
</div>
</div>
<div class="paragraph">
<p>Perfeito, nosso teste inicial funcionou com sucesso. Remova a linha referente ao usuário <code>luke</code> no arquivo <code>/etc/sudoers</code>, e vamos prosseguir.</p>
</div>
</li>
<li>
<p>Queremos controlar os comandos utilizados nos servidores do <em>datacenter</em>, que até o momento são as máquinas <code>ns1</code>, <code>ns2</code> e <code>nfs</code>.</p>
<div class="paragraph">
<p>Tecnicamente, seria possível configurar o <code>sudo</code> em cada um dos servidores&#8201;&#8212;&#8201;uma vez que as regras para a usuária <code>leia</code> são específica para a máquina <code>ns1</code> e as do usuário <code>chewie</code> se aplicam à máquina <code>ns2</code>&#8201;&#8212;&#8201;mas não faremos isso. Imagine que, ao invés de três máquinas, nosso <em>datacenter</em> tivesse centenas de VMs: seria factível controlar as regras de <code>sudo</code> localmente em cada um dos servidores? É evidente que não.</p>
</div>
<div class="paragraph">
<p>Temos algumas opções para configurar o <code>sudo</code> de forma coordenada entre múltiplos servidores. A gestão de configuração de servidores, usando ferramentas como o Puppet, Chef ou Ansible (que veremos na sessão seguinte) é um dos métodos mais modernos e eficientes de atingir esse objetivo.</p>
</div>
<div class="paragraph">
<p>Assim sendo, ao invés de desenvolver uma solução inadequada para o problema de configuração do <code>sudo</code> neste momento, iremos fazer uma breve pausa nessa tarefa. Na próxima sessão, aprenderemos as bases do Ansible e, com isso, a solução do problema ficará bem mais fácil. Nos vemos em breve!</p>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2018-11-19 17:06:04 -0200
</div>
</div>
</body>
</html>