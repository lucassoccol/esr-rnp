<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<title>Sessão 3: Autenticação centralizada</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="_sessão_3_autenticação_centralizada">Sessão 3: Autenticação centralizada</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Retomando o cenário apresentado na introdução da primeira sessão, num ambiente em que a virtualização é usada em larga escala, teremos diversas máquinas virtuais operando cada qual com seus serviços alocados. Imagine, hipoteticamente, que temos centenas de VMs dentro do <em>datacenter</em>. Vários desafios podem surgir à mente, mas tente responder a seguinte pergunta: com relação à gestão de contas, o que fazer quando um novo colaborar é integrado à equipe? Ou, por outro lado, quando um funcionário é desligado da empresa?</p>
</div>
<div class="paragraph">
<p>Ora, se temos centenas de VMs, é fácil supor que teremos que logar nas diferentes máquinas que novo colaborador (ou o antigo) deverá acessar e criar uma conta de usuário para ele&#8201;&#8212;&#8201;além disso, adicioná-lo a grupos e editar permissões relevantes. Fazer esse procedimento inúmeras vezes é claramente um processo que pode gerar erros de configuração, então poderia-se pensar em automatizá-lo, digamos, via <em>shell scripts</em>. Uma boa solução, mas não a ideal neste caso.</p>
</div>
<div class="paragraph">
<p>Sistemas de autenticação centralizados, como NIS (<em>Network Information Service</em>) ou LDAP (<em>Lightweight Directory Access Protocol</em>) são excelentes ferramentas para facilitar a gestão em cenários como o apresentado&#8201;&#8212;&#8201;adicionando o usuário em um único ponto, é possível distribuir essa configuração para dezenas, ou centenas, de máquinas de forma instantânea. O gerenciamento de grupos no sistema centralizado também permite atribuir permissionamento de forma fácil, ou removê-lo quando necessário.</p>
</div>
<div class="paragraph">
<p>Nesta sessão, iremos configurar um sistema de autenticação centralizado para o nosso laboratório usando LDAP, no qual gerenciaremos usuários e grupos, e faremos a integração desse sistema de autenticação com o Linux através do PAM (<em>Pluggable Authentication Modules</em>). Em lugar de fazer o controle de senhas dos usuários diretamente via <code>/etc/shadow</code> ou no LDAP, criaremos um sistema de autoridade certificadora (<em>Certificate Authority</em>) para o SSH, com o qual os usuários farão login nos servidores usando chaves assimétricas assinadas pela CA. Finalmente, para controlar ataques de força-bruta contra os servidores, usaremos o programa Fail2Ban para realizar o bloqueio automático de atacantes no firewall de host das máquinas.</p>
</div>
<div class="sect2">
<h3 id="_1_topologia_desta_sessão">1) Topologia desta sessão</h3>
<div class="paragraph">
<p>A figura abaixo mostra a topologia de rede que será utilizada nesta sessão, com as máquinas relevantes em destaque.</p>
</div>
<div id="img-topologia3" class="imageblock text-center">
<div class="content">
<img src="../img/Topologia_SEG10_S3.png" alt="Topologia SEG10 S3">
</div>
<div class="title">Figure 1. Topologia de rede desta sessão</div>
</div>
<div class="paragraph">
<p>Teremos três máquinas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ns1</code>, com <em>alias</em> <code>fw</code>, atuando como firewall de rede e DNS primário. Endereços IP via DHCP (interface <em>bridge</em>), 10.0.42.1/24 (interface DMZ) e 192.168.42.1/24 (interface Intranet).</p>
</li>
<li>
<p><code>ns2</code>, com <em>alias</em> <code>ldap</code>, localizada na DMZ e atuando como DNS secundário, servidor LDAP de autenticação centralizada e repositório de chaves SSH-CA. Endereço IP 10.0.42.2/24.</p>
</li>
<li>
<p><code>client</code>, localizada na Intranet e usada a partir de agora como ponto de partida para logins remotos nos diferentes servidores do <em>datacenter</em> simulado. Endereço IP 192.168.42.2/24.</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Observe que a topologia acima prevê a criação de um novo <em>alias</em> de rede para a máquina <code>ns2</code>, o nome <code>ns2</code>. Antes de começar, vamos ajustar nossa configuração DNS para refletir essa situação: acesse a máquina <code>ns1</code> como o usuário <code>root</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
ns1
root</pre>
</div>
</div>
<div class="paragraph">
<p>Edite o arquivo de zonas <code>/etc/nsd/zones/intnet.zone</code>, inserindo uma entrada CNAME para a máquina <code>ns2</code>, como se segue. <strong>Não se esqueça</strong> de incrementar o valor do serial no topo do arquivo!</p>
</div>
<div class="literalblock">
<div class="content">
<pre># nano /etc/nsd/zones/intnet.zone
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># grep '^ldap ' /etc/nsd/zones/intnet.zone
ldap    IN    CNAME             ns2</pre>
</div>
</div>
<div class="paragraph">
<p>Assine o arquivo de zonas usando o <em>script</em> criado na sessão anterior:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># bash /root/scripts/signzone-intnet.sh
reconfig start, read /etc/nsd/nsd.conf
ok
ok
ok
ok removed 0 rrsets, 0 messages and 0 key entries</pre>
</div>
</div>
<div class="paragraph">
<p>Verifique que a entrada foi criada com sucesso, usando o comando <code>dig</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># dig @127.0.0.1 ldap.intnet +noall +answer

; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Debian &lt;&lt;&gt;&gt; @127.0.0.1 ldap.intnet +noall +answer
; (1 server found)
;; global options: +cmd
ldap.intnet.            86138   IN      CNAME   ns2.intnet.
ns2.intnet.             86138   IN      A       10.0.42.2</pre>
</div>
</div>
<div class="paragraph">
<p>Certifique-se que a transferência de zonas entre o servidor DNS primário e secundário está funcionando corretamente&#8201;&#8212;&#8201;repita a consulta, desta vez no servidor <code>ns2</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># dig @10.0.42.2 ldap.intnet +noquestion

; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Debian &lt;&lt;&gt;&gt; @10.0.42.2 ldap.intnet +noquestion
; (1 server found)
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 48391
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; ANSWER SECTION:
ldap.intnet.            86207   IN      CNAME   ns2.intnet.
ns2.intnet.             86207   IN      A       10.0.42.2

;; Query time: 0 msec
;; SERVER: 10.0.42.2#53(10.0.42.2)
;; WHEN: Tue Nov 13 18:28:16 -02 2018
;; MSG SIZE  rcvd: 74</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_2_configuração_do_servidor_ldap">2) Configuração do servidor LDAP</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>O servidor LDAP, como explicitado na topologia desta sessão, será a máquina <code>ns2</code>. Acesse-a como o usuário <code>root</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
ns2
root</pre>
</div>
</div>
<div class="paragraph">
<p>Vamos, primeiramente, instalar o servidor LDAP através dos pacotes:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># apt-get install slapd ldap-utils ldapscripts</pre>
</div>
</div>
<div class="paragraph">
<p>Durante a instalação, será solicitada uma senha administrativa para o LDAP, que iremos redefinir em breve. Informe <code>rnpesr</code>.</p>
</div>
</li>
<li>
<p>Agora, vamos reconfigurar o servidor LDAP para definir alguns parâmetros que não foram questionados durante a instalação via <code>apt-get</code>. Execute:</p>
<div class="literalblock">
<div class="content">
<pre># dpkg-reconfigure -plow slapd</pre>
</div>
</div>
<div class="paragraph">
<p>Informe as seguintes opções:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Configurações do pacote slapd</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pergunta</th>
<th class="tableblock halign-left valign-top">Opção</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Omitir a configuração do servidor OpenLDAP?</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Não</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nome de domínio DNS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">intnet</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nome da organização</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">seg10</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Senha do administrador</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rnpesr (repetir)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Backend da base de dados a ser usado</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MDB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Você deseja que a base de dados seja removida quando o pacote slapd for expurgado ("purged")</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Não</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Move a base de dados antiga</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sim</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Durante a configuração, será criada uma base LDAP (semi) vazia, apenas com a raiz <code>dc=intnet</code> e o usuário administrativo <code>cn=admin,dc=intnet</code>. Iremos popular esta base brevemente.</p>
</div>
</li>
<li>
<p>Agora, vamos instalar o <code>nslcd</code>, um <em>daemon</em> LDAP local para resolução de diretivas de autenticação. Execute:</p>
<div class="literalblock">
<div class="content">
<pre># apt-get install nslcd</pre>
</div>
</div>
<div class="paragraph">
<p>Durante a instalação do pacote, informe as seguintes opções:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Configurações do pacote nslcd</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pergunta</th>
<th class="tableblock halign-left valign-top">Opção</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">URI do servidor LDAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ldapi:///</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base de buscas do servidor LDAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dc=intnet</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serviços de nome para configurar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">passwd, group, shadow</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Note que informamos que a localização do servidor LDAP é local, já que ele está instalado na máquina corrente. Além disso, iremos configurar as bases de contas (<code>passwd</code>), grupos (<code>group</code>) e senhas (<code>shadow</code>) junto ao LDAP.</p>
</div>
</li>
<li>
<p>Vamos configurar as opções padrão dos binários de linha de comando do <code>ldap-utils</code> (como os comandos <code>ldapsearch</code> e <code>ldapadd</code>, por exemplo). Edite manualmente ou use o <code>sed</code> para editar as linhas apropriadas do arquivo <code>/etc/ldap/ldap.conf</code>:</p>
<div class="literalblock">
<div class="content">
<pre># sed -i 's/^#\(BASE\).*/\1 dc=intnet/' /etc/ldap/ldap.conf</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># sed -i 's/^#\(URI\).*/\1 ldapi\:\/\/\//' /etc/ldap/ldap.conf</pre>
</div>
</div>
<div class="paragraph">
<p>Verifique que os valores editados estão corretos:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># grep -v '^#' /etc/ldap/ldap.conf | sed '/^$/d'
BASE dc=intnet
URI ldapi:///
TLS_CACERT      /etc/ssl/certs/ca-certificates.crt</pre>
</div>
</div>
</li>
<li>
<p>A seguir, vamos configurar o <code>ldapscripts</code>, um conjunto de ferramentas auxiliares que facilitam enormemente a configuração e uso de bases LDAP via linha de comando. Primeiro, edite manualmente ou use o <code>sed</code> para ajustar o arquivo <code>/etc/ldapscripts/ldapscripts.conf</code>, informando o <em>bind DN</em> do usuário administrativo na base LDAP, como se segue:</p>
<div class="literalblock">
<div class="content">
<pre># sed -i 's/^\(BINDDN=\).*/\1\"cn=admin,dc=intnet\"/' /etc/ldapscripts/ldapscripts.conf</pre>
</div>
</div>
<div class="paragraph">
<p>Depois, informe a senha do usuário administrativo no arquivo <code>/etc/ldapscripts/ldapscripts.passwd</code>. Execute:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># echo -n "rnpesr" &gt; /etc/ldapscripts/ldapscripts.passwd</pre>
</div>
</div>
<div class="paragraph">
<p>Como a senha do usuário administrativo do LDAP está embutida em texto claro nesse arquivo, é fundamental garantir que suas permissões estão suficientemente estritas. Verifique:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ls -ld /etc/ldapscripts/ldapscripts.passwd
-rw-r----- 1 root root 6 out 29 09:16 /etc/ldapscripts/ldapscripts.passwd</pre>
</div>
</div>
</li>
<li>
<p>Vamos inicializar a base LDAP usando o <code>ldapscripts</code>. Execute:</p>
<div class="literalblock">
<div class="content">
<pre># ldapinit -s</pre>
</div>
</div>
</li>
<li>
<p>Será que funcionou? Consulte a base LDAP sem autenticação, e liste seu conteúdo:</p>
<div class="literalblock">
<div class="content">
<pre># ldapsearch -x -LLL
dn: dc=intnet
objectClass: top
objectClass: dcObject
objectClass: organization
o: seg10
dc: intnet

dn: cn=admin,dc=intnet
objectClass: simpleSecurityObject
objectClass: organizationalRole
cn: admin
description: LDAP administrator

dn: ou=People,dc=intnet
objectClass: top
objectClass: organizationalUnit
ou: People

dn: ou=Groups,dc=intnet
objectClass: top
objectClass: organizationalUnit
ou: Groups

dn: ou=Hosts,dc=intnet
objectClass: top
objectClass: organizationalUnit
ou: Hosts

dn: ou=Idmap,dc=intnet
objectClass: organizationalUnit
ou: Idmap</pre>
</div>
</div>
<div class="paragraph">
<p>Perfeito! Temos configurada a raiz <code>dc=intnet</code> e usuário administrativo <code>cn=admin,dc=intnet</code> como anteriormente, e o comando <code>ldapinit</code> se encarregou de criar DNs para armazenar usuários, grupos, <em>hosts</em> e mapeamentos de identidade na base LDAP. Podemos prosseguir.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_3_habilitando_logs_do_ldap">3) Habilitando logs do LDAP</h3>
<div class="paragraph">
<p>Por padrão, o <em>daemon</em> <code>slapd</code> envia logs para a <em>facility</em> <code>local4</code> do sistema. Porém, após a instalação via <code>apt-get</code>, seu <em>log level</em> (nível de criticidade dos eventos registrados) é configurado para <code>none</code>&#8201;&#8212;&#8201;ou seja, nenhum evento é registrado. Evidentemente, essa situação não é interessante ao configurar o servidor, pois será muito difícil identificar as fontes de problemas se não tivermos nenhum log para consultar. Vamos corrigir isso.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Primeiro, crie um diretório específico para o armazenamento de LDIFs. LDIFs são uma sigla para LDAP <em>Data Interchange Format</em>, arquivos de texto plano que podem ser usados para representar informações em uma base LDAP. Algo equivalente a arquivos <em>dump</em> de bases SQL, em comparação livre.</p>
<div class="literalblock">
<div class="content">
<pre># mkdir /root/ldif</pre>
</div>
</div>
</li>
<li>
<p>Crie neste diretório um LDIF de nome <code>/root/ldif/slapdlog.ldif</code>, com o seguinte conteúdo:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">dn: cn=config
changeType: modify
replace: olcLogLevel
olcLogLevel: stats</code></pre>
</div>
</div>
<div class="paragraph">
<p>O LDIF acima irá alterar o valor do parâmetro <code>olcLogLevel</code>, que define o <em>log level</em> do <code>slapd</code>, para <code>stats.</code> Para aplicar essa configuração, execute:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapmodify -Y external -H ldapi:/// -f /root/ldif/slapdlog.ldif</pre>
</div>
</div>
</li>
<li>
<p>O próximo passo é informar ao <code>rsyslog</code> que as mensagens enviadas para a <em>facility</em> <code>local4</code> devem ser enviadas para um arquivo específico. Crie o arquivo novo <code>/etc/rsyslog.d/slapd.conf</code> com o seguinte conteúdo:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$template slapdtmpl,"[%$DAY%-%$MONTH%-%$YEAR% %timegenerated:12:19:date-rfc3339%] %app-name% %syslogseverity-text% %msg%\n"
local4.*    /var/log/slapd.log;slapdtmpl</code></pre>
</div>
</div>
</li>
<li>
<p>Em seguida, reinicie ambos os <em>daemons</em> do <code>rsyslog</code> e do <code>slapd</code>:</p>
<div class="literalblock">
<div class="content">
<pre># systemctl restart rsyslog.service</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl restart slapd.service</pre>
</div>
</div>
</li>
<li>
<p>Verifique que os registros de eventos do <code>slapd</code> estão sendo, de fato, enviados para o arquivo <code>/var/log/slapd.log</code>:</p>
<div class="literalblock">
<div class="content">
<pre>tail /var/log/slapd.log
[13-11-2018 18:35:18] slapd debug  daemon: shutdown requested and initiated.
[13-11-2018 18:35:18] slapd debug  slapd shutdown: waiting for 0 operations/tasks to finish
[13-11-2018 18:35:18] slapd debug  slapd stopped.
[13-11-2018 18:35:18] slapd debug  @(#) $OpenLDAP: slapd  (May 23 2018 04:25:19) $#012#011Debian OpenLDAP Maintainers &lt;pkg-openldap-devel@lists.alioth.debian.org&gt;
[13-11-2018 18:35:18] slapd debug  slapd starting</pre>
</div>
</div>
</li>
<li>
<p>A rotação de logs deve ser habilitada, caso contrário os arquivos de log poderão ficar excessivamente grandes. Crie o arquivo novo <code>/etc/logrotate.d/slapd</code>, com o seguinte conteúdo:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">/var/log/slapd.log {
  missingok
  notifempty
  compress
  daily
  rotate 30
  sharedscripts
  postrotate
    systemctl restart rsyslog.service
  endscript
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Como o <code>logrotate</code> é invocado via <code>cron</code>, não é necessário reiniciar nenhum serviço neste caso.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_4_edição_de_índices_e_permissões_no_ldap">4) Edição de índices e permissões no LDAP</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Para maior performance durante as consultas ao LDAP, é recomendável aumentar os parâmetros de indexação de alguns atributos. Crie o arquivo <code>/root/ldif/olcDbIndex.ldif</code>, com o seguinte conteúdo:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">dn: olcDatabase={1}mdb,cn=config
changetype: modify
replace: olcDbIndex
olcDbIndex: objectClass eq
olcDbIndex: cn pres,sub,eq
olcDbIndex: sn pres,sub,eq
olcDbIndex: uid pres,sub,eq
olcDbIndex: displayName pres,sub,eq
olcDbIndex: default sub
olcDbIndex: uidNumber eq
olcDbIndex: gidNumber eq
olcDbIndex: mail,givenName eq,subinitial
olcDbIndex: dc eq</code></pre>
</div>
</div>
<div class="paragraph">
<p>O LDIF acima irá alterar o valor do parâmetro <code>olcDbIndex</code>, que define quais parâmetros serão indexados pelo <code>slapd</code> e quais tipos de busca serão suportados. Para aplicar essa configuração, execute:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapmodify -Y EXTERNAL -H ldapi:/// -f /root/ldif/olcDbIndex.ldif</pre>
</div>
</div>
</li>
<li>
<p>É interessante permitir que usuários possam alterar seus parâmetros <code>loginShell</code> e entrada <code>gecos</code> (informações de conta do usuário) via comandos <code>chsh</code> e <code>chfn</code>. Para fazer isso, crie o arquivo novo <code>/root/ldif/olcAccess.ldif</code> com o seguinte conteúdo:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">dn: olcDatabase={1}mdb,cn=config
changetype: modify
add: olcAccess
olcAccess: {1}to attrs=loginShell,gecos
  by dn="cn=admin,dc=intnet" write
  by self write
  by * read</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para aplicar a configuração, execute:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapmodify -Y EXTERNAL -H ldapi:/// -f /root/ldif/olcAccess.ldif</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_5_adição_de_grupos_e_usuários_no_ldap">5) Adição de grupos e usuários no LDAP</h3>
<div class="paragraph">
<p>Agora sim, vamos começar a criar usuários e grupos em nossa base LDAP. Imagine que iremos criar um grupo de nome <code>sysadm</code>, no qual estarão todos os administradores de sistema que têm permissão para acessar servidores não-críticos. Nesse grupo, iremos criar o usuário <code>luke</code>, com senha <code>seg10luke</code>. Como proceder?</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Primeiro, crie o grupo usando o comando <code>ldapaddgroup</code>:</p>
<div class="literalblock">
<div class="content">
<pre># ldapaddgroup sysadm
Successfully added group sysadm to LDAP</pre>
</div>
</div>
<div class="paragraph">
<p>Verifique que o grupo foi corretamente criado usando o <code>ldapsearch</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapsearch -x -LLL 'cn=sysadm'
dn: cn=sysadm,ou=Groups,dc=intnet
objectClass: posixGroup
cn: sysadm
gidNumber: 10000
description: Group account</pre>
</div>
</div>
</li>
<li>
<p>A seguir, crie o usuário <code>luke</code>, informando seu grupo primário como <code>sysadm</code>:</p>
<div class="literalblock">
<div class="content">
<pre># ldapadduser luke sysadm
Successfully added user luke to LDAP
Successfully set password for user luke</pre>
</div>
</div>
<div class="paragraph">
<p>Novamente, consulte o <code>ldapsearch</code> para checar se o usuário foi criado com sucesso:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapsearch -x -LLL 'cn=luke'
dn: uid=luke,ou=People,dc=intnet
objectClass: account
objectClass: posixAccount
cn: luke
uid: luke
uidNumber: 10000
gidNumber: 10000
homeDirectory: /home/luke
loginShell: /bin/bash
gecos: luke
description: User account</pre>
</div>
</div>
<div class="paragraph">
<p>O comando <code>ldapid</code> também é uma boa opção neste cenário, fornecendo saída bastante similar à do comando <code>id</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapid luke
uid=10000(luke) gid=10000(sysadm) groups=10000(sysadm),10000(sysadm)</pre>
</div>
</div>
</li>
<li>
<p>Vamos configurar a senha do usuário <code>luke</code> como <code>seg10luke</code>:</p>
<div class="literalblock">
<div class="content">
<pre># ldapsetpasswd luke
Changing password for user uid=luke,ou=People,dc=intnet
New Password:
Retype New Password:
Successfully set password for user uid=luke,ou=People,dc=intnet</pre>
</div>
</div>
<div class="paragraph">
<p>Para verificar, cheque que o campo <code>userPassword</code> do usuário está preenchido com um <em>hash</em> de senha. Para o comando <code>ldapsearch</code> funcionar, temos que informar um <em>bind DN</em> administrativo e senha correspondente, já que este atributo não é legível sem autenticação:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapsearch -x -LLL -D 'cn=admin,dc=intnet' -W 'cn=luke' userPassword
Enter LDAP Password:
dn: uid=luke,ou=People,dc=intnet
userPassword:: e1NTSEF9NHdUSWZRcUhGR0o5VU5jNS9tVnhoaGJzNFVvNkFzMmE=</pre>
</div>
</div>
<div class="paragraph">
<p>O comando <code>ldapfinger</code> também é uma boa opção para consultar as informações do usuário (e seu <em>hash</em> de senha), já que faz parte do <code>ldapscripts</code> e utiliza as credenciais administrativas que configuramos anteriormente:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapfinger luke
dn: uid=luke,ou=People,dc=intnet
objectClass: account
objectClass: posixAccount
cn: luke
uid: luke
uidNumber: 10000
gidNumber: 10000
homeDirectory: /home/luke
loginShell: /bin/bash
gecos: luke
description: User account
userPassword:: e1NTSEF9NEU0aFI2N3lCNGplUHdXRHNHVEZYZTBEYm5YdGxDTUg=</pre>
</div>
</div>
</li>
<li>
<p>Apesar de termos informado o grupo <code>sysadm</code> como grupo primário do usuário <code>luke</code>, do ponto de vista do grupo esse usuário ainda não o integra. O comando <code>ldapaddusertogroup</code> faz esse trabalho:</p>
<div class="literalblock">
<div class="content">
<pre># ldapaddusertogroup luke sysadm
Successfully added user luke to group cn=sysadm,ou=Groups,dc=intnet</pre>
</div>
</div>
<div class="paragraph">
<p>Para verificar o pertencimento, use o comando <code>ldapsearch</code>, consultando os atributos <code>memberUid</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapsearch -x -LLL 'cn=sysadm'
dn: cn=sysadm,ou=Groups,dc=intnet
objectClass: posixGroup
cn: sysadm
gidNumber: 10000
description: Group account
memberUid: luke</pre>
</div>
</div>
<div class="paragraph">
<p>O <code>ldapgid</code>, parte da suíte <code>ldapscripts</code>, também é uma alternativa interessante:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapgid sysadm
gid=10000(sysadm) users(primary)=10000(luke) users(secondary)=10000(luke)</pre>
</div>
</div>
</li>
<li>
<p>Como já mencionado algumas vezes, o <code>ldapscripts</code> oferece um conjunto de programas que facilitam bastante as tarefas corriqueiras de manipulação da base LDAP via linha de comando. Apesar de termos trabalhado um bom número desses programas, listamos abaixo alguns outros que não foram utilizados. Consulte suas páginas de manual para mais informações sobre como operá-los:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Deleção de entradas:</p>
<div class="ulist">
<ul>
<li>
<p><code>/usr/sbin/ldapdeletegroup</code></p>
</li>
<li>
<p><code>/usr/sbin/ldapdeleteuser</code></p>
</li>
<li>
<p><code>/usr/sbin/ldapdeleteuserfromgroup</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Modificação de entradas:</p>
<div class="ulist">
<ul>
<li>
<p><code>/usr/sbin/ldapmodifygroup</code></p>
</li>
<li>
<p><code>/usr/sbin/ldapmodifyuser</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Renomear entradas:</p>
<div class="ulist">
<ul>
<li>
<p><code>/usr/sbin/ldaprenamegroup</code></p>
</li>
<li>
<p><code>/usr/sbin/ldaprenameuser</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Configurar grupo primário de um usuário:</p>
<div class="ulist">
<ul>
<li>
<p><code>/usr/sbin/ldapsetprimarygroup</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_6_integração_e_teste_do_sistema_de_autenticação_com_ldap">6) Integração e teste do sistema de autenticação com LDAP</h3>
<div class="paragraph">
<p>Agora, vamos integrar o sistema de autenticação do Linux com a base LDAP que configuramos anteriormente usando o PAM (<em>Pluggable Authentication Modules</em>). Felizmente, muito do trabalho de configuração já foi feito automaticamente pelos <em>scripts</em> de instalação do <code>apt-get</code> quando instalamos o pacote <code>nslcd</code>. Faltam apenas alguns poucos passos.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Quando um usuário do LDAP efetua login em uma máquina pela primeira vez, seu diretório <em>home</em> não existe, naturalmente. Vamos configurar o PAM para criar esse diretório automaticamente. Crie o arquivo novo <code>/usr/share/pam-configs/mkhomedir</code> com o seguinte conteúdo:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">Name: Create home directory during login
Default: yes
Priority: 900
Session-Type: Additional
Session:
        required        pam_mkhomedir.so umask=0022 skel=/etc/skel</code></pre>
</div>
</div>
<div class="paragraph">
<p>Em seguida, execute:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># pam-auth-update</pre>
</div>
</div>
<div class="paragraph">
<p>Durante a configuração do PAM, na pergunta "Perfis PAM para habilitar", mantenha todas as caixas marcadas e selecione OK.</p>
</div>
<div class="paragraph">
<p>Verifique que a configuração surtiu efeito pesquisando pelo termo <code>mkhomedir</code> nos arquivos de configuração do PAM, em <code>/etc/pam.d</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># grep -ri mkhomedir /etc/pam.d
/etc/pam.d/common-session:session       required        pam_mkhomedir.so umask=0022 skel=/etc/skel
/etc/pam.d/common-session-noninteractive:session        required        pam_mkhomedir.so umask=0022 skel=/etc/skel</pre>
</div>
</div>
</li>
<li>
<p>Reinicie os <em>daemons</em> <code>nslcd</code> e <code>nscd</code> para que a <em>cache</em> de usuários, grupos e senhas do LDAP seja atualizada:</p>
<div class="literalblock">
<div class="content">
<pre># systemctl restart nslcd.service</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl restart nscd.service</pre>
</div>
</div>
</li>
<li>
<p>Será que funcionou? Pesquise a lista de usuários do sistema e busque pelo usuário recém-criado <code>luke</code>:</p>
<div class="literalblock">
<div class="content">
<pre># getent passwd | grep luke
luke:*:10000:10000:luke:/home/luke:/bin/bash</pre>
</div>
</div>
<div class="paragraph">
<p>Excelente! E quando ao grupo <code>sysadm</code>?</p>
</div>
<div class="literalblock">
<div class="content">
<pre># getent group | grep sysadm
sysadm:*:10000:luke</pre>
</div>
</div>
<div class="paragraph">
<p>Finalmente, consulte se o usuário <code>luke</code> é reconhecido como membro de <code>sysadm</code> pelo sistema:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># groups luke
luke : sysadm</pre>
</div>
</div>
</li>
<li>
<p>Vamos testar: tente logar via <code>ssh</code> na máquina local usando o usuário <code>luke</code>:</p>
<div class="literalblock">
<div class="content">
<pre># ssh luke@localhost
The authenticity of host 'localhost (::1)' can't be established.
ECDSA key fingerprint is SHA256:mI2LM9Nxt5ltC7/VnlEgB+JBdqFbKxUj1FhhvLijcv4.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added 'localhost' (ECDSA) to the list of known hosts.
luke@localhost's password:
Creating directory '/home/luke'.</pre>
</div>
</div>
<div class="paragraph">
<p>Perfeito. Note que o diretório <code>/home/luke</code> foi criado automaticamente, como esperado. Faça as verificações pós-login de costume:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ whoami
luke</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ pwd
/home/luke</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ id
uid=10000(luke) gid=10000(sysadm) grupos=10000(sysadm)</pre>
</div>
</div>
</li>
<li>
<p>Falta testar se o usuário consegue alterar sua senha diretamente via console, sem necessidade de edição direta à base LDAP. Primeiro, verifique o <em>hash</em> da senha atual&#8201;&#8212;&#8201;note que iremos usar o próprio DN do usuário <code>luke</code> como <em>bind DN</em> durante a conexão LDAP, motivo pelo qual deve-se informar a senha desse usuário, e não do administrador:</p>
<div class="literalblock">
<div class="content">
<pre>$ ldapsearch -x -LLL -D 'uid=luke,ou=People,dc=intnet' -W 'uid=luke' userPassword
Enter LDAP Password:
dn: uid=luke,ou=People,dc=intnet
userPassword:: e1NTSEF9K29BcE55S3AwRU9XM0sreWVPeFNoZUJjdFhBbVJyVEg=</pre>
</div>
</div>
<div class="paragraph">
<p>Use o comando <code>passwd</code> para alterar a senha para um outro valor qualquer:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ passwd
(current) LDAP Password:
Nova senha:
Redigite a nova senha:
passwd: senha atualizada com sucesso</pre>
</div>
</div>
<div class="paragraph">
<p>Verifique novamente o <em>hash</em> da senha do usuário <code>luke</code> e compare os dois valores:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ldapsearch -x -LLL -D 'uid=luke,ou=People,dc=intnet' -W 'uid=luke' userPassword
Enter LDAP Password:
dn: uid=luke,ou=People,dc=intnet
userPassword:: e1NTSEF9b0REb2lVbWgvR0swMm9qaGJoZWJ2ZGtNYzFKTE1kazk=</pre>
</div>
</div>
<div class="paragraph">
<p>Perfeito, os <em>hashes</em> são diferentes; ou seja, a alteração de senha via <code>passwd</code> funcionou normalmente. Retorne a senha do usuário <code>luke</code> ao valor anterior, para evitar confusões no futuro.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_7_configurando_uma_autoridade_certificadora_ca_para_o_ssh">7) Configurando uma autoridade certificadora (CA) para o SSH</h3>
<div class="paragraph">
<p>Até o momento, instalamos e configuramos uma base LDAP, e testamos sua integração com os sistemas de autenticação do sistema usando o <code>ssh</code>. Porém, a todo momento, tivemos que digitar as senhas dos usuários para nos autenticar&#8201;&#8212;&#8201;será que podemos fazer isso de uma forma mais segura?</p>
</div>
<div class="paragraph">
<p>Nesta atividade iremos configurar uma autoridade certificadora para o <code>ssh</code>, com a qual assinaremos pares de chaves de <em>hosts</em> e de usuários. De posse dessas chaves, não será mais necessário informar senhas durante o login, tornando o processo significativamente mais seguro (desde que se tome cuidado para não perder a chave privada, como veremos).</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Primeiro, verifique que você está logado como usuário <code>root</code> na máquina <code>ns2</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
ns2
root</pre>
</div>
</div>
</li>
<li>
<p>Vamos adicionar um novo usuário à base LDAP, <code>sshca</code>, que será responsável por realizar os processos de assinaturas de chaves de <em>hosts</em> e usuários. Esse usuário irá pertencer ao grupo <code>setup</code>, um grupo especial para atividades de configuração de sistemas. Sua senha será <code>seg10sshca</code>.</p>
<div class="paragraph">
<p>Vamos por partes. Primeiro, crie o grupo:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapaddgroup setup
Successfully added group setup to LDAP</pre>
</div>
</div>
<div class="paragraph">
<p>Em seguida, o usuário:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapadduser sshca setup
Successfully added user sshca to LDAP
Successfully set password for user sshca</pre>
</div>
</div>
<div class="paragraph">
<p>Adicione o usuário ao grupo:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapaddusertogroup sshca setup
Successfully added user sshca to group cn=setup,ou=Groups,dc=intnet</pre>
</div>
</div>
<div class="paragraph">
<p>E, finalmente, configure a senha do usuário <code>sshca</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapsetpasswd sshca
Changing password for user uid=sshca,ou=People,dc=intnet
New Password:
Retype New Password:
Successfully set password for user uid=sshca,ou=People,dc=intnet</pre>
</div>
</div>
</li>
<li>
<p>Faça login com o usuário recém-criado no sistema local:</p>
<div class="literalblock">
<div class="content">
<pre># ssh sshca@localhost
sshca@localhost's password:
Creating directory '/home/sshca'.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ whoami
sshca</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ pwd
/home/sshca</pre>
</div>
</div>
</li>
<li>
<p>Vamos criar dois pares de chaves para a CA (<em>Certificate Authority</em>, ou autoridade certificadora) do <code>ssh</code>: uma para assinar chaves de <em>hosts</em>, denominada <code>server_ca</code>, e outra para assinar chaves de usuários, denominada <code>user_ca</code>. Iremos criar chaves RSA de 4096 bits, e devemos escolher uma senha bastante segura para a chave privada&#8201;&#8212;&#8201;já que, com ela, pode-se assinar quaisquer chaves <code>ssh</code> que autorizarão máquinas a se passarem por membros do nosso <em>datacenter</em> e usuários a logarem em qualquer servidor integrado.</p>
<div class="paragraph">
<p>Como estamos em um ambiente de laboratório, não iremos utilizar senhas para as chaves privadas de modo a agilizar a execução das atividades.</p>
</div>
<div class="paragraph">
<p>Para criar a chave de assinatura de <em>hosts</em>, <code>server_ca</code>, execute:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ssh-keygen -f server_ca -t rsa -b 4096 -N ''
Generating public/private rsa key pair.
Your identification has been saved in server_ca.
Your public key has been saved in server_ca.pub.
The key fingerprint is:
SHA256:op2g5J5DN/1pPy8RUHxnAdh51NHP/2Pmyo3Vq5Qlvjo sshca@ns2
The key's randomart image is:
+---[RSA 4096]----+
|         o.o.+o+o|
|        . o + + o|
|         . . + ..|
|          .     o|
|  . ... S  . . ..|
| o..o+.o  . . + o|
| .o...o. . . + .o|
| ...    + oEo =+o|
|  o.   . ..=+**+.|
+----[SHA256]-----+</pre>
</div>
</div>
<div class="paragraph">
<p>Verifique que o par de chaves foi criado com sucesso:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ls
server_ca  server_ca.pub</pre>
</div>
</div>
<div class="paragraph">
<p>Para criar a chave de assinatura de usuários, <code>user_ca</code>, execute:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ssh-keygen -f user_ca -t rsa -b 4096 -N ''
Generating public/private rsa key pair.
Your identification has been saved in user_ca.
Your public key has been saved in user_ca.pub.
The key fingerprint is:
SHA256:T6dFFMQiJnbGCLg0rj1tzaT4mfqagBn80YQaBGuWpuM sshca@ns2
The key's randomart image is:
+---[RSA 4096]----+
|o. ... o   o+.   |
|..= . + * ...    |
|.O + o = . ..    |
|* = o .    .     |
|+= + *  S . o    |
|++= = o  o +     |
|+E = o    o      |
| . .+            |
|  ++.            |
+----[SHA256]-----+</pre>
</div>
</div>
<div class="paragraph">
<p>Cheque que todos os quatro arquivos de chaves pública/privada foram criados:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ls
server_ca  server_ca.pub  user_ca  user_ca.pub</pre>
</div>
</div>
</li>
<li>
<p>Dada a grande sensibilidade das chaves privadas das CAs nesse sistema de autenticação que estamos configurando, é fundamental garantir também que, além de terem uma senha forte configurada, suas permissões estejam corretamente ajustadas.</p>
<div class="paragraph">
<p>Verifique as permissões das chaves usando o comando <code>ls</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ls -l *_ca*
-rw------- 1 sshca setup 1766 out 28 08:39 server_ca
-rw-r--r-- 1 sshca setup  392 out 28 08:39 server_ca.pub
-rw------- 1 sshca setup 1766 out 28 08:40 user_ca
-rw-r--r-- 1 sshca setup  392 out 28 08:40 user_ca.pub</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_8_configurando_a_ssh_ca_no_servidor_ldap">8) Configurando a SSH-CA no servidor LDAP</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Vamos configurar o servidor LDAP para interoperar com a CA <code>ssh</code> que configuramos na atividade anterior. Volte ao usuário <code>root</code> na máquina <code>ns2</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
ns2
root</pre>
</div>
</div>
<div class="paragraph">
<p>Crie um novo arquivo, <code>/root/scripts/sshsign.sh</code> com o seguinte conteúdo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">#!/bin/bash

CA_USER="sshca"
CA_ADDR="10.0.42.2"
CA_USER_PASS="seg10sshca"
SSH_OPTS="-o PreferredAuthentications=password -o PubkeyAuthentication=no"


function cleanup() {
  sed -i '/^HostCertificate/d' /etc/ssh/sshd_config
  sed -i '/^TrustedUserCAKeys/d' /etc/ssh/sshd_config

  rm -f ~/.ssh/known_hosts       \
    /etc/ssh/ssh_host_*      \
    /etc/ssh/ssh_known_hosts \
    /etc/ssh/user_ca.pub 2&gt; /dev/null
  dpkg-reconfigure openssh-server &amp;&gt; /dev/null

  systemctl restart sshd.service
}


# resetar sistema para estado conhecido
cleanup

# escanear chave do host ssh-ca
[ -d ~/.ssh ] || { mkdir ~/.ssh; chmod 700 ~/.ssh; }
if ! ssh-keygen -F ${CA_ADDR} 2&gt;/dev/null 1&gt;/dev/null; then
  ssh-keyscan -t rsa -T 10 ${CA_ADDR} 2&gt; /dev/null &gt;&gt; ~/.ssh/known_hosts
fi

# iterar em todas as pubkeys SSH
for pkeypath in /etc/ssh/ssh_host_*.pub; do
  pkeyname="$( echo "${pkeypath}" | awk -F'/' '{print $NF}' )"
  certname="$( echo "${pkeyname}" | sed 's/\(\.pub$\)/-cert\1 /' )"
  echo "Signing ${pkeyname} key..."

  # copiar pubkey
  sshpass -p "${CA_USER_PASS}" \
    scp ${SSH_OPTS} ${pkeypath} ${CA_USER}@${CA_ADDR}:~

  # assinar pubkey, validade [-5 min -&gt; 3 anos]
  identity="$(hostname --fqdn)"
  principals="$(hostname),$(hostname --fqdn),$(hostname -I | tr ' ' ',' | sed 's/,$//')"
  sshpass -p "${CA_USER_PASS}" \
    ssh ${SSH_OPTS} ${CA_USER}@${CA_ADDR} \
      ssh-keygen -s server_ca \
      -I "${identity}" \
      -n "${principals}" \
      -V -5m:+1095d \
      -h \
      ${pkeyname} 2&gt; /dev/null

  # copiar pubkey assinada de volta
  sshpass -p "${CA_USER_PASS}" \
    scp ${SSH_OPTS} ${CA_USER}@${CA_ADDR}:${certname} /etc/ssh/

  # remover temporarios do diretorio remoto
  sshpass -p "${CA_USER_PASS}" \
    ssh ${SSH_OPTS} ${CA_USER}@${CA_ADDR} \
      rm ${pkeyname} ${certname}

  # remover pubkey RSA antiga e configurar ssh para apresentar pubkey assinada
  rm -f ${pkeypath} 2&gt; /dev/null
  echo "HostCertificate /etc/ssh/${certname}" &gt;&gt; /etc/ssh/sshd_config
done

# copiar pubkey da server_ca e configurar reconhecimento de chaves de host assinadas
echo "Configuring host key trust..."
echo "@cert-authority * $(sshpass -p "${CA_USER_PASS}" ssh ${SSH_OPTS} ${CA_USER}@${CA_ADDR} cat server_ca.pub)" &gt; /etc/ssh/ssh_known_hosts

# copiar pubkey da user_ca e configurar reconhecimento de chaves de usuario assinadas
echo "Configuring user key trust..."
sshpass -p "${CA_USER_PASS}" \
  scp ${SSH_OPTS} ${CA_USER}@${CA_ADDR}:~/user_ca.pub /etc/ssh/
echo "TrustedUserCAKeys /etc/ssh/user_ca.pub" &gt;&gt; /etc/ssh/sshd_config

echo "All done!"
systemctl restart sshd.service</code></pre>
</div>
</div>
<div class="paragraph">
<p>Você deve estar se perguntando: o que esse <em>script</em> faz? Vamos ver:</p>
</div>
<div class="openblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>(Linhas 3-6) Definimos o usuário <code>sshca</code> e o IP <code>10.0.42.2</code> (o servidor <code>ns2</code> local no qual estamos logados no momento) como a origem das chaves da CA que utilizaremos a seguir. Configuramos a senha do usuário <code>sshca</code> de forma <em>hardcoded</em> para agilizar o processo de execução do <em>script</em> e informamos que os logins SSH serão feitos sempre via senha, não chaves assimétricas.</p>
</li>
<li>
<p>(Linhas 9-20) Função que reseta a situação do SSH no servidor para um estado conhecido, em caso de falha ou encerramento abrupto do usuário durante a execução do <em>script</em>.</p>
</li>
<li>
<p>(Linhas 27-30) Escaneamos a chave do servidor <code>10.0.42.2</code> e armazenamos no arquivo <code>~/.ssh/known_hosts</code>, evitando que o usuário tenha que confirmar que confia no <em>host</em> remoto antes de logar.</p>
</li>
<li>
<p>(Linhas 33-35) Iteramos sobre todas as chaves públicas no diretório <code>/etc/ssh</code> (RSA, ECDSA e ED25519), extraindo <em>strings</em> para usar à frente.</p>
</li>
<li>
<p>(Linhas 39-40) Copiamos a chave pública do <em>host</em> sendo processadao pelo <em>loop</em> para o servidor da CA.</p>
</li>
<li>
<p>(Linhas 43-52) Assinamos a chave pública do <em>host</em> sendo processadao pelo <em>loop</em> usando a chave <code>server_ca</code>, com validade de 3 anos.</p>
</li>
<li>
<p>(Linhas 55-56) Copiamos a chave pública assinada sendo processadao pelo <em>loop</em> de volta para a máquina local.</p>
</li>
<li>
<p>(Linhas 59-61) Removemos chaves pública não-assinada e assinada sendo processadao pelo <em>loop</em> da pasta do usuário <code>sshca</code> no servidor <code>10.0.42.2</code>, para evitar confusão em assinaturas futuras.</p>
</li>
<li>
<p>(Linhas 64-65) Removemos a chave pública sendo processadao pelo <em>loop</em> não-assinada e mantemos apenas a assinada, configurando o servidor <code>ssh</code> para apresentá-la para clientes.</p>
</li>
<li>
<p>(Linha 70) Configuramos a chave <code>server_ca.pub</code> como uma CA confiável para <em>hosts</em> remotos; a partir deste momento, quaisquer logins de cliente <code>ssh</code> da máquina local para <em>hosts</em> assinados não terão que confirmar relação de confiança antes de prosseguir.</p>
</li>
<li>
<p>(Linhas 74-76) Copiamos a chave <code>user_ca.pub</code> e a configuramos como uma CA confiável para usuários; a partir deste momento, qualquer usuário que apresente uma chave assinada pela CA terá seu login autorizado sem necessitar digitação de senha.</p>
</li>
<li>
<p>(Linha 79) Reiniciamos o servidor <code>ssh</code> para aplicar as configurações realizadas.</p>
</li>
</ol>
</div>
</div>
</div>
</li>
<li>
<p>Vamos instalar o <code>sshpass</code>, dependência para que o <em>script</em> acima funcione corretamente.</p>
<div class="literalblock">
<div class="content">
<pre># apt-get install sshpass</pre>
</div>
</div>
</li>
<li>
<p>Vamos configurar a máquina <code>ns2</code> para operar com a CA do <code>ssh</code>: execute o <em>script</em> criado no passo (1).</p>
<div class="literalblock">
<div class="content">
<pre># bash ~/scripts/sshsign.sh
Signing ssh_host_ecdsa_key.pub key...
Signing ssh_host_ed25519_key.pub key...
Signing ssh_host_rsa_key.pub key...
Configuring host key trust...
Configuring user key trust...
All done!</pre>
</div>
</div>
<div class="paragraph">
<p>Note que não foi necessário passar quaisquer parâmetros de linha de comando para o <em>script</em>. Ele autodetecta o <em>hostname</em> e endereços da máquina local e os configura como <em>principals</em> (conjunto de endereços/<em>hostnames</em> válidos para uma determinada chave; linha 44 do <em>script</em>).</p>
</div>
</li>
<li>
<p>Vamos verificar que o <em>script</em> fez seu trabalho corretamente. Cheque as linhas finais do arquivo <code>/etc/ssh/sshd_config</code>:</p>
<div class="literalblock">
<div class="content">
<pre># tail -n4 /etc/ssh/sshd_config
HostCertificate /etc/ssh/ssh_host_ecdsa_key-cert.pub
HostCertificate /etc/ssh/ssh_host_ed25519_key-cert.pub
HostCertificate /etc/ssh/ssh_host_rsa_key-cert.pub
TrustedUserCAKeys /etc/ssh/user_ca.pub</pre>
</div>
</div>
<div class="paragraph">
<p>Verifique que apenas chaves públicas assinadas existem no diretório <code>/etc/ssh</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ls -1 /etc/ssh/ssh_host_*.pub
/etc/ssh/ssh_host_ecdsa_key-cert.pub
/etc/ssh/ssh_host_ed25519_key-cert.pub
/etc/ssh/ssh_host_rsa_key-cert.pub</pre>
</div>
</div>
<div class="paragraph">
<p>Compare o conteúdo dos arquivos de chave pública <code>/home/sshca/server_ca.pub</code> e de chave da CA confiável <code>/etc/ssh/ssh_known_hosts</code>&#8201;&#8212;&#8201;eles devem ser iguais:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># cat /etc/ssh/ssh_known_hosts
@cert-authority * ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC+ZP47AOiRPcakZiLm+szvxWF5HKNa+BauaYXt5A6XjuUUJIYXXdTdzrq+d4rx379jxk5E+RHvPls1Y+5Cvn2/EpBgx20TXoT9+O0Nn7pemHd7qkDb2JqPzoHzjViG033L8UociItit13UVMlvB2+miW4RPMHhLjJpJT2BoWzvkBtJdukO/SA+3EYpIZAj8kyFfkp9+2A/A+OCREWoh5EkcjREAQRay+pc/j3sWDYrymu65OamPwGAe3Ih9/TmflUiwdHaNfJMY0BqpJsdFyUJeS36asjRhLtZltfLNTyY1gOq3XglLZb76YaQWOoIhzwqQ2WNSt72cY7s8p97loX5LTBSjNw6Kq0rOpKY3XmkyP2A5+L+CFxRxpl0obOkqiZqK/oT4cFE72EBaSg0XfFej19rd/AqqFSEHpbK4GjZzBAEID932DrgcR6ud74k1TDemQgWZ5dge0wEKMfeNVzUXhAPuxeIyQ6E+DxuayHIrUKZ7T36ZVz5N56TXnr+iaaejqpJfuSKZxC8YT9ZmRiHeZ+edze+R6QPiV76QUIQqzocO+OlWPHUZ2zVINV76DZARqxzZuKWW7JzA1+kTJ3VW3zGaOs53n36lfThb39ULHplsJUPfUGiun8cK7onzIbkRibbVu/kmrNG8nr2Z4GHMGpQ6KvYyGZNFIwioGMu6Q== sshca@ns2</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cat /home/sshca/server_ca.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC+ZP47AOiRPcakZiLm+szvxWF5HKNa+BauaYXt5A6XjuUUJIYXXdTdzrq+d4rx379jxk5E+RHvPls1Y+5Cvn2/EpBgx20TXoT9+O0Nn7pemHd7qkDb2JqPzoHzjViG033L8UociItit13UVMlvB2+miW4RPMHhLjJpJT2BoWzvkBtJdukO/SA+3EYpIZAj8kyFfkp9+2A/A+OCREWoh5EkcjREAQRay+pc/j3sWDYrymu65OamPwGAe3Ih9/TmflUiwdHaNfJMY0BqpJsdFyUJeS36asjRhLtZltfLNTyY1gOq3XglLZb76YaQWOoIhzwqQ2WNSt72cY7s8p97loX5LTBSjNw6Kq0rOpKY3XmkyP2A5+L+CFxRxpl0obOkqiZqK/oT4cFE72EBaSg0XfFej19rd/AqqFSEHpbK4GjZzBAEID932DrgcR6ud74k1TDemQgWZ5dge0wEKMfeNVzUXhAPuxeIyQ6E+DxuayHIrUKZ7T36ZVz5N56TXnr+iaaejqpJfuSKZxC8YT9ZmRiHeZ+edze+R6QPiV76QUIQqzocO+OlWPHUZ2zVINV76DZARqxzZuKWW7JzA1+kTJ3VW3zGaOs53n36lfThb39ULHplsJUPfUGiun8cK7onzIbkRibbVu/kmrNG8nr2Z4GHMGpQ6KvYyGZNFIwioGMu6Q== sshca@ns2</pre>
</div>
</div>
<div class="paragraph">
<p>Observer, finalmente, que os arquivos <code>/home/sshca/user_ca.pub</code> e <code>/etc/ssh/user_ca.pub</code> também devem ser idênticos:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># diff /home/sshca/user_ca.pub /etc/ssh/user_ca.pub</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Note que tanto no caso de assinatura de chaves de <em>host</em> como de chaves de usuário, futuramente, estamos fazendo o acesso no sentido <strong>máquina remota</strong> &#8594; <strong>servidor da CA</strong>, que não é o ideal. Em produção, o correto seria tornar o acesso ao servidor da CA o mais controlado possível, e fazer as assinaturas de chaves apenas de forma local, ou com acessos no sentido <strong>servidor da CA</strong> &#8594; <strong>máquina remota</strong>.</p>
</div>
<div class="paragraph">
<p>Outro aspecto relevante de segurança que sacrificamos em nosso cenário para agilizar a execução das atividades foi a configuração das chaves privadas de assinatura de <em>hosts</em> e usuários sem senha: em produção, é altamente recomendado que essas chaves sejam criadas com senhas fortes, para mitigar a possibilidade de assinatura indevida de chaves em caso de vazamento das mesmas.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_9_automatizando_a_assinatura_de_chaves_ssh_de_usuários">9) Automatizando a assinatura de chaves SSH de usuários</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Vamos agora fazer a segunda "perna" da configuração da CA <code>ssh</code>&#8201;&#8212;&#8201;assinar chaves de usuários. Na linha da atividade anterior, iremos usar um <em>script</em> para assinar chaves de usuários; porém, como o cenário de chaves de usuário é mais flexível que o de máquinas, iremos estabelecer algumas premissas para o funcionamento do <em>script</em>:</p>
<div class="openblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Deve-se estar logado com o mesmo nome do usuário com o qual se deseja assinar a chave.</p>
</li>
<li>
<p>Deve-se ter conectividade com o servidor <code>ns2</code>, no endereço <code>10.0.42.2</code>.</p>
</li>
<li>
<p>O nome de chave será fixo (<code>~/.ssh/id_rsa</code>).</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>Devido à primeira limitação, é conveniente que o <em>script</em> esteja localizado dentro da pasta do usuário&#8201;&#8212;&#8201;e, como se sabe, ao criar novos usuários o conteúdo da pasta <code>/etc/skel</code> é copiado para dentro de seu <em>home</em>. Assim, crie a pasta <code>/etc/skel/scripts</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># mkdir /etc/skel/scripts</pre>
</div>
</div>
<div class="paragraph">
<p>Dentro dela, crie o arquivo novo, <code>/etc/skel/scripts/sshsign_user.sh</code>, com o conteúdo que se segue:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">#!/bin/bash

CA_USER="sshca"
CA_ADDR="10.0.42.2"
CA_USER_PASS="seg10sshca"
SSH_OPTS="-o PreferredAuthentications=password -o PubkeyAuthentication=no"

# testar se chave ja foi assinada
if [ -f ~/.ssh/id_rsa-cert.pub ]; then
  echo "Key already signed, bailing."
  exit 1
fi

# escanear chave do host ssh-ca, se necessario
rm -f ~/.ssh/known_hosts 2&gt; /dev/null
[ -d ~/.ssh ] || { mkdir ~/.ssh; chmod 700 ~/.ssh; }
if ! ssh-keygen -F ${CA_ADDR} 2&gt;/dev/null 1&gt;/dev/null; then
  ssh-keyscan -t rsa -T 10 ${CA_ADDR} 2&gt; /dev/null &gt;&gt; ~/.ssh/known_hosts
fi

# gerar par de chaves RSA, se inexistentes
[ -f ~/.ssh/id_rsa.pub ] || ssh-keygen -f ~/.ssh/id_rsa -t rsa -b 4096 -N '' &amp;&gt; /dev/null

# copiar pubkey RSA
sshpass -p "${CA_USER_PASS}" \
  scp ${SSH_OPTS} ~/.ssh/id_rsa.pub ${CA_USER}@${CA_ADDR}:~

# assinar pubkey RSA, validade [-5 min -&gt; 1 ano]
echo "Signing ~/.ssh/id_rsa.pub key..."
user="$( whoami )"
sshpass -p "${CA_USER_PASS}" \
  ssh ${SSH_OPTS} ${CA_USER}@${CA_ADDR} \
    ssh-keygen -s user_ca \
    -I ${user} \
    -n ${user} \
    -V -5m:+1095d \
    id_rsa.pub 2&gt; /dev/null

# copiar pubkey assinada de volta
sshpass -p "${CA_USER_PASS}" \
  scp ${SSH_OPTS} ${CA_USER}@${CA_ADDR}:~/id_rsa-cert.pub ~/.ssh/

# remover temporarios do diretorio remoto
sshpass -p "${CA_USER_PASS}" \
  ssh ${SSH_OPTS} ${CA_USER}@${CA_ADDR} \
    rm id_rsa.pub id_rsa-cert.pub

# copiar pubkey da server_ca e configurar reconhecimento de chaves de host assinadas
echo "@cert-authority * $(sshpass -p "${CA_USER_PASS}" ssh ${SSH_OPTS} ${CA_USER}@${CA_ADDR} cat server_ca.pub)" &gt; ~/.ssh/known_hosts

# remover pubkey RSA antiga
rm -f ~/.ssh/id_rsa.pub 2&gt; /dev/null

echo "All done!"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Como o <em>script</em> guarda grandes semelhanças com o anterior, iremos destacar apenas os pontos de divergência:</p>
</div>
<div class="openblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>(Linhas 9-12) Testamos se a chave RSA do usuário já foi assinada anteriormente; se positivo, o programa se encerra.</p>
</li>
<li>
<p>(Linha 22) Caso o usuário não possua um par de chaves criado, cria-se automaticamente um par RSA de 4096 bits, sem senha.</p>
</li>
<li>
<p>(Linhas 30-37) A chave usada para assinar a chave pública do usuário desta vez é a <code>user_ca</code>. A validade é ajustada para um ano.</p>
</li>
<li>
<p>(Linha 49) De forma similar ao que foi feito anteriormente, copia-se a chave <code>server_ca.pub</code> como uma CA confiável para <em>hosts</em> remotos; a partir deste momento, logins de cliente <code>ssh</code> deste usuário para <em>hosts</em> assinados não terão que confirmar relação de confiança antes de prosseguir.</p>
</li>
</ol>
</div>
</div>
</div>
</li>
<li>
<p>Vamos testar o funcionamento do <em>script</em> com o usuário <code>luke</code>. Remova o diretório dele para garantir que o conteúdo do <code>/etc/skel</code> será copiado no próximo login:</p>
<div class="literalblock">
<div class="content">
<pre># rm -rf /home/luke</pre>
</div>
</div>
<div class="paragraph">
<p>Agora, logue como o usuário <code>luke</code> usando os comandos <code>su</code> ou <code>ssh</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ whoami ; pwd
luke
/home/luke</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ls ~/scripts
sshsign_user.sh</pre>
</div>
</div>
</li>
<li>
<p>Execute o <em>script</em>:</p>
<div class="literalblock">
<div class="content">
<pre>$ bash ~/scripts/sshsign_user.sh
Signing ~/.ssh/id_rsa.pub key...
All done!</pre>
</div>
</div>
<div class="paragraph">
<p>Note que, novamente, não foi necessário passar quaisquer parâmetros de linha de comando para o <em>script</em>. Ele utiliza o <em>username</em> do usuário informado pelo comando <code>whoami</code> como <em>principal</em> da chave.</p>
</div>
</li>
<li>
<p>Vamos verificar o funcionamento do <em>script</em>. Verifique que os arquivos de chave foram criados:</p>
<div class="literalblock">
<div class="content">
<pre>$ ls ~/.ssh/
id_rsa  id_rsa-cert.pub  known_hosts</pre>
</div>
</div>
<div class="paragraph">
<p>Cheque o conteúdo do arquivo <code>~/.ssh/known_hosts</code>, que deve conter informações da CA <code>ssh</code> para chaves de <em>host</em> assinadas:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cat ~/.ssh/known_hosts
@cert-authority * ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC+ZP47AOiRPcakZiLm+szvxWF5HKNa+BauaYXt5A6XjuUUJIYXXdTdzrq+d4rx379jxk5E+RHvPls1Y+5Cvn2/EpBgx20TXoT9+O0Nn7pemHd7qkDb2JqPzoHzjViG033L8UociItit13UVMlvB2+miW4RPMHhLjJpJT2BoWzvkBtJdukO/SA+3EYpIZAj8kyFfkp9+2A/A+OCREWoh5EkcjREAQRay+pc/j3sWDYrymu65OamPwGAe3Ih9/TmflUiwdHaNfJMY0BqpJsdFyUJeS36asjRhLtZltfLNTyY1gOq3XglLZb76YaQWOoIhzwqQ2WNSt72cY7s8p97loX5LTBSjNw6Kq0rOpKY3XmkyP2A5+L+CFxRxpl0obOkqiZqK/oT4cFE72EBaSg0XfFej19rd/AqqFSEHpbK4GjZzBAEID932DrgcR6ud74k1TDemQgWZ5dge0wEKMfeNVzUXhAPuxeIyQ6E+DxuayHIrUKZ7T36ZVz5N56TXnr+iaaejqpJfuSKZxC8YT9ZmRiHeZ+edze+R6QPiV76QUIQqzocO+OlWPHUZ2zVINV76DZARqxzZuKWW7JzA1+kTJ3VW3zGaOs53n36lfThb39ULHplsJUPfUGiunhistory8cK7onzIbkRibbVu/kmrNG8nr2Z4GHMGpQ6KvYyGZNFIwioGMu6Q== sshca@ns2</pre>
</div>
</div>
</li>
<li>
<p>Agora sim, vamos testar. Tente logar na máquina local usando o endereço IP ou <em>hostname</em> (o endereço especial <em>localhost</em> não é registrado como um <em>principal</em> válido na chave de <em>host</em>).</p>
<div class="literalblock">
<div class="content">
<pre>$ ssh luke@ns2
Linux ns2 4.9.0-8-amd64 #1 SMP Debian 4.9.130-2 (2018-10-27) x86_64

Last login: Tue Nov 13 18:40:31 2018 from ::1
luke@ns2:~$</pre>
</div>
</div>
<div class="paragraph">
<p>Perfeito! Não tivemos que digitar a senha do usuário ou confirmar a relação de confiança com o servidor, como esperado.</p>
</div>
</li>
<li>
<p>Todos as características do sistema que queríamos testar estão funcionais. Claro que devemos levar em consideração que todos os testes foram feitos dentro da máquina <code>ns2</code>&#8201;&#8212;&#8201;não testamos o funcionamento de contas de usuário via LDAP na rede, ou a autenticação de login remoto usando a CA do <code>ssh</code>.</p>
<div class="paragraph">
<p>Retorne ao usuário <code>root</code> na máquina <code>ns2</code> e remova o diretório do usuário <code>luke</code>. Vamos prosseguir com a configuração do <em>template</em> e de um cliente Linux para testar as funcionalidades.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
ns2
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># rm -rf /home/luke</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_10_configurando_o_template_para_funcionar_com_ldapssh_ca">10) Configurando o template para funcionar com LDAP/SSH-CA</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Como mencionado anteriormente, iremos configurar a VM <code>debian-template</code> para funcionar com os sistemas de autenticação do LDAP e SSH-CA. Assim, todas as máquinas que forem derivadas futuramente desse <em>template</em> estarão automaticamente integradas com o sistema de autenticação do nosso <em>datacenter</em> hipotético.</p>
<div class="paragraph">
<p>Ligue a VM <code>debian-template</code> e faça login como o usuário <code>root</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
debian-template
root</pre>
</div>
</div>
</li>
<li>
<p>Crie o arquivo novo <code>/root/scripts/sshsign.sh</code>, e cole dentro dele o conteúdo do <em>script</em> que discutimos no passo (1) da atividade (8).</p>
<div class="literalblock">
<div class="content">
<pre># nano /root/scripts/sshsign.sh
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ls /root/scripts/
changehost.sh  sshsign.sh  syncdirs.sh</pre>
</div>
</div>
</li>
<li>
<p>Agora, crie o diretório <code>/etc/skel/scripts</code>, e dentro dele crie o arquivo novo <code>/etc/skel/scripts/sshsign_user.sh</code>, com conteúdo idêntico ao do <em>script</em> que foi apresentado no passo (1) da atividade (9).</p>
<div class="literalblock">
<div class="content">
<pre># mkdir /etc/skel/scripts</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nano /etc/skel/scripts/sshsign_user.sh
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ls /etc/skel/scripts/
sshsign_user.sh</pre>
</div>
</div>
</li>
<li>
<p>Instale as dependências para funcionamento dos <em>scripts</em> criados anteriormente e também para integração do sistema de autenticação PAM com o LDAP.</p>
<div class="literalblock">
<div class="content">
<pre># apt-get install sshpass nslcd</pre>
</div>
</div>
<div class="paragraph">
<p>Durante a instalação do pacote <code>nslcd</code>, informe as seguintes opções:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Configurações do pacote nslcd</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pergunta</th>
<th class="tableblock halign-left valign-top">Opção</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">URI do servidor LDAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ldap://ldap.intnet/</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base de buscas do servidor LDAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dc=intnet</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serviços de nome para configurar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">passwd, group, shadow</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Assim como configurado antes, informe ao PAM que diretórios <em>home</em> inexistentes de usuários do LDAP devem ser criados automaticamente. Crie o arquivo novo <code>/usr/share/pam-configs/mkhomedir</code>, e cole dentro dele o conteúdo do arquivo discutido durante o passo (1) da atividade (6).</p>
<div class="literalblock">
<div class="content">
<pre># nano /usr/share/pam-configs/mkhomedir
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># pam-auth-update</pre>
</div>
</div>
<div class="paragraph">
<p>Durante a configuração do PAM, na pergunta "Perfis PAM para habilitar", mantenha todas as caixas marcadas e selecione OK.</p>
</div>
</li>
<li>
<p>Finalmente, vamos alterar o <em>script</em> <code>/root/scripts/changehost.sh</code>, criado durante a sessão (1) deste curso, para invocar automaticamente o <em>script</em> <code>/root/scripts/sshsign.sh</code> ao final e reiniciar os <em>daemons</em> do <code>nslcd</code> e <code>nscd</code>. Altere o conteúdo deste arquivo para:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">#!/bin/bash


# exibir uso do script e sair
function usage() {
  echo "  Usage: $0 -h HOSTNAME -i IPADDR -g GATEWAY"
  echo "  Netmask is assumed as /24."
  exit 1
}


# testar sintaxe valida de HOSTNAME
function valid_host() {
  if [[ "$nhost" =~ [^a-z0-9-] ]]; then
    echo "  [*] HOSTNAME must be lowercase alphanumeric: [a-z0-9]*"
    usage
  elif [ ${#nhost} -gt 63 ]; then
    echo "  [*] HOSTNAME must have &lt;63 chars"
    usage
  fi
}


# testar sintaxe valida de IPADDR/GATEWAY
function valid_ip() {
  local  ip=$1
  local  stat=1

  if [[ $ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
    OIFS=$IFS
    IFS='.'
    ip=($ip)
    IFS=$OIFS
    [[ ${ip[0]} -le 255 &amp;&amp; \
       ${ip[1]} -le 255 &amp;&amp; \
       ${ip[2]} -le 255 &amp;&amp; \
       ${ip[3]} -le 255 ]]
        stat=$?
  fi

  if [ $stat -ne 0 ] ; then
    echo "  [*] Invalid syntax for $2"
    usage
  fi
}


while getopts ":g:h:i:" opt; do
  case "$opt" in
    g)
      ngw=${OPTARG}
      ;;
    h)
      nhost=${OPTARG}
      ;;
    i)
      nip=${OPTARG}
      ;;
    *)
      usage
      ;;
  esac
done

# testar se parametros foram informados
[ -z $ngw ]   &amp;&amp; { echo "  [*] No gateway?"; usage; }
[ -z $nhost ] &amp;&amp; { echo "  [*] No hostname?"; usage; }
[ -z $nip ]   &amp;&amp; { echo "  [*] No ipaddr?"; usage; }

# testar sintaxe de parametros
valid_ip $nip "IPADDR"
valid_ip $ngw "GATEWAY"
valid_host $nhost

# alterar endereco ip/gateway
iff="/etc/network/interfaces"
cip="$( egrep '^address ' $iff | awk -F'[ /]' '{print $2}' )"
cgw="$( egrep '^gateway ' $iff | awk '{print $NF}' )"
sed -i "s|${cip}|${nip}|g" $iff
sed -i "s|${cgw}|${ngw}|g" $iff
ip addr flush label 'enp0s*'

# alterar hostname local
chost="$( hostname -s )"
sed -i "s/${chost}/${nhost}/g" /etc/hosts
sed -i "s/${chost}/${nhost}/g" /etc/hostname

invoke-rc.d hostname.sh restart
invoke-rc.d networking restart
hostnamectl set-hostname $nhost

# assinar chaves SSH
bash /root/scripts/sshsign.sh

# reiniciar sistema de autenticacao LDAP
systemctl restart nslcd.service
systemctl restart nscd.service

for table in `ls -1 /var/cache/nscd` ; do
  nscd --invalidate $table
done</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ao invocar este <em>script</em> após a criação de uma nova VM, iremos não apenas alterar seu endereço IP, <em>gateway</em> e <em>hostname</em> mas também integrá-la com o sistema de autenticação remota do LDAP e SSH-CA em um único comando, como veremos a seguir.</p>
</div>
<div class="paragraph">
<p>Findo este passo, desligue a máquina <code>debian-template</code>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_11_ajuste_das_regras_de_firewall">11) Ajuste das regras de firewall</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Observando os acessos feitos pelo <em>script</em> em <code>/root/scripts/sshsign.sh</code>, note que a máquina efetuando as assinaturas de chave necessita conseguir alcançar a máquina <code>ns2</code> pela rede, e logar via SSH com o usuário <code>sshca</code>. Mais além, as autenticações via rede são feitas junto ao servidor OpenLDAP, operando com o <em>daemon</em> <code>slapd</code>. Nenhum desses requisitos foi previsto em nossas regras de firewall originais, então temos que ajustá-las para permitir que máquinas da DMZ e Intranet consigam realizar esses acessos.</p>
<div class="paragraph">
<p>Vamos listar os requerimentos de regras:</p>
</div>
<div class="openblock">
<div class="content">
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>Máquinas na DMZ devem conseguir acessar a máquina <code>ns2</code> nas portas 22/TCP (SSH) e 389/TCP (LDAP). Como essas máquinas estão todas na mesma sub-rede, os acessos não passam pelo firewall e nenhuma configuração adicional se faz necessária.</p>
</li>
<li>
<p>Máquinas na Intranet devem conseguir acessar a máquina <code>ns2</code> nas portas 22/TCP (SSH) e 389/TCP (LDAP). Como esse tráfego passa <strong>através do</strong> firewall, devemos inserir regras na <em>chain</em> FORWARD.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>Logue como <code>root</code> na máquina <code>ns1</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
ns1
root</pre>
</div>
</div>
<div class="paragraph">
<p>Basta criar uma regra para atender o requisito (b), como se segue:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A FORWARD -s 192.168.42.0/24 -d 10.0.42.2/32 -p tcp -m multiport --dports 22,389 -j ACCEPT</pre>
</div>
</div>
<div class="paragraph">
<p>Salve as regras na configuração do firewall local:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># /etc/init.d/netfilter-persistent save
[....] Saving netfilter rules...run-parts: executing /usr/share/netfilter-persistent/plugins.d/15-ip4tables save
run-parts: executing /usr/share/netfilter-persistent/plugins.d/25-ip6tables save
done.</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_12_configurando_um_cliente_linux">12) Configurando um cliente Linux</h3>
<div class="paragraph">
<p>Nesta atividade iremos criar uma máquina cliente Linux para utilizarmos como ponto de partida para os logins <code>ssh</code> nos diferentes servidores que configuraremos durante este curso. O nome da máquina será <code>client</code>, alocada para a Intranet com o endereço IP 192.168.42.2/24. Iremos integrá-la com os sistemas de autenticação do LDAP e SSH-CA, e testar login remoto na máquina <code>ns2</code>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Clone a máquina <code>debian-template</code> seguindo os mesmos passos da atividade (6) da sessão 1. Para o nome da máquina, escolha <code>client</code>.</p>
</li>
<li>
<p>Após a clonagem, na janela principal do Virtualbox, clique com o botão direito sobre a VM <code>client</code> e depois em <em>Settings</em>.</p>
<div class="paragraph">
<p>Em <em>Network</em> &gt; <em>Adapter 1</em> &gt; <em>Attached to</em> &gt; <em>Host-only Adapter</em>, altere o nome da rede <em>host-only</em> para o mesmo da interface da VM <code>ns1</code> que está alocada à Intranet. Seguindo o exemplo mostrado no início da sessão 2, a rede escolhida seria a <code>Virtualbox Host-Only Ethernet Adapter #3</code>.</p>
</div>
<div class="paragraph">
<p>Clique em <em>OK</em>, e ligue a máquina <code>client</code>.</p>
</div>
</li>
<li>
<p>Logue como o usuário <code>root</code>&#8201;&#8212;&#8201;o primeiro login poderá demorar um pouco até que a tentativa de autenticação via rede no servidor LDAP, neste momento inatingível, incorra em <em>timeout</em>. Feito o login, use o script <code>/root/scripts/changehost.sh</code> para configurar a máquina de forma automática:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
debian-template
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># bash ~/scripts/changehost.sh -h client -i 192.168.42.2 -g 192.168.42.1
Signing ssh_host_ecdsa_key.pub key...
Signing ssh_host_ed25519_key.pub key...
Signing ssh_host_rsa_key.pub key...
Configuring host key trust...
Configuring user key trust...
All done!</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
client</pre>
</div>
</div>
</li>
<li>
<p>Se tudo tiver funcionado corretamente, a máquina <code>client</code> já estará integrada aos sistemas de autenticação LDAP e SSH-CA. Faça login como o usuário <code>luke</code> usando os comandos <code>su</code> ou <code>ssh</code>:</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami ; pwd
client
luke
/home/luke</pre>
</div>
</div>
</li>
<li>
<p>Vamos criar um par de chaves para esse usuário e assiná-las. Como o conteúdo do diretório <em>home</em> foi copiado diretamente do <code>/etc/skel</code>, temos à disposição o <em>script</em> para essa tarefa na pasta <code>~/scripts/sshsign_user.sh</code>. Execute-o:</p>
<div class="literalblock">
<div class="content">
<pre>$ bash ~/scripts/sshsign_user.sh
Signing ~/.ssh/id_rsa.pub key...
All done!</pre>
</div>
</div>
</li>
<li>
<p>Vamos testar? Tente logar usando o usuário <code>luke</code> na máquina <code>ns2</code>:</p>
<div class="literalblock">
<div class="content">
<pre>$ ssh luke@ns2
Creating directory '/home/luke'.
Linux ns2 4.9.0-8-amd64 #1 SMP Debian 4.9.130-2 (2018-10-27) x86_64

Last login: Tue Nov 13 21:05:01 2018 from 127.0.0.1
luke@ns2:~$</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami ; pwd
ns2
luke
/home/luke</pre>
</div>
</div>
<div class="paragraph">
<p>Excelente! Conseguimos logar sem ter que confirmar a relação de confiança com o servidor e sem digitar senha, como esperado.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_13_configurando_o_firewall_para_funcionar_com_ldapssh_ca">13) Configurando o firewall para funcionar com LDAP/SSH-CA</h3>
<div class="paragraph">
<p>Suponha, agora, que queremos integrar o firewall no sistema de autenticação LDAP/SSH-CA, mas com um maior nível de restrição. Sendo uma máquina crítica, não podemos permitir que qualquer usuário faça login nessa máquina, sendo necessário implementar controles mais estritos.</p>
</div>
<div class="paragraph">
<p>O primeiro passo, naturalmente, é fazer a integração com os sistemas de autenticação. Vamos fazer isso:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Logue como usuário <code>root</code> na máquina <code>ns1</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
ns1
root</pre>
</div>
</div>
</li>
<li>
<p>Instale as dependências para funcionamento dos <em>scripts</em> e integração do sistema de autenticação.</p>
<div class="literalblock">
<div class="content">
<pre># apt-get install sshpass nslcd</pre>
</div>
</div>
<div class="paragraph">
<p>Novamente, durante a instalação do pacote <code>nslcd</code>, informe as seguintes opções:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Configurações do pacote nslcd</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pergunta</th>
<th class="tableblock halign-left valign-top">Opção</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">URI do servidor LDAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ldap://ldap.intnet/</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base de buscas do servidor LDAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dc=intnet</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serviços de nome para configurar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">passwd, group, shadow</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Configure a criação automática de diretórios, com o arquivo novo <code>/usr/share/pam-configs/mkhomedir</code>. Para maior conveniência, você pode copiar o arquivo diretamente da máquina <code>ns2</code> para o local apropriado usando o comando <code>scp</code>, como se segue:</p>
<div class="literalblock">
<div class="content">
<pre># scp -o StrictHostKeyChecking=no aluno@ns2:/usr/share/pam-configs/mkhomedir /usr/share/pam-configs/
Warning: Permanently added 'ns2,10.0.42.2' (ECDSA) to the list of known hosts.
aluno@ns2's password:
mkhomedir                                                                          100%  170   449.4KB/s   00:00</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># pam-auth-update</pre>
</div>
</div>
<div class="paragraph">
<p>Durante a configuração do PAM, na pergunta "Perfis PAM para habilitar", mantenha todas as caixas marcadas e selecione OK.</p>
</div>
</li>
<li>
<p>Crie o arquivo novo <code>/root/scripts/sshsign.sh</code> e cole o conteúdo do <em>script</em> de assinatura de chaves de <em>host</em> que utilizamos anteriormente:</p>
<div class="literalblock">
<div class="content">
<pre># nano /root/scripts/sshsign.sh
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ls /root/scripts/
changehost.sh  signzone-intnet.sh  sshsign.sh  syncdirs.sh</pre>
</div>
</div>
<div class="paragraph">
<p>Execute-o:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># bash ~/scripts/sshsign.sh
Signing ssh_host_ecdsa_key.pub key...
Signing ssh_host_ed25519_key.pub key...
Signing ssh_host_rsa_key.pub key...
Configuring host key trust...
Configuring user key trust...
All done!</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_14_restringindo_login_por_grupos_e_usuários">14) Restringindo login por grupos e usuários</h3>
<div class="paragraph">
<p>Agora sim, com a integração concluída, imagine o seguinte cenário: não queremos que usuários do grupo <code>sysadm</code>, do qual faz parte o usuário <code>luke</code>, possam logar no firewall. Esse permissão será dada apenas a membros do grupo <code>fwadm</code>, que criaremos a seguir. Um desses usuários é o colaborador <code>han</code>, cuja senha será <code>seg10han</code>. Como configurar esse tipo de restrição?</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Primeiro, vamos criar o grupo e usuário. Logue na máquina <code>ns2</code> como usuário <code>root</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
ns2
root</pre>
</div>
</div>
</li>
<li>
<p>Crie o grupo:</p>
<div class="literalblock">
<div class="content">
<pre># ldapaddgroup fwadm
Successfully added group fwadm to LDAP</pre>
</div>
</div>
<div class="paragraph">
<p>Usuário:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapadduser han fwadm
Successfully added user han to LDAP
Successfully set password for user han</pre>
</div>
</div>
<div class="paragraph">
<p>Adicione o usuário ao grupo:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapaddusertogroup han fwadm
Successfully added user han to group cn=fwadm,ou=Groups,dc=intnet</pre>
</div>
</div>
<div class="paragraph">
<p>E, finalmente, configure a senha do usuário <code>han</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ldapsetpasswd han
Changing password for user uid=han,ou=People,dc=intnet
New Password:
Retype New Password:
Successfully set password for user uid=han,ou=People,dc=intnet</pre>
</div>
</div>
</li>
<li>
<p>De volta ao firewall, como usuário <code>root</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
ns1
root</pre>
</div>
</div>
<div class="paragraph">
<p>Edite o arquivo <code>/etc/nslcd.conf</code>, configurando a opção <code>pam_authz_search</code>. Essa opção permite que sejam definidos filtros de busca para o <code>nslcd</code>, através dos quais podemos restringir que usuários e/ou grupos podem logar na máquina local. No caso, queremos que apenas membros do grupo <code>fwadm</code> possam logar, portanto adicionamos a seguinte linha ao final do arquivo:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># echo 'pam_authz_search (&amp;(objectClass=posixGroup)(cn=fwadm)(memberUid=$username))' &gt;&gt; /etc/nslcd.conf</pre>
</div>
</div>
<div class="paragraph">
<p>Podemos customizar o filtro acima para incluir apenas usuários específicos, ou mesmo DNs que possuam um atributo qualquer (por exemplo, e-mails com um determinado sufixo). Tome sempre cuidado para não filtrar todos os usuários disponíveis no LDAP acidentalmente&#8201;&#8212;&#8201;é importante, nesses casos, sempre manter uma conta local (como <code>aluno</code> ou <code>root</code>, no nosso caso específico) com acesso ao sistema.</p>
</div>
<div class="paragraph">
<p>Reinicie os serviços do <code>nslcd</code> e <code>nscd</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl restart nslcd.service</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl restart nscd.service</pre>
</div>
</div>
<div class="paragraph">
<p>Verifique que o usuário <code>han</code> é visto como membro do grupo <code>fwadm</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># groups han
han : fwadm</pre>
</div>
</div>
<div class="paragraph">
<p>Ocasionalmente, reiniciar o <code>nscd</code> não é suficiente para que ele detecte novas alterações na base de usuários/grupos do LDAP. Nesse caso, podemos invalidar as <em>caches</em> das tabelas do <code>nscd</code> com o comando:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># nscd --invalidate TABLE</pre>
</div>
</div>
<div class="paragraph">
<p>As tabelas disponíveis podem ser consultadas na página de manual do <code>nscd</code>, ou vistas diretamente dentro da pasta <code>/var/cache/nscd</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ls -1 /var/cache/nscd/
group
hosts
netgroup
passwd
services</pre>
</div>
</div>
<div class="paragraph">
<p>Para invalidar todas as <em>caches</em> do <code>nscd</code>, podemos executar por exemplo:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># for table in `ls -1 /var/cache/nscd` ; do nscd --invalidate $table ; done</pre>
</div>
</div>
</li>
<li>
<p>Vamos testar a efetividade do controle aplicado. Na máquina <code>client</code>, faça login como o usuário <code>luke</code>:</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami
client
luke</pre>
</div>
</div>
<div class="paragraph">
<p>Tente logar via <code>ssh</code> na máquina <code>ns1</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ssh luke@ns1
LDAP authorisation check failed
Authentication failed.</pre>
</div>
</div>
<div class="paragraph">
<p>Como o usuário <code>luke</code> não pertence ao grupo <code>fwadm</code>, o acesso é negado. Observando o log de <em>debug</em> do <code>nslcd</code>, podemos ver que a pesquisa com o filtro aplicado anteriormente não retorna resultados:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>nslcd: [95f874] &lt;authz="luke"&gt; DEBUG: trying pam_authz_search "(&amp;(objectClass=posixGroup)(cn=fwadm)(memberUid=luke))"
nslcd: [95f874] &lt;authz="luke"&gt; DEBUG: myldap_search(base="dc=intnet", filter="(&amp;(objectClass=posixGroup)(cn=fwadm)(memberUid=luke))")
nslcd: [95f874] &lt;authz="luke"&gt; DEBUG: ldap_result(): end of results (0 total)
nslcd: [95f874] &lt;authz="luke"&gt; pam_authz_search "(&amp;(objectClass=posixGroup)(cn=fwadm)(memberUid=luke))" found no matches</pre>
</div>
</div>
</li>
<li>
<p>Vamos fazer o mesmo procedimento com o usuário <code>han</code>. Logue-se como <code>han</code> na máquina <code>client</code>:</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami
client
han</pre>
</div>
</div>
<div class="paragraph">
<p>Como é a primeira vez que estamos usando este usuário, gere um par de chaves assinadas para ele:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ bash ~/scripts/sshsign_user.sh
Signing ~/.ssh/id_rsa.pub key...
All done!</pre>
</div>
</div>
<div class="paragraph">
<p>Tente logar via <code>ssh</code> na máquina <code>ns1</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ssh han@ns1
Creating directory '/home/han'.
Linux ns1 4.9.0-8-amd64 #1 SMP Debian 4.9.130-2 (2018-10-27) x86_64

han@ns1:~$</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami ; pwd
ns1
han
/home/han</pre>
</div>
</div>
<div class="paragraph">
<p>Observando o log de <em>debug</em> do <code>nslcd</code>, podemos ver que a pesquisa com o filtro aplicado anteriormente retorna como resultado o grupo <code>cn=fwadm,ou=Groups,dc=intnet</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>nslcd: [138641] &lt;authz="han"&gt; DEBUG: trying pam_authz_search "(&amp;(objectClass=posixGroup)(cn=fwadm)(memberUid=han))"
nslcd: [138641] &lt;authz="han"&gt; DEBUG: myldap_search(base="dc=intnet", filter="(&amp;(objectClass=posixGroup)(cn=fwadm)(memberUid=han))")
nslcd: [138641] &lt;authz="han"&gt; DEBUG: ldap_result(): cn=fwadm,ou=Groups,dc=intnet
nslcd: [138641] &lt;authz="han"&gt; DEBUG: pam_authz_search found "cn=fwadm,ou=Groups,dc=intnet"</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_15_restringindo_logins_ssh_apenas_via_chaves_assimétricas">15) Restringindo logins SSH apenas via chaves assimétricas</h3>
<div class="paragraph">
<p>Apesar de o controle que aplicamos na atividade anterior ser interessante, ainda não resolvemos o problema completamente. Como é possível tentar login na máquina <code>ns1</code> usando senha, é possível que um atacante tente login por força-bruta, adivinhando a senha do usuário <code>han</code>, até conseguir. Vamos resolver isso.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Primeiro, vamos constatar o problema. Logue na máquina <code>client</code> como o usuário <code>han</code>:</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami
client
han</pre>
</div>
</div>
<div class="paragraph">
<p>Para evitar que o cliente <code>ssh</code> use nossa chave assinada, passe as opções abaixo para o comando. Em seguida, digite a senha correta do usuário <code>han</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ssh -o PreferredAuthentications=keyboard-interactive,password -o PubkeyAuthentication=no han@ns1
han@ns1's password:
Linux ns1 4.9.0-8-amd64 #1 SMP Debian 4.9.130-2 (2018-10-27) x86_64

Last login: Wed Nov 14 00:26:13 2018 from 192.168.42.2
han@ns1:~$</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami
ns1
han</pre>
</div>
</div>
<div class="paragraph">
<p>Note que conseguimos fazer o login usando senha normalmente, sem usar a chave assinada pela CA.</p>
</div>
</li>
<li>
<p>Logue como <code>root</code> na máquina <code>ns1</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
ns1
root</pre>
</div>
</div>
<div class="paragraph">
<p>Iremos aplicar o controle sobre a opção <code>PasswordAuthentication</code> do <code>sshd</code>, desativando-o. Assim, não será mais possível logar via senha, apenas via chaves assimétricas. Execute o comando abaixo:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># sed -i 's/^#\(PasswordAuthentication\).*/\1 no/' /etc/ssh/sshd_config</pre>
</div>
</div>
<div class="paragraph">
<p>E reinicie o <code>sshd</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl restart sshd.service</pre>
</div>
</div>
</li>
<li>
<p>De volta à máquina <code>client</code>, como <code>han</code>:</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami
client
han</pre>
</div>
</div>
<div class="paragraph">
<p>Tente novamente logar usando senha:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ssh -o PreferredAuthentications=keyboard-interactive,password -o PubkeyAuthentication=no han@ns1
Permission denied (publickey).</pre>
</div>
</div>
<div class="paragraph">
<p>Note que a permissão foi negada, pois apenas o método <code>publickey</code> é aceito para autenticação. Remova as opções do <code>ssh</code> e tente novamente, desta vez usando chaves:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ssh han@ns1
Linux ns1 4.9.0-8-amd64 #1 SMP Debian 4.9.130-2 (2018-10-27) x86_64

Last login: Wed Nov 14 00:27:39 2018 from 192.168.42.2
han@ns1:~$</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami
ns1
han</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_16_bloqueando_tentativas_de_brute_force_contra_o_ssh">16) Bloqueando tentativas de brute force contra o SSH</h3>
<div class="paragraph">
<p>Não podemos aplicar o mesmo tipo de controle que fizemos na máquina <code>ns1</code> (o firewall da rede) no servidor <code>ns2</code> (o servidor LDAP)&#8201;&#8212;&#8201;nosso <em>script</em> de assinatura de chaves de <em>host</em> e de usuário utiliza login via senha com o usuário <code>sshca</code> para operar. A alteração dos <em>scripts</em> para usarem chaves e a correspondente restrição a login usando senhas teria implicações muito negativas na segurança do sistema, neste momento. Vamos implementar um controle diferente, então: proteção contra ataques de força-bruta usando a ferramenta Fail2ban.</p>
</div>
<div class="paragraph">
<p>O Fail2ban opera através da análise de eventos de log (normalmente registrados no diretório <code>/var/log</code>) e seu processamento através de expressões regulares. Caso um evento "case" (ou seja, ocorra um <em>match</em>) com uma expressão regular configurada, o Fail2ban irá adicionar uma unidade ao contador de violações de um determinado <em>host</em> remoto. Se esse <em>host</em> ultrapassar o número de violações configuradas em um dado período, o Fail2ban irá então tomar alguma ação configurada pelo administrador (registrar um evento nos logs, enviar um e-mail para o administrador ou até mesmo bloquear de forma automática o <em>host</em> no firewall local).</p>
</div>
<div class="paragraph">
<p>Várias expressões regulares já vêm pré-configuradas no Fail2ban, para as ferramentas mais populares (como o <code>sshd</code>, o servidor web Apache ou o servidor SMTP Postfix). Caso se deseje configurar expressões regulares para ferramentas customizadas, também é possível fazê-lo.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Logue como o usuário <code>root</code> na máquina <code>ns2</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
ns2
root</pre>
</div>
</div>
</li>
<li>
<p>Instale a ferramenta <code>fail2ban</code>:</p>
<div class="literalblock">
<div class="content">
<pre># apt-get install fail2ban</pre>
</div>
</div>
</li>
<li>
<p>Note que, por padrão, apenas a <em>jail</em> <code>sshd</code> vem habilitada no Debian. Não teremos que fazer qualquer alteração nesse sentido, já que é justamente o serviço <code>ssh</code> que queremos proteger.</p>
<div class="literalblock">
<div class="content">
<pre># cat /etc/fail2ban/jail.d/defaults-debian.conf
[sshd]
enabled = true</pre>
</div>
</div>
</li>
<li>
<p>As opções padrão do Fail2ban ficam configuradas no arquivo <code>/etc/fail2ban/jail.conf</code>, seção <code>[DEFAULT]</code>. Em particular, temos interesse nas seguintes configurações:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>findtime</code>: Intervalo em que o Fail2ban irá registrar violações de <em>hosts</em> remotos.</p>
</li>
<li>
<p><code>maxretry</code>: Número de violações máximo permitido dentro do período <code>findtime</code> definido acima. Caso este valor seja ultrapassado, o Fail2ban irá tomar a ação configurada pelo administrador.</p>
</li>
<li>
<p><code>bantime</code>: Período em que o <em>host</em> remoto será afetado pela ação configurada. Caso esta ação seja, por exemplo, um bloqueio no firewall local, o <em>host</em> ficará banido pelo tempo especificado aqui.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Os valores padrão para as variáveis acima são os que se seguem:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># cat /etc/fail2ban/jail.conf | sed -n -e '/^\[DEFAULT\]/,/^\[/p' | grep '^maxretry\|^bantime\|^findtime'
bantime  = 600
findtime  = 600
maxretry = 5</pre>
</div>
</div>
</li>
<li>
<p>Vamos configurar o seguinte cenário: caso um atacante seja detectado pelo Fail2ban com mais de 3 violações (<code>maxretry</code>) num período de dez minutos (<code>findtime</code>), então iremos bani-lo via regra no firewall local (ação <code>iptables-multiport</code>) por dez minutos (<code>bantime</code>). Como o <code>findtime</code> e o <code>bantime</code> padrão estão corretos, iremos apenas configurar as duas outras variáveis, como se segue:</p>
<div class="literalblock">
<div class="content">
<pre># echo "maxretry = 3" &gt;&gt; /etc/fail2ban/jail.d/defaults-debian.conf</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># echo "banaction = iptables-multiport" &gt;&gt; /etc/fail2ban/jail.d/defaults-debian.conf</pre>
</div>
</div>
<div class="paragraph">
<p>O arquivo <code>/etc/fail2ban/jail.d/defaults-debian.conf</code> ficou assim, portanto:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># cat /etc/fail2ban/jail.d/defaults-debian.conf
[sshd]
enabled = true
maxretry = 3
banaction = iptables-multiport</pre>
</div>
</div>
</li>
<li>
<p>Uma outra configuração necessária é comentar uma linha do arquivo <code>/etc/fail2ban/filter.d/sshd.conf</code> que contém uma expressão regular para detectar entradas no seguinte formato no arquivo <code>/var/log/auth.log</code>:</p>
<div class="literalblock">
<div class="content">
<pre>Oct 30 12:03:47 ldap sshd[6677]: pam_unix(sshd:auth): authentication failure; logname= uid=0 euid=0 tty=ssh ruser= rhost=192.168.42.2  user=sshca</pre>
</div>
</div>
<div class="paragraph">
<p>Em sistemas com autenticação LDAP, como é o nosso caso, a linha acima é inserida em tentativas de login mesmo em caso de sucesso, como reportado em <a href="https://github.com/fail2ban/fail2ban/issues/106" class="bare">https://github.com/fail2ban/fail2ban/issues/106</a> . Para corrigir esse falso positivo, basta executar:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># sed -i 's/^\(.*pam_unix.*\)/#\1/' /etc/fail2ban/filter.d/sshd.conf</pre>
</div>
</div>
</li>
<li>
<p>Reinicie o Fail2ban para aplicar as configurações que realizamos:</p>
<div class="literalblock">
<div class="content">
<pre># systemctl restart fail2ban.service</pre>
</div>
</div>
</li>
<li>
<p>O Fail2ban criará novas <em>chains</em> no firewall para inserção de regras de banimento, quando adequado. Observe que o firewall está, até este momento, sem regras de BLOCK ou REJECT:</p>
<div class="literalblock">
<div class="content">
<pre># iptables -L -vn
Chain INPUT (policy ACCEPT 37 packets, 5021 bytes)
 pkts bytes target     prot opt in     out     source               destination
   26  1820 f2b-sshd   tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            multiport dports 22

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 13 packets, 1152 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain f2b-sshd (1 references)
 pkts bytes target     prot opt in     out     source               destination
   26  1820 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0</pre>
</div>
</div>
<div class="paragraph">
<p>Agora, vamos fazer uma simulação de ataque ao <code>sshd</code>. Monitore o arquivo <code>/var/log/fail2ban.log</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># tail -n5 -f /var/log/fail2ban.log
2018-11-14 00:31:44,246 fail2ban.filter         [2099]: INFO    Set findtime = 600
2018-11-14 00:31:44,246 fail2ban.filter         [2099]: INFO    Set jail log file encoding to UTF-8
2018-11-14 00:31:44,246 fail2ban.filter         [2099]: INFO    Set maxlines = 10
2018-11-14 00:31:44,277 fail2ban.server         [2099]: INFO    Jail sshd is not a JournalFilter instance
2018-11-14 00:31:44,281 fail2ban.jail           [2099]: INFO    Jail 'sshd' started</pre>
</div>
</div>
</li>
<li>
<p>Logue na máquina <code>client</code> como o usuário <code>han</code>, por exemplo:</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami
client
han</pre>
</div>
</div>
<div class="paragraph">
<p>Para disparar o filtro do Fail2ban na máquina <code>ns2</code>, não poderemos usar o login via chaves assimétricas, que obterá sucesso. Faça login usando senha como mostrado no comando a seguir; digite senhas incorretas para ativar a detecção do Fail2ban:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ssh -o PreferredAuthentications=keyboard-interactive,password -o PubkeyAuthentication=no han@ns2
han@ns2's password:
Permission denied, please try again.
han@ns2's password:
Permission denied, please try again.
han@ns2's password:
Permission denied (publickey,password).</pre>
</div>
</div>
<div class="paragraph">
<p>Tente logar novamente:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ssh -o PreferredAuthentications=keyboard-interactive,password -o PubkeyAuthentication=no han@ns2
ssh: connect to host ns2 port 22: Connection refused</pre>
</div>
</div>
<div class="paragraph">
<p>A máquina foi bloqueada, como esperado.</p>
</div>
</li>
<li>
<p>De volta à máquina <code>ns2</code>, como o usuário <code>root</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
ns2
root</pre>
</div>
</div>
<div class="paragraph">
<p>Note que os eventos de senha incorreta foram registrados pelo Fail2ban, bem como o banimento:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>2018-11-14 00:34:01,944 fail2ban.filter         [2099]: INFO    [sshd] Found 192.168.42.2
2018-11-14 00:34:04,830 fail2ban.filter         [2099]: INFO    [sshd] Found 192.168.42.2
2018-11-14 00:34:08,081 fail2ban.filter         [2099]: INFO    [sshd] Found 192.168.42.2
2018-11-14 00:34:08,534 fail2ban.actions        [2099]: NOTICE  [sshd] Ban 192.168.42.2</pre>
</div>
</div>
<div class="paragraph">
<p>Observe que a regra de REJECT foi inserida automaticamente pelo Fail2ban no firewall local:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -L f2b-sshd -vn
Chain f2b-sshd (1 references)
 pkts bytes target     prot opt in     out     source               destination
    1    60 REJECT     all  --  *      *       192.168.42.2         0.0.0.0/0            reject-with icmp-port-unreachable
  612 70528 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0</pre>
</div>
</div>
<div class="paragraph">
<p>Para remover o banimento de um endereço IP antes que o tempo total do <code>bantime</code> tenha transcorrido, é possível usar o comando <code>fail2ban-client</code>, como mostrado a seguir:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># fail2ban-client set sshd unbanip 192.168.42.2
192.168.42.2</pre>
</div>
</div>
<div class="paragraph">
<p>Note que a regra de firewall é apagada, como esperado:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -L f2b-sshd -vn
Chain f2b-sshd (1 references)
 pkts bytes target     prot opt in     out     source               destination
  395 25992 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0</pre>
</div>
</div>
</li>
<li>
<p>De volta à máquina <code>client</code>, como <code>han</code>, podemos tentar o login via senha novamente&#8201;&#8212;&#8201;desta vez, digite a senha correta:</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami
client
han</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ssh -o PreferredAuthentications=keyboard-interactive,password -o PubkeyAuthentication=no han@ns2
han@ns2's password:
Creating directory '/home/han'.
Linux ns2 4.9.0-8-amd64 #1 SMP Debian 4.9.130-2 (2018-10-27) x86_64

han@ns2:~$</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami
ns2
han</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2018-11-19 08:36:15 -0200
</div>
</div>
</body>
</html>