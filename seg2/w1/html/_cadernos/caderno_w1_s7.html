<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.7.1">
<title>Sessão 7: Redes privadas virtuais e inspeção de tráfego</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote::before{display:none}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{word-spacing:0;line-height:1.6}
.quoteblock.abstract blockquote::before,.quoteblock.abstract p::before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="_sessão_7_redes_privadas_virtuais_e_inspeção_de_tráfego">Sessão 7: Redes privadas virtuais e inspeção de tráfego</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_1_interceptação_ofensiva_de_tráfego_https_com_o_mitmproxy">1) Interceptação ofensiva de tráfego HTTPS com o <strong><em>mitmproxy</em></strong></h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada nas máquinas virtuais <em>KaliLinux-G</em> e <em>WinClient-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Vamos usar a ferramenta <code>mitmproxy</code> para inspecionar conteúdo HTTPS na rede, através de um ataque <em>man-in-the-middle</em> usando a técnica de ARP <em>spoofing</em>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Primeiro, mova a máquina <em>KaliLinux-G</em> para a Intranet alterando o nome da interface de rede <em>host-only</em> à que ela se encontra conectada no Virtualbox. Em seguida, altere seu endereço IP para algum que ainda não está sendo utilizado na rede, como 10.1.1.30, por exemplo. Teste a conectividade com as máquinas <em>FWGW1-G</em> e <em>WinClient-G</em> (desative o firewall do Windows na máquina <em>WinClient-G</em> para permitir a troca de pacotes ICMP).</p>
<div class="literalblock">
<div class="content">
<pre># hostname
KaliLinux-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nano /etc/network/interfaces
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cat /etc/network/interfaces
source /etc/network/interfaces.d/*

auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
address 10.1.1.30/24
gateway 10.1.1.1</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl restart networking</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ip a s eth0 | grep '^ *inet '
    inet 10.1.1.30/24 brd 10.1.1.255 scope global eth0</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ping -c1 10.1.1.1
PING 10.1.1.1 (10.1.1.1) 56(84) bytes of data.
64 bytes from 10.1.1.1: icmp_seq=1 ttl=64 time=0.185 ms

--- 10.1.1.1 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.185/0.185/0.185/0.000 ms</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>root@kali:~# ping -c1 10.1.1.10
PING 10.1.1.10 (10.1.1.10) 56(84) bytes of data.
64 bytes from 10.1.1.10: icmp_seq=1 ttl=128 time=0.451 ms

--- 10.1.1.10 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.451/0.451/0.451/0.000 ms</pre>
</div>
</div>
</li>
<li>
<p>Rode o comando <code>mitmproxy</code> uma vez, para que os certificados SSL sejam auto-gerados pelo programa. Assim que iniciado, saia do programa digitando <code>q</code>, e depois <code>y</code>.</p>
</li>
<li>
<p>Copie o certificado auto-gerado no passo (2) para a raiz do servidor web Apache instalado na máquina <em>KaliLinux-G</em>. Em seguida, renomeie o arquivo <code>index.html</code> e inicie o servidor web.</p>
<div class="literalblock">
<div class="content">
<pre># cp ~/.mitmproxy/mitmproxy-ca-cert.cer /var/www/html/</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># mv /var/www/html/index.html /var/www/html/index.html.bak</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl start apache2</pre>
</div>
</div>
</li>
<li>
<p>Na máquina <em>WinClient-G</em>, instale o navegador <em>Google Chrome</em>. O <em>Internet Explorer</em> padrão disponível no Windows 7 encontra-se um pouco defasado para lidar com websites HTTPS mais modernos. Em seguida, acesse o endereço IP da máquina <em>KaliLinux-G</em> e faça o download do arquivo <code>mitmproxy-ca-cert.cer</code>, como mostrado abaixo:</p>
<div id="img-mitmproxy-dlcert" class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/mitmproxy-dlcert.png" alt="mitmproxy dlcert">
</div>
<div class="title">Figure 1. Download do certificado do mitmproxy</div>
</div>
</li>
<li>
<p>De posse do certificado, instale-o na máquina <em>WinClient-G</em>. Clique duas vezes sobre o certificado, e em seguida em <em>Abrir</em>. Na janela seguinte, clique em <em>Instalar Certificado&#8230;&#8203;</em>.</p>
<div id="img-mitmproxy-instcert1" class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/mitmproxy-instcert1.png" alt="mitmproxy instcert1">
</div>
<div class="title">Figure 2. Instalação do certificado do mitmproxy, parte 1</div>
</div>
<div class="paragraph">
<p>Clique em <em>Avançar</em>. Em seguida, marque a caixa <em>Colocar todos os certificados no repositório a seguir</em>, clique em <em>Procurar&#8230;&#8203;</em> e selecione <em>Autoridades de Certificação Raiz Confiáveis</em>.</p>
</div>
<div id="img-mitmproxy-instcert2" class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/mitmproxy-instcert2.png" alt="mitmproxy instcert2">
</div>
<div class="title">Figure 3. Instalação do certificado do mitmproxy, parte 2</div>
</div>
<div class="paragraph">
<p>Finalmente, clique em <em>Avançar</em> e em seguida em <em>Concluir</em>. Agora, o certificado do <code>mitmproxy</code> é reconhecido como um AC Raiz pelo sistema Windows. Num cenário real, o atacante teria que descobrir algum vetor de ataque <em>client-side</em> que permitisse a ele ter o acesso para copiar o certificado e instalá-lo na máquina da vítima. Aqui, como estamos em um ambiente simulado, pudemos contar com a "colaboração" do usuário-alvo.</p>
</div>
</li>
<li>
<p>De volta ao <em>KaliLinux-G</em>, pare o Apache. Em seguida, permita o repasse de pacotes no kernel, e redirecione o tráfego da vítima para o <code>mitmproxy</code>:</p>
<div class="literalblock">
<div class="content">
<pre># systemctl stop apache2</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># sysctl -w net.ipv4.ip_forward=1</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80  -j REDIRECT --to-port 8080
# iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 443 -j REDIRECT --to-port 8080</pre>
</div>
</div>
</li>
<li>
<p>Agora sim, tudo pronto para efetivarmos o ataque. Abra duas abas lado-a-lado do terminal, logado como <code>root</code>. Na primeira, execute o ARP <em>spoofing</em> com o comando:</p>
<div class="literalblock">
<div class="content">
<pre># arpspoof -i eth0 -r -t 10.1.1.10 10.1.1.1</pre>
</div>
</div>
<div class="paragraph">
<p>No segundo terminal, inicie o <code>mitmproxy</code> (em sua variante web) para iniciar o ataque <em>man-in-the-middle</em> contra a máquina <em>WinClient-G</em>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># mitmweb --mode transparent</pre>
</div>
</div>
<div class="paragraph">
<p>Depois de pouco tempo, será aberta uma janela do navegador para inspeção do tráfego.</p>
</div>
</li>
<li>
<p>Na máquina <em>WinClient-G</em>, abra o <em>Google Chrome</em> e navegue por websites HTTP e HTTPS. Note como o tráfego está sendo interceptado pelo <code>mitmproxy</code> e, no caso de conexões SSL, sendo mostrado em claro. Como um exemplo, fizemos um login no <a href="https://facebook.com" class="bare">https://facebook.com</a> com uma conta de teste&#8201;&#8212;&#8201;imediatamente, o usuário e senha são mostrados em claro na janela do <code>mitmweb</code>, na máquina <em>KaliLinux-G</em>:</p>
<div id="img-mitmproxy-password" class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/mitmproxy-password.png" alt="mitmproxy password">
</div>
<div class="title">Figure 4. Credenciais em claro no mitmweb</div>
</div>
<div class="paragraph">
<p>Em parelelo, na janela do navegador na máquina <em>WinClient-G</em>, o login no Facebook é concluído com sucesso:</p>
</div>
<div id="img-mitmproxy-fblogin" class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/mitmproxy-fblogin.png" alt="mitmproxy fblogin">
</div>
<div class="title">Figure 5. Login no facebook através do mitmproxy</div>
</div>
</li>
<li>
<p>Finalmente, retorne o ambiente de laboratório a seu estado original: pare o <code>mitmweb</code>, encerre o ARP <em>spoofing</em> e remova as regras de firewall criadas no passo (6).</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_2_inspeção_corporativa_de_tráfego_https_usando_o_squid">2) Inspeção corporativa de tráfego HTTPS usando o Squid</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada nas máquinas virtuais <em>FWGW1-G</em> e <em>WinClient-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Na atividade anterior, fizemos um ataque <em>man-in-the-middle</em> com o intuito de inspecionar tráfego HTTPS de uma vítima usando o <code>mitmproxy</code>, nos mesmos moldes que um atacante o faria no mundo real. Mas e se o objetivo for legítimo, como para inspecionar tráfego em uma rede corporativa?</p>
</div>
<div class="paragraph">
<p>Iremos utilizar a funcionalidade <em>SslBump Peek and Splice</em> (<a href="https://wiki.squid-cache.org/Features/SslPeekAndSplice" class="bare">https://wiki.squid-cache.org/Features/SslPeekAndSplice</a>) do Squid, disponível a partir da versão 3.5, para implementar um proxy HTTPS para os clientes da rede 10.1.G.0/24. Tendo em vista que a versão do Squid disponível nos repositórios do Debian 9 não está totalmente configurada para operar como um proxy SSL, iremos instalá-lo manualmente a partir do código-fonte.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Na máquina <em>FWGW1-G</em>, instale as dependências de compilação:</p>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># apt-get -y install build-essential libssl1.0-dev</pre>
</div>
</div>
</li>
<li>
<p>A seguir, faça o download do código-fonte do Squid, sua configuração, compilação e instalação através dos comandos que se seguem. O passo de compilação (<code>make</code>) pode demorar um pouco, seja paciente.</p>
<div class="literalblock">
<div class="content">
<pre># cd ~/src/</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># wget http://www.squid-cache.org/Versions/v3/3.5/squid-3.5.28.tar.gz</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># tar zxf squid-3.5.28.tar.gz ; cd squid-3.5.28</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ./configure --prefix /usr/local --with-openssl=yes --enable-ssl-crtd --without-gnutls --enable-linux-netfilter</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># make</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># make install</pre>
</div>
</div>
</li>
<li>
<p>Feito isso, faremos a configuração inicial do Squid, incluindo criação de certificados para assinatura de conexões intermediárias, criação de usuários e permissionamento. Crie um arquivo novo, <code>/root/squidconfig.sh</code>, com o seguinte conteúdo:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">#!/bin/bash

CONF_DIR="/usr/local/etc"
PRIVKEY="${CONF_DIR}/ssl/private.key"
PUBKEY="${CONF_DIR}/ssl/public.crt"
PEMFILE="${CONF_DIR}/ssl/proxy.pem"

mkdir ${CONF_DIR}/ssl
chmod 700 ${CONF_DIR}/ssl

openssl genrsa 4096 &gt; ${PRIVKEY}
openssl req -new -nodes -x509 -extensions v3_ca -days 365 -key ${PRIVKEY} -subj "/C=BR/ST=DF/L=Brasilia/O=RNP/OU=ESR/CN=fwgw1-a.esr.rnp.br" -out ${PUBKEY}
cat ${PUBKEY} ${PRIVKEY} &gt; ${PEMFILE}

mkdir /usr/local/var/lib
/usr/local/libexec/ssl_crtd -c -s /usr/local/var/lib/ssl_db

groupadd -r squid
useradd -g squid -r squid
chown squid:squid /usr/local/var/logs
chown squid:squid ${CONF_DIR}/ssl</code></pre>
</div>
</div>
<div class="paragraph">
<p>Em seguida, execute-o com:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># bash ~/squidconfig.sh</pre>
</div>
</div>
</li>
<li>
<p>O próximo passo é editar o arquivo de configuração do Squid, <code>/usr/local/etc/squid.conf</code>. O excerto abaixo mostra uma configuração válida para um proxy HTTP/HTTPS transparente que executa <em>bumping</em> (ou seja, as inspeciona via técnica <em>man-in-the-middle</em>) em todas as conexões, exceto para os domínios que constam no arquivo <code>/usr/local/etc/whitelist.txt</code>, para os quais o proxy irá fazer <em>splicing</em> (i.e., as conexões não serão inspecionadas pelo proxy, mas sim repassadas diretamente ao destino final).</p>
<div class="paragraph">
<p>O método de <em>bump</em> seletivo implementado como descrito acima é feito através da observação do campo <code>SSL::server_name</code> enviado pelo cliente durante o processo de <em>handshake</em> TLS. Nesse campo o cliente indica a qual <em>hostname</em> ele deseja se conectar, uma extensão ao protocolo TLS denominada <em>Server Name Indication</em> (SNI). Isso permite a um servidor apresentar múltiplos certificados em um mesmo endereço IP, respondendo por vários sites HTTPS diferentes. É, em essência, um conceito análogo ao <em>name-based virtual hosting</em> do HTTP/1.1, mas para o protocolo HTTPS.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># user/group to run proxy as
cache_effective_user squid
cache_effective_group squid

# local networks to proxy
acl localnet src 10.1.1.0/24

# default ACLs
acl Safe_ports port 21
acl Safe_ports port 80
acl Safe_ports port 443
acl Safe_ports port 1025-65535
acl SSL_ports port 443
acl CONNECT method CONNECT

# SSL ACLs
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl noBumpSites ssl::server_name "/usr/local/etc/whitelist.txt"

# peek @ client TLS request to find SNI
ssl_bump peek step1 all

# splice connections to servers matching whitelist
ssl_bump splice noBumpSites

# bump all other connections
ssl_bump bump

# default http_access block
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

http_access allow localnet
http_access allow localhost

http_access deny all

# listen on ports 8080/HTTP and 8443/HTTPS, both as transparent proxy
http_port 8080 intercept
https_port 8443 intercept ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/usr/local/etc/ssl/proxy.pem

coredump_dir /usr/local/var/cache/squid

refresh_pattern ^ftp:             1440  20%   10080
refresh_pattern ^gopher:          1440   0%    1440
refresh_pattern -i (/cgi-bin/|\?)    0   0%       0
refresh_pattern .                    0  20%    4320</code></pre>
</div>
</div>
<div class="paragraph">
<p>Se você for membro do grupo B, lembre-se de alterar a <code>acl</code> <code>localnet</code> no arquivo de configuração acima.</p>
</div>
</li>
<li>
<p>Vamos popular o arquivo <code>/usr/local/etc/whitelist.txt</code> com alguns domínios que não serão inspecionados. Em geral, bancos e outras informações sigilosas são bons exemplos de destinos que não devem sofrer <em>man-in-the-middle</em>, até mesmo pelas questões éticas levantadas por esse tipo de inspeção. Por exemplo:</p>
<div class="literalblock">
<div class="content">
<pre># cat /usr/local/etc/whitelist.txt
.bb.com.br
.bancobrasil.com.br
.bradesco
.caixa.gov.br
.itau.com.br
.santander.com.br</pre>
</div>
</div>
</li>
<li>
<p>Finalmente, será necessário introduzir algumas regras no firewall da máquina <em>FWGW1-G</em> para que o tráfego dos clientes seja automaticamente repassado ao proxy para tratamento. Além de regras usuais de FORWARD e MASQUERADE para permitir acesso internet através de NAT, será necessário inserir as seguintes regras:</p>
<div class="literalblock">
<div class="content">
<pre># iptables -t nat -A PREROUTING -i enp0s9 -p tcp -m tcp --dport 80 -j REDIRECT --to-port 8080
# iptables -t nat -A PREROUTING -i enp0s9 -p tcp -m tcp --dport 443 -j REDIRECT --to-port 8443
# iptables -A INPUT -s 10.1.1.0/24 -p tcp -m tcp -m multiport --dports 8080,8443 -j ACCEPT</pre>
</div>
</div>
<div class="paragraph">
<p>Com as regras acima, todo tráfego com destino à porta 80 saindo do firewall será redirecionado para <code>localhost:8080</code>, e então tratado pelo Squid. O mesmo vale para o tráfego da porta 443, que será redirecionado para <code>localhost:8443</code>. Enfim, é necessário permitir aos clientes conectar-se diretamente essas novas portas, considerando que a política padrão da chain INPUT seja DROP.</p>
</div>
</li>
<li>
<p>Concluído esses passos, inicie o Squid com o comando:</p>
<div class="literalblock">
<div class="content">
<pre># /usr/local/sbin/squid -f /usr/local/etc/squid.conf</pre>
</div>
</div>
<div class="paragraph">
<p>A partir desse momento, todo o tráfego da rede 10.1.1.0/24 será repassado ao Squid para tratamento.</p>
</div>
</li>
<li>
<p>Se você tentar navegar na internet na máquina <em>WinClient-G</em> neste momento, no entanto, irá notar que embora conexões HTTP sejam tratadas com sucesso, conexões HTTPS provavelmente irão encontrar erros na cadeia de certificação. Isso se deve ao fato de o Squid estar reescrevendo os certificados de servidor com o seu próprio, que não é reconhecido pelo cliente como válido.</p>
<div class="paragraph">
<p>Para contornar esse problema, siga os seguintes passos:</p>
</div>
<div class="openblock">
<div class="content">
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Copie o certificado <code>/usr/local/etc/ssl/public.crt</code> para a máquina <em>WinClient-G</em> (via PuTTY, WinSCP ou fazendo o download via HTTP/FTP, por exemplo).</p>
</li>
<li>
<p>Clique com o botão direito no arquivo e escolha "Instalar Certificado".</p>
</li>
<li>
<p>Clique em "Avançar".</p>
</li>
<li>
<p>Escolha "Colocar todos os certificados no repositório a seguir", e então em "Procurar&#8230;&#8203;".</p>
</li>
<li>
<p>Escolha a pasta "Autoridades de Certificação Raiz Confiáveis" e depois em "OK".</p>
</li>
<li>
<p>Clique em "Avançar", e então em "Concluir".</p>
</li>
</ol>
</div>
</div>
</div>
</li>
<li>
<p>Falta testar a configuração que fizemos. Acesse um website com HTTPS e verifique sua cadeia de certificação: o site terá sido assinado pelo proxy Squid, e não pela autoridade certificadora original. Veja, por exemplo, um acesso ao site <a href="https://twitter.com" class="bare">https://twitter.com</a> :</p>
<div id="img-squid-bump" class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/squid-bump.png" alt="squid bump">
</div>
<div class="title">Figure 6. Acesso via Squid/Bump a <a href="https://twitter.com" class="bare">https://twitter.com</a></div>
</div>
<div class="paragraph">
<p>Agora, acesse um dos websites cujo domínio consta no arquivo <code>/usr/local/etc/whitelist.txt</code>, e verifique sua cadeia certificadora: a AC que assina o certificado será a original, inalterada pelo proxy. Veja abaixo um acesso a <a href="https://www.bb.com.br" class="bare">https://www.bb.com.br</a> :</p>
</div>
<div id="img-squid-splice" class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/squid-splice.png" alt="squid splice">
</div>
<div class="title">Figure 7. Acesso via Squid/Splice a <a href="https://www.bb.com.br" class="bare">https://www.bb.com.br</a></div>
</div>
</li>
<li>
<p>Finalmente, retorne o ambiente de laboratório a seu estado original: pare o Squid (via <code>/usr/local/sbin/squid -k shutdown</code>) e remova as regras de firewall criadas no passo (6).</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_3_vpn_ssl_usando_o_openvpn">3) VPN SSL usando o OpenVPN</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada nas máquinas virtuais <em>FWGW1-G</em> e <em>WinClient-G</em>. Esta é uma atividade a ser realizada <strong>EM DUPLA</strong>, entre membros dos grupos <strong>A</strong> e <strong>B</strong>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nesta atividade, iremos configurar um servidor e um cliente para estabelecer uma sessão VPN SSL. Para o estabelecimento dessa sessão utilizaremos o OpenVPN configurado como servidor no <em>host</em> <em>FWGW1-G</em> e o cliente instalado na máquina <em>WinClient-G</em>.</p>
</div>
<div class="paragraph">
<p>A conexão será feita entre duplas, ou seja:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Máquina <em>WinClient-A</em> irá conectar-se ao servidor <em>FWGW1-B</em> de um colega, e</p>
</li>
<li>
<p>máquina <em>WinClient-B</em> irá conectar-se ao servidor <em>FWGW1-A</em> do colega.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Na máquina <em>FWGW-1-G</em>, o primeiro passo é instalar o pacote <code>openvpn</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># apt-get install openvpn</pre>
</div>
</div>
</li>
<li>
<p>Para gerar os certificados da autoridade certificadora (CA, ou <em>certificate authority</em>), <em>hosts</em> e usuários, vamos utilizar o conjunto de scripts <code>easy-rsa</code>, que acompanha o pacote do OpenVPN. Entre no diretório <code>/usr/share/easy-rsa</code>:</p>
<div class="literalblock">
<div class="content">
<pre># cd /usr/share/easy-rsa</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ln -s /usr/share/easy-rsa/openssl-1.0.0.cnf /usr/share/easy-rsa/openssl.cnf</pre>
</div>
</div>
<div class="paragraph">
<p>Agora, edite o arquivo <code>/usr/share/easy-rsa/vars</code> com os dados dos campos de certificado a serem gerados. Altere os campos <code>KEY_COUNTRY</code>, <code>KEY_PROVINCE</code>, <code>KEY_CITY</code>, <code>KEY_ORG</code>, <code>KEY_EMAIL</code> e <code>KEY_OU</code> com os dados relevantes à sua organização. Por exemplo:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># nano /usr/share/easy-rsa/vars
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># grep KEY_COUNTRY /usr/share/easy-rsa/vars -A5
export KEY_COUNTRY="BR"
export KEY_PROVINCE="DF"
export KEY_CITY="Brasilia"
export KEY_ORG="RNP"
export KEY_EMAIL="suporte@esr.rnp.br"
export KEY_OU="ESR"</pre>
</div>
</div>
<div class="paragraph">
<p>A seguir, importe o arquivo de variáveis <code>/usr/share/easy-rsa/vars</code> para o <em>shell</em> corrente:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># . /usr/share/easy-rsa/vars
NOTE: If you run ./clean-all, I will be doing a rm -rf on /usr/share/easy-rsa/keys</pre>
</div>
</div>
<div class="paragraph">
<p>Finalmente, utilize os seguintes comandos para gerar o certificado da CA:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ./clean-all</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ./build-ca
Generating a 2048 bit RSA private key
..........+++
........+++
writing new private key to 'ca.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [BR]:
State or Province Name (full name) [DF]:
Locality Name (eg, city) [Brasilia]:
Organization Name (eg, company) [RNP]:
Organizational Unit Name (eg, section) [ESR]:
Common Name (eg, your name or your server's hostname) [RNP CA]:
Name [EasyRSA]:
Email Address [suporte@esr.rnp.br]:</pre>
</div>
</div>
<div class="paragraph">
<p>Note que todos os campos já estavam com os valores corretos, então bastou apertar ENTER em cada um deles. Se não tivéssemos editado o arquivo <code>/usr/share/easy-rsa/vars</code>, cada um desses campos teria que ser digitado individualmente.</p>
</div>
</li>
<li>
<p>Para gerar o certificado do servidor OpenVPN (a máquina <em>FWGW1-G</em>), use o seguinte comando:</p>
<div class="literalblock">
<div class="content">
<pre># ./build-key-server FWGW1-A

(...)

Country Name (2 letter code) [BR]:
State or Province Name (full name) [DF]:
Locality Name (eg, city) [Brasilia]:
Organization Name (eg, company) [RNP]:
Organizational Unit Name (eg, section) [ESR]:
Common Name (eg, your name or your server's hostname) [FWGW1-A]:
Name [EasyRSA]:
Email Address [suporte@esr.rnp.br]:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:

(...)

Sign the certificate? [y/n]:y

1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Data Base Updated</pre>
</div>
</div>
<div class="paragraph">
<p>Mantenha o campo <em>A challenge password</em> vazio. Responda <code>y</code> para as perguntas <em>Sign the certificate?</em> e <em>1 out of 1 certificate requests certified, commit?</em>.</p>
</div>
</li>
<li>
<p>Vamos agora gerar o certificado do cliente. Atente-se para o fato de que o cliente do seu servidor é na realidade a máquina <em>WinClient-G</em> do seu colega, e não a sua própria (então, membros do grupo A gerarão certificados para as máquinas <em>WinClient-B</em>, e membros do grupo B gerarão para as máquinas <em>WinClient-A</em>).</p>
<div class="literalblock">
<div class="content">
<pre># ./build-key WinClient-B

(...)

Country Name (2 letter code) [BR]:
State or Province Name (full name) [DF]:
Locality Name (eg, city) [Brasilia]:
Organization Name (eg, company) [RNP]:
Organizational Unit Name (eg, section) [ESR]:
Common Name (eg, your name or your server's hostname) [WinClient-B]:
Name [EasyRSA]:
Email Address [suporte@esr.rnp.br]:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:

(...)

Sign the certificate? [y/n]:y

1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Data Base Updated</pre>
</div>
</div>
<div class="paragraph">
<p>Assim como anteriormente, mantenha o campo <em>A challenge password</em> vazio, e responda <code>y</code> para as perguntas <em>Sign the certificate?</em> e <em>1 out of 1 certificate requests certified, commit?</em>.</p>
</div>
</li>
<li>
<p>Gere os parâmetros de troca de chaves <em>Diffie-Hellman</em> com o comando abaixo. O passo de geração pode demorar um pouco, seja paciente.</p>
<div class="literalblock">
<div class="content">
<pre># ./build-dh
Generating DH parameters, 2048 bit long safe prime, generator 2
This is going to take a long time
(...)</pre>
</div>
</div>
</li>
<li>
<p>As chaves/certificados foram todos gerados no subdiretório <code>keys</code> da pasta corrente, <code>/usr/share/easy-rsa</code>. Copie-os para o diretório <code>/etc/openvpn/keys</code> (onde faremos a configuração do <em>daemon</em>) com os comandos que se seguem:</p>
<div class="literalblock">
<div class="content">
<pre># mkdir /etc/openvpn/keys</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cp keys/ca.crt /etc/openvpn/keys/
# cp keys/FWGW1-A.crt /etc/openvpn/keys/
# cp keys/FWGW1-A.key /etc/openvpn/keys/
# cp keys/dh2048.pem /etc/openvpn/keys/</pre>
</div>
</div>
</li>
<li>
<p>Agora, vamos fazer a configuração do OpenVPN. Crie um arquivo novo, <code>/etc/openvpn/openvpn.conf</code>, com o seguinte conteúdo:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">port 1194
proto udp
dev tun

ca   /etc/openvpn/keys/ca.crt
key  /etc/openvpn/keys/FWGW1-A.key
cert /etc/openvpn/keys/FWGW1-A.crt
dh   /etc/openvpn/keys/dh2048.pem

server 10.8.1.0 255.255.255.0
ifconfig-pool-persist ipp.txt

push "route 10.1.1.0 255.255.255.0"
push "route 172.16.1.0 255.255.255.0"

keepalive 10 120
comp-lzo
auth-nocache
persist-key
persist-tun
status openvpn-status.log
verb 3

tls-version-min 1.2
tls-cipher TLS-DHE-RSA-WITH-AES-256-GCM-SHA384:TLS-DHE-RSA-WITH-AES-256-CBC-SHA256:TLS-DHE-RSA-WITH-AES-128-GCM-SHA256:TLS-DHE-RSA-WITH-AES-128-CBC-SHA256
cipher AES-256-CBC
auth SHA512
reneg-sec 60</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nas linhas <code>key</code> e <code>cert</code> , substitua a letra ao final do arquivo <code>/etc/openvpn/keys/FWGW1-G</code> pela que representa seu grupo.</p>
</div>
<div class="paragraph">
<p>Note que a linha <code>server</code> indica uma <strong>NOVA</strong> rede que será criada para o túnel VPN. Nesse sentido, configura a faixa 10.8.1.0/24 se você for membro do grupo A, e 10.8.2.0/24 se você for membro do grupo B.</p>
</div>
<div class="paragraph">
<p>De igual forma, nas linhas <code>push route</code>, informe as rotas 10.1.1.0/24 e 172.16.1.0/24 se você for membro do grupo A, e 10.1.2.0/24 e 172.16.2.0/24 se você for membro do grupo B.</p>
</div>
</li>
<li>
<p>Transfira as chaves geradas no passo (4) para o cliente <strong>que irá se conectar no seu servidor</strong>. Para os membros do grupo A, isso significa transferir as chaves para a máquina <em>WinClient-B</em> do seu colega; e, para os membros do grupo B, transferi-las para a máquina <em>WinClient-A</em>. Vamos fazer isso em alguns passos simples:</p>
<div class="paragraph">
<p>Primeiro, em sua máquina <em>FWGW1-G</em>, gere um pacote <code>.tar.gz</code> com as chaves a serem transferidas.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># mkdir /tmp/vpn-keys</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cp /usr/share/easy-rsa/keys/ca.crt /tmp/vpn-keys/
# cp /usr/share/easy-rsa/keys/WinClient-B.key /tmp/vpn-keys/
# cp /usr/share/easy-rsa/keys/WinClient-B.crt /tmp/vpn-keys/</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># tar czf /tmp/vpn-keys.tar.gz /tmp/vpn-keys/
tar: Removing leading `/' from member names</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># chmod a+r /tmp/vpn-keys.tar.gz</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># rm -rf /tmp/vpn-keys</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ls -ld /tmp/vpn-keys.tar.gz
-rw-r--r-- 1 root root 5525 Sep  7 09:02 /tmp/vpn-keys.tar.gz</pre>
</div>
</div>
<div class="paragraph">
<p>Como não há regra no firewall que permita conexão via SSH ou HTTP vinda de fora, vamos inserir uma regra temporária para permitir a cópia remota:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A INPUT -i enp0s3 -p tcp -m tcp --dport 22 -j ACCEPT</pre>
</div>
</div>
<div class="paragraph">
<p>Descubra o IP público da máquina <em>FWGW1-G</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ip a s enp0s3 | grep '^ *inet ' | awk '{print $2}'
192.168.29.103/24</pre>
</div>
</div>
<div class="paragraph">
<p>Copie o arquivo com as chaves do cliente usando o IP público e o comando <code>scp</code>&#8201;&#8212;&#8201;use os programas <code>pscp.exe</code>, <em>Cygwin</em> ou <em>WinSCP</em> para a tarefa. No exemplo abaixo, iremos usar o Cygwin:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>fbs@FBS-DESKTOP ~
$ scp aluno@192.168.29.103:/tmp/vpn-keys.tar.gz ~
vpn-keys.tar.gz                                                         100% 5525   705.2KB/s   00:00</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>fbs@FBS-DESKTOP ~
$ ls -ld ~/vpn-keys.tar.gz
-rw-r--r-- 1 fbs None 5525 Sep  7 10:09 /home/fbs/vpn-keys.tar.gz</pre>
</div>
</div>
<div class="paragraph">
<p>Ainda na máquina <em>FWGW1-G</em>, remova a regra de firewall temporária que criamos para a cópia remota, bem como o arquivo contendo as chaves no <code>/tmp</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -D INPUT -i enp0s3 -p tcp -m tcp --dport 22 -j ACCEPT</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># rm /tmp/vpn-keys.tar.gz</pre>
</div>
</div>
</li>
<li>
<p>Instale o OpenVPN na máquina <em>WinClient-G</em>. <strong>NÃO</strong> instale o software <em>Private Tunnel</em>, mas sim o OpenVPN <em>Open Source</em>, acessível em <a href="https://openvpn.net/index.php/open-source/downloads.html" class="bare">https://openvpn.net/index.php/open-source/downloads.html</a> . Aceite todas as opções padrão do instalador; ao ser perguntado se deseja instalar os <em>drivers</em> de rede do OpenVPN, responda afirmativamente.</p>
</li>
<li>
<p>Entre na pasta de configuração do OpenVPN no Windows, <code>C:\Program Files\OpenVPN\config</code>. Aqui, iremos fazer duas coisas: (1) criar o arquivo de configuração do OpenVPN para conexão no servidor <em>FWGW1-G</em> do seu colega de atividade, e (2) extrair as chaves do cliente copiadas no passo (8). Vamos lá:</p>
<div class="paragraph">
<p>Crie o arquivo <code>winclient-b.ovpn</code> no <em>Desktop</em> do seu usuário na máquina <em>WinClient-G</em>, com o conteúdo a seguir. Logo após, mova-o para <code>C:\Program Files\OpenVPN\config\winclient-b.ovpn</code>, concedendo permissão administrativa quando solicitado.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">client
proto udp
dev tun

ca   ca.crt
key  WinClient-B.key
cert WinClient-B.crt

remote 192.168.29.103 1194
resolv-retry infinite
nobind

keepalive 10 120
comp-lzo
auth-nocache
persist-key
persist-tun
status openvpn-status.log
verb 3

tls-version-min 1.2
tls-cipher TLS-DHE-RSA-WITH-AES-256-GCM-SHA384:TLS-DHE-RSA-WITH-AES-256-CBC-SHA256:TLS-DHE-RSA-WITH-AES-128-GCM-SHA256:TLS-DHE-RSA-WITH-AES-128-CBC-SHA256
cipher AES-256-CBC
auth SHA512
reneg-sec 60</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nas linhas <code>key</code> e <code>cert</code> , substitua a letra ao final do arquivo <code>WinClient-G</code> pela que representa seu grupo.</p>
</div>
<div class="paragraph">
<p>Na linha <code>remote</code>, insira o IP público da máquina <em>FWGW1-G</em> <strong>do seu colega</strong>&#8201;&#8212;&#8201;esta será a máquina em que seu cliente VPN irá tentar conectar-se quando iniciado.</p>
</div>
<div class="paragraph">
<p>O segundo passo é extrair o arquivo <code>.tar.gz</code> contendo as chaves do cliente que foi copiado no passo (8). Use o <em>7-zip</em> (disponível em <a href="https://www.7-zip.org/download.html" class="bare">https://www.7-zip.org/download.html</a>) para fazer a extração, numa pasta em que seu usuário possua permissão (como o <em>Desktop</em>, por exemplo). Depois, mova as chaves para <code>C:\Program Files\OpenVPN\config</code>. Sua pasta deve ficar assim:</p>
</div>
<div id="img-ovpn-folder" class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/ovpn-folder.png" alt="ovpn folder">
</div>
<div class="title">Figure 8. Estado final da pasta do OpenVPN na máquina WinClient-G</div>
</div>
</li>
<li>
<p>Tudo quase pronto! Vamos testar o funcionamento da VPN, passo a passo: primeiro, o aluno do grupo A deverá atuar como servidor, e o aluno do grupo B atuará como cliente. A seguir, as posições serão invertidas.</p>
<div class="paragraph">
<p>No firewall do aluno do grupo A, <em>FWGW1-A</em>, crie uma regra que permita que conexões VPN sejam autorizadas através do firewall interno:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A INPUT -i enp0s3 -p udp -m udp --dport 1194 -m state --state NEW,ESTABLISHED -j ACCEPT</pre>
</div>
</div>
<div class="paragraph">
<p>Em seguida, inicie o OpenVPN e aguarde:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># /usr/sbin/openvpn --config /etc/openvpn/openvpn.conf
Fri Sep  7 10:21:24 2018 OpenVPN 2.3.4 x86_64-pc-linux-gnu [SSL (OpenSSL)] [LZO] [EPOLL] [PKCS11] [MH] [IPv6] built on Jun 26 2017
Fri Sep  7 10:21:24 2018 library versions: OpenSSL 1.0.1t  3 May 2016, LZO 2.08
Fri Sep  7 10:21:24 2018 Diffie-Hellman initialized with 2048 bit key
Fri Sep  7 10:21:24 2018 Socket Buffers: R=[212992-&gt;131072] S=[212992-&gt;131072]
Fri Sep  7 10:21:24 2018 ROUTE_GATEWAY 192.168.29.1/255.255.255.0 IFACE=enp0s3 HWADDR=08:00:27:43:b1:9d
Fri Sep  7 10:21:24 2018 TUN/TAP device tun0 opened
Fri Sep  7 10:21:24 2018 TUN/TAP TX queue length set to 100
Fri Sep  7 10:21:24 2018 do_ifconfig, tt-&gt;ipv6=0, tt-&gt;did_ifconfig_ipv6_setup=0
Fri Sep  7 10:21:24 2018 /sbin/ip link set dev tun0 up mtu 1500
Fri Sep  7 10:21:24 2018 /sbin/ip addr add dev tun0 local 10.8.1.1 peer 10.8.1.2
Fri Sep  7 10:21:24 2018 /sbin/ip route add 10.8.1.0/24 via 10.8.1.2
Fri Sep  7 10:21:24 2018 UDPv4 link local (bound): [undef]
Fri Sep  7 10:21:24 2018 UDPv4 link remote: [undef]
Fri Sep  7 10:21:24 2018 MULTI: multi_init called, r=256 v=256
Fri Sep  7 10:21:24 2018 IFCONFIG POOL: base=10.8.1.4 size=62, ipv6=0
Fri Sep  7 10:21:24 2018 ifconfig_pool_read(), in='WinClient-B,10.8.1.4', TODO: IPv6
Fri Sep  7 10:21:24 2018 succeeded -&gt; ifconfig_pool_set()
Fri Sep  7 10:21:24 2018 IFCONFIG POOL LIST
Fri Sep  7 10:21:24 2018 WinClient-B,10.8.1.4
Fri Sep  7 10:21:24 2018 Initialization Sequence Completed</pre>
</div>
</div>
<div class="paragraph">
<p>Na máquina cliente do aluno do grupo B, <em>WinClient-B</em>, inicie o OpenVPN como administrador. Navegue até a pasta <code>C:\Program Files\OpenVPN\bin</code>, clique com o botão direito no executável <code>openvpn-gui.exe</code> e selecione <em>Executar como administrador</em>. Autorize a execução na janela seguinte.</p>
</div>
<div class="paragraph">
<p>Deverá aparecer um símbolo de um monitor com um cadeado no <em>tray</em> do sistema, no canto inferior direito da tela, próximo ao relógio. Clique com o botão direito nesse ícone e selecione <em>Connect</em>.</p>
</div>
<div class="paragraph">
<p>Se tudo deu certo, após alguns instantes a janela do OpenVPN que se abriu momentaneamente irá fechar, e o ícone do monitor ficará verde. Colocando o mouse em cima do ícone, você deve ver as linhas <em>Connected to: winclient-b</em> e <em>Assigned IP: 10.8.1.X</em>.</p>
</div>
</li>
<li>
<p>Vamos fazer os testes de conectividade. Na máquina <em>WinClient-B</em>, cheque se as rotas para as redes 10.1.1.0/24 e 172.16.1.0/24 foram importadas corretamente:</p>
<div class="literalblock">
<div class="content">
<pre>C:\&gt;route print
IPv4 Route Table
===========================================================================
Active Routes:
Network Destination          Netmask          Gateway        Interface  Metric
           10.1.1.0    255.255.255.0         10.8.1.5         10.8.1.6      35
         172.16.1.0    255.255.255.0         10.8.1.5         10.8.1.6      35</pre>
</div>
</div>
<div class="paragraph">
<p>A saída do comando <code>route print</code> acima foi sumarizada para obtermos a informação relevante nesta atividade: que as rotas para as redes 10.1.1.0/24 e 172.16.1.0/24 foram adicionadas, e que ambas passam pelo <em>gateway</em> 10.8.1.5, no exemplo. Mas, que roteador é esse? O <code>ipconfig /all</code> mostra essa informação:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>C:\&gt;ipconfig /all

(...)

Ethernet adapter Ethernet 2:

   Connection-specific DNS Suffix  . :
   Description . . . . . . . . . . . : TAP-Windows Adapter V9
   Physical Address. . . . . . . . . : 00-FF-C5-80-A0-B0
   DHCP Enabled. . . . . . . . . . . : Yes
   Autoconfiguration Enabled . . . . : Yes
   Link-local IPv6 Address . . . . . : fe80::2d85:5fb5:4550:adbf%44(Preferred)
   IPv4 Address. . . . . . . . . . . : 10.8.1.6(Preferred)
   Subnet Mask . . . . . . . . . . . : 255.255.255.252
   Lease Obtained. . . . . . . . . . : sexta-feira, 7 de setembro de 2018 11:21:55
   Lease Expires . . . . . . . . . . : sábado, 7 de setembro de 2019 11:21:54
   Default Gateway . . . . . . . . . :
   DHCP Server . . . . . . . . . . . : 10.8.1.5
   DHCPv6 IAID . . . . . . . . . . . : 738262981
   DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-21-81-69-7F-88-D7-F6-DF-94-BE
   DNS Servers . . . . . . . . . . . : fec0:0:0:ffff::1%1
                                       fec0:0:0:ffff::2%1
                                       fec0:0:0:ffff::3%1
   NetBIOS over Tcpip. . . . . . . . : Enabled</pre>
</div>
</div>
<div class="paragraph">
<p>A interface de rede <code>Ethernet 2</code>, mostrada acima, é do tipo TAP e possui IP 10.8.1.6. É através dela que iremos atingir o <em>gateway</em> 10.8.1.5, e portanto as redes 10.1.1.0/24 e 172.16.1.0/24&#8201;&#8212;&#8201;essa é a interface criada pela conexão do OpenVPN.</p>
</div>
</li>
<li>
<p>Se testarmos a conectividade entre a VPN e os <em>hosts</em> da DMZ e da Intranet teremos uma surpresa ingrata, no entanto: não haverá sucesso. Antes de fazer o teste a seguir, verifique se a máquina <em>LinServer-A</em> está ligada. Feito isso, na máquina <em>WinClient-B</em>:</p>
<div class="literalblock">
<div class="content">
<pre>C:\&gt;ping 172.16.1.10

Pinging 172.16.1.10 with 32 bytes of data:
Request timed out.
Request timed out.
Request timed out.
Request timed out.

Ping statistics for 172.16.1.10:
    Packets: Sent = 4, Received = 0, Lost = 4 (100% loss),</pre>
</div>
</div>
<div class="paragraph">
<p>Qual seria a razão? Simples: não estamos permitindo o repasse de pacotes entre as interfaces da VPN e a DMZ/Intranet. Para corrigir isso, basta adicionar uma regra à tabela FORWARD do <em>FWGW1-A</em>&#8201;&#8212;&#8201;de forma genérica, podemos permitir o repasse de qualquer interface do tipo <code>tun</code>, que é o tipo criado pelo OpenVPN quando de sua conexão, para essas duas redes.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A FORWARD -i tun+ -d 172.16.1.0/24 -j ACCEPT
# iptables -A FORWARD -i tun+ -d 10.1.1.0/24 -j ACCEPT</pre>
</div>
</div>
<div class="paragraph">
<p>Imediatamente, temos o resultado na máquina <em>WinClient-B</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>C:\&gt;ping 172.16.1.10

Pinging 172.16.1.10 with 32 bytes of data:
Reply from 172.16.1.10: bytes=32 time&lt;1ms TTL=63
Reply from 172.16.1.10: bytes=32 time&lt;1ms TTL=63
Reply from 172.16.1.10: bytes=32 time&lt;1ms TTL=63
Reply from 172.16.1.10: bytes=32 time&lt;1ms TTL=63

Ping statistics for 172.16.1.10:
    Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),
Approximate round trip times in milli-seconds:
    Minimum = 0ms, Maximum = 0ms, Average = 0ms</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Cuidado ao criar as regras de repasse de pacotes para as interfaces da VPN. Uma regra muito leniente, como <code>iptables -A FORWARD -i tun+ -j ACCEPT</code>, permitiria ao cliente da VPN conectar-se a qualquer <em>host</em> da Internet através do túnel&#8201;&#8212;&#8201;efetivamente utilizando a VPN como uma conexão alternativa de rede. Como raramente esse é o objetivo pretendido pelo administrador, seja específico ao dizer quais redes/máquinas poderão ser atingidas a partir da VPN.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Agora, faça o caminho contrário: a máquina <em>FWGW1-B</em> será o servidor, e a máquina <em>WinClient-A</em> irá conectar-se a ela. Refaça todos os passos da atividade, e verifique que a VPN está funcionando em ambos os sentidos.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2018-10-27 10:46:45 -03
</div>
</div>
</body>
</html>