<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.7.1">
<title>Sessão 3: Firewall</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote::before{display:none}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{word-spacing:0;line-height:1.6}
.quoteblock.abstract blockquote::before,.quoteblock.abstract p::before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="_sessão_3_firewall">Sessão 3: Firewall</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As atividades desta sessão serão realizadas na máquina virtual <em>FWGW1-G</em>, com pequenas exceções apontadas pelo enunciado dos exercícios.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_1_trabalhando_com_chains_no_iptables">1) Trabalhando com <strong><em>chains</em></strong> no <strong><em>iptables</em></strong></h3>
<div class="paragraph">
<p>O Netfilter é um <em>framework</em> provido pelo kernel Linux que permite que várias operações relacionadas à rede sejam implementadas através de <em>handlers</em> customizados. Ele provê diversas funções e operações que permitem filtragem de pacotes, tradução de endereços de rede e portas, bem como a capacidade de proibir que pacotes cheguem a pontos sensíveis da rede.</p>
</div>
<div class="paragraph">
<p>O <code>iptables</code> é a ferramenta em espaço de usuário que permite a gerência do Netfilter. Há vários conceitos centrais ao <code>iptables</code>, como:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Tabelas:</p>
<div class="ulist">
<ul>
<li>
<p><em>Filter</em>: filtragem de pacotes.</p>
</li>
<li>
<p><em>NAT</em>: tradução de endereços.</p>
</li>
<li>
<p><em>Mangle</em>: marcação de pacotes e QoS.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Chains:</p>
<div class="ulist">
<ul>
<li>
<p>INPUT: entrada no firewall propriamente dito.</p>
</li>
<li>
<p>OUTPUT: saída do firewall propriamente dito.</p>
</li>
<li>
<p>FORWARD: passagem através do firewall.</p>
</li>
<li>
<p>PREROUTING: decisões pré-roteamento; presente apenas nas tables <em>NAT</em> e <em>Mangle</em>.</p>
</li>
<li>
<p>POSTROUTING: decisões pós-roteamento; presente apenas nas tables <em>NAT</em> e <em>Mangle</em>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Alvos:</p>
<div class="ulist">
<ul>
<li>
<p>ACCEPT: aceita o pacote.</p>
</li>
<li>
<p>DROP: descarta o pacote sem informar o remetente.</p>
</li>
<li>
<p>REJECT: rejeita o pacote e notifica o remetente.</p>
</li>
<li>
<p>LOG: loga o pacote nos registros do <code>iptables</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Manipulação de regras:</p>
<div class="ulist">
<ul>
<li>
<p>A: adiciona a regra ao final da <em>chain</em> (<em>append</em>).</p>
</li>
<li>
<p>I: insere a regra no começo da <em>chain</em> (<em>insert</em>).</p>
</li>
<li>
<p>D: apaga a regra (<em>delete</em>).</p>
</li>
<li>
<p>L: listas as regras de uma dada <em>chain</em> (<em>list</em>).</p>
</li>
<li>
<p>P: ajusta a política padrão de uma <em>chain</em> (<em>policy</em>).</p>
</li>
<li>
<p>F: apaga todas as regras da <em>chain</em> (<em>flush</em>).</p>
</li>
</ul>
</div>
</li>
<li>
<p>Padrões de casamento:</p>
<div class="ulist">
<ul>
<li>
<p><code>-s</code>: IP de origem do pacote.</p>
</li>
<li>
<p><code>-d</code>: IP de destino do pacote.</p>
</li>
<li>
<p><code>-i</code>: interface de entrada.</p>
</li>
<li>
<p><code>-o</code>: interface de saída.</p>
</li>
<li>
<p><code>-p</code>: protocolo, que pode ser dos tipos TCP, UDP e ICMP.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Módulos adicionais para casamento de pacotes (<em>extended packet matching modules</em>) podem ser habilitados com a opção <code>-m</code> ou <code>--match</code>. Destacamos:</p>
<div class="ulist">
<ul>
<li>
<p><code>conntrack</code>: quando habilitado, permite acesso ao controle de estados de conexões; normalmente invocado por <code>-m conntrack --ctstate</code> ou para um <em>subset</em> de suas funções, <code>-m state --state</code>. Estados válidos incluem INVALID, NEW, ESTABLISHED, RELATED e UNTRACKED.</p>
</li>
<li>
<p><code>icmp</code>: possibilita filtrar tipos específicos de ICMP, via <em>flag</em> <code>--icmp-type</code>.</p>
</li>
<li>
<p><code>mac</code>: possibilita filtragem por endereço físico de origem, via <em>flag</em> <code>--mac-source</code>.</p>
</li>
<li>
<p><code>multiport</code>: permite especificação de até 15 portas dentro de uma mesma regra, separadas por vírgula, ou um <em>range</em> com a sintaxe <code>porta:porta</code>. Pode-se especificar portas de origem (<code>--sports</code>), destino (<code>--dports</code>) ou ambas (<code>--ports</code>).</p>
</li>
<li>
<p><code>tcp</code>: habilita as opções <code>--source-port</code> (ou <code>--sport</code>), <code>--destination-port</code> (ou <code>--dport</code>), <code>--tcp-flags</code> (<em>flags válidas</em>: SYN, ACK, FIN, RST, URG, PSH, ALL e NONE), <code>--syn</code> e <code>--tcp-option</code> para pacotes TCP.</p>
</li>
<li>
<p><code>udp</code>: habilita as opções <code>--source-port</code> (ou <code>--sport</code>), <code>--destination-port</code> (ou <code>--dport</code>) para pacotes UDP.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Primeiro, vamos testar a filtragem simples (<em>stateless</em>) no <code>iptables</code>. Faça login na máquina <em>FWGW1-G</em> como <code>root</code> e mude a política padrão da <em>chain</em> OUTPUT para DROP. Em seguida, tente conectar-se à porta 80/HTTP de um host remoto na Internet. É possível?</p>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nc -z -w5 -v obsd3.srv.ualberta.ca 80
obsd3.srv.ualberta.ca [129.128.5.194] 80 (http) open</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -P OUTPUT DROP</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nc -z -w5 -v obsd3.srv.ualberta.ca 80
obsd3.srv.ualberta.ca: forward host lookup failed: Host name lookup failure : Resource temporarily unavailable</pre>
</div>
</div>
</li>
<li>
<p>Agora, crie uma regra na <em>chain</em> OUTPUT que permita a saída de pacotes na porta 80/HTTP (não se esqueça também de permitir consultas DNS à porta 53/UDP, se estiver utilizando um nome e não um endereço IP) e tente conectar-se novamente. Qual o resultado?</p>
<div class="literalblock">
<div class="content">
<pre># iptables -A OUTPUT -p tcp --dport 80 -j ACCEPT
# iptables -A OUTPUT -p udp --dport 53 -j ACCEPT</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nc -z -w5 -v obsd3.srv.ualberta.ca 80
obsd3.srv.ualberta.ca [129.128.5.194] 80 (http) open</pre>
</div>
</div>
</li>
<li>
<p>Mude a política padrão da <em>chain</em> INPUT também para DROP. Ainda é possível conectar-se?</p>
<div class="literalblock">
<div class="content">
<pre># iptables -P INPUT DROP</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nc -z -w5 -v obsd3.srv.ualberta.ca 80
Host name lookup failure</pre>
</div>
</div>
<div class="paragraph">
<p>Apesar de o resultado parecer o mesmo obtido anteriormente, há uma diferente substancial&#8201;&#8212;&#8201;as requisições DNS/HTTP estão sendo enviado com sucesso, porém a resposta de retorno está sendo bloqueada. Rode o <code>tcpdump</code> em outra sessão e monitore a interface de rede de saída (<code>enp0s3</code>), filtrando apenas por pacotes oriundos/destinados ao IP dessa interface, enquanto o comando <code>nc</code> acima é executado. A requisição DNS e enviada e sua resposta retorna, porém é descartada pelo kernel.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ip a s enp0s3 | grep '^ *inet ' | awk '{print $2}'
192.168.29.107/24</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># tcpdump -i enp0s3 -n src 192.168.29.107 or dst 192.168.29.107
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on enp0s3, link-type EN10MB (Ethernet), capture size 262144 bytes
21:52:28.135864 IP 192.168.29.107.33147 &gt; 8.8.8.8.53: 48302+ A? obsd3.srv.ualberta.ca. (39)
21:52:28.215508 IP 8.8.8.8.53 &gt; 192.168.29.107.33147: 48302 1/0/0 A 129.128.5.194 (55)</pre>
</div>
</div>
</li>
<li>
<p>Finalmente, crie uma regra apropriada na <em>chain</em> INPUT e teste o sucesso na conexão HTTP.</p>
<div class="literalblock">
<div class="content">
<pre># iptables -A INPUT -p tcp --sport 80 -j ACCEPT
# iptables -A INPUT -p udp --sport 53 -j ACCEPT</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nc -z -w5 -v obsd3.srv.ualberta.ca 80
obsd3.srv.ualberta.ca [129.128.5.194] 80 (http) open</pre>
</div>
</div>
<div class="paragraph">
<p>Note que devemos usar <code>--sport</code> (<em>source port</em>) ao invés de <code>--dport</code> (<em>destination port</em>), como feito anteriormente na regra da <em>chain</em> OUTPUT.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_2_firewall_stateful">2) Firewall <strong><em>stateful</em></strong></h3>
<div class="paragraph">
<p>Não é conveniente nem manutenível criar regras como fizemos na atividade (1)&#8201;&#8212;&#8201;para cada regra de saída, ter que existir uma regra de entrada correspondente. Podemos usar a capacidade do <code>iptables</code> de monitorar estados de conexões a nosso favor, já que ele é um firewall <em>stateful</em>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Remova as regras da chain INPUT. Em seguida crie uma regra genérica que permita que conexões estabelecidas sejam autorizadas através do firewall. Em seguida, tente estabelecer uma conexão HTTP. Foi possível?</p>
<div class="literalblock">
<div class="content">
<pre># iptables -F INPUT</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A INPUT -m state --state ESTABLISHED -j ACCEPT</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -L
Chain INPUT (policy DROP)
target     prot opt source               destination
ACCEPT     all  --  anywhere             anywhere             state ESTABLISHED

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination

Chain OUTPUT (policy DROP)
target     prot opt source               destination
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:http
ACCEPT     udp  --  anywhere             anywhere             udp dpt:domain</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nc -z -w5 -v obsd3.srv.ualberta.ca 80
obsd3.srv.ualberta.ca [129.128.5.194] 80 (http) open</pre>
</div>
</div>
</li>
<li>
<p>Qual seria, então, a diferença entre filtros de pacotes <em>stateless</em> e <em>stateful</em>?</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_3_configurando_o_firewall_fwgw1_g_tabela_filter">3) Configurando o firewall <strong><em>FWGW1-G</em></strong>: tabela <strong><em>filter</em></strong></h3>
<div class="paragraph">
<p>A partir desta atividade o roteiro está dividido em duas grandes partes. Na primeira, o aluno programará um controle de pacotes para permitir a comunicação entre os <em>hosts</em> descritos na topologia do laboratório. Na segunda parte, programará a tradução de pacotes. Se precisar, retorne à imagem constante da atividade (2) da sessão 1&#8201;&#8212;&#8201;Configuração preliminar das máquinas.</p>
</div>
<div class="paragraph">
<p>A tabela a seguir mostra uma listagem com a descrição dos serviços a serem disponibilizados pelos servidores da DMZ, cuja permissão de acesso será configurada nas atividades a seguir.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Serviços de rede disponíveis na DMZ</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Servidor</th>
<th class="tableblock halign-left valign-top">Serviço</th>
<th class="tableblock halign-left valign-top">Protocolo</th>
<th class="tableblock halign-left valign-top">Porta</th>
<th class="tableblock halign-left valign-top">Descrição</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SSH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">22</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serviço de login remoto</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Postfix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">25</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor de mensagens</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Apache</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">80</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor de páginas web</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Courier</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">110</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor POP3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PostgreSQL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5432</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor de banco de dados</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bind</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">53</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor DNS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">123</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor de hora</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">21</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor de arquivos</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IIS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">80</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor de páginas web</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IIS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">443</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor de páginas web</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3389</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serviço de conexão remota</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">123</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor de hora</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A realização desta atividade é fundamental para a realização das demais atividades deste curso.
A política de filtro de pacotes será a mais restritiva possível, permitindo somente as conexões previamente definidas no firewall. Dessa forma, a política padrão é negar todos os pacotes que chegarem, saírem e/ou atravessarem o firewall.</p>
</div>
<div class="paragraph">
<p>A cada item será necessário verificar a configuração corrente do firewall. Para listar as regras das tabelas <em>input</em> e <em>nat</em> do firewall, respectivamente, use os comandos:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -L -vn
# iptables -t nat -L -vn</pre>
</div>
</div>
<div class="paragraph">
<p>Caso cometa um erro, você pode apagar todas as regras das tabelas <em>input</em> e <em>nat</em> do firewall, respectivamente, com os comandos:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -F
# iptables -t nat -F</pre>
</div>
</div>
<div class="paragraph">
<p>Use o comando <code>tcpdump</code> para testar o funcionamento de suas regras.</p>
</div>
<div class="sect3">
<h4 id="_1_configuração_preliminar">1) Configuração preliminar</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>O primeiro passo, antes de mesmo começar a mexer no firewall, é ter uma maneira de gravar suas regras. Iremos instalar o pacote <code>iptables-persistent</code> para atingir esse objetivo; mas, antes de começar, garanta que seu firewall não possui regras e que as políticas de entrada/saída são permissivas:</p>
<div class="literalblock">
<div class="content">
<pre># iptables -P INPUT ACCEPT
# iptables -P OUTPUT ACCEPT
# iptables -F</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -L
Chain INPUT (policy ACCEPT)
target     prot opt source               destination

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination</pre>
</div>
</div>
</li>
<li>
<p>Agora, instale o pacote <code>iptables-persistent</code> para tornar suas configurações de firewall permanentes mesmo após o <code>reboot</code> da máquina.</p>
<div class="literalblock">
<div class="content">
<pre># apt-get install iptables-persistent</pre>
</div>
</div>
<div class="paragraph">
<p>Na instalação do pacote, quando perguntado, responda:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 65%;">
<caption class="title">Table 2. Configurações do iptables-persistent</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pergunta</th>
<th class="tableblock halign-left valign-top">Resposta</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Salvar as regras IPv4 atuais?</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sim</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Salvar as regras IPv6 atuais?</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sim</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Isso feito, basta dar início ao processo de configuração do firewall. Ao inserir um conjunto de regras com as quais você esteja satisfeito, é possível gravá-las de forma fácil com o comando:</p>
<div class="literalblock">
<div class="content">
<pre># iptables-save &gt; /etc/iptables/rules.v4</pre>
</div>
</div>
</li>
<li>
<p>Se cometer qualquer erro durante o processo de configuração, você pode recarregar o conjunto de regras salvo no arquivo <code>/etc/iptables/rules.v4</code> com o comando:</p>
<div class="literalblock">
<div class="content">
<pre># systemctl restart netfilter-persistent.service</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_2_configuração_do_acesso_ao_firewall">2) Configuração do acesso ao firewall</h4>
<div class="paragraph">
<p>Vamos primeiramente permitir acesso administrativo ao firewall por SSH, bem como pacotes ICMP para testes de conectividades.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Primeiro, torne as políticas do firewall restritivas, ajustando a política das <em>chains</em> INPUT e FORWARD para DROP.</p>
<div class="literalblock">
<div class="content">
<pre># iptables -P INPUT DROP
# iptables -P FORWARD DROP</pre>
</div>
</div>
</li>
<li>
<p>Teste o funcionamento do firewall. Na máquina <em>LinServer</em>, por exemplo, tente enviar um pacote ICMP para a máquina <em>FWGW1-G</em>.</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname
LinServer-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ping -c1 172.16.1.1
PING 172.16.1.1 (172.16.1.1) 56(84) bytes of data.

--- 172.16.1.1 ping statistics ---
1 packets transmitted, 0 received, 100% packet loss, time 0ms</pre>
</div>
</div>
</li>
<li>
<p>Agora, adicione as seguintes regras ao firewall:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Permita todo o tráfego na interface <em>loopback</em>, e rejeitar qualquer pacote vindo da rede 127.0.0.0/8 que não seja para a interface <code>lo</code> com <code>icmp-port-unreachable</code></p>
</li>
<li>
<p>Permita conexões destinadas ao firewall (<em>chain</em> INPUT) cujo estado seja relacionado ou estabelecido.</p>
</li>
<li>
<p>Permita gerência via <code>ssh</code> do firewall <em>FWGW1-G</em> a partir de máquinas da Intranet.</p>
</li>
<li>
<p>Permita que pacotes ICMP oriundos das redes DMZ/Intranet cheguem ao firewall <em>FWGW1-G</em>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A INPUT -i lo -j ACCEPT
# iptables -A INPUT -d 127.0.0.0/8 -i '!lo' -j REJECT --reject-with icmp-port-unreachable
# iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
# iptables -A INPUT -s 10.1.1.0/24 -p tcp -m tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
# iptables -A INPUT -s 172.16.1.0/24 -p icmp -m icmp --icmp-type any -j ACCEPT
# iptables -A INPUT -s 10.1.1.0/24 -p icmp -m icmp --icmp-type any -j ACCEPT</pre>
</div>
</div>
</li>
<li>
<p>Realize o teste de conexão do passo (2) novamente, e verifique que suas configurações funcionaram.</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname
LinServer-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ping -c1 172.16.1.1
PING 172.16.1.1 (172.16.1.1) 56(84) bytes of data.
64 bytes from 172.16.1.1: icmp_seq=1 ttl=64 time=0.235 ms

--- 172.16.1.1 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.235/0.235/0.235/0.000 ms</pre>
</div>
</div>
</li>
<li>
<p>Se quiser, use o PuTTY (<a href="https://www.putty.org/" class="bare">https://www.putty.org/</a>) ou Cygwin (<a href="http://www.cygwin.com/" class="bare">http://www.cygwin.com/</a>), nas máquinas <em>WinClient-G</em> ou sua máquina física, para conectar-se à máquina <em>FWGW1-G</em> e testar sua configuração.</p>
<div class="paragraph">
<p>Abaixo, temos um exemplo de conexão a partir da máquina física usando Cygwin/x64 para o <em>host</em> <em>FWGW1-G</em>, via SSH.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>fbs@LOCAL-PC ~
$ uname
CYGWIN_NT-10.0</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>fbs@LOCAL-PC ~
$ ssh aluno@10.1.1.1
No mail.
Last login: Sun Aug 19 22:30:33 2018 from 10.1.1.254</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ whoami
aluno</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hostname
FWGW1-A</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_3_configuração_do_acesso_intranet_dmz">3) Configuração do acesso Intranet &gt; DMZ</h4>
<div class="paragraph">
<p>Agora, vamos configurar o firewall para permitir pacotes originados na Intranet que atravessem o firewall com destino aos serviços da DMZ. Verifique a lista de serviços a serem permitidos na tabela 7&#8201;&#8212;&#8201;"Serviços de rede disponíveis na DMZ".</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Adicione regras à <em>chain</em> FORWARD da tabela <em>filter</em> que permitam que o serviços da tabela referenciada acima possam ser acessados a partir da Intranet.</p>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A FORWARD -s 10.1.1.0/24 -d 172.16.1.10/32 -p tcp -m multiport --dports 22,25,80,110,5432 -j ACCEPT
# iptables -A FORWARD -s 10.1.1.0/24 -d 172.16.1.10/32 -p udp -m multiport --dports 53,123 -j ACCEPT</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A FORWARD -s 10.1.1.0/24 -d 172.16.1.20/32 -p tcp -m multiport --dports 21,80,443,3389 -j ACCEPT
# iptables -A FORWARD -s 10.1.1.0/24 -d 172.16.1.20/32 -p udp -m multiport --dports 123 -j ACCEPT</pre>
</div>
</div>
</li>
<li>
<p>Teste sua configuração acessando o servidor web IIS instalado na máquina <em>WinServer-G</em>, e acessando-o a partir da máquina <em>WinClient-G</em>.</p>
<div id="img-fwd-iis-ok" class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/firewall-fwd-iis-ok.png" alt="firewall fwd iis ok">
</div>
<div class="title">Figure 1. Acesso da Intranet para a DMZ</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_4_configuração_do_acesso_dmzintranet_internet">4) Configuração do acesso DMZ/Intranet &gt; Internet</h4>
<div class="paragraph">
<p>Agora, vamos configurar o acesso da DMZ e Intranet para a Internet. Para isso, teremos que permitir que pacotes originados nessas redes atravessem o firewall via interface de rede <em>outbound</em>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Adicione regras à <em>chain</em> FORWARD da tabela <em>filter</em> que permitam que as redes DMZ e Intranet possam acessar qualquer serviço na Internet, via quaisquer protocolos.</p>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A FORWARD -s 172.16.1.0/24 -o enp0s3 -j ACCEPT
# iptables -A FORWARD -s 10.1.1.0/24   -o enp0s3 -j ACCEPT</pre>
</div>
</div>
</li>
<li>
<p>Teste sua configuração acessando uma página da Internet a partir da máquina <em>LinServer-G</em>.</p>
<div class="paragraph">
<p>Observe que, se a regra de <code>MASQUERADE</code> inserida através do arquivo <code>/etc/rc.local</code> durante o <em>boot</em> do sistema tiver sido removida durante a atividade (3) desta seção (comando <code>iptables -t nat -F</code>), o acesso acima não irá funcionar. Iremos reconfigurar regras que viabilizem a conexão logo a seguir, na atividade (4.1).</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hostname
LinServer-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ nc -z -w5 -v obsd3.srv.ualberta.ca 80
obsd3.srv.ualberta.ca [129.128.5.194] 80 (http) open</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_5_configuração_do_acesso_internet_dmz">5) Configuração do acesso Internet &gt; DMZ</h4>
<div class="paragraph">
<p>Finalmente, o último passo é permitir que requisições vindas da Internet possam acessar alguns serviços publicados pela DMZ.</p>
</div>
<div class="paragraph">
<p>Como dois serviços das máquinas <em>LinServer-G</em> e <em>WinServer-G</em> operam nas mesmas portas (80/TCP e 123/UDP), teremos que fazer uma técnica de PAT (<em>port address translation</em>) para que ambos possam ser atingidos. O primeiro passo será feito aqui, nas regras da <em>chain</em> FORWARD; na próxima atividade, em que configuraremos o DNAT, será realizada a parte de tradução de portas.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Serviços publicados pela DMZ para a Internet</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Servidor</th>
<th class="tableblock halign-left valign-top">Serviço</th>
<th class="tableblock halign-left valign-top">Protocolo</th>
<th class="tableblock halign-left valign-top">Porta do serviço</th>
<th class="tableblock halign-left valign-top">Porta Internet</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Postfix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">25</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">25</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Apache</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">80</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">80</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Courier</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">110</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">110</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bind</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">53</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">53</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">123</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">123</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">21</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">21</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IIS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">80</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8080</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IIS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">443</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">443</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">123</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8123</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>O teste deste configuração será feito na próxima atividade, em que configuraremos o NAT.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As regras de DNAT que inseriremos na atividade a seguir entrarão na <em>chain</em> PREROUTING, ou pré-roteamento. Isso significa dizer que os números de porta Internet mostrados acima serão traduzidos para os números das porta de serviço <strong>ANTES</strong> que as regras da <em>chain</em> FORWARD sejam processadas.</p>
</div>
<div class="paragraph">
<p>Tenha isso em mente ao decidir quais números de porta utilizar nas regras de repasse deste exercício.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Adicione regras à <em>chain</em> FORWARD da tabela <em>filter</em> que permitam que a Internet consiga acessar os serviços publicados pelas máquinas da DMZ, de acordo com as especificações acima.</p>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A FORWARD -i enp0s3 -d 172.16.1.10/32 -p tcp -m multiport --dports 25,80,110 -j ACCEPT
# iptables -A FORWARD -i enp0s3 -d 172.16.1.10/32 -p udp -m multiport --dports 53,123 -j ACCEPT
# iptables -A FORWARD -i enp0s3 -d 172.16.1.20/32 -p tcp -m multiport --dports 21,80,443 -j ACCEPT
# iptables -A FORWARD -i enp0s3 -d 172.16.1.20/32 -p udp -m multiport --dports 123 -j ACCEPT</pre>
</div>
</div>
<div class="paragraph">
<p>Como a tradução dos números de porta já terá sido realizado quando as regras acima forem processadas, devemos utilizar os número de porta internos (ou de serviço, de acordo com a tabela) na configuração das regras de <em>forward</em>.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_configurando_o_firewall_fwgw1_g_tabela_nat">4) Configurando o firewall <strong><em>FWGW1-G</em></strong>: tabela <strong><em>nat</em></strong></h3>
<div class="paragraph">
<p>O principal objetivo desta atividade é demonstrar o entendimento do funcionamento dos tipos de NAT e aplicá-los em uma simulação de caso real.</p>
</div>
<div class="paragraph">
<p>Utilizando os conceitos aprendidos, será necessário configurar o NAT no firewall <em>FWGW1-G</em> para permitir que as máquinas da rede local e da DMZ consigam acessar a Internet. Também será necessária a configuração do NAT para publicação dos serviços da DMZ para a Internet.</p>
</div>
<div class="sect3">
<h4 id="_1_configuração_do_snat_dmzintranet_internet">1) Configuração do SNAT: DMZ/Intranet &gt; Internet</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Antes de configurar o SNAT para acesso DMZ/Intranet &gt; Internet, será necessário remover a configuração de <em>masquerading</em> preexistente, que fizemos na sessão 1. Edite o arquivo <code>/etc/rc.local</code> e remova ou comente a linha:</p>
<div class="literalblock">
<div class="content">
<pre>iptables -t nat -A POSTROUTING -o enp0s3 -j MASQUERADE</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># sed -i 's/\(iptables -t nat -A POSTROUTING -o enp0s3 -j MASQUERADE\)/#\1/' /etc/rc.local</pre>
</div>
</div>
</li>
<li>
<p>Da mesma forma, remova essa regra do firewall, já que configuraremos outras regras, mais específicas, em seu lugar a seguir.</p>
<div class="literalblock">
<div class="content">
<pre># iptables -t nat -L POSTROUTING -vn --line-number
Chain POSTROUTING (policy ACCEPT 2 packets, 104 bytes)
num   pkts bytes target     prot opt in     out     source               destination
1       70  5922 MASQUERADE  all  --  *      enp0s3    0.0.0.0/0            0.0.0.0/0</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -t nat -D POSTROUTING 1</pre>
</div>
</div>
</li>
<li>
<p>Agora sim, tudo pronto. Insira uma regra no firewall que faça tradução dos endereços das redes DMZ/Intranet via <em>masquerading</em>, permitindo assim seu acesso à Internet.</p>
<div class="literalblock">
<div class="content">
<pre># iptables -t nat -A POSTROUTING -s 172.16.1.0/24 -o enp0s3 -j MASQUERADE
# iptables -t nat -A POSTROUTING -s 10.1.1.0/24 -o enp0s3 -j MASQUERADE</pre>
</div>
</div>
</li>
<li>
<p>Teste sua configuração. Acesse, por exemplo, a máquina <em>LinServer-G</em> e tente acessar um site na Internet.</p>
<div class="literalblock">
<div class="content">
<pre># hostname
LinServer-A

# nc -z -w5 -v obsd3.srv.ualberta.ca 80
obsd3.srv.ualberta.ca [129.128.5.194] 80 (http) open</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_2_configuração_do_dnat_internet_dmz">2) Configuração do DNAT: Internet &gt; DMZ</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Agora, vamos configurar o DNAT, que irá permitir acesso pela Internet aos serviços publicados pela DMZ. Comece fazendo as regras para a máquina <em>LinServer-G</em>, que não exige PAT.</p>
<div class="literalblock">
<div class="content">
<pre># iptables -t nat -A PREROUTING -i enp0s3 -p tcp -m multiport --dports 25,80,110 -j DNAT --to-destination 172.16.1.10
# iptables -t nat -A PREROUTING -i enp0s3 -p udp -m multiport --dports 53,123 -j DNAT --to-destination 172.16.1.10</pre>
</div>
</div>
</li>
<li>
<p>Agora, teste sua configuração. Primeiro, instale o servidor web Apache na máquina <em>LinServer-G</em>; a seguir, em sua máquina física, acesso o IP público da máquina <em>FWGW1-G</em> na porta 80/TCP e verifique que de fato é exibida no navegador a página web instalada no <em>LinServer-G</em>.</p>
<div class="paragraph">
<p>Primeiro, vamos instalar o servidor web Apache na máquina <em>LinServer-G</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
LinServer-A

# apt-get install --no-install-recommends apache2</pre>
</div>
</div>
<div class="paragraph">
<p>Em seguida, vamos monitorar o log de acesso do Apache, aguardando por conexões:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># tail -f -n0 /var/log/apache2/access.log</pre>
</div>
</div>
<div class="paragraph">
<p>Agora, temos que descobrir o IP público da máquina <em>FWGW1-G</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ip a s enp0s3 | grep '^ *inet '
    inet 192.168.29.103/24 brd 192.168.29.255 scope global enp0s3</pre>
</div>
</div>
<div class="paragraph">
<p>Finalmente, vamos acessar esse IP na porta 80 a partir da máquina física:</p>
</div>
<div id="img-firewall-dnat-linserver" class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/firewall-dnat-linserver.png" alt="firewall dnat linserver">
</div>
<div class="title">Figure 2. Teste DNAT do acesso Internet &gt; LinServer</div>
</div>
<div class="paragraph">
<p>Voltando ao monitoramento do log de acessos do Apache na máquina <em>LinServer-G</em>, vemos que o acesso de fato se concretizou:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
LinServer-A

# tail -f -n0 /var/log/apache2/access.log
192.168.29.102 - - [25/Aug/2018:15:19:57 -0400] "GET / HTTP/1.1" 200 3380 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36"
192.168.29.102 - - [25/Aug/2018:15:19:57 -0400] "GET /icons/openlogo-75.png HTTP/1.1" 200 6040 "http://192.168.29.103/" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36"</pre>
</div>
</div>
</li>
<li>
<p>Faça o mesmo processo para a configuração do DNAT da máquina <em>WinServer-G</em>. Atente-se para o fato de que duas portas internat, 80/TCP e 123/UDP, serão acessadas através das portas externas 8080/TCP e 8123/UDP respectivamente. Configure o PAT de acordo.</p>
<div class="literalblock">
<div class="content">
<pre># iptables -t nat -A PREROUTING -i enp0s3 -p tcp -m multiport --dports 21,443 -j DNAT --to-destination 172.16.1.20
# iptables -t nat -A PREROUTING -i enp0s3 -p tcp --dport 8080 -j DNAT --to-destination 172.16.1.20:80
# iptables -t nat -A PREROUTING -i enp0s3 -p udp --dport 8123 -j DNAT --to-destination 172.16.1.20:123</pre>
</div>
</div>
</li>
<li>
<p>Teste sua configuração. Em sua máquina física, acesso o IP público da máquina <em>FWGW1-G</em> na porta 8080/TCP e verifique que de fato é exibida no navegador a página web do servidor IIS instalada na máquina <em>WinServer-G</em>.</p>
<div class="paragraph">
<p>Utilizando o mesmo IP público descoberto anteriormente, basta acessá-lo na porta 8080 como solicitado:</p>
</div>
<div id="img-firewall-dnat-winserver" class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/firewall-dnat-winserver.png" alt="firewall dnat winserver">
</div>
<div class="title">Figure 3. Teste DNAT do acesso Internet &gt; WinServer</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_6_revisão_final_da_configuração_do_firewall_fwgw1_g">6) Revisão final da configuração do firewall <strong><em>FWGW1-G</em></strong></h3>
<div class="paragraph">
<p>Salve a configuração feita até aqui e reinicie o firewall com os comandos:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A

# iptables-save &gt; /etc/iptables/rules.v4
# systemctl restart netfilter-persistent.service</pre>
</div>
</div>
<div class="paragraph">
<p>Revise se todos os pontos abordados até aqui foram contemplados. Que outras regras interessantes poderiam ser incluídas na configuração desse firewall?</p>
</div>
<div class="paragraph">
<p>Abaixo, temos a configuração final sugerida para o firewall:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># Generated by iptables-save v1.6.0 on Thu Oct 11 10:17:13 2018
*filter
:INPUT DROP [57:15290]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [75:8092]
-A INPUT -i lo -j ACCEPT
-A INPUT -d 127.0.0.0/8 -i !lo -j REJECT --reject-with icmp-port-unreachable
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -s 10.1.1.0/24 -p tcp -m tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
-A INPUT -s 172.16.1.0/24 -p icmp -m icmp --icmp-type any -j ACCEPT
-A INPUT -s 10.1.1.0/24 -p icmp -m icmp --icmp-type any -j ACCEPT
-A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -s 10.1.1.0/24 -d 172.16.1.10/32 -p tcp -m multiport --dports 22,25,80,110,5432 -j ACCEPT
-A FORWARD -s 10.1.1.0/24 -d 172.16.1.10/32 -p udp -m multiport --dports 53,123 -j ACCEPT
-A FORWARD -s 10.1.1.0/24 -d 172.16.1.20/32 -p tcp -m multiport --dports 21,80,443,3389 -j ACCEPT
-A FORWARD -s 10.1.1.0/24 -d 172.16.1.20/32 -p udp -m multiport --dports 123 -j ACCEPT
-A FORWARD -s 172.16.1.0/24 -o enp0s3 -j ACCEPT
-A FORWARD -s 10.1.1.0/24 -o enp0s3 -j ACCEPT
-A FORWARD -d 172.16.1.10/32 -i enp0s3 -p tcp -m multiport --dports 25,80,110 -j ACCEPT
-A FORWARD -d 172.16.1.10/32 -i enp0s3 -p udp -m multiport --dports 53,123 -j ACCEPT
-A FORWARD -d 172.16.1.20/32 -i enp0s3 -p tcp -m multiport --dports 21,443,80 -j ACCEPT
-A FORWARD -d 172.16.1.20/32 -i enp0s3 -p udp -m multiport --dports 123 -j ACCEPT
COMMIT
# Completed on Thu Oct 11 10:17:13 2018
# Generated by iptables-save v1.6.0 on Thu Oct 11 10:17:13 2018
*nat
:PREROUTING ACCEPT [2:84]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A PREROUTING -i enp0s3 -p tcp -m multiport --dports 25,80,110 -j DNAT --to-destination 172.16.1.10
-A PREROUTING -i enp0s3 -p udp -m multiport --dports 53,123 -j DNAT --to-destination 172.16.1.10
-A PREROUTING -i enp0s3 -p tcp -m multiport --dports 21,443 -j DNAT --to-destination 172.16.1.20
-A PREROUTING -i enp0s3 -p tcp -m tcp --dport 8080 -j DNAT --to-destination 172.16.1.20:80
-A PREROUTING -i enp0s3 -p udp -m udp --dport 8123 -j DNAT --to-destination 172.16.1.20:123
-A POSTROUTING -s 10.1.1.0/24 -o enp0s3 -j MASQUERADE
-A POSTROUTING -s 172.16.1.0/24 -o enp0s3 -j MASQUERADE
COMMIT
# Completed on Thu Oct 11 10:17:13 2018</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2018-10-27 10:35:17 -03
</div>
</div>
</body>
</html>